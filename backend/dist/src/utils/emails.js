"use strict";async function sendEmail(e,a,l){var i,t,o,n,s,r,d;let u,c;try{null===(i=null==l?void 0:l.step)||void 0===i||i.call(l,`Processing email template: ${a}`);const t=await(0,mailer_1.fetchAndProcessEmailTemplate)(e,a);u=t.processedTemplate;c=t.processedSubject}catch(e){console_1.logger.error("EMAIL","Error processing email template",e);null===(t=null==l?void 0:l.fail)||void 0===t||t.call(l,e.message);throw e}let m,p={};if(e.USER_ID)try{const a=await(0,token_1.generateUnsubscribeToken)(e.USER_ID);p={userId:e.USER_ID,locale:e.LOCALE||"en",unsubscribeToken:a}}catch(e){console_1.logger.warn("EMAIL","Failed to generate unsubscribe token",e)}try{null===(o=null==l?void 0:l.step)||void 0===o||o.call(l,"Preparing email template");m=await(0,mailer_1.prepareEmailTemplate)(u,c,p)}catch(e){console_1.logger.error("EMAIL","Error preparing email template",e);null===(n=null==l?void 0:l.fail)||void 0===n||n.call(l,e.message);throw e}const E={to:e.TO,subject:c,html:m},T=APP_EMAILER;try{null===(s=null==l?void 0:l.step)||void 0===s||s.call(l,`Sending email to ${e.TO}`);await(0,mailer_1.sendEmailWithProvider)(T,E);null===(r=null==l?void 0:l.success)||void 0===r||r.call(l,`Email sent successfully to ${e.TO}`)}catch(e){console_1.logger.error("EMAIL","Error sending email with provider",e);null===(d=null==l?void 0:l.fail)||void 0===d||d.call(l,e.message);throw e}}async function sendChatEmail(e,a,l,i,t,o){var n,s,r;null===(n=null==o?void 0:o.step)||void 0===n||n.call(o,`Queueing chat email to ${a.email}`);const d={TO:a.email,SENDER_NAME:e.firstName,RECEIVER_NAME:a.firstName,MESSAGE:i.text,TICKET_ID:l.id};try{await exports.emailQueue.add({emailData:d,emailType:t});null===(s=null==o?void 0:o.success)||void 0===s||s.call(o,"Chat email queued successfully")}catch(e){null===(r=null==o?void 0:o.fail)||void 0===r||r.call(o,e.message);throw e}}async function sendFiatTransactionEmail(e,a,l,i,t){var o,n,s;null===(o=null==t?void 0:t.step)||void 0===o||o.call(t,`Queueing fiat transaction email to ${e.email}`);const r={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,TRANSACTION_TYPE:a.type,TRANSACTION_ID:a.id,AMOUNT:a.amount,CURRENCY:l,TRANSACTION_STATUS:a.status,NEW_BALANCE:i,DESCRIPTION:a.description||"N/A"};try{await exports.emailQueue.add({emailData:r,emailType:"FiatWalletTransaction"});null===(n=null==t?void 0:t.success)||void 0===n||n.call(t,"Fiat transaction email queued successfully")}catch(e){null===(s=null==t?void 0:t.fail)||void 0===s||s.call(t,e.message);throw e}}function getBinaryOrderEmailTemplate(e,a){const l={RISE_FALL:"BinaryRiseFall",HIGHER_LOWER:"BinaryHigherLower",TOUCH_NO_TOUCH:"BinaryTouchNoTouch",CALL_PUT:"BinaryCallPut",TURBO:"BinaryTurbo"}[e]||"BinaryRiseFall";switch(a){case"WIN":return`${l}Win`;case"LOSS":return`${l}Loss`;case"DRAW":return`${l}Draw`;default:return"BinaryOrderResult"}}async function sendBinaryOrderEmail(e,a,l){var i,t,o;null===(i=null==l?void 0:l.step)||void 0===i||i.call(l,`Queueing binary order email to ${e.email}`);const n=getBinaryOrderEmailTemplate(a.type,a.status);let s=0,r="";switch(a.status){case"WIN":s=a.profit;r="+";break;case"LOSS":s=a.amount;r="-";break;case"DRAW":s=0;r=""}const d=a.symbol.split("/")[1],u={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,ORDER_ID:a.id,RESULT:a.status,MARKET:a.symbol,CURRENCY:d,AMOUNT:a.amount,PROFIT:`${r}${s}`,ENTRY_PRICE:a.price,CLOSE_PRICE:a.closePrice,SIDE:a.side};switch(a.type){case"HIGHER_LOWER":case"TURBO":if(a.barrier){u.BARRIER=a.barrier;u.BARRIER_LEVEL=a.barrierLevelId||"Custom"}break;case"TOUCH_NO_TOUCH":a.barrier&&(u.BARRIER=a.barrier);const e="TOUCH"===a.side;a.status;if("WIN"===a.status){u.TOUCH_RESULT=e?"The price touched your barrier level!":"The price never touched your barrier level!";u.MULTIPLIER_INFO=e?"Touch Multiplier Applied":"No Touch Multiplier Applied"}else u.TOUCH_RESULT=e?"The price did not touch your barrier level before expiry.":"The price touched your barrier level before expiry.";break;case"CALL_PUT":if(a.strikePrice){u.STRIKE=a.strikePrice;u.STRIKE_LEVEL=a.strikeLevelId||"Custom"}}try{await exports.emailQueue.add({emailData:u,emailType:n});null===(t=null==l?void 0:l.success)||void 0===t||t.call(l,`Binary order email queued successfully (${n})`)}catch(e){null===(o=null==l?void 0:l.fail)||void 0===o||o.call(l,e.message);throw e}}async function sendWalletBalanceUpdateEmail(e,a,l,i,t,o){var n,s,r;null===(n=null==o?void 0:o.step)||void 0===n||n.call(o,`Queueing wallet balance update email to ${e.email}`);const d={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,ACTION:l,AMOUNT:i,CURRENCY:a.currency,NEW_BALANCE:t};try{await exports.emailQueue.add({emailData:d,emailType:"WalletBalanceUpdate"});null===(s=null==o?void 0:o.success)||void 0===s||s.call(o,"Wallet balance update email queued successfully")}catch(e){null===(r=null==o?void 0:o.fail)||void 0===r||r.call(o,e.message);throw e}}async function sendTransactionStatusUpdateEmail(e,a,l,i,t,o){var n,s,r;null===(n=null==o?void 0:o.step)||void 0===n||n.call(o,`Queueing transaction status update email to ${e.email}`);const d={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,TRANSACTION_TYPE:a.type,TRANSACTION_ID:a.id,TRANSACTION_STATUS:a.status,AMOUNT:a.amount,CURRENCY:l.currency,NEW_BALANCE:i,NOTE:t||"N/A"};try{await exports.emailQueue.add({emailData:d,emailType:"TransactionStatusUpdate"});null===(s=null==o?void 0:o.success)||void 0===s||s.call(o,"Transaction status update email queued successfully")}catch(e){null===(r=null==o?void 0:o.fail)||void 0===r||r.call(o,e.message);throw e}}async function sendAuthorStatusUpdateEmail(e,a,l){var i,t,o;null===(i=null==l?void 0:l.step)||void 0===i||i.call(l,`Queueing author status update email to ${e.email}`);const n={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,AUTHOR_STATUS:a.status,APPLICATION_ID:a.id};try{await exports.emailQueue.add({emailData:n,emailType:"AuthorStatusUpdate"});null===(t=null==l?void 0:l.success)||void 0===t||t.call(l,"Author status update email queued successfully")}catch(e){null===(o=null==l?void 0:l.fail)||void 0===o||o.call(l,e.message);throw e}}async function sendOutgoingTransferEmail(e,a,l,i,t,o){var n,s,r;null===(n=null==o?void 0:o.step)||void 0===n||n.call(o,`Queueing outgoing transfer email to ${e.email}`);const d={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,AMOUNT:i,CURRENCY:l.currency,NEW_BALANCE:l.balance,TRANSACTION_ID:t,RECIPIENT_NAME:`${a.firstName} ${a.lastName}`};try{await exports.emailQueue.add({emailData:d,emailType:"OutgoingWalletTransfer"});null===(s=null==o?void 0:o.success)||void 0===s||s.call(o,"Outgoing transfer email queued successfully")}catch(e){null===(r=null==o?void 0:o.fail)||void 0===r||r.call(o,e.message);throw e}}async function sendIncomingTransferEmail(e,a,l,i,t,o){var n,s,r;null===(n=null==o?void 0:o.step)||void 0===n||n.call(o,`Queueing incoming transfer email to ${e.email}`);const d={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,AMOUNT:i,CURRENCY:l.currency,NEW_BALANCE:l.balance,TRANSACTION_ID:t,SENDER_NAME:`${a.firstName} ${a.lastName}`};try{await exports.emailQueue.add({emailData:d,emailType:"IncomingWalletTransfer"});null===(s=null==o?void 0:o.success)||void 0===s||s.call(o,"Incoming transfer email queued successfully")}catch(e){null===(r=null==o?void 0:o.fail)||void 0===r||r.call(o,e.message);throw e}}async function sendSpotWalletWithdrawalConfirmationEmail(e,a,l,i){var t,o,n;null===(t=null==i?void 0:i.step)||void 0===t||t.call(i,`Queueing spot wallet withdrawal confirmation email to ${e.email}`);const s={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,AMOUNT:a.amount,CURRENCY:l.currency,ADDRESS:a.metadata.address,FEE:a.fee,CHAIN:a.metadata.chain,MEMO:a.metadata.memo||"N/A",STATUS:a.status};try{await exports.emailQueue.add({emailData:s,emailType:"SpotWalletWithdrawalConfirmation"});null===(o=null==i?void 0:i.success)||void 0===o||o.call(i,"Spot wallet withdrawal confirmation email queued successfully")}catch(e){null===(n=null==i?void 0:i.fail)||void 0===n||n.call(i,e.message);throw e}}async function sendSpotWalletDepositConfirmationEmail(e,a,l,i,t){var o,n,s;null===(o=null==t?void 0:t.step)||void 0===o||o.call(t,`Queueing spot wallet deposit confirmation email to ${e.email}`);const r={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,TRANSACTION_ID:a.referenceId,AMOUNT:a.amount,CURRENCY:l.currency,CHAIN:i,FEE:a.fee};try{await exports.emailQueue.add({emailData:r,emailType:"SpotWalletDepositConfirmation"});null===(n=null==t?void 0:t.success)||void 0===n||n.call(t,"Spot wallet deposit confirmation email queued successfully")}catch(e){null===(s=null==t?void 0:t.fail)||void 0===s||s.call(t,e.message);throw e}}async function sendAiInvestmentEmail(e,a,l,i,t,o){var n,s,r;null===(n=null==o?void 0:o.step)||void 0===n||n.call(o,`Queueing AI investment email to ${e.email}`);const d="WIN"===i.result?"+":"LOSS"===i.result?"-":"",u={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,PLAN_NAME:a.title,AMOUNT:i.amount.toString(),CURRENCY:i.symbol.split("/")[1],DURATION:l.duration.toString(),TIMEFRAME:l.timeframe,STATUS:i.status,PROFIT:void 0!==i.profit?`${d}${i.profit}`:"N/A"};try{await exports.emailQueue.add({emailData:u,emailType:t});null===(s=null==o?void 0:o.success)||void 0===s||s.call(o,"AI investment email queued successfully")}catch(e){null===(r=null==o?void 0:o.fail)||void 0===r||r.call(o,e.message);throw e}}async function sendInvestmentEmail(e,a,l,i,t,o){var n,s,r;null===(n=null==o?void 0:o.step)||void 0===n||n.call(o,`Queueing investment email to ${e.email}`);const d="WIN"===i.result?"+":"LOSS"===i.result?"-":"",u={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,PLAN_NAME:a.title,AMOUNT:i.amount.toString(),DURATION:l.duration.toString(),TIMEFRAME:l.timeframe,STATUS:i.status,PROFIT:`${d}${i.profit}`||"N/A"};try{await exports.emailQueue.add({emailData:u,emailType:t});null===(s=null==o?void 0:o.success)||void 0===s||s.call(o,"Investment email queued successfully")}catch(e){null===(r=null==o?void 0:o.fail)||void 0===r||r.call(o,e.message);throw e}}async function sendIcoContributionEmail(e,a,l,i,t,o,n){var s,r,d;null===(s=null==n?void 0:n.step)||void 0===s||s.call(n,`Queueing ICO contribution email to ${e.email}`);const u=new Date(a.createdAt).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),c={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,TOKEN_NAME:l.name,PHASE_NAME:i.name,AMOUNT:a.amount.toString(),CURRENCY:l.purchaseCurrency,DATE:u};"IcoContributionPaid"===t?c.TRANSACTION_ID=o||"N/A":"IcoNewContribution"===t&&(c.CONTRIBUTION_STATUS=a.status);try{await exports.emailQueue.add({emailData:c,emailType:t});null===(r=null==n?void 0:n.success)||void 0===r||r.call(n,"ICO contribution email queued successfully")}catch(e){null===(d=null==n?void 0:n.fail)||void 0===d||d.call(n,e.message);throw e}}async function sendStakingInitiationEmail(e,a,l,i,t){var o,n,s;null===(o=null==t?void 0:t.step)||void 0===o||o.call(t,`Queueing staking initiation email to ${e.email}`);const r=new Date(a.stakeDate).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),d=new Date(a.releaseDate).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),u={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,TOKEN_NAME:l.name,STAKE_AMOUNT:a.amount.toString(),TOKEN_SYMBOL:l.currency,STAKE_DATE:r,RELEASE_DATE:d,EXPECTED_REWARD:i};try{await exports.emailQueue.add({emailData:u,emailType:"StakingInitiationConfirmation"});null===(n=null==t?void 0:t.success)||void 0===n||n.call(t,"Staking initiation email queued successfully")}catch(e){null===(s=null==t?void 0:t.fail)||void 0===s||s.call(t,e.message);throw e}}async function sendStakingRewardEmail(e,a,l,i,t){var o,n,s;null===(o=null==t?void 0:t.step)||void 0===o||o.call(t,`Queueing staking reward email to ${e.email}`);const r=(0,date_fns_1.format)(new Date(a.releaseDate),"MMMM do, yyyy 'at' hh:mm a"),d={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,TOKEN_NAME:l.name,REWARD_AMOUNT:i.toString(),TOKEN_SYMBOL:l.currency,DISTRIBUTION_DATE:r};try{await exports.emailQueue.add({emailData:d,emailType:"StakingRewardDistribution"});null===(n=null==t?void 0:t.success)||void 0===n||n.call(t,"Staking reward email queued successfully")}catch(e){null===(s=null==t?void 0:t.fail)||void 0===s||s.call(t,e.message);throw e}}async function sendOrderConfirmationEmail(e,a,l,i){var t,o,n,s,r,d;null===(t=null==i?void 0:i.step)||void 0===t||t.call(i,`Queueing order confirmation email to ${e.email}`);const u=new Date(a.createdAt).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),c=await db_1.models.ecommerceOrder.findByPk(a.id,{include:[{model:db_1.models.ecommerceOrderItem,as:"orderItems",include:[{model:db_1.models.ecommerceProduct,as:"product"}]}]}),m=(null===(o=null==c?void 0:c.orderItems)||void 0===o?void 0:o.reduce((e,a)=>e+a.product.price*a.quantity,0))||l.price,p=(await db_1.models.settings.findAll()).reduce((e,a)=>{e[a.key]=a.value;return e},{});let E=0;"PHYSICAL"===l.type&&"true"===p.ecommerceShippingEnabled&&(E=parseFloat(p.ecommerceDefaultShippingCost||"0"));let T=0;if("true"===p.ecommerceTaxEnabled){T=m*(parseFloat(p.ecommerceDefaultTaxRate||"0")/100)}const y=m+E+T,v={TO:e.email,CUSTOMER_NAME:e.firstName,ORDER_NUMBER:a.id,ORDER_DATE:u,PRODUCT_NAME:l.name,QUANTITY:(null===(s=null===(n=null==c?void 0:c.orderItems)||void 0===n?void 0:n[0])||void 0===s?void 0:s.quantity)||1,PRODUCT_PRICE:l.price.toString(),PRODUCT_CURRENCY:l.currency,SUBTOTAL:m.toFixed(2),SHIPPING_COST:E.toFixed(2),TAX_AMOUNT:T.toFixed(2),ORDER_TOTAL:y.toFixed(2),ORDER_STATUS:a.status,PRODUCT_TYPE:l.type};try{await exports.emailQueue.add({emailData:v,emailType:"OrderConfirmation"});null===(r=null==i?void 0:i.success)||void 0===r||r.call(i,"Order confirmation email queued successfully")}catch(e){null===(d=null==i?void 0:i.fail)||void 0===d||d.call(i,e.message);throw e}}async function sendEmailToTargetWithTemplate(e,a,l,i){var t,o,n;null===(t=null==i?void 0:i.step)||void 0===t||t.call(i,`Sending email to ${e}`);const s={to:e,subject:a,html:l},r=APP_EMAILER;try{await(0,mailer_1.sendEmailWithProvider)(r,s);null===(o=null==i?void 0:i.success)||void 0===o||o.call(i,`Email sent successfully to ${e}`)}catch(e){null===(n=null==i?void 0:i.fail)||void 0===n||n.call(i,e.message);throw e}}async function sendKycEmail(e,a,l,i){var t,o,n;null===(t=null==i?void 0:i.step)||void 0===t||t.call(i,`Queueing KYC email to ${e.email}`);const s="KycSubmission"===l?"CREATED_AT":"UPDATED_AT",r="KycSubmission"===l?new Date(a.createdAt).toISOString():new Date(a.updatedAt).toISOString(),d={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,[s]:r,LEVEL:a.level,STATUS:a.status};"KycRejected"===l&&a.adminNotes&&(d.MESSAGE=a.adminNotes);try{await exports.emailQueue.add({emailData:d,emailType:l});null===(o=null==i?void 0:i.success)||void 0===o||o.call(i,"KYC email queued successfully")}catch(e){null===(n=null==i?void 0:i.fail)||void 0===n||n.call(i,e.message);throw e}}async function sendForexTransactionEmail(e,a,l,i,t,o){var n,s,r;null===(n=null==o?void 0:o.step)||void 0===n||n.call(o,`Queueing forex transaction email to ${e.email}`);const d={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,ACCOUNT_ID:l.accountId,TRANSACTION_ID:a.id,AMOUNT:a.amount.toString(),CURRENCY:i,STATUS:a.status};let u="";"FOREX_DEPOSIT"===t?u="ForexDepositConfirmation":"FOREX_WITHDRAW"===t&&(u="ForexWithdrawalConfirmation");try{await exports.emailQueue.add({emailData:d,emailType:u});null===(s=null==o?void 0:o.success)||void 0===s||s.call(o,"Forex transaction email queued successfully")}catch(e){null===(r=null==o?void 0:o.fail)||void 0===r||r.call(o,e.message);throw e}}async function sendCopyTradingLeaderApplicationEmail(e,a,l){var i,t,o;null===(i=null==l?void 0:l.step)||void 0===i||i.call(l,`Queueing copy trading leader application email to ${e.email}`);const n={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,DISPLAY_NAME:a.displayName,CREATED_AT:(0,date_fns_1.format)(new Date(a.createdAt),"MMMM do, yyyy 'at' hh:mm a")};try{await exports.emailQueue.add({emailData:n,emailType:"CopyTradingLeaderApplicationSubmitted"});null===(t=null==l?void 0:l.success)||void 0===t||t.call(l,"Copy trading leader application email queued successfully")}catch(e){null===(o=null==l?void 0:l.fail)||void 0===o||o.call(l,e.message);console_1.logger.error("EMAIL","Failed to queue copy trading leader application email",e)}}async function sendCopyTradingLeaderApprovedEmail(e,a){var l,i,t;null===(l=null==a?void 0:a.step)||void 0===l||l.call(a,`Queueing copy trading leader approval email to ${e.email}`);const o={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,URL:process.env.NEXT_PUBLIC_SITE_URL||"https://yoursite.com"};try{await exports.emailQueue.add({emailData:o,emailType:"CopyTradingLeaderApplicationApproved"});null===(i=null==a?void 0:a.success)||void 0===i||i.call(a,"Copy trading leader approval email queued successfully")}catch(e){null===(t=null==a?void 0:a.fail)||void 0===t||t.call(a,e.message);console_1.logger.error("EMAIL","Failed to queue copy trading leader approval email",e)}}async function sendCopyTradingLeaderRejectedEmail(e,a,l){var i,t,o;null===(i=null==l?void 0:l.step)||void 0===i||i.call(l,`Queueing copy trading leader rejection email to ${e.email}`);const n={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,REJECTION_REASON:a};try{await exports.emailQueue.add({emailData:n,emailType:"CopyTradingLeaderApplicationRejected"});null===(t=null==l?void 0:l.success)||void 0===t||t.call(l,"Copy trading leader rejection email queued successfully")}catch(e){null===(o=null==l?void 0:l.fail)||void 0===o||o.call(l,e.message);console_1.logger.error("EMAIL","Failed to queue copy trading leader rejection email",e)}}async function sendCopyTradingLeaderSuspendedEmail(e,a,l){var i,t,o;null===(i=null==l?void 0:l.step)||void 0===i||i.call(l,`Queueing copy trading leader suspension email to ${e.email}`);const n={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,SUSPENSION_REASON:a};try{await exports.emailQueue.add({emailData:n,emailType:"CopyTradingLeaderSuspended"});null===(t=null==l?void 0:l.success)||void 0===t||t.call(l,"Copy trading leader suspension email queued successfully")}catch(e){null===(o=null==l?void 0:l.fail)||void 0===o||o.call(l,e.message);console_1.logger.error("EMAIL","Failed to queue copy trading leader suspension email",e)}}async function sendCopyTradingNewFollowerEmail(e,a,l,i){var t,o,n;null===(t=null==i?void 0:i.step)||void 0===t||t.call(i,`Queueing new follower email to ${e.email}`);const s={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,FOLLOWER_NAME:`${l.firstName} ${l.lastName}`,COPY_MODE:a.copyMode,STARTED_AT:(0,date_fns_1.format)(new Date(a.createdAt),"MMMM do, yyyy 'at' hh:mm a"),URL:process.env.NEXT_PUBLIC_SITE_URL||"https://yoursite.com"};try{await exports.emailQueue.add({emailData:s,emailType:"CopyTradingLeaderNewFollower"});null===(o=null==i?void 0:i.success)||void 0===o||o.call(i,"New follower email queued successfully")}catch(e){null===(n=null==i?void 0:i.fail)||void 0===n||n.call(i,e.message);console_1.logger.error("EMAIL","Failed to queue new follower email",e)}}async function sendCopyTradingFollowerStoppedEmail(e,a,l,i){var t,o,n;null===(t=null==i?void 0:i.step)||void 0===t||t.call(i,`Queueing follower stopped email to ${e.email}`);const s=new Date(a.createdAt),r=new Date,d=Math.floor((r.getTime()-s.getTime())/864e5),u={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,FOLLOWER_NAME:`${l.firstName} ${l.lastName}`,STOPPED_AT:(0,date_fns_1.format)(r,"MMMM do, yyyy 'at' hh:mm a"),DAYS_FOLLOWED:d.toString(),URL:process.env.NEXT_PUBLIC_SITE_URL||"https://yoursite.com"};try{await exports.emailQueue.add({emailData:u,emailType:"CopyTradingLeaderFollowerStopped"});null===(o=null==i?void 0:i.success)||void 0===o||o.call(i,"Follower stopped email queued successfully")}catch(e){null===(n=null==i?void 0:i.fail)||void 0===n||n.call(i,e.message);console_1.logger.error("EMAIL","Failed to queue follower stopped email",e)}}async function sendCopyTradingSubscriptionStartedEmail(e,a,l,i){var t,o,n,s,r,d;null===(t=null==i?void 0:i.step)||void 0===t||t.call(i,`Queueing subscription started email to ${e.email}`);const u={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,LEADER_NAME:l.displayName,RISK_LEVEL:l.riskLevel||"Medium",TRADING_STYLE:l.tradingStyle||"Balanced",WIN_RATE:(null===(o=l.winRate)||void 0===o?void 0:o.toString())||"N/A",COPY_MODE:a.copyMode,MAX_DAILY_LOSS:(null===(n=a.maxDailyLoss)||void 0===n?void 0:n.toString())||"Not Set",MAX_POSITION_SIZE:(null===(s=a.maxPositionSize)||void 0===s?void 0:s.toString())||"Not Set",URL:process.env.NEXT_PUBLIC_SITE_URL||"https://yoursite.com"};try{await exports.emailQueue.add({emailData:u,emailType:"CopyTradingFollowerSubscriptionStarted"});null===(r=null==i?void 0:i.success)||void 0===r||r.call(i,"Subscription started email queued successfully")}catch(e){null===(d=null==i?void 0:i.fail)||void 0===d||d.call(i,e.message);console_1.logger.error("EMAIL","Failed to queue subscription started email",e)}}async function sendCopyTradingSubscriptionPausedEmail(e,a,l,i){var t,o,n;null===(t=null==i?void 0:i.step)||void 0===t||t.call(i,`Queueing subscription paused email to ${e.email}`);const s={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,LEADER_NAME:a,PAUSE_REASON:l,URL:process.env.NEXT_PUBLIC_SITE_URL||"https://yoursite.com"};try{await exports.emailQueue.add({emailData:s,emailType:"CopyTradingFollowerSubscriptionPaused"});null===(o=null==i?void 0:i.success)||void 0===o||o.call(i,"Subscription paused email queued successfully")}catch(e){null===(n=null==i?void 0:i.fail)||void 0===n||n.call(i,e.message);console_1.logger.error("EMAIL","Failed to queue subscription paused email",e)}}async function sendCopyTradingSubscriptionResumedEmail(e,a,l,i){var t,o,n;null===(t=null==i?void 0:i.step)||void 0===t||t.call(i,`Queueing subscription resumed email to ${e.email}`);const s={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,LEADER_NAME:a,COPY_MODE:l,URL:process.env.NEXT_PUBLIC_SITE_URL||"https://yoursite.com"};try{await exports.emailQueue.add({emailData:s,emailType:"CopyTradingFollowerSubscriptionResumed"});null===(o=null==i?void 0:i.success)||void 0===o||o.call(i,"Subscription resumed email queued successfully")}catch(e){null===(n=null==i?void 0:i.fail)||void 0===n||n.call(i,e.message);console_1.logger.error("EMAIL","Failed to queue subscription resumed email",e)}}async function sendCopyTradingSubscriptionStoppedEmail(e,a,l,i){var t,o,n;null===(t=null==i?void 0:i.step)||void 0===t||t.call(i,`Queueing subscription stopped email to ${e.email}`);const s={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,LEADER_NAME:a,TOTAL_TRADES:l.totalTrades.toString(),WIN_RATE:l.winRate.toFixed(2),TOTAL_PROFIT:l.totalProfit.toFixed(2),ROI:l.roi.toFixed(2),URL:process.env.NEXT_PUBLIC_SITE_URL||"https://yoursite.com"};try{await exports.emailQueue.add({emailData:s,emailType:"CopyTradingFollowerSubscriptionStopped"});null===(o=null==i?void 0:i.success)||void 0===o||o.call(i,"Subscription stopped email queued successfully")}catch(e){null===(n=null==i?void 0:i.fail)||void 0===n||n.call(i,e.message);console_1.logger.error("EMAIL","Failed to queue subscription stopped email",e)}}async function sendCopyTradingTradeProfitEmail(e,a,l,i){var t,o,n;null===(t=null==i?void 0:i.step)||void 0===t||t.call(i,`Queueing trade profit email to ${e.email}`);const s={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,LEADER_NAME:a,SYMBOL:l.symbol,SIDE:l.side,ENTRY_PRICE:l.entryPrice.toString(),EXIT_PRICE:l.exitPrice.toString(),PROFIT:l.profit.toFixed(2),YOUR_PROFIT:l.yourProfit.toFixed(2),PROFIT_SHARE_PERCENT:l.profitSharePercent.toString(),LEADER_PROFIT_SHARE:l.leaderProfitShare.toFixed(2),URL:process.env.NEXT_PUBLIC_SITE_URL||"https://yoursite.com"};try{await exports.emailQueue.add({emailData:s,emailType:"CopyTradingTradeProfit"});null===(o=null==i?void 0:i.success)||void 0===o||o.call(i,"Trade profit email queued successfully")}catch(e){null===(n=null==i?void 0:i.fail)||void 0===n||n.call(i,e.message);console_1.logger.error("EMAIL","Failed to queue trade profit email",e)}}async function sendCopyTradingTradeLossEmail(e,a,l,i,t){var o,n,s;null===(o=null==t?void 0:t.step)||void 0===o||o.call(t,`Queueing trade loss email to ${e.email}`);const r={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,LEADER_NAME:a,SYMBOL:i.symbol,SIDE:i.side,ENTRY_PRICE:i.entryPrice.toString(),EXIT_PRICE:i.exitPrice.toString(),LOSS:i.loss.toFixed(2),SUBSCRIPTION_ID:l,URL:process.env.NEXT_PUBLIC_SITE_URL||"https://yoursite.com"};try{await exports.emailQueue.add({emailData:r,emailType:"CopyTradingTradeLoss"});null===(n=null==t?void 0:t.success)||void 0===n||n.call(t,"Trade loss email queued successfully")}catch(e){null===(s=null==t?void 0:t.fail)||void 0===s||s.call(t,e.message);console_1.logger.error("EMAIL","Failed to queue trade loss email",e)}}async function sendCopyTradingDailyLossLimitEmail(e,a,l,i,t){var o,n,s;null===(o=null==t?void 0:t.step)||void 0===o||o.call(t,`Queueing daily loss limit email to ${e.email}`);const r={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,LEADER_NAME:a,DAILY_LOSS_LIMIT:l.toFixed(2),CURRENT_LOSS:i.toFixed(2),URL:process.env.NEXT_PUBLIC_SITE_URL||"https://yoursite.com"};try{await exports.emailQueue.add({emailData:r,emailType:"CopyTradingDailyLossLimitReached"});null===(n=null==t?void 0:t.success)||void 0===n||n.call(t,"Daily loss limit email queued successfully")}catch(e){null===(s=null==t?void 0:t.fail)||void 0===s||s.call(t,e.message);console_1.logger.error("EMAIL","Failed to queue daily loss limit email",e)}}async function sendCopyTradingInsufficientBalanceEmail(e,a,l,i,t,o,n){var s,r,d;null===(s=null==n?void 0:n.step)||void 0===s||s.call(n,`Queueing insufficient balance email to ${e.email}`);const u={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,LEADER_NAME:a,SYMBOL:i,REQUIRED_AMOUNT:t.toFixed(2),AVAILABLE_BALANCE:o.toFixed(2),SUBSCRIPTION_ID:l,URL:process.env.NEXT_PUBLIC_SITE_URL||"https://yoursite.com"};try{await exports.emailQueue.add({emailData:u,emailType:"CopyTradingInsufficientBalance"});null===(r=null==n?void 0:n.success)||void 0===r||r.call(n,"Insufficient balance email queued successfully")}catch(e){null===(d=null==n?void 0:n.fail)||void 0===d||d.call(n,e.message);console_1.logger.error("EMAIL","Failed to queue insufficient balance email",e)}}async function sendCopyTradingProfitShareEarnedEmail(e,a,l,i,t,o,n){var s,r,d;null===(s=null==n?void 0:n.step)||void 0===s||s.call(n,`Queueing profit share earned email to ${e.email}`);const u={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,FOLLOWER_NAME:a,SYMBOL:l,FOLLOWER_PROFIT:i.toFixed(2),PROFIT_SHARE_PERCENT:t.toString(),PROFIT_SHARE_AMOUNT:o.toFixed(2),URL:process.env.NEXT_PUBLIC_SITE_URL||"https://yoursite.com"};try{await exports.emailQueue.add({emailData:u,emailType:"CopyTradingProfitShareEarned"});null===(r=null==n?void 0:n.success)||void 0===r||r.call(n,"Profit share earned email queued successfully")}catch(e){null===(d=null==n?void 0:n.fail)||void 0===d||d.call(n,e.message);console_1.logger.error("EMAIL","Failed to queue profit share earned email",e)}}async function sendCopyTradingProfitSharePaidEmail(e,a,l,i,t,o,n,s){var r,d,u;null===(r=null==s?void 0:s.step)||void 0===r||r.call(s,`Queueing profit share paid email to ${e.email}`);const c={TO:e.email,USER_ID:e.id,FIRSTNAME:e.firstName,LEADER_NAME:a,SYMBOL:l,YOUR_PROFIT:i.toFixed(2),PROFIT_SHARE_PERCENT:t.toString(),PROFIT_SHARE_AMOUNT:o.toFixed(2),NET_PROFIT:n.toFixed(2),URL:process.env.NEXT_PUBLIC_SITE_URL||"https://yoursite.com"};try{await exports.emailQueue.add({emailData:c,emailType:"CopyTradingProfitSharePaid"});null===(d=null==s?void 0:s.success)||void 0===d||d.call(s,"Profit share paid email queued successfully")}catch(e){null===(u=null==s?void 0:s.fail)||void 0===u||u.call(s,e.message);console_1.logger.error("EMAIL","Failed to queue profit share paid email",e)}}var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});exports.emailQueue=void 0;exports.sendEmail=sendEmail;exports.sendChatEmail=sendChatEmail;exports.sendFiatTransactionEmail=sendFiatTransactionEmail;exports.sendBinaryOrderEmail=sendBinaryOrderEmail;exports.sendWalletBalanceUpdateEmail=sendWalletBalanceUpdateEmail;exports.sendTransactionStatusUpdateEmail=sendTransactionStatusUpdateEmail;exports.sendAuthorStatusUpdateEmail=sendAuthorStatusUpdateEmail;exports.sendOutgoingTransferEmail=sendOutgoingTransferEmail;exports.sendIncomingTransferEmail=sendIncomingTransferEmail;exports.sendSpotWalletWithdrawalConfirmationEmail=sendSpotWalletWithdrawalConfirmationEmail;exports.sendSpotWalletDepositConfirmationEmail=sendSpotWalletDepositConfirmationEmail;exports.sendAiInvestmentEmail=sendAiInvestmentEmail;exports.sendInvestmentEmail=sendInvestmentEmail;exports.sendIcoContributionEmail=sendIcoContributionEmail;exports.sendStakingInitiationEmail=sendStakingInitiationEmail;exports.sendStakingRewardEmail=sendStakingRewardEmail;exports.sendOrderConfirmationEmail=sendOrderConfirmationEmail;exports.sendEmailToTargetWithTemplate=sendEmailToTargetWithTemplate;exports.sendKycEmail=sendKycEmail;exports.sendForexTransactionEmail=sendForexTransactionEmail;exports.sendCopyTradingLeaderApplicationEmail=sendCopyTradingLeaderApplicationEmail;exports.sendCopyTradingLeaderApprovedEmail=sendCopyTradingLeaderApprovedEmail;exports.sendCopyTradingLeaderRejectedEmail=sendCopyTradingLeaderRejectedEmail;exports.sendCopyTradingLeaderSuspendedEmail=sendCopyTradingLeaderSuspendedEmail;exports.sendCopyTradingNewFollowerEmail=sendCopyTradingNewFollowerEmail;exports.sendCopyTradingFollowerStoppedEmail=sendCopyTradingFollowerStoppedEmail;exports.sendCopyTradingSubscriptionStartedEmail=sendCopyTradingSubscriptionStartedEmail;exports.sendCopyTradingSubscriptionPausedEmail=sendCopyTradingSubscriptionPausedEmail;exports.sendCopyTradingSubscriptionResumedEmail=sendCopyTradingSubscriptionResumedEmail;exports.sendCopyTradingSubscriptionStoppedEmail=sendCopyTradingSubscriptionStoppedEmail;exports.sendCopyTradingTradeProfitEmail=sendCopyTradingTradeProfitEmail;exports.sendCopyTradingTradeLossEmail=sendCopyTradingTradeLossEmail;exports.sendCopyTradingDailyLossLimitEmail=sendCopyTradingDailyLossLimitEmail;exports.sendCopyTradingInsufficientBalanceEmail=sendCopyTradingInsufficientBalanceEmail;exports.sendCopyTradingProfitShareEarnedEmail=sendCopyTradingProfitShareEarnedEmail;exports.sendCopyTradingProfitSharePaidEmail=sendCopyTradingProfitSharePaidEmail;const bull_1=__importDefault(require("bull")),mailer_1=require("./mailer"),date_fns_1=require("date-fns"),db_1=require("@b/db"),console_1=require("@b/utils/console"),token_1=require("@b/utils/token"),APP_EMAILER=process.env.APP_EMAILER||"nodemailer-service";exports.emailQueue=new bull_1.default("emailQueue",{redis:{host:"127.0.0.1",port:6379}});exports.emailQueue.process(async e=>{const{emailData:a,emailType:l}=e.data;try{await sendEmail(a,l);console_1.logger.debug("EMAIL",`Email sent: ${l}`)}catch(e){console_1.logger.error("EMAIL",`Failed to send email: ${l}`,e);throw e}});