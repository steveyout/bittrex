"use strict";function extractAggregations(e,t){const a=[];t.forEach(e=>{e.aggregation&&e.aggregation.field&&e.aggregation.value&&a.push({alias:e.metric,field:String(e.aggregation.field),value:String(e.aggregation.value)})});e.forEach(e=>{if("pie"===e.type&&e.config&&e.config.field&&e.config.status){const t=String(e.config.field);e.config.status.forEach(e=>{a.push({alias:String(e.value),field:t,value:String(e.value)})})}});const r=new Map;a.forEach(e=>{const t=`${e.alias}:${e.field}:${e.value}`;r.set(t,e)});return Array.from(r.values())}function escapeValue(e){if(null==e)return"''";return"'"+String(e).replace(/'/g,"''")+"'"}async function fetchRowsForInterval(e,t,a,r,n,s={}){const o={createdAt:{[sequelize_1.Op.between]:[t,a]},...s},l="hour"===r?"%Y-%m-%d %H:00:00":"%Y-%m-%d 00:00:00",i=[[sequelize_1.Sequelize.fn("DATE_FORMAT",sequelize_1.Sequelize.col("createdAt"),l),"dateGroup"],[sequelize_1.Sequelize.fn("COUNT","*"),"total"]];n.forEach(e=>{const t="CASE WHEN "+String(e.field)+" = "+escapeValue(String(e.value))+" THEN 1 ELSE 0 END";i.push([sequelize_1.Sequelize.fn("SUM",sequelize_1.Sequelize.literal(t)),e.alias])});return(await e.findAll({where:o,attributes:i,group:["dateGroup"],raw:!0})).map(e=>{const t={date:new Date(e.dateGroup),total:Number(e.total)||0};n.forEach(a=>{t[a.alias]=Number(e[a.alias])||0});return t}).sort((e,t)=>e.date.getTime()-t.date.getTime())}function generateTimeSeries(e,t,a,r,n){const s=[];if("24h"===e){const e=(0,date_fns_1.startOfDay)(a);for(let t=0;t<24;t++){const a={date:(0,date_fns_1.addHours)(e,t),total:0};n.forEach(e=>{a[e.alias]=0});s.push(a)}}else if("7d"===e){const e=(0,date_fns_1.startOfWeek)(a);for(let t=0;t<7;t++){const a={date:(0,date_fns_1.addDays)(e,t),total:0};n.forEach(e=>{a[e.alias]=0});s.push(a)}}else if("30d"===e){const e=(0,date_fns_1.startOfMonth)(a);for(let t=0;t<30;t++){const a={date:(0,date_fns_1.addDays)(e,t),total:0};n.forEach(e=>{a[e.alias]=0});s.push(a)}}else if("3m"===e){const e=(0,date_fns_1.startOfMonth)((0,date_fns_1.subMonths)(a,2));let t=(0,date_fns_1.startOfWeek)(e);const r=(0,date_fns_1.endOfMonth)(a);for(;t<=r;){const e={date:t,total:0};n.forEach(t=>{e[t.alias]=0});s.push(e);t=(0,date_fns_1.addWeeks)(t,1)}}else if("6m"===e){const e=a.getFullYear();if(a.getMonth()<6)for(let t=0;t<6;t++){const a={date:new Date(e,t,1),total:0};n.forEach(e=>{a[e.alias]=0});s.push(a)}else for(let t=6;t<12;t++){const a={date:new Date(e,t,1),total:0};n.forEach(e=>{a[e.alias]=0});s.push(a)}}else if("y"===e||"1y"===e){const e=a.getFullYear();for(let t=0;t<12;t++){const a={date:new Date(e,t,1),total:0};n.forEach(e=>{a[e.alias]=0});s.push(a)}}return s}function aggregateDataByPeriod(e,t){if("hour"===t||"day"===t)return e;const a=[];if(!e.length)return a;let r=(0,date_fns_1.startOfWeek)(e[0].date);const n=e[e.length-1].date;for(;r<=n;){const t=(0,date_fns_1.endOfWeek)(r),n=e.filter(e=>e.date>=r&&e.date<=t);if(n.length){const e={date:new Date(r),total:0};Object.keys(n[0]).filter(e=>"date"!==e).forEach(t=>{e[t]=n.reduce((e,a)=>e+(Number(a[t])||0),0)});a.push(e)}r=(0,date_fns_1.addDays)(r,7)}return a}async function getChartData({model:e,timeframe:t,charts:a,kpis:r,where:n={}}){const s=new Date;let o,l,i,f;switch(t){case"24h":o=(0,date_fns_1.startOfDay)(s);l="hour";i="hour";break;case"7d":o=(0,date_fns_1.startOfWeek)(s);l="day";i="day";break;case"30d":o=(0,date_fns_1.startOfMonth)(s);l="day";i="day";break;case"3m":o=(0,date_fns_1.startOfMonth)((0,date_fns_1.subMonths)(s,2));l="day";i="week";break;case"6m":o=s.getMonth()<6?new Date(s.getFullYear(),0,1):new Date(s.getFullYear(),6,1);l="day";i="month";break;default:o=new Date(s.getFullYear(),0,1);l="day";i="month"}switch(t){case"24h":f=(0,date_fns_1.endOfDay)(s);break;case"7d":f=(0,date_fns_1.endOfWeek)(s);break;case"30d":case"3m":f=(0,date_fns_1.endOfMonth)(s);break;case"6m":f=s.getMonth()<6?new Date(s.getFullYear(),6,0):new Date(s.getFullYear(),12,0);break;case"y":case"1y":f=new Date(s.getFullYear(),12,0);break;default:f=s}const d=extractAggregations(a,r),c=await fetchRowsForInterval(e,o,f,l,d,n);let u=[];if("month"===i){const e=f.getFullYear(),t=[];for(let a=0;a<12;a++){const r={date:new Date(e,a,1),total:0};d.forEach(e=>{r[e.alias]=0});t.push(r)}c.forEach(e=>{const a=(0,date_fns_1.format)(new Date(e.date),"yyyy-MM"),r=t.find(e=>(0,date_fns_1.format)(e.date,"yyyy-MM")===a);if(r){r.total+=Number(e.total)||0;d.forEach(t=>{r[t.alias]+=Number(e[t.alias])||0})}});u=t}else{const e=generateTimeSeries(t,o,f,l,d),a=new Map(e.map(e=>[formatKey(e.date,l),e]));c.forEach(e=>{const t=formatKey(new Date(e.date),l);if(a.has(t)){const r=a.get(t);r.total=Number(e.total)||0;d.forEach(t=>{r[t.alias]=Number(e[t.alias])||0})}});u=Array.from(a.values())}const h={kpis:[]},g=u.filter(e=>e.total>0),_=g.length?g[g.length-1]:u[u.length-1];r.forEach(e=>{if(!u.length){h.kpis.push({id:e.id,title:e.title,value:0,change:0,trend:[],icon:e.icon});return}const t=Number(_[e.metric]||0),a=u.length>1?Number(u[u.length-2][e.metric]||0):t;let r=0;r=0===a?0===t?0:100:(t-a)/a*100;let n=Math.round(100*r)/100;Number.isFinite(n)||(n=r===1/0?100:r===-1/0?-100:0);const s=u.map(t=>({date:t.date.toISOString(),value:Number(t[e.metric]||0)}));h.kpis.push({id:e.id,title:e.title,value:t,change:n,trend:s,icon:e.icon})});a.forEach(e=>{var t,a;"pie"===e.type?h[e.id]=(null===(a=null===(t=e.config)||void 0===t?void 0:t.status)||void 0===a?void 0:a.map(e=>{const t=u.reduce((t,a)=>t+(Number(a[String(e.value)])||0),0);return{id:String(e.value),name:e.label,value:t,color:e.color}}))||[]:h[e.id]=u.map(t=>{const a={date:t.date.toISOString()};e.metrics.forEach(e=>{var r;a[e]=null!==(r=t[e])&&void 0!==r?r:0});return a})});return h}Object.defineProperty(exports,"__esModule",{value:!0});exports.getChartData=getChartData;const sequelize_1=require("sequelize"),date_fns_1=require("date-fns"),formatKey=(e,t)=>"hour"===t?(0,date_fns_1.format)(e,"yyyy-MM-dd HH:00:00"):"day"===t?(0,date_fns_1.format)(e,"yyyy-MM-dd"):e.toISOString();