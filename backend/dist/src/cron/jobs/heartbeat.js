"use strict";async function fetchPublicIp(){const e=Date.now();if(cachedPublicIp&&lastIpFetch&&e-lastIpFetch<6e4)return cachedPublicIp;try{const t=await new Promise((e,t)=>{https_1.default.get("https://api.ipify.org?format=json",r=>{let o="";r.on("data",e=>{o+=e});r.on("end",()=>{try{const t=JSON.parse(o);e(t.ip)}catch(e){t(new Error("Failed to parse IP response"))}});r.on("error",t)}).on("error",t)});cachedPublicIp=t;lastIpFetch=e;return t}catch(e){return"127.0.0.1"}}async function resetChartEngineSettings(){var e;try{let t=!1;const r=await db_1.models.settings.findOne({where:{key:"binarySettings"}});if(null==r?void 0:r.value)try{const o=JSON.parse(r.value);if("CHART_ENGINE"===(null===(e=o.display)||void 0===e?void 0:e.chartType)){o.display.chartType="TRADINGVIEW";o._lastModified=(new Date).toISOString();await db_1.models.settings.update({value:JSON.stringify(o)},{where:{key:"binarySettings"}});console_1.logger.groupItem("HEARTBEAT","Binary chart type reset to TradingView","warn");t=!0}}catch(e){}const o=await db_1.models.settings.findOne({where:{key:"spotChartEngine"}});if("CHART_ENGINE"===(null==o?void 0:o.value)){await db_1.models.settings.update({value:"TRADINGVIEW"},{where:{key:"spotChartEngine"}});console_1.logger.groupItem("HEARTBEAT","Spot chart engine reset to TradingView","warn");t=!0}if(t)try{const{CacheManager:e}=await Promise.resolve().then(()=>__importStar(require("@b/utils/cache"))),t=e.getInstance();await t.clearCache();console_1.logger.groupItem("HEARTBEAT","Settings cache cleared","info")}catch(e){}}catch(e){console_1.logger.groupItem("HEARTBEAT",`Failed to reset chart engine settings: ${e.message}`,"error")}}async function getPurchaseCode(e){try{const t=process.cwd(),r=t.endsWith("backend")||t.endsWith("backend/")||t.endsWith("backend\\")?path_1.default.dirname(t):t,o=path_1.default.join(r,"lic",`${e}.lic`),n=(await promises_1.default.readFile(o,"utf-8")).trim();try{const e=Buffer.from(n,"base64").toString("utf-8"),t=JSON.parse(e);if(t.purchaseCode)return t.purchaseCode;if(t.licenseKey)return t.licenseKey}catch(e){if(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(n))return n}return null}catch(e){return null}}async function getActivatedProducts(){const e=[],t=process.env.MAIN_PRODUCT_ID||"35599184",r=await getPurchaseCode(t);r&&e.push({productId:t,purchaseCode:r,name:"Bicrypto",type:"core"});try{if(db_1.models.extension){const t=await db_1.models.extension.findAll({where:{productId:{[require("sequelize").Op.not]:null}},attributes:["productId","name","title"]});for(const r of t)if(r.productId){const t=await getPurchaseCode(r.productId);t&&e.push({productId:r.productId,purchaseCode:t,name:r.title||r.name,type:"extension"})}}if(db_1.models.ecosystemBlockchain){const t=await db_1.models.ecosystemBlockchain.findAll({where:{productId:{[require("sequelize").Op.not]:null}},attributes:["productId","name","chain"]});for(const r of t)if(r.productId){const t=await getPurchaseCode(r.productId);t&&e.push({productId:r.productId,purchaseCode:t,name:r.name||r.chain,type:"blockchain"})}}if(db_1.models.exchange){const t=await db_1.models.exchange.findAll({where:{productId:{[require("sequelize").Op.not]:null}},attributes:["productId","name","title"]});for(const r of t)if(r.productId){const t=await getPurchaseCode(r.productId);t&&e.push({productId:r.productId,purchaseCode:t,name:r.title||r.name,type:"exchange"})}}}catch(e){console_1.logger.warn("HEARTBEAT","Failed to fetch product list from database")}return e}async function sendBatchHeartbeat(e){var t;try{const r=(0,security_1.getCachedFingerprint)(),o=process.env.NEXT_PUBLIC_SITE_URL||process.env.APP_PUBLIC_URL||"localhost";let n;try{n=new URL(o).host}catch(e){n=o.replace(/^https?:\/\//,"").split("/")[0]}const s=await fetchPublicIp(),a=process.cwd(),c=a.endsWith("backend")||a.endsWith("backend/")||a.endsWith("backend\\")?path_1.default.dirname(a):a,i=path_1.default.join(c,"package.json");let u="unknown";try{u=JSON.parse(await promises_1.default.readFile(i,"utf-8")).version||"unknown"}catch(e){}const l={version:u,nodeVersion:process.version,platform:os_1.default.platform(),arch:os_1.default.arch(),uptime:process.uptime(),timestamp:(new Date).toISOString(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone},d=new AbortController,p=setTimeout(()=>d.abort(),3e4),g=await fetch("https://updates.mashdiv.com/api/client/licenses/heartbeat/batch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({products:e.map(e=>({productId:e.productId,purchaseCode:e.purchaseCode})),fingerprint:r,domain:n,ipAddress:s,metadata:l}),signal:d.signal});clearTimeout(p);if(!g.ok)throw(0,error_1.createError)({statusCode:500,message:`Server returned ${g.status}`});const h=await g.json();return{success:null===(t=h.success)||void 0===t||t,results:h.results||[],totalSuccess:h.total_success||0,totalFailed:h.total_failed||0}}catch(t){return{success:!1,results:[],totalSuccess:0,totalFailed:e.length}}}async function processLicenseHeartbeat(){var e;if((0,security_1.getSecurityStatus)().initialized){console_1.logger.group("HEARTBEAT","Processing license heartbeats...");try{const t=await getActivatedProducts();if(0===t.length){console_1.logger.groupItem("HEARTBEAT","No activated products found");console_1.logger.groupEnd("HEARTBEAT","No heartbeats to send",!0);return}const r=new Map;for(const e of t)r.set(e.productId,e);const o=await sendBatchHeartbeat(t);if(!o.success&&0===o.results.length){console_1.logger.groupItem("HEARTBEAT","Batch endpoint unavailable, skipping heartbeat","warn");console_1.logger.groupEnd("HEARTBEAT","Heartbeat skipped",!1);return}let n=0,s=0;const a="61200000";for(const t of o.results){const o=r.get(t.product_id),c=(null==o?void 0:o.name)||t.product_id,i=(null===(e=null==o?void 0:o.type)||void 0===e?void 0:e.toUpperCase())||"UNKNOWN";if(t.success){n++;console_1.logger.groupItem("HEARTBEAT",`[${i}] ${c}: OK`)}else{s++;const e=t.status||"unknown";if("not_activated"===e)console_1.logger.groupItem("HEARTBEAT",`[${i}] ${c}: Not activated`,"warn");else if("revoked"===e){console_1.logger.groupItem("HEARTBEAT",`[${i}] ${c}: License revoked`,"error");t.product_id===a&&await resetChartEngineSettings()}else if("expired"===e){console_1.logger.groupItem("HEARTBEAT",`[${i}] ${c}: License expired`,"error");t.product_id===a&&await resetChartEngineSettings()}else"not_found"===e?console_1.logger.groupItem("HEARTBEAT",`[${i}] ${c}: License not found`,"warn"):console_1.logger.groupItem("HEARTBEAT",`[${i}] ${c}: ${t.message||e}`,"warn")}}const c=(0,security_1.getSecurityLevel)();console_1.logger.groupItem("HEARTBEAT",`Security level: ${c}`);console_1.logger.groupItem("HEARTBEAT",`Products: ${n} OK, ${s} failed`);console_1.logger.groupEnd("HEARTBEAT",`Batch heartbeat completed (${t.length} products)`,0===s)}catch(e){console_1.logger.groupItem("HEARTBEAT",`Error: ${e.message}`,"error");console_1.logger.groupEnd("HEARTBEAT","Heartbeat failed",!1);throw e}}}var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}});Object.defineProperty(e,o,n)}:function(e,t,r,o){void 0===o&&(o=r);e[o]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var e=function(t){e=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t};return e(t)};return function(t){if(t&&t.__esModule)return t;var r={};if(null!=t)for(var o=e(t),n=0;n<o.length;n++)"default"!==o[n]&&__createBinding(r,t,o[n]);__setModuleDefault(r,t);return r}}(),__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});exports.processLicenseHeartbeat=processLicenseHeartbeat;const security_1=require("@b/utils/security"),console_1=require("@b/utils/console"),db_1=require("@b/db"),promises_1=__importDefault(require("fs/promises")),path_1=__importDefault(require("path")),os_1=__importDefault(require("os")),https_1=__importDefault(require("https")),error_1=require("@b/utils/error");let cachedPublicIp=null,lastIpFetch=0;const IP_CACHE_DURATION=6e4;