'use strict';function _0x309a(_0x3ad23a,_0x14c1a1){_0x3ad23a=_0x3ad23a-0x191;const _0x99d43b=_0x99d4();let _0x309a67=_0x99d43b[_0x3ad23a];return _0x309a67;}const _0x1257cf=_0x309a;(function(_0x3257d2,_0x59d2ba){const _0x403a06=_0x309a,_0x533981=_0x3257d2();while(!![]){try{const _0x160c27=-parseInt(_0x403a06(0x198))/0x1+parseInt(_0x403a06(0x192))/0x2*(parseInt(_0x403a06(0x196))/0x3)+-parseInt(_0x403a06(0x191))/0x4+-parseInt(_0x403a06(0x19e))/0x5+parseInt(_0x403a06(0x19a))/0x6+-parseInt(_0x403a06(0x19c))/0x7*(parseInt(_0x403a06(0x197))/0x8)+parseInt(_0x403a06(0x1a1))/0x9*(parseInt(_0x403a06(0x194))/0xa);if(_0x160c27===_0x59d2ba)break;else _0x533981['push'](_0x533981['shift']());}catch(_0x178eca){_0x533981['push'](_0x533981['shift']());}}}(_0x99d4,0x34024));function getRateLimitKey(_0x3a13aa,_0x25f768,_0x309517){return _0x25f768?_0x3a13aa+':user:'+_0x25f768:_0x3a13aa+':ip:'+(_0x309517||'unknown');}async function checkRateLimit(_0x1d5bc9,_0xb5816a,_0x281b29){const _0x3023c4=_0x309a;try{const _0x2af4bb=redis_1['RedisSingleton'][_0x3023c4(0x19d)](),_0x108ab7=await _0x2af4bb['get'](_0x1d5bc9);if(null!==_0x108ab7&&parseInt(_0x108ab7,0xa)>=_0xb5816a){const _0x579f30=await _0x2af4bb[_0x3023c4(0x1a3)](_0x1d5bc9);return{'allowed':!0x1,'remaining':0x0,'retryAfter':_0x579f30>0x0?_0x579f30:_0x281b29,'headers':{'Retry-After':(_0x579f30>0x0?_0x579f30:_0x281b29)['toString'](),'X-RateLimit-Limit':_0xb5816a[_0x3023c4(0x193)](),'X-RateLimit-Remaining':'0'}};}await _0x2af4bb[_0x3023c4(0x1a2)]()['incr'](_0x1d5bc9)['expire'](_0x1d5bc9,_0x281b29)['exec']();const _0x2937f8=_0xb5816a-(_0x108ab7?parseInt(_0x108ab7,0xa)+0x1:0x1);return{'allowed':!0x0,'remaining':Math['max'](0x0,_0x2937f8)};}catch(_0x205869){return console_1[_0x3023c4(0x199)]['error'](_0x3023c4(0x195),_0x3023c4(0x19b),_0x205869),{'allowed':!0x0,'remaining':_0xb5816a};}}function createRateLimiterFn(_0x1134c5={}){const {limit:_0x378ed1=0x64,window:_0x38a19b=0x3c,keyPrefix:_0x38a098='rateLimit',message:_0x3b0c5d='Rate\x20Limit\x20Exceeded,\x20Try\x20Again\x20Later'}=_0x1134c5;return async _0x48e97b=>{const _0x30ca00=_0x309a;var _0x5c6c1b;const _0x1976f5=null==_0x48e97b?void 0x0:_0x48e97b[_0x30ca00(0x1a0)],_0x18fcd4=(null==_0x48e97b?void 0x0:_0x48e97b['req'])||_0x48e97b,_0x5d1644=(null==_0x18fcd4?void 0x0:_0x18fcd4['ip'])||(null===(_0x5c6c1b=null==_0x18fcd4?void 0x0:_0x18fcd4['connection'])||void 0x0===_0x5c6c1b?void 0x0:_0x5c6c1b['remoteAddress'])||(null==_0x18fcd4?void 0x0:_0x18fcd4[_0x30ca00(0x19f)]),_0x4478ba=getRateLimitKey(_0x38a098,null==_0x1976f5?void 0x0:_0x1976f5['id'],_0x5d1644),_0x393526=await checkRateLimit(_0x4478ba,_0x378ed1,_0x38a19b);if(!_0x393526[_0x30ca00(0x1a4)])throw{'statusCode':0x1ad,'message':_0x3b0c5d,'headers':_0x393526['headers']};};}Object['defineProperty'](exports,'__esModule',{'value':!0x0}),exports['getRateLimitKey']=getRateLimitKey,exports['checkRateLimit']=checkRateLimit,exports['createRateLimiterFn']=createRateLimiterFn;const redis_1=require(_0x1257cf(0x1a5)),console_1=require('@b/utils/console');function _0x99d4(){const _0x37e0ac=['Error\x20checking\x20rate\x20limit','83972CsphKD','getInstance','18935nGdLXv','remoteAddress','user','61317qqrOOy','multi','ttl','allowed','../../utils/redis','987084rEPyvl','2ErvHBM','toString','720HcKzzf','RATE_LIMIT','1255329eKzavQ','264mrvXUY','424817xkJqEu','logger','2251752aSdsyp'];_0x99d4=function(){return _0x37e0ac;};return _0x99d4();}