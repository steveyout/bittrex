"use strict";async function getMatchingEngine(){try{return(await Promise.resolve().then(()=>__importStar(require("@b/api/(ext)/ecosystem/utils/matchingEngine")))).MatchingEngine.getInstance()}catch(e){return{getTicker:async()=>({last:0})}}}async function cacheCurrencies(){try{const e=await getCurrencies();await redis.set("currencies",JSON.stringify(e),"EX",300)}catch(e){console_1.logger.error("CURRENCY","Error caching currencies",e)}}async function updateCurrencyRates(e){await db_1.sequelize.transaction(async r=>{const t=Object.keys(e);t.forEach(r=>{const t=e[r];if(!(0,lodash_1.isNumber)(t)||isNaN(t))throw(0,error_1.createError)({statusCode:400,message:`Invalid price for currency ${r}: ${t}`})});const a=t.map(t=>db_1.models.currency.update({price:e[t]},{where:{id:t},transaction:r}));await Promise.all(a)});return(await db_1.models.currency.findAll({where:{id:Object.keys(e)}})).map(e=>e.get({plain:!0}))}async function findCurrencyById(e){const r=await db_1.models.currency.findOne({where:{id:e}});if(!r)throw(0,error_1.createError)({statusCode:404,message:"Currency not found"});return r}async function getCurrencies(){try{const e=await db_1.models.currency.findAll({where:{status:"true"},order:[["id","ASC"]]});return e&&Array.isArray(e)?e.map(e=>e.get({plain:!0})):[]}catch(e){return[]}}var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,t,a){void 0===a&&(a=t);var n=Object.getOwnPropertyDescriptor(r,t);n&&!("get"in n?!r.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return r[t]}});Object.defineProperty(e,a,n)}:function(e,r,t,a){void 0===a&&(a=t);e[a]=r[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(){var e=function(r){e=Object.getOwnPropertyNames||function(e){var r=[];for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(r[r.length]=t);return r};return e(r)};return function(r){if(r&&r.__esModule)return r;var t={};if(null!=r)for(var a=e(r),n=0;n<a.length;n++)"default"!==a[n]&&__createBinding(t,r,a[n]);__setModuleDefault(t,r);return t}}(),__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});exports.getEcoPriceInUSD=exports.getSpotPriceInUSD=exports.getFiatPriceInUSD=exports.baseResponseSchema=exports.baseCurrencySchema=void 0;exports.cacheCurrencies=cacheCurrencies;exports.updateCurrencyRates=updateCurrencyRates;exports.findCurrencyById=findCurrencyById;exports.getCurrencies=getCurrencies;const db_1=require("@b/db"),exchange_1=__importDefault(require("@b/utils/exchange")),utils_1=require("@b/api/exchange/utils"),console_1=require("@b/utils/console"),redis_1=require("@b/utils/redis"),schema_1=require("@b/utils/schema"),lodash_1=require("lodash"),error_1=require("@b/utils/error"),redis=redis_1.RedisSingleton.getInstance();exports.baseCurrencySchema={id:(0,schema_1.baseNumberSchema)("ID of the currency"),name:(0,schema_1.baseStringSchema)("Currency name"),symbol:(0,schema_1.baseStringSchema)("Currency symbol"),precision:(0,schema_1.baseNumberSchema)("Currency precision"),price:(0,schema_1.baseNumberSchema)("Currency price"),status:(0,schema_1.baseBooleanSchema)("Currency status")};exports.baseResponseSchema={status:(0,schema_1.baseBooleanSchema)("Indicates if the request was successful"),statusCode:(0,schema_1.baseNumberSchema)("HTTP status code"),data:(0,schema_1.baseObjectSchema)("Detailed data response")};cacheCurrencies();const getFiatPriceInUSD=async e=>{if("USD"===e)return 1;const r=await db_1.models.currency.findOne({where:{id:e,status:!0}});if(!r)throw(0,error_1.createError)(404,`Currency ${e} not found`);const t=parseFloat(r.price);if(!t||isNaN(t)||t<=0){console_1.logger.warn("CURRENCY",`Invalid price for FIAT currency ${e}, defaulting to 1`);return 1}return t};exports.getFiatPriceInUSD=getFiatPriceInUSD;const getSpotPriceInUSD=async e=>{var r,t,a;if("USDT"===e)return 1;const n=await exchange_1.default.startExchange();if(!n)throw(0,error_1.createError)(503,"Service temporarily unavailable. Please try again later.");try{const r=await(0,utils_1.loadBanStatus)();if(await(0,utils_1.handleBanStatus)(r))throw(0,error_1.createError)(503,"Service temporarily unavailable. Please try again later.");const t=`${e}/USDT`,a=(await n.fetchTicker(t)).last;if(null==a)throw(0,error_1.createError)({statusCode:500,message:"Error fetching ticker data"});return a}catch(n){if(503===n.statusCode)throw n;(null===(r=n.message)||void 0===r?void 0:r.includes("market"))||(null===(t=n.message)||void 0===t?void 0:t.includes("symbol"))||(null===(a=n.message)||void 0===a?void 0:a.includes("not found"))||console_1.logger.error("CURRENCY",`Error fetching spot price for ${e}`,n);throw(0,error_1.createError)({statusCode:404,message:`Market data unavailable for ${e}`})}};exports.getSpotPriceInUSD=getSpotPriceInUSD;const getEcoPriceInUSD=async e=>{var r,t,a;if("USDT"===e)return 1;const n=await getMatchingEngine();try{const r=`${e}/USDT`,t=(await n.getTicker(r)).last;if(null==t)throw(0,error_1.createError)({statusCode:500,message:"Error fetching ticker data"});return t}catch(n){(null===(r=n.message)||void 0===r?void 0:r.includes("market"))||(null===(t=n.message)||void 0===t?void 0:t.includes("symbol"))||(null===(a=n.message)||void 0===a?void 0:a.includes("not found"))||console_1.logger.error("CURRENCY",`Error fetching eco price for ${e}`,n);throw(0,error_1.createError)({statusCode:404,message:`Market data unavailable for ${e}`})}};exports.getEcoPriceInUSD=getEcoPriceInUSD;