"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const error_1=require("@b/utils/error"),db_1=require("@b/db"),console_1=require("@b/utils/console"),utils_1=require("./utils");exports.metadata={summary:"Checks Mollie payment status",description:"Retrieves current payment status from Mollie API and updates local records",operationId:"checkMolliePaymentStatus",tags:["Finance","Deposit","Mollie"],requiresAuth:!0,parameters:[{name:"transactionId",in:"query",required:!0,schema:{type:"string"},description:"Transaction UUID"}],responses:{200:{description:"Payment status retrieved successfully",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"},data:{type:"object",properties:{transactionId:{type:"string"},molliePaymentId:{type:"string"},status:{type:"string"},mollieStatus:{type:"string"},amount:{type:"number"},currency:{type:"string"},method:{type:"string"},createdAt:{type:"string"},expiresAt:{type:"string"},paidAt:{type:"string"},isCancelable:{type:"boolean"},checkoutUrl:{type:"string"},details:{type:"object"}}}}}}}},400:{description:"Bad request"},401:{description:"Unauthorized"},404:{description:"Transaction not found"},500:{description:"Internal server error"}}};exports.default=async t=>{var e,a,r,s,o,i,n,l,u;const{query:d,user:c}=t;if(!(null==c?void 0:c.id))throw(0,error_1.createError)({statusCode:401,message:"Authentication required"});if(!d.transactionId)throw(0,error_1.createError)({statusCode:400,message:"Transaction ID is required"});(0,utils_1.validateMollieConfig)();try{const t=await db_1.models.transaction.findOne({where:{uuid:d.transactionId,userId:c.id}});if(!t)throw(0,error_1.createError)({statusCode:404,message:"Transaction not found"});const m=t.referenceId||(null===(e=t.metadata)||void 0===e?void 0:e.molliePaymentId);if(!m)throw(0,error_1.createError)({statusCode:400,message:"Mollie payment ID not found for this transaction"});try{const e=await(0,utils_1.makeApiRequest)(`/payments/${m}`);if(!e)throw(0,error_1.createError)({statusCode:404,message:"Payment not found at Mollie"});if((null===(a=t.metadata)||void 0===a?void 0:a.mollieStatus)!==e.status){const a=(0,utils_1.mapMollieStatus)(e.status);await db_1.models.transaction.update({status:a,metadata:JSON.stringify({...t.metadata,molliePaymentId:e.id,mollieStatus:e.status,lastStatusCheck:(new Date).toISOString()})},{where:{uuid:t.uuid}})}return{success:!0,data:{transactionId:t.uuid,molliePaymentId:e.id,status:(0,utils_1.mapMollieStatus)(e.status),mollieStatus:e.status,amount:parseFloat(e.amount.value),currency:e.amount.currency,method:e.method||"unknown",createdAt:e.createdAt,expiresAt:e.expiresAt||null,paidAt:"paid"===e.status?e.createdAt:null,isCancelable:e.isCancelable,checkoutUrl:(null===(s=null===(r=e._links)||void 0===r?void 0:r.checkout)||void 0===s?void 0:s.href)||null,details:e.details||{}}}}catch(e){console_1.logger.warn("MOLLIE",`Failed to fetch from Mollie API: ${e.message}`);return{success:!0,data:{transactionId:t.uuid,molliePaymentId:m,status:t.status,mollieStatus:(null===(o=t.metadata)||void 0===o?void 0:o.mollieStatus)||"unknown",amount:t.amount,currency:(null===(i=t.metadata)||void 0===i?void 0:i.currency)||"EUR",method:(null===(n=t.metadata)||void 0===n?void 0:n.method)||"unknown",createdAt:t.createdAt,expiresAt:(null===(l=t.metadata)||void 0===l?void 0:l.expiresAt)||null,paidAt:"COMPLETED"===t.status?t.updatedAt:null,isCancelable:!1,checkoutUrl:(null===(u=t.metadata)||void 0===u?void 0:u.checkoutUrl)||null,details:{},note:"Status retrieved from local database due to API unavailability"}}}}catch(t){console_1.logger.error("MOLLIE","Status check error",t);if(t.statusCode)throw t;throw(0,error_1.createError)({statusCode:500,message:t.message||"Failed to check Mollie payment status"})}};