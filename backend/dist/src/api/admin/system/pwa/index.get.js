"use strict";function getManifestPath(){if("production"===process.env.NODE_ENV){const e=[path_1.default.join(process.cwd(),"frontend","public","manifest.json"),path_1.default.join(process.cwd(),"public","manifest.json"),path_1.default.join(process.cwd(),"..","frontend","public","manifest.json")];for(const t of e)if(fs_1.default.existsSync(t))return t;return e[0]}return path_1.default.join(process.cwd(),"..","frontend","public","manifest.json")}function getPublicDir(){if("production"===process.env.NODE_ENV){const e=[path_1.default.join(process.cwd(),"frontend","public"),path_1.default.join(process.cwd(),"public"),path_1.default.join(process.cwd(),"..","frontend","public")];for(const t of e)if(fs_1.default.existsSync(t))return t;return e[0]}return path_1.default.join(process.cwd(),"..","frontend","public")}function getWebManifestPath(){if("production"===process.env.NODE_ENV){const e=[path_1.default.join(process.cwd(),"frontend","public","site.webmanifest"),path_1.default.join(process.cwd(),"public","site.webmanifest"),path_1.default.join(process.cwd(),"..","frontend","public","site.webmanifest")];for(const t of e)if(fs_1.default.existsSync(t))return t;return e[0]}return path_1.default.join(process.cwd(),"..","frontend","public","site.webmanifest")}function getDefaultManifest(){const e=process.env.NEXT_PUBLIC_SITE_NAME||"App",t=process.env.NEXT_PUBLIC_SITE_DESCRIPTION||"";return{name:e,short_name:e.substring(0,12),description:t,start_url:"/",display:"standalone",orientation:"portrait",background_color:"#ffffff",theme_color:"#000000",scope:"/",lang:"en",dir:"ltr",categories:[],icons:[{src:"/img/logo/android-icon-36x36.webp",sizes:"36x36",type:"image/png",density:"0.75"},{src:"/img/logo/android-icon-48x48.webp",sizes:"48x48",type:"image/png",density:"1.0"},{src:"/img/logo/android-icon-72x72.webp",sizes:"72x72",type:"image/png",density:"1.5"},{src:"/img/logo/android-icon-96x96.webp",sizes:"96x96",type:"image/png",density:"2.0"},{src:"/img/logo/android-icon-144x144.webp",sizes:"144x144",type:"image/png",density:"3.0"},{src:"/img/logo/android-icon-192x192.webp",sizes:"192x192",type:"image/png",density:"4.0"},{src:"/img/logo/android-icon-256x256.webp",sizes:"256x256",type:"image/png",density:"5.0"},{src:"/img/logo/android-icon-384x384.webp",sizes:"384x384",type:"image/png",density:"6.0"},{src:"/img/logo/android-icon-512x512.webp",sizes:"512x512",type:"image/png",density:"8.0"},{src:"/img/logo/android-icon-512x512.webp",sizes:"512x512",type:"image/png",density:"8.0",purpose:"maskable"}],screenshots:[],shortcuts:[{name:"Dashboard",url:"/",short_name:"Dashboard"}],related_applications:[],prefer_related_applications:!1}}var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const error_1=require("@b/utils/error"),console_1=require("@b/utils/console"),promises_1=__importDefault(require("fs/promises")),fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path"));exports.metadata={summary:"Get PWA manifest configuration",operationId:"getPwaManifest",tags:["Admin","System","PWA"],responses:{200:{description:"PWA manifest configuration",content:{"application/json":{schema:{type:"object",properties:{manifest:{type:"object"},icons:{type:"array"},screenshots:{type:"array"}}}}}},500:{description:"Internal server error"}},permission:"view.settings",requiresAuth:!0};exports.default=async e=>{const{ctx:t}=e;try{null==t||t.step("Reading PWA manifest configuration");const e=getManifestPath(),s=getWebManifestPath(),i=getPublicDir(),n=process.env.NEXT_PUBLIC_SITE_NAME||"App",o=process.env.NEXT_PUBLIC_SITE_DESCRIPTION||"";let r={},a=!1;if(fs_1.default.existsSync(e)){const t=await promises_1.default.readFile(e,"utf-8");r=JSON.parse(t);"App"!==r.name&&r.name||(r.name=n);"App"!==r.short_name&&r.short_name||(r.short_name=n.substring(0,12));r.description||(r.description=o)}else{r=getDefaultManifest();const t=path_1.default.dirname(e);fs_1.default.existsSync(t)||await promises_1.default.mkdir(t,{recursive:!0});const i=JSON.stringify(r,null,2);await promises_1.default.writeFile(e,i,"utf-8");await promises_1.default.writeFile(s,i,"utf-8");console_1.logger.info("PWA",`Auto-generated manifest files at ${e}`);a=!0}if(!fs_1.default.existsSync(s)){const e=JSON.stringify(r,null,2);await promises_1.default.writeFile(s,e,"utf-8");console_1.logger.info("PWA",`Auto-generated site.webmanifest at ${s}`);a=!0}const c=path_1.default.join(i,"img","logo");let p=[];if(fs_1.default.existsSync(c)){p=(await promises_1.default.readdir(c)).filter(e=>(e.endsWith(".png")||e.endsWith(".webp"))&&(e.includes("android")||e.includes("icon")||e.includes("chrome")))}const d=path_1.default.join(i,"img","screenshots");let f=[];if(fs_1.default.existsSync(d)){f=(await promises_1.default.readdir(d)).filter(e=>e.endsWith(".png")||e.endsWith(".webp")||e.endsWith(".jpg"))}null==t||t.success(a?"PWA manifest files created":"PWA manifest loaded successfully");return{manifest:r,availableIcons:p,availableScreenshots:f,manifestPath:e,filesCreated:a}}catch(e){console_1.logger.error("PWA","Failed to read PWA manifest",e);null==t||t.fail(`Failed to read PWA manifest: ${null==e?void 0:e.message}`);throw(0,error_1.createError)({statusCode:500,message:`Failed to read PWA manifest: ${null==e?void 0:e.message}`})}};