"use strict";function calculateSharpeRatio(e,t=.02){if(e.length<2)return 0;const a=e.reduce((e,t)=>e+t,0)/e.length,l=calculateStdDev(e);if(0===l)return 0;return(252*a-t)/(l*Math.sqrt(252))}function calculateSortinoRatio(e,t=.02){if(e.length<2)return 0;const a=e.reduce((e,t)=>e+t,0)/e.length,l=e.filter(e=>e<0);if(0===l.length)return a>0?1/0:0;const r=calculateStdDev(l);if(0===r)return 0;return(252*a-t)/(r*Math.sqrt(252))}function calculateMaxDrawdown(e){if(e.length<2)return{maxDrawdown:0,maxDrawdownPercent:0,drawdownHistory:[]};let t=e[0],a=0,l=0;const r=[];let n=null;for(let o=1;o<e.length;o++){const c=e[o];if(c>t){if(n){n.recovered=!0;n.endDate=new Date;r.push(n);n=null}t=c}else{const e=t-c,r=e/t*100;if(n){if(c<n.trough){n.trough=c;n.drawdown=t-c;n.drawdownPercent=n.drawdown/t*100}}else n={peak:t,trough:c,drawdown:e,drawdownPercent:r,startDate:new Date,recovered:!1};if(e>a){a=e;l=r}}}n&&r.push(n);return{maxDrawdown:a,maxDrawdownPercent:l,drawdownHistory:r}}function calculateCurrentDrawdown(e){if(0===e.length)return{currentDrawdown:0,currentDrawdownPercent:0,peakValue:0};const t=Math.max(...e),a=e[e.length-1],l=Math.max(0,t-a);return{currentDrawdown:l,currentDrawdownPercent:t>0?l/t*100:0,peakValue:t}}function calculateStdDev(e){if(e.length<2)return 0;const t=e.reduce((e,t)=>e+t,0)/e.length,a=e.map(e=>Math.pow(e-t,2)).reduce((e,t)=>e+t,0)/e.length;return Math.sqrt(a)}function calculateVolatility(e){if(e.length<2)return 0;return calculateStdDev(e)*Math.sqrt(252)}function calculateRollingVolatility(e,t=20){const a=[];for(let l=t-1;l<e.length;l++){const r=e.slice(l-t+1,l+1);a.push(calculateVolatility(r))}return a}function calculateProfitFactor(e){const t=e.filter(e=>e>0).reduce((e,t)=>e+t,0),a=Math.abs(e.filter(e=>e<0).reduce((e,t)=>e+t,0));return 0===a?t>0?1/0:0:t/a}function calculateExpectancy(e){if(0===e.length)return 0;const t=e.filter(e=>e>0),a=e.filter(e=>e<0),l=t.length/e.length,r=a.length/e.length;return l*(t.length>0?t.reduce((e,t)=>e+t,0)/t.length:0)-r*(a.length>0?Math.abs(a.reduce((e,t)=>e+t,0)/a.length):0)}async function calculatePerformanceMetrics(e,t,a,l){const r={status:"CLOSED",profit:{[sequelize_1.Op.ne]:null}};if("leader"===e){r.leaderId=t;r.isLeaderTrade=!0}else r.followerId=t;a&&(r.closedAt={...r.closedAt,[sequelize_1.Op.gte]:a});l&&(r.closedAt={...r.closedAt,[sequelize_1.Op.lte]:l});const n=await db_1.models.copyTradingTrade.findAll({where:r,order:[["closedAt","ASC"]],raw:!0});if(0===n.length)return{sharpeRatio:0,sortinoRatio:0,maxDrawdown:0,maxDrawdownPercent:0,volatility:0,avgReturn:0,winRate:0,profitFactor:0,avgWin:0,avgLoss:0,expectancy:0,totalTrades:0,winningTrades:0,losingTrades:0};const o=n,c=o.map(e=>e.profit||0),u=o.map(e=>(e.profitPercent||0)/100);let i=1e4;const s=[i];for(const e of c){i+=e;s.push(i)}const d=c.filter(e=>e>0),f=c.filter(e=>e<0),w=d.length>0?d.reduce((e,t)=>e+t,0)/d.length:0,h=f.length>0?Math.abs(f.reduce((e,t)=>e+t,0)/f.length):0,{maxDrawdown:p,maxDrawdownPercent:g}=calculateMaxDrawdown(s);return{sharpeRatio:calculateSharpeRatio(u),sortinoRatio:calculateSortinoRatio(u),maxDrawdown:p,maxDrawdownPercent:g,volatility:calculateVolatility(u),avgReturn:u.reduce((e,t)=>e+t,0)/u.length,winRate:d.length/c.length*100,profitFactor:calculateProfitFactor(c),avgWin:w,avgLoss:h,expectancy:calculateExpectancy(c),totalTrades:c.length,winningTrades:d.length,losingTrades:f.length}}async function calculateDailyReturns(e,t,a=30){const l=new Date;l.setDate(l.getDate()-a);l.setHours(0,0,0,0);const r={status:"CLOSED",closedAt:{[sequelize_1.Op.gte]:l}};if("leader"===e){r.leaderId=t;r.isLeaderTrade=!0}else r.followerId=t;return(await db_1.models.copyTradingTrade.findAll({where:r,attributes:[[(0,sequelize_1.fn)("DATE",(0,sequelize_1.col)("closedAt")),"date"],[(0,sequelize_1.fn)("SUM",(0,sequelize_1.col)("profit")),"totalProfit"],[(0,sequelize_1.fn)("SUM",(0,sequelize_1.col)("cost")),"totalCost"],[(0,sequelize_1.fn)("COUNT",(0,sequelize_1.col)("id")),"tradeCount"]],group:[(0,sequelize_1.fn)("DATE",(0,sequelize_1.col)("closedAt"))],order:[[(0,sequelize_1.fn)("DATE",(0,sequelize_1.col)("closedAt")),"ASC"]],raw:!0})).map(e=>({date:e.date,return:e.totalCost>0?e.totalProfit/e.totalCost*100:0,trades:parseInt(e.tradeCount)}))}async function calculateMonthlyPerformance(e,t,a=12){const l=new Date;l.setMonth(l.getMonth()-a);l.setDate(1);l.setHours(0,0,0,0);const r={status:"CLOSED",closedAt:{[sequelize_1.Op.gte]:l}};if("leader"===e){r.leaderId=t;r.isLeaderTrade=!0}else r.followerId=t;return(await db_1.models.copyTradingTrade.findAll({where:r,attributes:[[(0,sequelize_1.fn)("DATE_FORMAT",(0,sequelize_1.col)("closedAt"),"%Y-%m"),"month"],[(0,sequelize_1.fn)("SUM",(0,sequelize_1.col)("profit")),"totalProfit"],[(0,sequelize_1.fn)("SUM",(0,sequelize_1.col)("cost")),"totalCost"],[(0,sequelize_1.fn)("COUNT",(0,sequelize_1.col)("id")),"tradeCount"],[(0,sequelize_1.fn)("SUM",(0,sequelize_1.literal)("CASE WHEN profit > 0 THEN 1 ELSE 0 END")),"winCount"]],group:[(0,sequelize_1.fn)("DATE_FORMAT",(0,sequelize_1.col)("closedAt"),"%Y-%m")],order:[[(0,sequelize_1.fn)("DATE_FORMAT",(0,sequelize_1.col)("closedAt"),"%Y-%m"),"ASC"]],raw:!0})).map(e=>({month:e.month,profit:parseFloat(e.totalProfit)||0,roi:e.totalCost>0?e.totalProfit/e.totalCost*100:0,trades:parseInt(e.tradeCount)||0,winRate:e.tradeCount>0?parseInt(e.winCount)/parseInt(e.tradeCount)*100:0}))}async function calculateAlpha(e,t=0){return{alpha:252*(await calculatePerformanceMetrics("leader",e)).avgReturn-(.02+1*(t-.02)),beta:1}}function calculateRiskAdjustedReturn(e,t){return 0===t?0:e/t}Object.defineProperty(exports,"__esModule",{value:!0});exports.calculateSharpeRatio=calculateSharpeRatio;exports.calculateSortinoRatio=calculateSortinoRatio;exports.calculateMaxDrawdown=calculateMaxDrawdown;exports.calculateCurrentDrawdown=calculateCurrentDrawdown;exports.calculateStdDev=calculateStdDev;exports.calculateVolatility=calculateVolatility;exports.calculateRollingVolatility=calculateRollingVolatility;exports.calculateProfitFactor=calculateProfitFactor;exports.calculateExpectancy=calculateExpectancy;exports.calculatePerformanceMetrics=calculatePerformanceMetrics;exports.calculateDailyReturns=calculateDailyReturns;exports.calculateMonthlyPerformance=calculateMonthlyPerformance;exports.calculateAlpha=calculateAlpha;exports.calculateRiskAdjustedReturn=calculateRiskAdjustedReturn;const db_1=require("@b/db"),sequelize_1=require("sequelize");