"use strict";function calculatePnL(e,r,t,a,o=0){let n;n="BUY"===a?(r-e)*t:(e-r)*t;n-=o;const c=e*t;return{profit:n,profitPercent:c>0?n/c*100:0}}function calculateUnrealizedPnL(e,r,t,a){const{profit:o,profitPercent:n}=calculatePnL(e,r,t,a,0);return{unrealizedProfit:o,unrealizedProfitPercent:n}}async function calculateProfitShareBreakdown(e,r,t="USDT"){const a=await(0,index_1.getCopyTradingSettings)(),o=a.platformFeePercent||2,n=Math.min(r,100),c=a.enableProfitShare?n:0;if(e<=0)return{grossProfit:e,platformFee:0,platformFeePercent:o,leaderShare:0,leaderSharePercent:c,followerNet:e,currency:t};const i=e*(o/100),l=e-i,s=l*(c/100);return{grossProfit:e,platformFee:i,platformFeePercent:o,leaderShare:s,leaderSharePercent:c,followerNet:l-s,currency:t}}async function distributeProfitShare(e,r,t,a,o,n){try{if(a<=0)return{success:!0,leaderShare:0,platformFee:0,followerNet:a,currency:o};const c=await calculateProfitShareBreakdown(a,t.profitSharePercent||20,o),i=n||await db_1.sequelize.transaction(),l=!!n;try{if(c.leaderShare>0){const n=await(0,wallet_1.getWalletByUserIdAndCurrency)(t.userId,o);if(n){await(0,wallet_1.updateWalletBalance)(n,c.leaderShare,"add",`ct_profit_share_${e}`,i);await db_1.models.copyTradingTransaction.create({userId:t.userId,leaderId:t.id,followerId:r.id,tradeId:e,type:"PROFIT_SHARE_RECEIVED",amount:c.leaderShare,currency:o,fee:0,balanceBefore:parseFloat(n.balance.toString()),balanceAfter:parseFloat(n.balance.toString())+c.leaderShare,description:`Profit share from follower trade: ${(0,currency_1.formatCurrencyAmount)(c.leaderShare,o)}`,metadata:JSON.stringify({grossProfit:a,sharePercent:c.leaderSharePercent,currency:o}),status:"COMPLETED"},{transaction:i})}}await db_1.models.copyTradingTransaction.create({userId:r.userId,leaderId:t.id,followerId:r.id,tradeId:e,type:"PROFIT_SHARE_PAID",amount:c.leaderShare,currency:o,fee:c.platformFee,balanceBefore:0,balanceAfter:0,description:`Profit share paid to leader: ${(0,currency_1.formatCurrencyAmount)(c.leaderShare,o)}`,metadata:JSON.stringify({grossProfit:a,leaderSharePercent:c.leaderSharePercent,platformFeePercent:c.platformFeePercent,currency:o}),status:"COMPLETED"},{transaction:i});c.platformFee>0&&await db_1.models.copyTradingTransaction.create({userId:r.userId,followerId:r.id,tradeId:e,type:"PLATFORM_FEE",amount:c.platformFee,currency:o,fee:0,balanceBefore:0,balanceAfter:0,description:`Platform fee for profitable trade: ${(0,currency_1.formatCurrencyAmount)(c.platformFee,o)}`,metadata:JSON.stringify({grossProfit:a,feePercent:c.platformFeePercent,currency:o}),status:"COMPLETED"},{transaction:i});await db_1.models.copyTradingLeader.update({totalProfit:(0,sequelize_1.literal)(`"totalProfit" + ${c.leaderShare}`)},{where:{id:t.id},transaction:i});l||await i.commit();await(0,index_1.createAuditLog)({entityType:"copyTradingTrade",entityId:e,action:"PROFIT_DISTRIBUTED",userId:r.userId,metadata:c});return{success:!0,leaderShare:c.leaderShare,platformFee:c.platformFee,followerNet:c.followerNet,currency:o}}catch(e){l||await i.rollback();throw e}}catch(e){console_1.logger.error("COPY_TRADING","Failed to distribute profit share",e);return{success:!1,leaderShare:0,platformFee:0,followerNet:0,currency:o,error:e.message}}}async function processPendingProfitDistributions(){let e=0,r=0;try{const t=await db_1.models.copyTradingTrade.findAll({where:{status:"CLOSED",followerId:{[sequelize_1.Op.ne]:null},profit:{[sequelize_1.Op.gt]:0}},include:[{model:db_1.models.copyTradingFollower,as:"follower",include:[{model:db_1.models.copyTradingLeader,as:"leader"}]}]});for(const a of t){if(await db_1.models.copyTradingTransaction.findOne({where:{tradeId:a.id,type:"PROFIT_SHARE_PAID"}}))continue;const t=a.follower,o=null==t?void 0:t.leader;if(!t||!o)continue;const n=a.profitCurrency||(0,currency_1.getQuoteCurrency)(a.symbol);(await distributeProfitShare(a.id,t,o,a.profit,n)).success?e++:r++}return{processed:e,failed:r}}catch(t){console_1.logger.error("COPY_TRADING","Failed to process pending profit distributions",t);return{processed:e,failed:r}}}async function getLeaderEarnings(e,r,t){const a={leaderId:e,type:"PROFIT_SHARE_RECEIVED",status:"COMPLETED"};if(r||t){a.createdAt={};r&&(a.createdAt[sequelize_1.Op.gte]=r);t&&(a.createdAt[sequelize_1.Op.lte]=t)}const o=await db_1.models.copyTradingTransaction.findAll({where:a,attributes:["amount","currency"]});let n=0;const c={};let i=0;for(const e of o){const r=parseFloat(e.amount)||0,t=e.currency||"USDT";c[t]=(c[t]||0)+r;i++;try{n+=await(0,currency_1.convertToUSDT)(r,t)}catch(e){console_1.logger.warn("COPY_TRADING",`Currency conversion failed for ${t}`,e);n+=r}}return{totalEarnings:n,totalProfitShares:n,totalPlatformFees:0,tradeCount:i,currency:"USDT",earningsByCurrency:c}}async function getFollowerProfitSharePayments(e,r,t){const a={followerId:e,status:"COMPLETED"};if(r||t){a.createdAt={};r&&(a.createdAt[sequelize_1.Op.gte]=r);t&&(a.createdAt[sequelize_1.Op.lte]=t)}const o=await db_1.models.copyTradingTransaction.findAll({where:{...a,type:"PROFIT_SHARE_PAID"},attributes:["amount","currency"]}),n=await db_1.models.copyTradingTransaction.findAll({where:{...a,type:"PLATFORM_FEE"},attributes:["amount","currency"]});let c=0;const i={};let l=0;for(const e of o){const r=parseFloat(e.amount)||0,t=e.currency||"USDT";i[t]=(i[t]||0)+r;l++;try{c+=await(0,currency_1.convertToUSDT)(r,t)}catch(e){console_1.logger.warn("COPY_TRADING",`Currency conversion failed for ${t}`,e);c+=r}}let s=0;for(const e of n){const r=parseFloat(e.amount)||0,t=e.currency||"USDT";try{s+=await(0,currency_1.convertToUSDT)(r,t)}catch(e){console_1.logger.warn("COPY_TRADING",`Currency conversion failed for ${t}`,e);s+=r}}return{totalPaid:c,totalPlatformFees:s,tradeCount:l,currency:"USDT",paidByCurrency:i}}async function previewProfitShare(e,r){var t;const a=await db_1.models.copyTradingTrade.findByPk(e,{include:[{model:db_1.models.copyTradingFollower,as:"follower",include:[{model:db_1.models.copyTradingLeader,as:"leader"}]}]});if(!a)return{grossProfit:0,breakdown:null};const o=a,n=o.executedPrice||o.price,c=o.executedAmount||o.amount,{profit:i}=calculatePnL(n,r,c,o.side,o.fee||0);if(i<=0||!(null===(t=o.follower)||void 0===t?void 0:t.leader))return{grossProfit:i,breakdown:null};return{grossProfit:i,breakdown:await calculateProfitShareBreakdown(i,o.follower.leader.profitSharePercent||20)}}Object.defineProperty(exports,"__esModule",{value:!0});exports.calculatePnL=calculatePnL;exports.calculateUnrealizedPnL=calculateUnrealizedPnL;exports.calculateProfitShareBreakdown=calculateProfitShareBreakdown;exports.distributeProfitShare=distributeProfitShare;exports.processPendingProfitDistributions=processPendingProfitDistributions;exports.getLeaderEarnings=getLeaderEarnings;exports.getFollowerProfitSharePayments=getFollowerProfitSharePayments;exports.previewProfitShare=previewProfitShare;const db_1=require("@b/db"),sequelize_1=require("sequelize"),console_1=require("@b/utils/console"),wallet_1=require("@b/api/(ext)/ecosystem/utils/wallet"),index_1=require("./index"),currency_1=require("./currency");