"use strict";async function handleOrderCreated(e,r,t,s,a,d,o){return LeaderTradeListener.getInstance().onOrderCreated({orderId:e,userId:r,symbol:t,side:s,type:a,amount:d,price:o,status:"NEW",createdAt:new Date})}async function isActiveLeader(e){return!!await db_1.models.copyTradingLeader.findOne({where:{userId:e,status:"ACTIVE"}})}async function getLeaderInfo(e){const r=await db_1.models.copyTradingLeader.findOne({where:{userId:e,status:"ACTIVE"}});if(!r)return null;const t=r,s=await db_1.models.copyTradingFollower.count({where:{leaderId:t.id,status:"ACTIVE"}});return{id:t.id,displayName:t.displayName,followerCount:s}}async function handleOrderCancelled(e,r,t){var s,a;try{const d=await db_1.models.copyTradingLeader.findOne({where:{userId:r,status:"ACTIVE"}});if(!d)return{success:!0};const o=d,n=await db_1.models.copyTradingTrade.findOne({where:{leaderId:o.id,leaderOrderId:e,isLeaderTrade:!0,status:{[sequelize_1.Op.in]:["PENDING","OPEN","PARTIALLY_FILLED"]}}});if(!n)return{success:!0};const i=n;console_1.logger.info("COPY_TRADING",`Leader cancelled order ${e}, cancelling copy trades for trade ${i.id}`);await n.update({status:"CANCELLED",closedAt:new Date});const l=await db_1.models.copyTradingTrade.findAll({where:{leaderTradeId:i.id,isLeaderTrade:!1,status:{[sequelize_1.Op.in]:["PENDING","OPEN","PARTIALLY_FILLED"]}},include:[{model:db_1.models.copyTradingFollower,as:"follower",include:[{model:db_1.models.user,as:"user"}]}]});let c=0;for(const e of l)try{await e.update({status:"CANCELLED",closedAt:new Date});if(e.leaderOrderId&&(null===(s=e.follower)||void 0===s?void 0:s.userId))try{const{cancelOrderByUuid:r}=await Promise.resolve().then(()=>__importStar(require("@b/api/(ext)/ecosystem/utils/scylla/queries"))),{getOrderByUuid:s}=await Promise.resolve().then(()=>__importStar(require("@b/api/(ext)/ecosystem/utils/scylla/queries"))),a=await s(e.follower.userId,e.leaderOrderId,new Date(e.createdAt).toISOString());a&&"OPEN"===a.status&&await r(e.follower.userId,e.leaderOrderId,new Date(e.createdAt).toISOString(),t,BigInt(a.price),a.side,BigInt(a.amount))}catch(r){console_1.logger.warn("COPY_TRADING",`Failed to cancel ecosystem order for follower ${null===(a=e.follower)||void 0===a?void 0:a.userId}: ${r.message}`)}const r=await db_1.models.copyTradingFollowerAllocation.findOne({where:{followerId:e.followerId,symbol:t,isActive:!0}});if(r){const t=r;"BUY"===e.side?await r.update({quoteUsedAmount:Math.max(0,t.quoteUsedAmount-(e.cost||0))}):await r.update({baseUsedAmount:Math.max(0,t.baseUsedAmount-(e.amount||0))})}c++}catch(r){console_1.logger.error("COPY_TRADING",`Failed to cancel follower trade ${e.id}: ${r.message}`)}await(0,index_1.createAuditLog)({entityType:"copyTradingTrade",entityId:i.id,action:"TRADE_CANCELLED",userId:r,metadata:{symbol:t,orderId:e,cancelledFollowers:c}});console_1.logger.info("COPY_TRADING",`Cancelled ${c} follower trades for leader trade ${i.id}`);return{success:!0,cancelledCount:c}}catch(e){console_1.logger.error("COPY_TRADING","Error in handleOrderCancelled",e);return{success:!1,error:e.message}}}var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,t,s){void 0===s&&(s=t);var a=Object.getOwnPropertyDescriptor(r,t);a&&!("get"in a?!r.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return r[t]}});Object.defineProperty(e,s,a)}:function(e,r,t,s){void 0===s&&(s=t);e[s]=r[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(){var e=function(r){e=Object.getOwnPropertyNames||function(e){var r=[];for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(r[r.length]=t);return r};return e(r)};return function(r){if(r&&r.__esModule)return r;var t={};if(null!=r)for(var s=e(r),a=0;a<s.length;a++)"default"!==s[a]&&__createBinding(t,r,s[a]);__setModuleDefault(t,r);return t}}();Object.defineProperty(exports,"__esModule",{value:!0});exports.LeaderTradeListener=void 0;exports.handleOrderCreated=handleOrderCreated;exports.isActiveLeader=isActiveLeader;exports.getLeaderInfo=getLeaderInfo;exports.handleOrderCancelled=handleOrderCancelled;const db_1=require("@b/db"),sequelize_1=require("sequelize"),console_1=require("@b/utils/console"),wallet_1=require("@b/api/(ext)/ecosystem/utils/wallet"),index_1=require("./index");class LeaderTradeListener{constructor(){this.isProcessing=!1;this.pendingEvents=[];this.processInterval=null}static getInstance(){LeaderTradeListener.instance||(LeaderTradeListener.instance=new LeaderTradeListener);return LeaderTradeListener.instance}start(e=1e3){if(!this.processInterval){this.processInterval=setInterval(async()=>{await this.processPendingEvents()},e);console_1.logger.info("COPY_TRADING","LeaderTradeListener started")}}stop(){if(this.processInterval){clearInterval(this.processInterval);this.processInterval=null}console_1.logger.info("COPY_TRADING","LeaderTradeListener stopped")}async onOrderCreated(e){try{const r=await db_1.models.copyTradingLeader.findOne({where:{userId:e.userId,status:"ACTIVE"}});if(!r)return{success:!0};const t=r,s=await db_1.models.copyTradingFollower.count({where:{leaderId:t.id,status:"ACTIVE"}});if(0===s)return{success:!0};const a=await db_1.models.copyTradingTrade.create({leaderId:t.id,symbol:e.symbol,side:e.side,type:e.type,amount:e.amount,price:e.price,cost:"BUY"===e.side?e.amount*e.price:e.amount,fee:0,feeCurrency:e.symbol.split("/")[1]||"USDT",status:"PENDING",isLeaderTrade:!0,leaderOrderId:e.orderId,executedAmount:0,executedPrice:0}),[,d]=e.symbol.split("/"),o=await(0,wallet_1.getWalletByUserIdAndCurrency)(e.userId,d),n=o?parseFloat(o.balance.toString()):0,i=await this.processLeaderTrade(a,t,n);await(0,index_1.createAuditLog)({entityType:"copyTradingTrade",entityId:a.id,action:"TRADE_CREATED",userId:e.userId,metadata:{symbol:e.symbol,side:e.side,amount:e.amount,price:e.price,followers:s,processed:i.followersProcessed}});return{success:!0,tradeId:a.id,followersProcessed:i.followersProcessed}}catch(e){console_1.logger.error("COPY_TRADING","Error in LeaderTradeListener.onOrderCreated",e);return{success:!1,error:e.message}}}async processLeaderTrade(e,r,t){try{const{queueLeaderTrade:t}=await Promise.resolve().then(()=>__importStar(require("./copyQueue")));await t(e.id,r.id,e.symbol,0);console_1.logger.info("COPY_TRADING",`Queued leader trade ${e.id} for processing`);return{followersProcessed:0,errors:[]}}catch(e){console_1.logger.error("COPY_TRADING","Failed to queue leader trade",e);return{followersProcessed:0,errors:[e.message]}}}async processPendingEvents(){if(!this.isProcessing&&0!==this.pendingEvents.length){this.isProcessing=!0;try{for(;this.pendingEvents.length>0;){const e=this.pendingEvents.shift();e&&await this.onOrderCreated(e)}}finally{this.isProcessing=!1}}}queueEvent(e){this.pendingEvents.push(e)}}exports.LeaderTradeListener=LeaderTradeListener;LeaderTradeListener.instance=null;