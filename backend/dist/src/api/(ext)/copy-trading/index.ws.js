"use strict";function broadcastTradeUpdate(e,a){var t;const r={type:`trade_${a}`,trade:{id:e.id,symbol:e.symbol,side:e.side,amount:e.amount,price:e.price,profit:e.profit,status:e.status},leaderId:e.leaderId,followerId:e.followerId};Websocket_1.messageBroker.broadcastToSubscribedClients("/api/ext/copy-trading",{channel:"leader_updates",leaderId:e.leaderId},{stream:"leader_trade",data:r});e.followerId&&(null===(t=e.follower)||void 0===t?void 0:t.userId)&&Websocket_1.messageBroker.broadcastToSubscribedClients("/api/ext/copy-trading",{channel:"my_trades",userId:e.follower.userId},{stream:"my_trade",data:r})}function broadcastLeaderUpdate(e,a){const t={type:"leader_stats",leader:{id:e.id,displayName:e.displayName,roi:a.roi,winRate:a.winRate,totalFollowers:a.totalFollowers}};Websocket_1.messageBroker.broadcastToSubscribedClients("/api/ext/copy-trading",{channel:"leader_updates",leaderId:e.id},{stream:"leader_stats",data:t});Websocket_1.messageBroker.broadcastToSubscribedClients("/api/ext/copy-trading",{channel:"all_leaders"},{stream:"leaderboard_update",data:t})}async function broadcastLeaderboard(){try{const e=await db_1.models.copyTradingLeader.findAll({where:{status:"ACTIVE",isPublic:!0},include:[{model:db_1.models.user,as:"user",attributes:["id","firstName","lastName","avatar"]}]}),a=e.map(e=>e.id),t=a.length>0?await(0,stats_calculator_1.calculateBatchLeaderStats)(a):new Map,r=e.map(e=>{var a;const r=t.get(e.id)||{roi:0,winRate:0,totalFollowers:0};return{id:e.id,displayName:e.displayName,avatar:e.avatar||(null===(a=e.user)||void 0===a?void 0:a.avatar),roi:r.roi,winRate:r.winRate,totalFollowers:r.totalFollowers,tradingStyle:e.tradingStyle,riskLevel:e.riskLevel}});r.sort((e,a)=>a.roi-e.roi);const s=r.slice(0,50);Websocket_1.messageBroker.broadcastToSubscribedClients("/api/ext/copy-trading",{channel:"all_leaders"},{stream:"leaderboard",data:s})}catch(e){console_1.logger.error("COPY_TRADING_WS","Failed to broadcast leaderboard",e)}}function broadcastUserNotification(e,a){Websocket_1.messageBroker.broadcastToSubscribedClients("/api/ext/copy-trading",{channel:"my_trades",userId:e},{stream:"notification",data:a})}function broadcastSubscriptionUpdate(e,a,t){const r={type:"subscription_update",followerId:e,status:a,leaderId:t.leaderId};Websocket_1.messageBroker.broadcastToSubscribedClients("/api/ext/copy-trading",{channel:"my_trades",userId:t.userId},{stream:"subscription_update",data:r})}Object.defineProperty(exports,"__esModule",{value:!0});exports.onClose=exports.copyTradingHandler=exports.metadata=void 0;exports.broadcastTradeUpdate=broadcastTradeUpdate;exports.broadcastLeaderUpdate=broadcastLeaderUpdate;exports.broadcastLeaderboard=broadcastLeaderboard;exports.broadcastUserNotification=broadcastUserNotification;exports.broadcastSubscriptionUpdate=broadcastSubscriptionUpdate;const Websocket_1=require("@b/handler/Websocket"),db_1=require("@b/db"),console_1=require("@b/utils/console"),sequelize_1=require("sequelize"),stats_calculator_1=require("@b/api/(ext)/copy-trading/utils/stats-calculator");exports.metadata={requiresAuth:!0};class CopyTradingDataHandler{constructor(){this.activeSubscriptions=new Map}static getInstance(){CopyTradingDataHandler.instance||(CopyTradingDataHandler.instance=new CopyTradingDataHandler);return CopyTradingDataHandler.instance}async addSubscription(e,a,t){const r=t?`${a}:${t}`:a;this.activeSubscriptions.has(r)||this.activeSubscriptions.set(r,new Set);this.activeSubscriptions.get(r).add(e);let s=null;switch(a){case"my_trades":s=await this.getMyTrades(e);break;case"leader_updates":t&&(s=await this.getLeaderData(t));break;case"all_leaders":s=await this.getLeaderboard();break;case"my_subscriptions":s=await this.getMySubscriptions(e)}console_1.logger.info("COPY_TRADING_WS",`User ${e} subscribed to ${r}`);return{success:!0,data:s}}removeSubscription(e,a,t){const r=t?`${a}:${t}`:a;if(this.activeSubscriptions.has(r)){this.activeSubscriptions.get(r).delete(e);0===this.activeSubscriptions.get(r).size&&this.activeSubscriptions.delete(r);console_1.logger.info("COPY_TRADING_WS",`User ${e} unsubscribed from ${r}`)}}removeAllSubscriptions(e){const a=[];for(const[t,r]of this.activeSubscriptions)if(r.has(e)){r.delete(e);0===r.size&&a.push(t)}for(const e of a)this.activeSubscriptions.delete(e);a.length>0&&console_1.logger.info("COPY_TRADING_WS",`Cleaned up ${a.length} subscriptions for user ${e}`)}async getMyTrades(e){try{const a=await db_1.models.copyTradingFollower.findAll({where:{userId:e,status:{[sequelize_1.Op.in]:["ACTIVE","PAUSED"]}},attributes:["id"]});if(0===a.length)return[];const t=a.map(e=>e.id);return(await db_1.models.copyTradingTrade.findAll({where:{followerId:{[sequelize_1.Op.in]:t},status:{[sequelize_1.Op.in]:["OPEN","PENDING","PENDING_REPLICATION"]}},include:[{model:db_1.models.copyTradingLeader,as:"leader",attributes:["id","displayName"]}],order:[["createdAt","DESC"]],limit:50})).map(e=>e.toJSON())}catch(e){console_1.logger.error("COPY_TRADING_WS","Failed to get my trades",e);return[]}}async getLeaderData(e){try{const a=await db_1.models.copyTradingLeader.findByPk(e,{include:[{model:db_1.models.user,as:"user",attributes:["id","firstName","lastName","avatar"]}]});return a?a.toJSON():null}catch(e){console_1.logger.error("COPY_TRADING_WS","Failed to get leader data",e);return null}}async getLeaderboard(){try{const e=await db_1.models.copyTradingLeader.findAll({where:{status:"ACTIVE",isPublic:!0},include:[{model:db_1.models.user,as:"user",attributes:["id","firstName","lastName","avatar"]}]}),a=e.map(e=>e.id),t=a.length>0?await(0,stats_calculator_1.calculateBatchLeaderStats)(a):new Map,r=e.map(e=>{var a;const r=t.get(e.id)||{roi:0,winRate:0,totalFollowers:0};return{id:e.id,displayName:e.displayName,avatar:e.avatar||(null===(a=e.user)||void 0===a?void 0:a.avatar),roi:r.roi,winRate:r.winRate,totalFollowers:r.totalFollowers,tradingStyle:e.tradingStyle,riskLevel:e.riskLevel}});r.sort((e,a)=>a.roi-e.roi);return r.slice(0,50)}catch(e){console_1.logger.error("COPY_TRADING_WS","Failed to get leaderboard",e);return[]}}async getMySubscriptions(e){try{const a=await db_1.models.copyTradingFollower.findAll({where:{userId:e,status:{[sequelize_1.Op.in]:["ACTIVE","PAUSED"]}},include:[{model:db_1.models.copyTradingLeader,as:"leader",include:[{model:db_1.models.user,as:"user",attributes:["id","firstName","lastName","avatar"]}]}]}),t=a.filter(e=>e.leader).map(e=>e.leader.id),r=t.length>0?await(0,stats_calculator_1.calculateBatchLeaderStats)(t):new Map;return a.map(e=>{var a;const t=e.leader?r.get(e.leader.id):null;return{id:e.id,status:e.status,leader:e.leader?{id:e.leader.id,displayName:e.leader.displayName,avatar:e.leader.avatar||(null===(a=e.leader.user)||void 0===a?void 0:a.avatar),roi:(null==t?void 0:t.roi)||0,winRate:(null==t?void 0:t.winRate)||0}:null}})}catch(e){console_1.logger.error("COPY_TRADING_WS","Failed to get my subscriptions",e);return[]}}}exports.copyTradingHandler=CopyTradingDataHandler.getInstance();exports.default=async(e,a)=>{var t;if("string"==typeof a)try{a=JSON.parse(a)}catch(e){return{error:"Invalid message format"}}const r=null===(t=e.user)||void 0===t?void 0:t.id;if(!r)return{error:"Authentication required"};const{action:s,payload:o}=a,{channel:i,leaderId:d}=o||{};if(!i)return{error:"Channel is required"};const l=CopyTradingDataHandler.getInstance();if("SUBSCRIBE"===s){return{subscribed:i,leaderId:d,data:(await l.addSubscription(r,i,d)).data}}if("UNSUBSCRIBE"===s){l.removeSubscription(r,i,d);return{unsubscribed:i,leaderId:d}}return{error:"Unknown action"}};const onClose=(e,a,t)=>{CopyTradingDataHandler.getInstance().removeAllSubscriptions(t)};exports.onClose=onClose;