"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),utils_1=require("@b/api/(ext)/copy-trading/utils"),security_1=require("@b/api/(ext)/copy-trading/utils/security"),sequelize_1=require("sequelize"),wallet_1=require("@b/services/wallet");exports.metadata={summary:"Remove Funds from Market Allocation",description:"Removes funds from a specific market allocation within a subscription.",operationId:"removeFundsFromAllocation",tags:["Copy Trading","Followers","Allocations"],requiresAuth:!0,logModule:"COPY",logTitle:"Remove funds from allocation",middleware:["copyTradingFunds"],parameters:[{name:"id",in:"path",required:!0,schema:{type:"string",format:"uuid"},description:"Subscription (follower) ID"},{name:"allocationId",in:"path",required:!0,schema:{type:"string",format:"uuid"},description:"Allocation ID"}],requestBody:{required:!0,content:{"application/json":{schema:{type:"object",properties:{amount:{type:"number",minimum:1e-8,maximum:1e7,description:"Amount to remove"},currency:{type:"string",enum:["BASE","QUOTE"],description:"Which currency to remove (BASE or QUOTE)"}},required:["amount","currency"]}}}},responses:{200:{description:"Funds removed successfully",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"},allocation:{type:"object"}}}}}},400:{description:"Bad Request"},401:{description:"Unauthorized"},403:{description:"Forbidden"},404:{description:"Allocation not found"},429:{description:"Too Many Requests"},500:{description:"Internal Server Error"}}};exports.default=async e=>{const{user:t,params:o,body:r,ctx:a}=e,{id:s,allocationId:i}=o;if(!(null==t?void 0:t.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});if(!(0,security_1.isValidUUID)(s)||!(0,security_1.isValidUUID)(i))throw(0,error_1.createError)({statusCode:400,message:"Invalid ID format"});null==a||a.step("Validating request");const n=(0,security_1.validateFundOperation)(r);n.valid||(0,security_1.throwValidationError)(n);const{amount:u}=n.sanitized,l=r.currency;if(!l||!["BASE","QUOTE"].includes(l))throw(0,error_1.createError)({statusCode:400,message:"Currency type must be BASE or QUOTE"});null==a||a.step("Fetching subscription");const d=await db_1.models.copyTradingFollower.findByPk(s);if(!d)throw(0,error_1.createError)({statusCode:404,message:"Subscription not found"});if(d.userId!==t.id)throw(0,error_1.createError)({statusCode:403,message:"Access denied"});if("STOPPED"===d.status)throw(0,error_1.createError)({statusCode:400,message:"Cannot remove funds from a stopped subscription"});null==a||a.step("Fetching allocation");const c=await db_1.models.copyTradingFollowerAllocation.findOne({where:{id:i,followerId:s}});if(!c)throw(0,error_1.createError)({statusCode:404,message:"Allocation not found"});const m=c,[p,y]=m.symbol.split("/"),f="BASE"===l?p:y;let b,A;if("BASE"===l){b=m.baseAmount-m.baseUsedAmount;A=m.baseUsedAmount}else{b=m.quoteAmount-m.quoteUsedAmount;A=m.quoteUsedAmount}if(u>b)throw(0,error_1.createError)({statusCode:400,message:`Cannot remove ${u} ${f}. Only ${b} available (${A} in use)`});null==a||a.step("Removing funds from allocation");await db_1.sequelize.transaction(async e=>{const o=`ct_remove_funds_${i}_${l}`,r=await wallet_1.walletService.transfer({idempotencyKey:o,fromUserId:t.id,toUserId:t.id,fromWalletType:"COPY_TRADING",toWalletType:"ECO",fromCurrency:f,toCurrency:f,amount:u,description:`Transfer ${u} ${f} from CT to ECO wallet (remove funds from ${m.symbol})`,metadata:{allocationId:i,symbol:m.symbol,currencyType:l},transaction:e});"BASE"===l?await c.update({baseAmount:(0,sequelize_1.literal)(`"baseAmount" - ${u}`)},{transaction:e}):await c.update({quoteAmount:(0,sequelize_1.literal)(`"quoteAmount" - ${u}`)},{transaction:e});await(0,utils_1.createCopyTradingTransaction)({userId:t.id,leaderId:d.leaderId,followerId:s,type:"DEALLOCATION",amount:-u,currency:f,balanceBefore:r.fromResult.previousBalance,balanceAfter:r.fromResult.newBalance,description:`Transfer ${u} ${f} from CT to ECO wallet (remove funds from ${m.symbol})`,metadata:JSON.stringify({allocationId:i,symbol:m.symbol,currencyType:l})},e);await(0,utils_1.createCopyTradingTransaction)({userId:t.id,leaderId:d.leaderId,followerId:s,type:"DEALLOCATION",amount:u,currency:f,balanceBefore:r.toResult.previousBalance,balanceAfter:r.toResult.newBalance,description:`Received ${u} ${f} in ECO wallet (remove funds from ${m.symbol})`,metadata:JSON.stringify({allocationId:i,symbol:m.symbol,currencyType:l})},e);await(0,utils_1.createAuditLog)({entityType:"ALLOCATION",entityId:i,action:"DEALLOCATE",oldValue:{baseAmount:m.baseAmount,quoteAmount:m.quoteAmount},newValue:{baseAmount:"BASE"===l?m.baseAmount-u:m.baseAmount,quoteAmount:"QUOTE"===l?m.quoteAmount-u:m.quoteAmount},userId:t.id},e)});await c.reload();null==a||a.success(`Removed ${u} ${f} from ${m.symbol}`);return{message:`Successfully removed ${u} ${f} from ${m.symbol}`,allocation:c.toJSON()}};