"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),utils_1=require("@b/api/(ext)/copy-trading/utils"),security_1=require("@b/api/(ext)/copy-trading/utils/security"),sequelize_1=require("sequelize"),wallet_1=require("@b/services/wallet");exports.metadata={summary:"Add Funds to Market Allocation",description:"Adds funds to a specific market allocation within a subscription.",operationId:"addFundsToAllocation",tags:["Copy Trading","Followers","Allocations"],requiresAuth:!0,logModule:"COPY",logTitle:"Add funds to allocation",middleware:["copyTradingFunds"],parameters:[{name:"id",in:"path",required:!0,schema:{type:"string",format:"uuid"},description:"Subscription (follower) ID"},{name:"allocationId",in:"path",required:!0,schema:{type:"string",format:"uuid"},description:"Allocation ID"}],requestBody:{required:!0,content:{"application/json":{schema:{type:"object",properties:{amount:{type:"number",minimum:1e-8,maximum:1e7,description:"Amount to add"},currency:{type:"string",enum:["BASE","QUOTE"],description:"Which currency to add (BASE for selling, QUOTE for buying)"}},required:["amount","currency"]}}}},responses:{200:{description:"Funds added successfully",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"},allocation:{type:"object"}}}}}},400:{description:"Bad Request"},401:{description:"Unauthorized"},403:{description:"Forbidden"},404:{description:"Allocation not found"},429:{description:"Too Many Requests"},500:{description:"Internal Server Error"}}};exports.default=async e=>{const{user:t,params:o,body:r,ctx:a}=e,{id:i,allocationId:s}=o;if(!(null==t?void 0:t.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});if(!(0,security_1.isValidUUID)(i)||!(0,security_1.isValidUUID)(s))throw(0,error_1.createError)({statusCode:400,message:"Invalid ID format"});null==a||a.step("Validating request");const n=(0,security_1.validateFundOperation)(r);n.valid||(0,security_1.throwValidationError)(n);const{amount:d}=n.sanitized,l=r.currency;if(!l||!["BASE","QUOTE"].includes(l))throw(0,error_1.createError)({statusCode:400,message:"Currency type must be BASE or QUOTE"});null==a||a.step("Fetching subscription");const u=await db_1.models.copyTradingFollower.findByPk(i);if(!u)throw(0,error_1.createError)({statusCode:404,message:"Subscription not found"});if(u.userId!==t.id)throw(0,error_1.createError)({statusCode:403,message:"Access denied"});if("STOPPED"===u.status)throw(0,error_1.createError)({statusCode:400,message:"Cannot add funds to a stopped subscription"});null==a||a.step("Fetching allocation");const c=await db_1.models.copyTradingFollowerAllocation.findOne({where:{id:s,followerId:i}});if(!c)throw(0,error_1.createError)({statusCode:404,message:"Allocation not found"});const m=c,[p,y]=m.symbol.split("/"),f="BASE"===l?p:y;null==a||a.step("Adding funds to allocation");await db_1.sequelize.transaction(async e=>{const o=`ct_add_funds_${s}_${l}_${Date.now()}`,r=await wallet_1.walletService.transfer({idempotencyKey:o,fromUserId:t.id,toUserId:t.id,fromWalletType:"ECO",toWalletType:"COPY_TRADING",fromCurrency:f,toCurrency:f,amount:d,description:`Transfer ${d} ${f} from ECO to CT wallet (add funds to ${m.symbol})`,metadata:{followerId:i,leaderId:u.leaderId,allocationId:s,symbol:m.symbol,currencyType:l},transaction:e});"BASE"===l?await c.update({baseAmount:(0,sequelize_1.literal)(`"baseAmount" + ${d}`)},{transaction:e}):await c.update({quoteAmount:(0,sequelize_1.literal)(`"quoteAmount" + ${d}`)},{transaction:e});await(0,utils_1.createCopyTradingTransaction)({userId:t.id,leaderId:u.leaderId,followerId:i,type:"ALLOCATION",amount:d,currency:f,balanceBefore:r.fromResult.previousBalance,balanceAfter:r.fromResult.newBalance,description:`Transfer ${d} ${f} from ECO to CT wallet (add funds to ${m.symbol})`,metadata:JSON.stringify({allocationId:s,symbol:m.symbol,currencyType:l})},e);await(0,utils_1.createAuditLog)({entityType:"ALLOCATION",entityId:s,action:"ALLOCATE",oldValue:{baseAmount:m.baseAmount,quoteAmount:m.quoteAmount},newValue:{baseAmount:"BASE"===l?m.baseAmount+d:m.baseAmount,quoteAmount:"QUOTE"===l?m.quoteAmount+d:m.quoteAmount},userId:t.id},e)});await c.reload();null==a||a.success(`Added ${d} ${f} to ${m.symbol}`);return{message:`Successfully added ${d} ${f} to ${m.symbol}`,allocation:c.toJSON()}};