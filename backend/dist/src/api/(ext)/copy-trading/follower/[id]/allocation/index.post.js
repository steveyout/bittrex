"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),utils_1=require("@b/api/(ext)/copy-trading/utils"),security_1=require("@b/api/(ext)/copy-trading/utils/security"),wallet_1=require("@b/services/wallet");exports.metadata={summary:"Create Market Allocation",description:"Creates a new market allocation for a subscription. The market must be one of the leader's declared markets.",operationId:"createSubscriptionAllocation",tags:["Copy Trading","Followers","Allocations"],requiresAuth:!0,logModule:"COPY",logTitle:"Create allocation",middleware:["copyTradingFunds"],parameters:[{name:"id",in:"path",required:!0,schema:{type:"string",format:"uuid"},description:"Subscription (follower) ID"}],requestBody:{required:!0,content:{"application/json":{schema:{type:"object",properties:{symbol:{type:"string",description:"Market symbol (e.g., BTC/USDT)"},baseAmount:{type:"number",minimum:0,description:"Initial base currency amount for selling"},quoteAmount:{type:"number",minimum:0,description:"Initial quote currency amount for buying"}},required:["symbol"]}}}},responses:{200:{description:"Allocation created successfully",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"},allocation:{type:"object"}}}}}},400:{description:"Bad Request"},401:{description:"Unauthorized"},403:{description:"Forbidden"},404:{description:"Subscription not found"},429:{description:"Too Many Requests"},500:{description:"Internal Server Error"}}};exports.default=async e=>{const{user:r,params:t,body:o,ctx:a}=e,{id:s}=t,{symbol:i,baseAmount:n=0,quoteAmount:l=0}=o;if(!(null==r?void 0:r.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});if(!(0,security_1.isValidUUID)(s))throw(0,error_1.createError)({statusCode:400,message:"Invalid subscription ID"});if(!i||"string"!=typeof i)throw(0,error_1.createError)({statusCode:400,message:"Symbol is required"});const c=i.split("/");if(2!==c.length)throw(0,error_1.createError)({statusCode:400,message:"Invalid symbol format. Use BASE/QUOTE (e.g., BTC/USDT)"});const[d,u]=c;null==a||a.step("Fetching subscription");const m=await db_1.models.copyTradingFollower.findByPk(s);if(!m)throw(0,error_1.createError)({statusCode:404,message:"Subscription not found"});if(m.userId!==r.id)throw(0,error_1.createError)({statusCode:403,message:"Access denied"});if("STOPPED"===m.status)throw(0,error_1.createError)({statusCode:400,message:"Cannot add allocations to a stopped subscription"});null==a||a.step("Verifying leader market");const p=await db_1.models.copyTradingLeaderMarket.findOne({where:{leaderId:m.leaderId,symbol:i,isActive:!0}});if(!p)throw(0,error_1.createError)({statusCode:400,message:`Market ${i} is not available for this leader`});const y=p.minBase||0,f=p.minQuote||0,b=Number(n)||0,w=Number(l)||0;if(y>0&&b>0&&b<y)throw(0,error_1.createError)({statusCode:400,message:`${i}: Minimum ${d} allocation is ${y}`});if(f>0&&w>0&&w<f)throw(0,error_1.createError)({statusCode:400,message:`${i}: Minimum ${u} allocation is ${f}`});null==a||a.step("Checking for existing allocation");if(await db_1.models.copyTradingFollowerAllocation.findOne({where:{followerId:s,symbol:i}}))throw(0,error_1.createError)({statusCode:400,message:`You already have an allocation for ${i}. Use add-funds to increase it.`});if(b<0||w<0)throw(0,error_1.createError)({statusCode:400,message:"Amounts cannot be negative"});if(0===b&&0===w)throw(0,error_1.createError)({statusCode:400,message:"At least one of baseAmount or quoteAmount must be greater than 0"});null==a||a.step("Creating allocation");let C;const g=`ct_allocation_${s}_${i}_${Date.now()}`;await db_1.sequelize.transaction(async e=>{if(b>0){null==a||a.step(`Transferring ${b} ${d} from ECO to COPY_TRADING wallet`);const t=await wallet_1.walletService.transfer({idempotencyKey:`${g}_base`,fromUserId:r.id,toUserId:r.id,fromWalletType:"ECO",toWalletType:"COPY_TRADING",fromCurrency:d,toCurrency:d,amount:b,description:`Transfer ${b} ${d} from ECO to CT wallet (allocate to ${i})`,metadata:{symbol:i,currencyType:"BASE",followerId:s,leaderId:m.leaderId},transaction:e});await(0,utils_1.createCopyTradingTransaction)({userId:r.id,leaderId:m.leaderId,followerId:s,type:"ALLOCATION",amount:b,currency:d,balanceBefore:t.fromResult.previousBalance,balanceAfter:t.fromResult.newBalance,description:`Transfer ${b} ${d} from ECO to CT wallet (allocate to ${i})`,metadata:JSON.stringify({symbol:i,currencyType:"BASE"})},e)}if(w>0){null==a||a.step(`Transferring ${w} ${u} from ECO to COPY_TRADING wallet`);const t=await wallet_1.walletService.transfer({idempotencyKey:`${g}_quote`,fromUserId:r.id,toUserId:r.id,fromWalletType:"ECO",toWalletType:"COPY_TRADING",fromCurrency:u,toCurrency:u,amount:w,description:`Transfer ${w} ${u} from ECO to CT wallet (allocate to ${i})`,metadata:{symbol:i,currencyType:"QUOTE",followerId:s,leaderId:m.leaderId},transaction:e});await(0,utils_1.createCopyTradingTransaction)({userId:r.id,leaderId:m.leaderId,followerId:s,type:"ALLOCATION",amount:w,currency:u,balanceBefore:t.fromResult.previousBalance,balanceAfter:t.fromResult.newBalance,description:`Transfer ${w} ${u} from ECO to CT wallet (allocate to ${i})`,metadata:JSON.stringify({symbol:i,currencyType:"QUOTE"})},e)}C=await db_1.models.copyTradingFollowerAllocation.create({followerId:s,symbol:i,baseCurrency:d,quoteCurrency:u,baseAmount:b,quoteAmount:w,baseUsedAmount:0,quoteUsedAmount:0,totalProfit:0,totalTrades:0,winRate:0,isActive:!0},{transaction:e});await(0,utils_1.createAuditLog)({entityType:"ALLOCATION",entityId:C.id,action:"CREATE",newValue:{symbol:i,baseAmount:b,quoteAmount:w},userId:r.id},e)});null==a||a.success(`Created allocation for ${i}`);return{message:`Successfully created allocation for ${i}`,allocation:C.toJSON()}};