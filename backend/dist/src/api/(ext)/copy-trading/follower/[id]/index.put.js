"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),utils_1=require("@b/api/(ext)/copy-trading/utils"),security_1=require("@b/api/(ext)/copy-trading/utils/security");exports.metadata={summary:"Update Subscription Settings",description:"Updates the settings for a subscription.",operationId:"updateCopyTradingSubscription",tags:["Copy Trading","Followers"],requiresAuth:!0,logModule:"COPY",logTitle:"Update subscription",middleware:["copyTradingFollowerAction"],parameters:[{name:"id",in:"path",required:!0,schema:{type:"string",format:"uuid"},description:"Subscription ID"}],requestBody:{required:!0,content:{"application/json":{schema:{type:"object",properties:{copyMode:{type:"string",enum:["PROPORTIONAL","FIXED_AMOUNT","FIXED_RATIO"]},fixedAmount:{type:"number",minimum:.01},fixedRatio:{type:"number",minimum:.01,maximum:10},maxDailyLoss:{type:"number",minimum:0,maximum:100},maxPositionSize:{type:"number",minimum:0,maximum:100},stopLossPercent:{type:"number",minimum:0,maximum:100},takeProfitPercent:{type:"number",minimum:0,maximum:1e3}}}}}},responses:{200:{description:"Subscription updated successfully",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"},subscription:{type:"object"}}}}}},400:{description:"Bad Request"},401:{description:"Unauthorized"},403:{description:"Forbidden"},404:{description:"Subscription not found"},429:{description:"Too Many Requests"},500:{description:"Internal Server Error"}}};exports.default=async e=>{var t,i,r;const{user:o,params:s,body:a,ctx:n}=e,{id:u}=s;if(!(null==o?void 0:o.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});if(!(0,security_1.isValidUUID)(u))throw(0,error_1.createError)({statusCode:400,message:"Invalid subscription ID"});null==n||n.step("Validating request");const d=(0,security_1.validateSubscriptionUpdate)(a);d.valid||(0,security_1.throwValidationError)(d);null==n||n.step("Fetching subscription");const p=await db_1.models.copyTradingFollower.findByPk(u);if(!p)throw(0,error_1.createError)({statusCode:404,message:"Subscription not found"});if(p.userId!==o.id)throw(0,error_1.createError)({statusCode:403,message:"Access denied"});if("STOPPED"===p.status)throw(0,error_1.createError)({statusCode:400,message:"Cannot update a stopped subscription"});const c={},m={},l=["copyMode","fixedAmount","fixedRatio","maxDailyLoss","maxPositionSize","stopLossPercent","takeProfitPercent"];for(const e of l)if(void 0!==d.sanitized[e]){m[e]=p[e];c[e]=d.sanitized[e]}const y=null!==(t=c.copyMode)&&void 0!==t?t:p.copyMode;if("FIXED_AMOUNT"===y){const e=null!==(i=c.fixedAmount)&&void 0!==i?i:p.fixedAmount;if(!e||e<=0)throw(0,error_1.createError)({statusCode:400,message:"Fixed amount is required for FIXED_AMOUNT mode"})}if("FIXED_RATIO"===y){const e=null!==(r=c.fixedRatio)&&void 0!==r?r:p.fixedRatio;if(!e||e<=0)throw(0,error_1.createError)({statusCode:400,message:"Fixed ratio is required for FIXED_RATIO mode"})}null==n||n.step("Updating subscription");await p.update(c);await(0,utils_1.createAuditLog)({entityType:"FOLLOWER",entityId:u,action:"UPDATE",oldValue:m,newValue:c,userId:o.id});null==n||n.success("Subscription updated");return{message:"Subscription updated successfully",subscription:p.toJSON()}};