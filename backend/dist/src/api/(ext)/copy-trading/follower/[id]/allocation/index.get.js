"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),security_1=require("@b/api/(ext)/copy-trading/utils/security");exports.metadata={summary:"Get Subscription Allocations",description:"Retrieves all market allocations for a subscription.",operationId:"getSubscriptionAllocations",tags:["Copy Trading","Followers","Allocations"],requiresAuth:!0,logModule:"COPY",logTitle:"Get allocations",parameters:[{name:"id",in:"path",required:!0,schema:{type:"string",format:"uuid"},description:"Subscription (follower) ID"}],responses:{200:{description:"Allocations retrieved successfully",content:{"application/json":{schema:{type:"array",items:{type:"object"}}}}},401:{description:"Unauthorized"},403:{description:"Forbidden"},404:{description:"Subscription not found"},500:{description:"Internal Server Error"}}};exports.default=async e=>{const{user:r,params:o,ctx:t}=e,{id:s}=o;if(!(null==r?void 0:r.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});if(!(0,security_1.isValidUUID)(s))throw(0,error_1.createError)({statusCode:400,message:"Invalid subscription ID"});null==t||t.step("Fetching subscription");const i=await db_1.models.copyTradingFollower.findByPk(s);if(!i)throw(0,error_1.createError)({statusCode:404,message:"Subscription not found"});if(i.userId!==r.id)throw(0,error_1.createError)({statusCode:403,message:"Access denied"});null==t||t.step("Fetching allocations");const a=await db_1.models.copyTradingFollowerAllocation.findAll({where:{followerId:s},order:[["symbol","ASC"]]});null==t||t.success(`Found ${a.length} allocations`);return a.map(e=>e.toJSON())};