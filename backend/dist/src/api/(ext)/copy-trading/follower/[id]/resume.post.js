"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),utils_1=require("@b/api/(ext)/copy-trading/utils"),security_1=require("@b/api/(ext)/copy-trading/utils/security");exports.metadata={summary:"Resume Subscription",description:"Resumes a paused subscription.",operationId:"resumeCopyTradingSubscription",tags:["Copy Trading","Followers"],requiresAuth:!0,logModule:"COPY",logTitle:"Resume subscription",middleware:["copyTradingFollowerAction"],parameters:[{name:"id",in:"path",required:!0,schema:{type:"string",format:"uuid"},description:"Subscription ID"}],responses:{200:{description:"Subscription resumed successfully",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"},subscription:{type:"object"}}}}}},400:{description:"Bad Request"},401:{description:"Unauthorized"},403:{description:"Forbidden"},404:{description:"Subscription not found"},429:{description:"Too Many Requests"},500:{description:"Internal Server Error"}}};exports.default=async e=>{const{user:r,params:s,ctx:t}=e,{id:i}=s;if(!(null==r?void 0:r.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});if(!(0,security_1.isValidUUID)(i))throw(0,error_1.createError)({statusCode:400,message:"Invalid subscription ID"});null==t||t.step("Fetching subscription");const o=await db_1.models.copyTradingFollower.findByPk(i,{include:[{model:db_1.models.copyTradingLeader,as:"leader"}]});if(!o)throw(0,error_1.createError)({statusCode:404,message:"Subscription not found"});if(o.userId!==r.id)throw(0,error_1.createError)({statusCode:403,message:"Access denied"});if("PAUSED"!==o.status)throw(0,error_1.createError)({statusCode:400,message:"Only paused subscriptions can be resumed"});const a=o.leader;if(!a||"ACTIVE"!==a.status)throw(0,error_1.createError)({statusCode:400,message:"Cannot resume - leader is no longer active"});null==t||t.step("Resuming subscription");const u=o.status;await o.update({status:"ACTIVE"});await(0,utils_1.createAuditLog)({entityType:"FOLLOWER",entityId:i,action:"RESUME",oldValue:{status:u},newValue:{status:"ACTIVE"},userId:r.id});null==t||t.step("Sending notification");await(0,utils_1.notifyFollowerSubscriptionEvent)(i,"RESUMED",void 0,t);null==t||t.success("Subscription resumed");return{message:"Subscription resumed successfully",subscription:o.toJSON()}};