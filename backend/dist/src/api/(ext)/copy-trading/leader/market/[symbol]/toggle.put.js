"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),utils_1=require("@b/api/(ext)/copy-trading/utils"),wallet_1=require("@b/services/wallet"),sequelize_1=require("sequelize");exports.metadata={summary:"Toggle leader market status",description:"Enables or disables a market for the leader. When disabling a market with follower allocations, refunds are automatically processed.",operationId:"toggleLeaderMarket",tags:["Copy Trading","Leader"],requiresAuth:!0,logModule:"COPY",logTitle:"Toggle leader market",parameters:[{name:"symbol",in:"path",required:!0,schema:{type:"string"},description:"Market symbol (URL encoded, e.g., BTC%2FUSDT)"}],requestBody:{required:!0,content:{"application/json":{schema:{type:"object",properties:{isActive:{type:"boolean",description:"Whether to enable (true) or disable (false) the market"}},required:["isActive"]}}}},responses:{200:{description:"Market status toggled successfully",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"},message:{type:"string"},market:{type:"object"},refundedAllocations:{type:"number"}}}}}},400:{description:"Bad Request - Has open positions"},401:{description:"Unauthorized"},404:{description:"Leader or Market not found"}}};exports.default=async e=>{const{user:t,params:a,body:r,ctx:s}=e;if(!(null==t?void 0:t.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});const o=decodeURIComponent(a.symbol),{isActive:i}=r;if("boolean"!=typeof i)throw(0,error_1.createError)({statusCode:400,message:"isActive must be a boolean"});null==s||s.step("Finding leader profile");const l=await db_1.models.copyTradingLeader.findOne({where:{userId:t.id}});if(!l)throw(0,error_1.createError)({statusCode:404,message:"Leader not found"});const n=l.id,d=o.split("/");if(2!==d.length)throw(0,error_1.createError)({statusCode:400,message:"Invalid symbol format. Use BASE/QUOTE (e.g., BTC/USDT)"});const[c,u]=d;null==s||s.step("Finding market");let m=await db_1.models.copyTradingLeaderMarket.findOne({where:{leaderId:n,symbol:o}});if(i&&!m){null==s||s.step("Validating market exists in ecosystem");if(!await db_1.models.ecosystemMarket.findOne({where:{currency:c,pair:u,status:!0}}))throw(0,error_1.createError)({statusCode:400,message:`Market ${o} not found or inactive in ecosystem`});null==s||s.step("Creating new market entry");m=await db_1.models.copyTradingLeaderMarket.create({leaderId:n,symbol:o,baseCurrency:c,quoteCurrency:u,isActive:!0});await(0,utils_1.createAuditLog)({entityType:"LEADER",entityId:n,action:"UPDATE",newValue:{symbol:o,baseCurrency:c,quoteCurrency:u,isActive:!0},userId:t.id,reason:"Market enabled"});null==s||s.success("Market enabled");return{success:!0,message:`Market ${o} enabled`,market:m,refundedAllocations:0}}if(!m)throw(0,error_1.createError)({statusCode:404,message:"Market not found"});if(m.isActive===i)return{success:!0,message:`Market ${o} is already ${i?"enabled":"disabled"}`,market:m,refundedAllocations:0};if(!i){null==s||s.step("Checking for open positions");const e=await db_1.models.copyTradingTrade.count({where:{leaderId:n,symbol:o,status:{[sequelize_1.Op.in]:["OPEN","PENDING","PARTIALLY_FILLED"]}}});if(e>0)throw(0,error_1.createError)({statusCode:400,message:`Cannot disable market with ${e} open positions. Please close all positions first.`});null==s||s.step("Finding follower allocations to refund");const a=await db_1.models.copyTradingFollowerAllocation.findAll({where:{symbol:o,isActive:!0},include:[{model:db_1.models.copyTradingFollower,as:"follower",where:{leaderId:n},attributes:["id","userId"]}]});let r=0;if(a.length>0){null==s||s.step(`Refunding ${a.length} follower allocations`);await db_1.sequelize.transaction(async e=>{for(const t of a){const a=t,s=a.follower,i=Math.max(0,a.baseAmount-a.baseUsedAmount),l=Math.max(0,a.quoteAmount-a.quoteUsedAmount);if(i>0){const t=`ct_toggle_base_${a.id}`,r=await wallet_1.walletService.transfer({idempotencyKey:t,fromUserId:s.userId,toUserId:s.userId,fromWalletType:"COPY_TRADING",toWalletType:"ECO",fromCurrency:c,toCurrency:c,amount:i,description:`Transfer ${i} ${c} from CT to ECO wallet (leader disabled ${o})`,metadata:{allocationId:a.id,symbol:o,reason:"LEADER_MARKET_DISABLED"},transaction:e});await(0,utils_1.createCopyTradingTransaction)({userId:s.userId,leaderId:n,followerId:s.id,type:"DEALLOCATION",amount:-i,currency:c,balanceBefore:r.fromResult.previousBalance,balanceAfter:r.fromResult.newBalance,description:`Transfer ${i} ${c} from CT to ECO wallet (leader disabled ${o})`,metadata:JSON.stringify({allocationId:a.id,symbol:o,reason:"LEADER_MARKET_DISABLED"})},e);await(0,utils_1.createCopyTradingTransaction)({userId:s.userId,leaderId:n,followerId:s.id,type:"DEALLOCATION",amount:i,currency:c,balanceBefore:r.toResult.previousBalance,balanceAfter:r.toResult.newBalance,description:`Received ${i} ${c} in ECO wallet (leader disabled ${o})`,metadata:JSON.stringify({allocationId:a.id,symbol:o,reason:"LEADER_MARKET_DISABLED"})},e)}if(l>0){const t=`ct_toggle_quote_${a.id}`,r=await wallet_1.walletService.transfer({idempotencyKey:t,fromUserId:s.userId,toUserId:s.userId,fromWalletType:"COPY_TRADING",toWalletType:"ECO",fromCurrency:u,toCurrency:u,amount:l,description:`Transfer ${l} ${u} from CT to ECO wallet (leader disabled ${o})`,metadata:{allocationId:a.id,symbol:o,reason:"LEADER_MARKET_DISABLED"},transaction:e});await(0,utils_1.createCopyTradingTransaction)({userId:s.userId,leaderId:n,followerId:s.id,type:"DEALLOCATION",amount:-l,currency:u,balanceBefore:r.fromResult.previousBalance,balanceAfter:r.fromResult.newBalance,description:`Transfer ${l} ${u} from CT to ECO wallet (leader disabled ${o})`,metadata:JSON.stringify({allocationId:a.id,symbol:o,reason:"LEADER_MARKET_DISABLED"})},e);await(0,utils_1.createCopyTradingTransaction)({userId:s.userId,leaderId:n,followerId:s.id,type:"DEALLOCATION",amount:l,currency:u,balanceBefore:r.toResult.previousBalance,balanceAfter:r.toResult.newBalance,description:`Received ${l} ${u} in ECO wallet (leader disabled ${o})`,metadata:JSON.stringify({allocationId:a.id,symbol:o,reason:"LEADER_MARKET_DISABLED"})},e)}await a.update({isActive:!1,baseAmount:a.baseUsedAmount,quoteAmount:a.quoteUsedAmount},{transaction:e});r++}await m.update({isActive:!1},{transaction:e})});await(0,utils_1.createAuditLog)({entityType:"LEADER",entityId:n,action:"UPDATE",oldValue:{symbol:o,isActive:!0},newValue:{symbol:o,isActive:!1,refundedAllocations:r},userId:t.id,reason:`Market disabled, ${r} allocations refunded`});null==s||s.success(`Market disabled, ${r} allocations refunded`);return{success:!0,message:`Market ${o} disabled. ${r} follower allocation(s) refunded.`,market:await m.reload(),refundedAllocations:r}}await m.update({isActive:!1});await(0,utils_1.createAuditLog)({entityType:"LEADER",entityId:n,action:"UPDATE",oldValue:{symbol:o,isActive:!0},newValue:{symbol:o,isActive:!1},userId:t.id,reason:"Market disabled"});null==s||s.success("Market disabled");return{success:!0,message:`Market ${o} disabled`,market:m,refundedAllocations:0}}null==s||s.step("Enabling market");await m.update({isActive:!0});await(0,utils_1.createAuditLog)({entityType:"LEADER",entityId:n,action:"UPDATE",oldValue:{symbol:o,isActive:!1},newValue:{symbol:o,isActive:!0},userId:t.id,reason:"Market enabled"});null==s||s.success("Market enabled");return{success:!0,message:`Market ${o} enabled`,market:m,refundedAllocations:0}};