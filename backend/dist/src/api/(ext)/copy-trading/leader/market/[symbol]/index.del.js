"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),utils_1=require("@b/api/(ext)/copy-trading/utils"),sequelize_1=require("sequelize"),console_1=require("@b/utils/console");exports.metadata={summary:"Remove a market from leader's list",description:"Deactivates a market from the leader's declared trading markets. Cannot remove markets with open positions. Followers' allocations for this market will be deactivated.",operationId:"removeLeaderMarket",tags:["Copy Trading","Leader"],requiresAuth:!0,logModule:"COPY",logTitle:"Remove leader market",parameters:[{name:"symbol",in:"path",required:!0,schema:{type:"string"},description:"Market symbol (URL encoded, e.g., BTC%2FUSDT)"}],responses:{200:{description:"Market removed successfully",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"},message:{type:"string"},deactivatedAllocations:{type:"number"}}}}}},400:{description:"Bad Request - Has open positions"},401:{description:"Unauthorized"},404:{description:"Leader or Market not found"}}};exports.default=async e=>{const{user:t,params:o,ctx:r}=e;if(!(null==t?void 0:t.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});const a=decodeURIComponent(o.symbol);null==r||r.step("Finding leader profile");const s=await db_1.models.copyTradingLeader.findOne({where:{userId:t.id}});if(!s)throw(0,error_1.createError)({statusCode:404,message:"Leader not found"});const i=s.id;null==r||r.step("Checking for open positions");const l=await db_1.models.copyTradingTrade.count({where:{leaderId:i,symbol:a,status:{[sequelize_1.Op.in]:["OPEN","PENDING","PARTIALLY_FILLED"]}}});if(l>0)throw(0,error_1.createError)({statusCode:400,message:`Cannot remove market with ${l} open positions. Please close all trades first.`});null==r||r.step("Finding market");const d=await db_1.models.copyTradingLeaderMarket.findOne({where:{leaderId:i,symbol:a}});if(!d)throw(0,error_1.createError)({statusCode:404,message:"Market not found"});null==r||r.step("Deactivating market");await d.update({isActive:!1});null==r||r.step("Deactivating follower allocations");let n=0;try{const e=(await db_1.models.copyTradingFollower.findAll({where:{leaderId:i},attributes:["id"]})).map(e=>e.id);if(e.length>0){const[t]=await db_1.models.copyTradingFollowerAllocation.update({isActive:!1},{where:{followerId:{[sequelize_1.Op.in]:e},symbol:a,isActive:!0}});n=t;n>0&&console_1.logger.info("COPY_TRADING",`Deactivated ${n} follower allocations for ${a} when leader ${i} removed market`)}}catch(e){console_1.logger.error("COPY_TRADING",`Error deactivating follower allocations: ${e.message}`)}await(0,utils_1.createAuditLog)({entityType:"LEADER",entityId:i,action:"UPDATE",oldValue:{symbol:a,isActive:!0},newValue:{symbol:a,isActive:!1,deactivatedAllocations:n},userId:t.id,reason:"Market removed"});null==r||r.success("Market removed");return{success:!0,message:`Market removed successfully. ${n} follower allocation(s) deactivated.`,deactivatedAllocations:n}};