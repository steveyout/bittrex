"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),utils_1=require("@b/api/(ext)/copy-trading/utils");exports.metadata={summary:"Update leader market settings",description:"Update settings for a market, such as minimum allocation amounts for base and quote currencies.",operationId:"updateLeaderMarket",tags:["Copy Trading","Leader"],requiresAuth:!0,logModule:"COPY",logTitle:"Update leader market",parameters:[{name:"symbol",in:"path",required:!0,schema:{type:"string"},description:"Market symbol (URL encoded, e.g., BTC%2FUSDT)"}],requestBody:{required:!0,content:{"application/json":{schema:{type:"object",properties:{minBase:{type:"number",description:"Minimum base currency allocation amount"},minQuote:{type:"number",description:"Minimum quote currency allocation amount"}}}}}},responses:{200:{description:"Market updated successfully",content:{"application/json":{schema:{type:"object",properties:{id:{type:"string"},symbol:{type:"string"},baseCurrency:{type:"string"},quoteCurrency:{type:"string"},minBase:{type:"number"},minQuote:{type:"number"},isActive:{type:"boolean"}}}}}},400:{description:"Bad Request"},401:{description:"Unauthorized"},404:{description:"Leader or Market not found"}}};exports.default=async e=>{const{user:t,params:r,body:o,ctx:a}=e;if(!(null==t?void 0:t.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});const s=decodeURIComponent(r.symbol),{minBase:n,minQuote:i}=o;null==a||a.step("Finding leader profile");const d=await db_1.models.copyTradingLeader.findOne({where:{userId:t.id,status:"ACTIVE"}});if(!d)throw(0,error_1.createError)({statusCode:404,message:"Active leader profile not found"});const u=d.id;null==a||a.step("Finding market");const p=await db_1.models.copyTradingLeaderMarket.findOne({where:{leaderId:u,symbol:s}});if(!p)throw(0,error_1.createError)({statusCode:404,message:"Market not found"});const c={minBase:p.minBase,minQuote:p.minQuote};null==a||a.step("Updating market settings");const m={};"number"==typeof n&&n>=0&&(m.minBase=n);"number"==typeof i&&i>=0&&(m.minQuote=i);if(0===Object.keys(m).length)throw(0,error_1.createError)({statusCode:400,message:"No valid fields to update"});await p.update(m);await(0,utils_1.createAuditLog)({entityType:"LEADER",entityId:u,action:"UPDATE",oldValue:c,newValue:m,userId:t.id,reason:"Market settings updated"});null==a||a.success("Market settings updated");return p};