"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),sequelize_1=require("sequelize"),stats_calculator_1=require("@b/api/(ext)/copy-trading/utils/stats-calculator");exports.metadata={summary:"Get Copy Trading Leader Details",description:"Retrieves detailed information about a specific leader.",operationId:"getCopyTradingLeader",tags:["Copy Trading","Leaders"],requiresAuth:!1,logModule:"COPY",logTitle:"Get leader details",parameters:[{name:"id",in:"path",required:!0,schema:{type:"string"},description:"Leader ID"}],responses:{200:{description:"Leader details retrieved successfully",content:{"application/json":{schema:{type:"object"}}}},404:{description:"Leader not found"},500:{description:"Internal Server Error"}}};exports.default=async e=>{const{params:t,user:r,ctx:a}=e,{id:s}=t;null==a||a.step("Fetching leader");const d=await db_1.models.copyTradingLeader.findOne({where:{id:s,status:"ACTIVE"},include:[{model:db_1.models.user,as:"user",attributes:["id","firstName","lastName","avatar"]},{model:db_1.models.copyTradingLeaderMarket,as:"markets",where:{isActive:!0},required:!1}]});if(!d)throw(0,error_1.createError)({statusCode:404,message:"Leader not found"});const i=(null==r?void 0:r.id)===d.userId;if(!d.isPublic&&!i)throw(0,error_1.createError)({statusCode:404,message:"Leader not found"});null==a||a.step("Fetching daily stats");const o=new Date;o.setDate(o.getDate()-30);const l=await db_1.models.copyTradingLeaderStats.findAll({where:{leaderId:s,date:{[sequelize_1.Op.gte]:o.toISOString().split("T")[0]}},order:[["date","ASC"]]});null==a||a.step("Fetching recent trades");const n=await db_1.models.copyTradingTrade.findAll({where:{leaderId:s,isLeaderTrade:!0,status:"CLOSED"},order:[["closedAt","DESC"]],limit:10});null==a||a.step("Checking user follow status");let u=!1,c=null,p=null;if((null==r?void 0:r.id)&&!i){const e=await db_1.models.copyTradingFollower.findOne({where:{userId:r.id,leaderId:s,status:{[sequelize_1.Op.in]:["ACTIVE","PAUSED"]}}});if(e){u=!0;c=e.id;p=e.status}}null==a||a.step("Calculating leader stats");const m=await(0,stats_calculator_1.getLeaderStats)(s);null==a||a.success("Leader details retrieved");return{...d.toJSON(),...m,dailyStats:l.map(e=>e.toJSON()),recentTrades:n.map(e=>({id:e.id,symbol:e.symbol,side:e.side,profit:e.profit,profitPercent:e.profitPercent,closedAt:e.closedAt})),isFollowing:u,followerId:c,followerStatus:p,isOwnProfile:i}};