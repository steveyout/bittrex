"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error");exports.metadata={summary:"Get Copy Trade Details",description:"Retrieves detailed information about a specific copy trade.",operationId:"getCopyTradeDetails",tags:["Copy Trading","Trades"],requiresAuth:!0,logModule:"COPY",logTitle:"Get trade details",parameters:[{name:"id",in:"path",required:!0,schema:{type:"string"},description:"Trade ID"}],responses:{200:{description:"Trade details retrieved successfully",content:{"application/json":{schema:{type:"object"}}}},401:{description:"Unauthorized"},403:{description:"Forbidden"},404:{description:"Trade not found"},500:{description:"Internal Server Error"}}};exports.default=async e=>{var r,t;const{user:d,params:a,ctx:o}=e,{id:s}=a;if(!(null==d?void 0:d.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});null==o||o.step("Fetching trade");const i=await db_1.models.copyTradingTrade.findByPk(s,{include:[{model:db_1.models.copyTradingLeader,as:"leader",attributes:["id","displayName","userId","profitSharePercent"],include:[{model:db_1.models.user,as:"user",attributes:["id","firstName","lastName","avatar"]}]},{model:db_1.models.copyTradingFollower,as:"follower",attributes:["id","userId","allocatedAmount","currency","copyMode"]}]});if(!i)throw(0,error_1.createError)({statusCode:404,message:"Trade not found"});const l=(null===(r=i.follower)||void 0===r?void 0:r.userId)===d.id,n=(null===(t=i.leader)||void 0===t?void 0:t.userId)===d.id;if(!l&&!n)throw(0,error_1.createError)({statusCode:403,message:"Access denied"});null==o||o.step("Fetching related transactions");const c=await db_1.models.copyTradingTransaction.findAll({where:{tradeId:s},order:[["createdAt","ASC"]]});null==o||o.step("Fetching leader trade");let u=null;if(i.leaderTradeId){const e=await db_1.models.copyTradingTrade.findByPk(i.leaderTradeId,{attributes:["id","symbol","side","type","amount","price","cost","status","createdAt"]});e&&(u=e.toJSON())}null==o||o.success("Trade details retrieved");return{...i.toJSON(),transactions:c.map(e=>e.toJSON()),leaderTrade:u,viewerRole:n?"leader":"follower"}};