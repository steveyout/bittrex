"use strict";async function getHistoricalCandles(e,t,r,a){if(!client||!scyllaFuturesKeyspace)throw(0,error_1.createError)({statusCode:503,message:"Ecosystem extension not available"});try{const s=`\n      SELECT * FROM ${scyllaFuturesKeyspace}.candles\n      WHERE symbol = ?\n      AND interval = ?\n      AND "createdAt" >= ?\n      AND "createdAt" <= ?\n      ORDER BY "createdAt" ASC;\n    `,n=[e,t,new Date(r),new Date(a)];let l=(await client.execute(s,n,{prepare:!0})).rows.map(e=>[e.createdAt.getTime(),e.open,e.high,e.low,e.close,e.volume]);const{fillCandleGaps:o,intervalDurations:c,normalizeToIntervalBoundary:i}=await Promise.resolve().then(()=>__importStar(require("../candles"))),u=c[t]||6e4;if(0===l.length){const s=`\n        SELECT * FROM ${scyllaFuturesKeyspace}.candles\n        WHERE symbol = ?\n        AND interval = ?\n        AND "createdAt" < ?\n        ORDER BY "createdAt" DESC\n        LIMIT 1;\n      `,n=[e,t,new Date(r)],l=await client.execute(s,n,{prepare:!0});if(l.rows.length>0){const e=l.rows[0],r=e.createdAt.getTime(),s=e.close,n=i(r,t),o=[];let c=n+u;const d=500;let y=0;for(;c<=a&&y<d;){o.push([c,s,s,s,s,0]);c+=u;y++}return o}return[]}l=o(l,t,r,a,500);return l}catch(e){throw(0,error_1.createError)({statusCode:500,message:`Failed to fetch historical futures candles: ${e.message}`})}}async function getLastCandles(){if(!client||!scyllaFuturesKeyspace)throw(0,error_1.createError)({statusCode:503,message:"Ecosystem extension not available"});try{const e=`\n      SELECT symbol, interval, open, high, low, close, volume, "createdAt", "updatedAt"\n      FROM ${scyllaFuturesKeyspace}.latest_candles;\n    `,t=await client.execute(e,[],{prepare:!0}),r={};t.rows.forEach(e=>{const t=`${e.symbol}:${e.interval}`,a={symbol:e.symbol,interval:e.interval,open:e.open,high:e.high,low:e.low,close:e.close,volume:e.volume,createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt)};(!r[t]||a.createdAt>r[t].createdAt)&&(r[t]=a)});return Object.values(r)}catch(e){console.error(`Failed to fetch latest futures candles: ${e.message}`);throw(0,error_1.createError)({statusCode:500,message:`Failed to fetch latest futures candles: ${e.message}`})}}async function getLatestCandleForSymbol(e,t){if(!client||!scyllaFuturesKeyspace)return null;try{const r=`\n      SELECT symbol, interval, open, high, low, close, volume, "createdAt", "updatedAt"\n      FROM ${scyllaFuturesKeyspace}.latest_candles\n      WHERE symbol = ? AND interval = ?\n      LIMIT 1;\n    `,a=await client.execute(r,[e,t],{prepare:!0});if(0===a.rows.length)return null;const s=a.rows[0];return{symbol:s.symbol,interval:s.interval,open:s.open,high:s.high,low:s.low,close:s.close,volume:s.volume,createdAt:new Date(s.createdAt),updatedAt:new Date(s.updatedAt)}}catch(r){console.error(`Failed to fetch latest futures candle for ${e}/${t}: ${r.message}`);return null}}async function getYesterdayCandles(){if(!client||!scyllaFuturesKeyspace)throw(0,error_1.createError)({statusCode:503,message:"Ecosystem extension not available"});try{const e=new Date;e.setHours(0,0,0,0);const t=new Date(e.getTime()-864e5),r=`\n      SELECT * FROM ${scyllaFuturesKeyspace}.latest_candles\n      WHERE "createdAt" >= ? AND "createdAt" < ?;\n    `,a=await client.execute(r,[t.toISOString(),e.toISOString()],{prepare:!0}),s={};for(const e of a.rows){if("1d"!==e.interval)continue;const t={symbol:e.symbol,interval:e.interval,open:e.open,high:e.high,low:e.low,close:e.close,volume:e.volume,createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt)};s[e.symbol]||(s[e.symbol]=[]);s[e.symbol].push(t)}return s}catch(e){console.error(`Failed to fetch yesterday's futures candles: ${e.message}`);throw(0,error_1.createError)({statusCode:500,message:`Failed to fetch yesterday's futures candles: ${e.message}`})}}var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}});Object.defineProperty(e,a,s)}:function(e,t,r,a){void 0===a&&(a=r);e[a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var e=function(t){e=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t};return e(t)};return function(t){if(t&&t.__esModule)return t;var r={};if(null!=t)for(var a=e(t),s=0;s<a.length;s++)"default"!==a[s]&&__createBinding(r,t,a[s]);__setModuleDefault(r,t);return r}}();Object.defineProperty(exports,"__esModule",{value:!0});exports.getHistoricalCandles=getHistoricalCandles;exports.getLastCandles=getLastCandles;exports.getLatestCandleForSymbol=getLatestCandleForSymbol;exports.getYesterdayCandles=getYesterdayCandles;const error_1=require("@b/utils/error");let client,scyllaFuturesKeyspace,Candle;try{const e=require("@b/api/(ext)/ecosystem/utils/scylla/client");client=e.default;scyllaFuturesKeyspace=e.scyllaFuturesKeyspace;Candle=require("@b/api/(ext)/ecosystem/utils/scylla/queries").Candle}catch(e){}