"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.closePosition=exports.updatePositions=exports.calculateUnrealizedPnl=void 0;const utils_1=require("@b/api/finance/wallet/utils"),error_1=require("@b/utils/error");let fromBigIntMultiply,fromBigInt;try{const e=require("@b/api/(ext)/ecosystem/utils/blockchain");fromBigIntMultiply=e.fromBigIntMultiply;fromBigInt=e.fromBigInt}catch(e){}const positions_1=require("./queries/positions");let updateWalletBalance;try{const e=require("../../ecosystem/utils/wallet");updateWalletBalance=e.updateWalletBalance}catch(e){}const SCALE_FACTOR=BigInt(10**18),FUTURES_WALLET_TYPE="FUTURES",scaleDown=e=>Number(e)/Number(SCALE_FACTOR),scaleUp=e=>BigInt(Math.round(e*Number(SCALE_FACTOR))),calculateUnrealizedPnl=(e,t,o,s)=>{const i=scaleDown(e),a=scaleDown(o),n=scaleDown(t);return scaleUp("BUY"===s?(a-i)*n:(i-a)*n)};exports.calculateUnrealizedPnl=calculateUnrealizedPnl;const updatePositions=async(e,t,o,s)=>{await Promise.all([updateSinglePosition(e,o,s),updateSinglePosition(t,o,s)])};exports.updatePositions=updatePositions;const updateSinglePosition=async(e,t,o)=>{const s=await(0,positions_1.getPosition)(e.userId,e.symbol,e.side);s?await updateExistingPosition(s,e,t,o):await createNewPosition(e,t,o)},updateExistingPosition=async(e,t,o,s)=>{const i=scaleDown(e.amount)+scaleDown(o),a=(scaleDown(e.entryPrice)*scaleDown(e.amount)+scaleDown(t.price)*scaleDown(o))/i,n=scaleUp(i),r=scaleUp(a),l=(0,exports.calculateUnrealizedPnl)(r,n,s,t.side);await(0,positions_1.updatePositionInDB)(e.userId,e.id,r,n,l,e.stopLossPrice,e.takeProfitPrice)},createNewPosition=async(e,t,o)=>{const s=(0,exports.calculateUnrealizedPnl)(e.price,t,o,e.side);await(0,positions_1.createPosition)(e.userId,e.symbol,e.side,e.price,t,e.leverage,s,e.stopLossPrice,e.takeProfitPrice)},closePosition=async e=>{const t=await(0,positions_1.getPosition)(e.userId,e.symbol,e.side);if(!t)throw(0,error_1.createError)({statusCode:404,message:`No position found for user ${e.userId} and symbol ${e.symbol}`});{const o=fromBigIntMultiply?fromBigIntMultiply(t.unrealizedPnl,BigInt(1)):t.unrealizedPnl,s=e.symbol.split("/")[1],i=await(0,utils_1.getWallet)(e.userId,"FUTURES",s);if(!i)throw(0,error_1.createError)({statusCode:404,message:`Wallet not found for user ${e.userId} and currency ${s}`});if(!updateWalletBalance)throw(0,error_1.createError)({statusCode:500,message:"Ecosystem extension not available for wallet operations"});await updateWalletBalance(i,o,"add");await(0,positions_1.updatePositionStatus)(t.userId,t.id,"CLOSED")}};exports.closePosition=closePosition;