"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const provider_1=require("@b/api/(ext)/ecosystem/utils/provider"),smartContract_1=require("@b/api/(ext)/ecosystem/utils/smartContract"),db_1=require("@b/db"),query_1=require("@b/utils/query"),ethers_1=require("ethers"),error_1=require("@b/utils/error");exports.metadata={summary:"Get custodial wallet balances and tokens",description:"Retrieves the native token balance and all ERC-20 token balances for a specific ecosystem custodial wallet by interacting with its smart contract.",operationId:"viewEcosystemCustodialWallet",tags:["Admin","Ecosystem","Wallet"],parameters:[{index:0,name:"id",in:"path",description:"ID of the ecosystem custodial wallet",required:!0,schema:{type:"string"}}],responses:{200:{description:"Custodial wallet balances retrieved successfully",content:{"application/json":{schema:{type:"object",properties:{nativeBalance:{type:"string",description:"Native token balance"},tokenBalances:{type:"array",items:{type:"object",properties:{tokenAddress:{type:"string",description:"Token contract address"},name:{type:"string",description:"Token name"},currency:{type:"string",description:"Token currency"},icon:{type:"string",description:"Token icon URL"},balance:{type:"string",description:"Token balance"}}}}}}}}},404:(0,query_1.notFoundMetadataResponse)("Custodial Wallet"),500:query_1.serverErrorResponse},requiresAuth:!0,permission:"view.ecosystem.custodial.wallet",demoMask:["tokenBalances.tokenAddress"]};exports.default=async e=>{const{params:t,ctx:r}=e,{id:a}=t;null==r||r.step("Fetching custodial wallet balances");try{const e=await db_1.models.ecosystemCustodialWallet.findByPk(a);if(!e)throw(0,error_1.createError)({statusCode:404,message:"Custodial wallet not found"});const t=await(0,provider_1.getProvider)(e.chain);if(!t)throw(0,error_1.createError)({statusCode:503,message:"Provider not initialized"});const{abi:r}=await(0,smartContract_1.getSmartContract)("wallet","CustodialWalletERC20");if(!r)throw(0,error_1.createError)({statusCode:500,message:"Smart contract ABI not found"});const s=new ethers_1.ethers.Contract(e.address,r,t);let o;try{o=await s.getNativeBalance();void 0===o&&(o=ethers_1.ethers.parseUnits("0",18))}catch(e){console.error("Error fetching native balance:",e);o=ethers_1.ethers.parseUnits("0",18)}const n=await db_1.models.ecosystemToken.findAll({where:{chain:e.chain,status:!0},attributes:["contract","decimals","name","currency","icon"]}),i=n.map(e=>e.contract);let c;try{c=await s.getAllBalances(i);c&&0!==c.length||(c=[o,Array(i.length).fill(ethers_1.ethers.parseUnits("0",18))])}catch(e){console.error("Contract call error:",e);c=[o,Array(i.length).fill(ethers_1.ethers.parseUnits("0",18))]}const l=c[1].map((e,t)=>({tokenAddress:i[t],name:n[t].name,currency:n[t].currency,icon:n[t].icon,balance:ethers_1.ethers.formatUnits(e,n[t].decimals)}));return{nativeBalance:ethers_1.ethers.formatEther(o),tokenBalances:l}}catch(e){console.error(`Failed to retrieve custodial wallet balances and tokens: ${e.message}`);throw(0,error_1.createError)({statusCode:500,message:e.message})}};