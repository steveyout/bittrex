"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const query_1=require("@b/utils/query"),utils_1=require("../utils"),db_1=require("@b/db"),provider_1=require("@b/api/(ext)/ecosystem/utils/provider"),utxo_1=require("@b/api/(ext)/ecosystem/utils/utxo"),ethers_1=require("ethers"),chains_1=require("@b/api/(ext)/ecosystem/utils/chains"),safe_imports_1=require("@b/utils/safe-imports"),error_1=require("@b/utils/error");exports.metadata={summary:"Get master wallet details by ID",description:"Retrieves comprehensive information about a specific ecosystem master wallet including its current balance, associated custodial wallets, and configuration details. Balance is fetched in real-time from the blockchain.",operationId:"getEcosystemMasterWalletById",tags:["Admin","Ecosystem","Wallet"],parameters:[{index:0,name:"id",in:"path",required:!0,description:"ID of the ecosystem master wallet to retrieve",schema:{type:"string"}}],responses:{200:{description:"Ecosystem master wallet details",content:{"application/json":{schema:{type:"object",properties:utils_1.baseEcosystemMasterWalletSchema}}}},401:query_1.unauthorizedResponse,404:(0,query_1.notFoundMetadataResponse)("Ecosystem Master Wallet"),500:query_1.serverErrorResponse},permission:"view.ecosystem.master.wallet",requiresAuth:!0,demoMask:["address","ecosystemCustodialWallets.address"]};exports.default=async e=>{const{params:t,ctx:a}=e;null==a||a.step("Fetching master wallet details");const s=await db_1.models.ecosystemMasterWallet.findByPk(t.id,{include:[{model:db_1.models.ecosystemCustodialWallet,as:"ecosystemCustodialWallets",attributes:["id","address","status"]}]});if(!s)throw(0,error_1.createError)({statusCode:404,message:`Ecosystem master wallet not found: ${t.id}`});await getWalletBalance(s);const r=await db_1.models.ecosystemMasterWallet.findByPk(t.id,{include:[{model:db_1.models.ecosystemCustodialWallet,as:"ecosystemCustodialWallets",attributes:["id","address","status"]}]});if(!r)throw(0,error_1.createError)({statusCode:404,message:`Ecosystem master wallet not found: ${t.id}`});null==a||a.success("Retrieved master wallet successfully");return r.get({plain:!0})};const getWalletBalance=async e=>{var t,a,s;try{let r;if("SOL"===e.chain){const t=await(0,safe_imports_1.getSolanaService)();if(!t)throw(0,error_1.createError)({statusCode:503,message:"Solana service not available"});const a=await t.getInstance();r=await a.getBalance(e.address)}else if("TRON"===e.chain){const t=await(0,safe_imports_1.getTronService)();if(!t)throw(0,error_1.createError)({statusCode:503,message:"Tron service not available"});const a=await t.getInstance();r=await a.getBalance(e.address)}else if("XMR"===e.chain){const i=await(0,safe_imports_1.getMoneroService)();if(!i){console.log(`[${e.chain}] Monero service not available - skipping balance fetch`);return}try{const e=await i.getInstance();r=await e.getBalance("master_wallet")}catch(r){(null===(t=r.message)||void 0===t?void 0:t.includes("not active"))||(null===(a=r.message)||void 0===a?void 0:a.includes("not synchronized"))?console.log(`[${e.chain}] ${r.message} - skipping balance fetch`):console.log(`[${e.chain}] Error fetching balance: ${null===(s=r.message)||void 0===s?void 0:s.substring(0,100)}`);return}}else if("TON"===e.chain){const t=await(0,safe_imports_1.getTonService)();if(!t)throw(0,error_1.createError)({statusCode:503,message:"TON service not available"});const a=await t.getInstance();r=await a.getBalance(e.address)}else if(["BTC","LTC","DOGE","DASH"].includes(e.chain))r=await(0,utxo_1.fetchUTXOWalletBalance)(e.chain,e.address);else{const t=await(0,provider_1.getProvider)(e.chain),a=await t.getBalance(e.address),s=chains_1.chainConfigs[e.chain].decimals;r=ethers_1.ethers.formatUnits(a.toString(),s)}if(!r||isNaN(parseFloat(r))){console.error(`Invalid formatted balance for ${e.chain} wallet: ${r}`);return}if(0===parseFloat(r))return;await(0,utils_1.updateMasterWalletBalance)(e.id,parseFloat(r))}catch(t){console.error(`Failed to fetch ${e.chain} wallet balance: ${t.message}`)}};