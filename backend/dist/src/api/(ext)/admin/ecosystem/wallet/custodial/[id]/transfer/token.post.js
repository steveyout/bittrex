"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),custodialWallet_1=require("@b/api/(ext)/ecosystem/utils/custodialWallet"),provider_1=require("@b/api/(ext)/ecosystem/utils/provider"),ethers_1=require("ethers"),encrypt_1=require("@b/utils/encrypt"),query_1=require("@b/utils/query"),error_1=require("@b/utils/error");exports.metadata={summary:"Transfer ERC-20 tokens from custodial wallet",description:"Transfers ERC-20 compatible tokens from an ecosystem custodial wallet to a specified recipient address. Supports any standard ERC-20 token on the wallet's blockchain.",operationId:"transferTokensEcosystemCustodialWallet",tags:["Admin","Ecosystem","Wallet"],parameters:[{index:0,name:"id",in:"path",description:"Ecosystem Custodial Wallet ID",required:!0,schema:{type:"string"}}],requestBody:{required:!0,content:{"application/json":{schema:{type:"object",properties:{tokenAddress:{type:"string",description:"ERC-20 token contract address"},recipient:{type:"string",description:"Recipient address"},amount:{type:"string",description:"Amount to transfer in the token's smallest unit (considering token decimals)"}},required:["id","tokenAddress","recipient","amount"]}}}},responses:{200:{description:"ERC-20 tokens transferred successfully",content:{"application/json":{schema:{type:"object",properties:{transactionHash:{type:"string",description:"Transaction hash"}}}}}},401:query_1.unauthorizedResponse,404:(0,query_1.notFoundMetadataResponse)("Custodial Wallet"),500:query_1.serverErrorResponse},requiresAuth:!0,permission:"access.ecosystem.custodial.wallet",logModule:"ADMIN_ECO",logTitle:"Transfer ERC-20 Tokens"};exports.default=async e=>{const{user:t,body:s,params:r,ctx:a}=e;if(!t)throw(0,error_1.createError)({statusCode:401,message:"Authentication required to transfer tokens"});const{id:o}=r,{tokenAddress:n,recipient:i,amount:l}=s;try{null==a||a.step("Fetching Custodial Wallet");const e=await db_1.models.ecosystemCustodialWallet.findByPk(o);if(!e)throw(0,error_1.createError)({statusCode:404,message:"Custodial wallet not found"});null==a||a.step("Fetching Master Wallet");const t=await db_1.models.ecosystemMasterWallet.findByPk(e.masterWalletId);if(!t)throw(0,error_1.createError)({statusCode:404,message:"Master wallet not found"});if(!t.data)throw(0,error_1.createError)({statusCode:500,message:"Master wallet data not found"});null==a||a.step("Decrypting Master Wallet Data");const s=JSON.parse((0,encrypt_1.decrypt)(t.data)),{privateKey:r}=s;null==a||a.step("Initializing Provider and Contract");const d=await(0,provider_1.getProvider)(e.chain),c=new ethers_1.ethers.Wallet(r).connect(d),u=await(0,custodialWallet_1.getCustodialWalletContract)(e.address,c);null==a||a.step("Executing ERC-20 Token Transfer");const p=await u.transferTokens(n,i,l);await p.wait();null==a||a.success(`ERC-20 tokens transferred successfully to ${i}`);return{message:"ERC-20 tokens transferred successfully"}}catch(e){console.error(`Failed to transfer ERC-20 tokens: ${e.message}`);throw(0,error_1.createError)({statusCode:500,message:e.message})}};