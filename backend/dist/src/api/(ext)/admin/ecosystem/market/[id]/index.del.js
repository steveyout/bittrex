"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),sequelize_1=require("sequelize"),queries_1=require("@b/api/(ext)/ecosystem/utils/scylla/queries"),query_1=require("@b/utils/query"),errors_1=require("@b/utils/schema/errors"),error_1=require("@b/utils/error");exports.metadata={summary:"Deletes a specific ecosystem market",description:"Deletes a single ecosystem market by its ID. This operation also removes all associated market data from the database for the market. The market is permanently deleted (force delete).",operationId:"deleteEcosystemMarket",tags:["Admin","Ecosystem","Market"],parameters:(0,query_1.deleteRecordParams)("Ecosystem Market"),responses:{200:{description:"Market deleted successfully",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string",description:"Success message"}}}}}},401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("Ecosystem Market"),500:errors_1.serverErrorResponse},permission:"delete.ecosystem.market",requiresAuth:!0,logModule:"ADMIN_ECO",logTitle:"Delete market"};exports.default=async e=>{var r,t;const{params:s,query:a,ctx:o}=e;null==o||o.step("Fetching market details");const i=await db_1.models.ecosystemMarket.findOne({where:{id:s.id},attributes:["currency","pair"],paranoid:!1});if(!i)throw(0,error_1.createError)({statusCode:404,message:"Market not found"});const l=i.currency,d=i.pair,c=`${l}/${d}`;null==o||o.step("Checking for open copy trading trades");try{const e=await(null===(r=db_1.models.copyTradingTrade)||void 0===r?void 0:r.count({where:{symbol:c,status:{[sequelize_1.Op.in]:["PENDING","OPEN","PARTIALLY_FILLED"]}}}));if(e&&e>0)throw(0,error_1.createError)({statusCode:400,message:`Cannot delete market with ${e} open copy trading trades. Please close or cancel all copy trades first.`})}catch(e){if(!(null===(t=e.message)||void 0===t?void 0:t.includes("copy trading")))throw e}null==o||o.step("Deleting market record");const n=await(0,query_1.handleSingleDelete)({model:"ecosystemMarket",id:s.id,query:{...a,force:!0},postDelete:async()=>{var e,r;null==o||o.step("Deleting market data from database");await(0,queries_1.deleteAllMarketData)(l);null==o||o.step("Cleaning up copy trading data");try{await(null===(e=db_1.models.copyTradingFollowerAllocation)||void 0===e?void 0:e.update({isActive:!1},{where:{symbol:c}}));await(null===(r=db_1.models.copyTradingLeaderMarket)||void 0===r?void 0:r.update({isActive:!1},{where:{symbol:c}}))}catch(e){}}});null==o||o.success("Market deleted successfully");return n};