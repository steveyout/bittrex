"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),utils_1=require("../../utils"),errors_1=require("@b/utils/schema/errors"),error_1=require("@b/utils/error");exports.metadata={summary:"Update AI Market Maker market configuration",operationId:"updateAiMarketMakerMarket",tags:["Admin","AI Market Maker","Market"],description:"Updates the configuration parameters of an AI Market Maker market. Validates price ranges to ensure target price remains within bounds, real liquidity percentage stays between 0-100, and tracks all changes in the history log for audit purposes. Returns the updated market maker with pool and ecosystem market details.",logModule:"ADMIN_MM",logTitle:"Update Market Maker Configuration",parameters:[{index:0,name:"id",in:"path",required:!0,description:"ID of the AI Market Maker to update",schema:{type:"string"}}],requestBody:{required:!0,content:{"application/json":{schema:utils_1.aiMarketMakerUpdateSchema}}},responses:{200:utils_1.aiMarketMakerStoreSchema,401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("AI Market Maker Market"),500:errors_1.serverErrorResponse},requiresAuth:!0,permission:"edit.ai.market-maker.market"};exports.default=async e=>{const{params:r,body:a,ctx:t}=e;null==t||t.step("Fetch market maker from database");const i=await db_1.models.aiMarketMaker.findByPk(r.id,{include:[{model:db_1.models.aiMarketMakerPool,as:"pool"}]});if(!i)throw(0,error_1.createError)(404,"AI Market Maker not found");const{targetPrice:o,priceRangeLow:s,priceRangeHigh:n,aggressionLevel:d,maxDailyVolume:l,volatilityThreshold:c,pauseOnHighVolatility:u,realLiquidityPercent:p}=a;null==t||t.step("Validate price parameters");const g=null!=s?s:i.priceRangeLow,k=null!=n?n:i.priceRangeHigh,m=null!=o?o:i.targetPrice;if(g>=k)throw(0,error_1.createError)(400,"Price range low must be less than price range high");if(m<g||m>k)throw(0,error_1.createError)(400,"Target price must be within the price range");if(void 0!==p&&(p<0||p>100))throw(0,error_1.createError)(400,"Real liquidity percent must be between 0 and 100");null==t||t.step("Track configuration changes");const h={};void 0!==o&&o!==i.targetPrice&&(h.targetPrice={old:i.targetPrice,new:o});void 0!==s&&s!==i.priceRangeLow&&(h.priceRangeLow={old:i.priceRangeLow,new:s});void 0!==n&&n!==i.priceRangeHigh&&(h.priceRangeHigh={old:i.priceRangeHigh,new:n});void 0!==d&&d!==i.aggressionLevel&&(h.aggressionLevel={old:i.aggressionLevel,new:d});void 0!==p&&p!==i.realLiquidityPercent&&(h.realLiquidityPercent={old:i.realLiquidityPercent,new:p});null==t||t.step("Update market maker configuration");await i.update({...void 0!==o&&{targetPrice:o},...void 0!==s&&{priceRangeLow:s},...void 0!==n&&{priceRangeHigh:n},...void 0!==d&&{aggressionLevel:d},...void 0!==l&&{maxDailyVolume:l},...void 0!==c&&{volatilityThreshold:c},...void 0!==u&&{pauseOnHighVolatility:u},...void 0!==p&&{realLiquidityPercent:p}});null==t||t.step("Create history record for changes");if(Object.keys(h).length>0){const e=i.pool;await db_1.models.aiMarketMakerHistory.create({marketMakerId:i.id,action:void 0!==o?"TARGET_CHANGE":"CONFIG_CHANGE",details:h,priceAtAction:m,poolValueAtAction:(null==e?void 0:e.totalValueLocked)||0})}null==t||t.success("Market maker configuration updated successfully");return db_1.models.aiMarketMaker.findByPk(r.id,{include:[{model:db_1.models.aiMarketMakerPool,as:"pool"},{model:db_1.models.ecosystemMarket,as:"market"}]})};