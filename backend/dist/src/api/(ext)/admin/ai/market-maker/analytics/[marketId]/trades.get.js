"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),constants_1=require("@b/utils/constants"),query_1=require("@b/utils/query"),error_1=require("@b/utils/error"),sequelize_1=require("sequelize");exports.metadata={summary:"Get trade history for an AI Market Maker",operationId:"getAiMarketMakerTrades",tags:["Admin","AI Market Maker","Analytics"],parameters:[{index:0,name:"marketId",in:"path",required:!0,description:"ID of the AI Market Maker",schema:{type:"string"}},...constants_1.crudParameters,{name:"startDate",in:"query",required:!1,description:"Start date for trade history",schema:{type:"string",format:"date-time"}},{name:"endDate",in:"query",required:!1,description:"End date for trade history",schema:{type:"string",format:"date-time"}},{name:"botId",in:"query",required:!1,description:"Filter by specific bot ID",schema:{type:"string"}}],responses:{200:{description:"Paginated trade history",content:{"application/json":{schema:{type:"object",properties:{data:{type:"array",items:{type:"object",properties:{id:{type:"string"},timestamp:{type:"string"},side:{type:"string"},price:{type:"number"},amount:{type:"number"},botId:{type:"string"},botName:{type:"string"},pnl:{type:"number"}}}},pagination:constants_1.paginationSchema,summary:{type:"object",properties:{totalTrades:{type:"number"},totalVolume:{type:"number"},avgPrice:{type:"number"},totalPnL:{type:"number"}}}}}}}},401:query_1.unauthorizedResponse,404:(0,query_1.notFoundMetadataResponse)("AI Market Maker"),500:query_1.serverErrorResponse},requiresAuth:!0,logModule:"ADMIN_AI",logTitle:"Get Market Maker Trades",permission:"view.ai.market-maker.analytics"};exports.default=async e=>{const{params:t,query:r,ctx:a}=e,{page:i=1,perPage:o=20,startDate:n,endDate:s,botId:d}=r;null==a||a.step("Get Market Maker Trades");if(!await db_1.models.aiMarketMaker.findByPk(t.marketId))throw(0,error_1.createError)(404,"AI Market Maker not found");const u={marketMakerId:t.marketId,action:"TRADE"};n&&(u.createdAt={...u.createdAt,[sequelize_1.Op.gte]:new Date(n)});s&&(u.createdAt={...u.createdAt,[sequelize_1.Op.lte]:new Date(s)});const{count:l,rows:p}=await db_1.models.aiMarketMakerHistory.findAndCountAll({where:u,order:[["createdAt","DESC"]],limit:Number(o),offset:(Number(i)-1)*Number(o)});let m=p;d&&(m=p.filter(e=>{var t;return(null===(t=e.details)||void 0===t?void 0:t.botId)===d}));const c=m.map(e=>{var t,r,a,i,o,n;return{id:e.id,timestamp:e.createdAt,side:(null===(t=e.details)||void 0===t?void 0:t.side)||"UNKNOWN",price:e.priceAtAction,amount:(null===(r=e.details)||void 0===r?void 0:r.amount)||0,botId:(null===(a=e.details)||void 0===a?void 0:a.botId)||null,botName:(null===(i=e.details)||void 0===i?void 0:i.botName)||"Unknown",pnl:(null===(o=e.details)||void 0===o?void 0:o.pnl)||0,type:(null===(n=e.details)||void 0===n?void 0:n.type)||"AI_ONLY"}});let y=0,b=0,k=0;for(const e of m){const t=e.details||{};y+=t.amount||0;b+=t.pnl||0;k+=Number(e.priceAtAction)||0}const M=m.length>0?k/m.length:0,g=Math.ceil(l/Number(o));null==a||a.success("Get Market Maker Trades retrieved successfully");return{data:c,pagination:{currentPage:Number(i),perPage:Number(o),total:l,totalPages:g},summary:{totalTrades:l,totalVolume:y,avgPrice:M,totalPnL:b}}};