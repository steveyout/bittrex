"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),console_1=require("@b/utils/console"),MarketMakerEngine_1=__importDefault(require("../../utils/engine/MarketMakerEngine"));exports.metadata={summary:"Reset daily trade counts for a market maker",description:"Resets the daily trade counts for all bots and the daily volume for a specific market maker. Use this when bots have hit their daily limit mid-day.",operationId:"resetMarketMakerDaily",tags:["Admin","AI Market Maker"],requiresAuth:!0,permission:"edit.ai.market-maker.market",params:{type:"object",properties:{id:{type:"string",description:"Market Maker ID"}},required:["id"]},responses:{200:{description:"Daily counts reset successfully",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"},message:{type:"string"},botsReset:{type:"number"}}}}}},404:{description:"Market maker not found"}}};exports.default=async e=>{const{params:t}=e,{id:a}=t,r=await db_1.models.aiMarketMaker.findByPk(a,{include:[{model:db_1.models.aiBot,as:"bots"}]});if(!r)throw(0,error_1.createError)(404,"Market maker not found");await db_1.models.aiMarketMaker.update({currentDailyVolume:0},{where:{id:a}});const[s]=await db_1.models.aiBot.update({dailyTradeCount:0},{where:{marketMakerId:a}});console_1.logger.info("AI_MM",`Manual daily reset for market ${a}: ${s} bots reset`);const o=MarketMakerEngine_1.default.getMarketManager();if(o){const e=o.getMarketInstance(a);if(e){const t=await db_1.models.aiMarketMaker.findByPk(a,{include:[{model:db_1.models.aiMarketMakerPool,as:"pool"},{model:db_1.models.ecosystemMarket,as:"market"},{model:db_1.models.aiBot,as:"bots"}]});t&&e.updateConfig(t)}}await db_1.models.aiMarketMakerHistory.create({marketMakerId:a,action:"CONFIG_CHANGE",details:{field:"dailyReset",triggeredBy:"ADMIN",note:"Manual daily trade count reset",botsReset:s},priceAtAction:r.targetPrice||0,poolValueAtAction:0});return{success:!0,message:`Daily counts reset successfully. ${s} bots reset.`,botsReset:s}};