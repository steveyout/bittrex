"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),utils_1=require("../../utils"),errors_1=require("@b/utils/schema/errors"),error_1=require("@b/utils/error");exports.metadata={summary:"Update AI Market Maker price mode",operationId:"updateAiMarketMakerPriceMode",tags:["Admin","AI Market Maker","Market"],description:"Updates the price mode settings for an AI Market Maker. AUTONOMOUS mode generates prices independently, FOLLOW_EXTERNAL tracks an external exchange price, and HYBRID combines both approaches with configurable correlation.",logModule:"ADMIN_MM",logTitle:"Update Market Maker Price Mode",parameters:[{index:0,name:"id",in:"path",required:!0,description:"ID of the AI Market Maker",schema:{type:"string"}}],requestBody:{required:!0,content:{"application/json":{schema:utils_1.priceModeUpdateSchema}}},responses:{200:{description:"Price mode updated successfully",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"},priceMode:{type:"string"},externalSymbol:{type:"string"},correlationStrength:{type:"number"}}}}}},400:errors_1.badRequestResponse,401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("AI Market Maker Market"),500:errors_1.serverErrorResponse},requiresAuth:!0,permission:"edit.ai.market-maker.market"};exports.default=async e=>{const{params:r,body:t,ctx:o}=e,{priceMode:a,externalSymbol:i,correlationStrength:s}=t;null==o||o.step("Fetch market maker from database");const n=await db_1.models.aiMarketMaker.findByPk(r.id,{include:[{model:db_1.models.aiMarketMakerPool,as:"pool"}]});if(!n)throw(0,error_1.createError)(404,"AI Market Maker not found");null==o||o.step("Validate price mode configuration");if(("FOLLOW_EXTERNAL"===a||"HYBRID"===a)&&!i)throw(0,error_1.createError)(400,"External symbol is required for FOLLOW_EXTERNAL and HYBRID price modes");if(void 0!==s&&(s<0||s>100))throw(0,error_1.createError)(400,"Correlation strength must be between 0 and 100");const d=n.priceMode,l=n.externalSymbol,c=Number(n.correlationStrength);null==o||o.step("Update price mode configuration");const p={priceMode:a};void 0!==i&&(p.externalSymbol=i);void 0!==s&&(p.correlationStrength=s);await n.update(p);null==o||o.step("Create history record for config change");const u=n.pool;await db_1.models.aiMarketMakerHistory.create({marketMakerId:n.id,action:"CONFIG_CHANGE",details:{changeType:"PRICE_MODE",previousMode:d,newMode:a,previousSymbol:l,newSymbol:i||null,previousCorrelation:c,newCorrelation:null!=s?s:c},priceAtAction:Number(n.lastKnownPrice)||Number(n.targetPrice),poolValueAtAction:(null==u?void 0:u.totalValueLocked)||0});null==o||o.success("Price mode updated successfully");return{message:"Price mode updated successfully",priceMode:a,externalSymbol:i||n.externalSymbol,correlationStrength:null!=s?s:c}};