"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),utils_1=require("../../utils"),query_1=require("@b/utils/query"),error_1=require("@b/utils/error");exports.metadata={summary:"Get P&L report for an AI Market Maker",operationId:"getAiMarketMakerPnL",tags:["Admin","AI Market Maker","Analytics"],parameters:[{index:0,name:"marketId",in:"path",required:!0,description:"ID of the AI Market Maker",schema:{type:"string"}}],responses:{200:{description:"P&L report with daily, weekly, monthly, and all-time data",content:{"application/json":{schema:utils_1.pnlReportSchema}}},401:query_1.unauthorizedResponse,404:(0,query_1.notFoundMetadataResponse)("AI Market Maker"),500:query_1.serverErrorResponse},requiresAuth:!0,logModule:"ADMIN_AI",logTitle:"Get Market Maker PnL",permission:"view.ai.market-maker.analytics"};exports.default=async e=>{var r;const{params:t,ctx:a}=e;null==a||a.step("Get Market Maker PnL");const l=await db_1.models.aiMarketMaker.findByPk(t.marketId,{include:[{model:db_1.models.aiMarketMakerPool,as:"pool"},{model:db_1.models.ecosystemMarket,as:"market"}]});if(!l)throw(0,error_1.createError)(404,"AI Market Maker not found");const n=l.pool;if(!n)throw(0,error_1.createError)(404,"Pool not found for this market maker");const i=new Date,o=new Date(i.getTime()-864e5),d=new Date(i.getTime()-6048e5),s=new Date(i.getTime()-2592e6),u=await db_1.models.aiMarketMakerHistory.findAll({where:{marketMakerId:t.marketId,action:"TRADE"},order:[["createdAt","ASC"]]});let m=0,c=0,k=0,v=0;const p={};for(const e of u){const t=new Date(e.createdAt),a=t.toISOString().slice(0,10),l=(null===(r=e.details)||void 0===r?void 0:r.pnl)||0;p[a]=(p[a]||0)+l;v+=l;t>=o&&(m+=l);t>=d&&(c+=l);t>=s&&(k+=l)}const M=Object.keys(p).sort();let y=0;const f=M.map(e=>{y+=p[e];return{date:e,pnl:p[e],cumulativePnl:y}}),g=Number(n.unrealizedPnL)||0,h=Number(n.realizedPnL)||0,b=Number(n.initialBaseBalance)*Number(l.targetPrice)+Number(n.initialQuoteBalance),I=g+h,w=b>0?I/b*100:0;null==a||a.success("Get Market Maker PnL retrieved successfully");return{marketId:t.marketId,market:l.market,summary:{daily:m,weekly:c,monthly:k,allTime:v,unrealized:g,realized:h,total:I},roi:{percent:w.toFixed(2),initialInvestment:b,currentValue:Number(n.totalValueLocked)},history:f,breakdown:{tradeCount:u.length,winningTrades:u.filter(e=>{var r;return((null===(r=e.details)||void 0===r?void 0:r.pnl)||0)>0}).length,losingTrades:u.filter(e=>{var r;return((null===(r=e.details)||void 0===r?void 0:r.pnl)||0)<0}).length,avgWin:u.filter(e=>{var r;return((null===(r=e.details)||void 0===r?void 0:r.pnl)||0)>0}).length>0?u.filter(e=>{var r;return((null===(r=e.details)||void 0===r?void 0:r.pnl)||0)>0}).reduce((e,r)=>{var t;return e+((null===(t=r.details)||void 0===t?void 0:t.pnl)||0)},0)/u.filter(e=>{var r;return((null===(r=e.details)||void 0===r?void 0:r.pnl)||0)>0}).length:0,avgLoss:u.filter(e=>{var r;return((null===(r=e.details)||void 0===r?void 0:r.pnl)||0)<0}).length>0?u.filter(e=>{var r;return((null===(r=e.details)||void 0===r?void 0:r.pnl)||0)<0}).reduce((e,r)=>{var t;return e+((null===(t=r.details)||void 0===t?void 0:t.pnl)||0)},0)/u.filter(e=>{var r;return((null===(r=e.details)||void 0===r?void 0:r.pnl)||0)<0}).length:0},lastUpdated:(new Date).toISOString()}};