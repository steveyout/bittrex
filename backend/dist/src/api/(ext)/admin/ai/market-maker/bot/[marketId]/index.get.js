"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),utils_1=require("../../utils"),query_1=require("@b/utils/query"),error_1=require("@b/utils/error"),queries_1=require("../../utils/scylla/queries"),console_1=require("@b/utils/console");exports.metadata={summary:"List all bots for a specific AI Market Maker",operationId:"listMarketMakerBots",tags:["Admin","AI Market Maker","Bot"],description:"Retrieves all AI bots associated with a specific market maker, including their configuration, status, and trading statistics. Returns enhanced bot data with trade metrics from both MySQL (dailyTradeCount) and Scylla (actual trade records).",parameters:[{index:0,name:"marketId",in:"path",required:!0,description:"ID of the AI Market Maker",schema:{type:"string"}}],responses:{200:{description:"List of bots with configuration, status, and trading statistics",content:{"application/json":{schema:{type:"array",items:{type:"object",properties:{...utils_1.aiBotSchema,tradesExecuted:{type:"number",description:"Total number of trades executed by the bot"},profitableTrades:{type:"number",description:"Number of profitable trades"},totalVolume:{type:"number",description:"Total trading volume generated by the bot"},totalPnL:{type:"number",description:"Total profit/loss (always 0 for AI-to-AI trades)"},botType:{type:"string",description:"Bot personality type (SCALPER, SWING, ACCUMULATOR, DISTRIBUTOR, MARKET_MAKER)"},stats:{type:"object",description:"Detailed trading statistics for the bot",properties:{totalTrades:{type:"number",description:"Total number of trades"},successRate:{type:"number",description:"Success rate (0.5 = 50%)"},avgProfitPerTrade:{type:"number",description:"Average profit per trade"},isActive:{type:"boolean",description:"Whether the bot is currently active"},timeSinceLastTrade:{type:"number",nullable:!0,description:"Milliseconds since last trade, or null if never traded"}}}}}}}}},401:query_1.unauthorizedResponse,404:(0,query_1.notFoundMetadataResponse)("AI Market Maker"),500:query_1.serverErrorResponse},requiresAuth:!0,logModule:"ADMIN_AI",logTitle:"Get Market Maker Bots",permission:"view.ai.market-maker.bot"};exports.default=async e=>{const{params:t,ctx:r}=e;null==r||r.step("Get Market Maker Bots");const a=await db_1.models.aiMarketMaker.findByPk(t.marketId);if(!a)throw(0,error_1.createError)(404,"AI Market Maker not found");const o=await db_1.models.aiBot.findAll({where:{marketMakerId:t.marketId},order:[["personality","ASC"]]}),s=a.marketId;console_1.logger.info("AI_MM",`Querying Scylla with ecosystemMarket.id: ${s}`);console_1.logger.info("AI_MM",`aiMarketMaker.id (params.marketId): ${t.marketId}`);console_1.logger.debug("AI_MM","MySQL bots",o.map(e=>({id:e.id,name:e.name})));const i=await(0,queries_1.debugGetAllTrades)(10);console_1.logger.debug("AI_MM",`Found ${i.length} total trades in Scylla`);if(i.length>0){console_1.logger.debug("AI_MM",`First trade market_id: ${i[0].marketId}`);console_1.logger.debug("AI_MM",`First trade buyBotId: ${i[0].buyBotId}`);console_1.logger.debug("AI_MM",`First trade sellBotId: ${i[0].sellBotId}`)}const d=await(0,queries_1.getBotTradeStats)(s);console_1.logger.debug("AI_MM",`Got ${d.size} bot stats entries from Scylla`);d.size>0&&console_1.logger.debug("AI_MM","Bot stats keys",Array.from(d.keys()));console_1.logger.debug("AI_MM","MySQL dailyTradeCounts",o.map(e=>({id:e.id,name:e.name,dailyTradeCount:e.dailyTradeCount})));null==r||r.success("Get Market Maker Bots retrieved successfully");return o.map(e=>{const t=d.get(e.id)||{tradeCount:0,totalVolume:0},r=Math.max(e.dailyTradeCount||0,t.tradeCount);console_1.logger.debug("AI_MM",`Bot ${e.name}: MySQL=${e.dailyTradeCount||0}, Scylla=${t.tradeCount}, using=${r}`);return{...e.toJSON(),botType:e.personality,tradesExecuted:r,profitableTrades:Math.floor(.5*r),totalVolume:t.totalVolume,totalPnL:0,stats:{totalTrades:r,successRate:.5,avgProfitPerTrade:0,isActive:"ACTIVE"===e.status,timeSinceLastTrade:e.lastTradeAt?Date.now()-new Date(e.lastTradeAt).getTime():null}}})};