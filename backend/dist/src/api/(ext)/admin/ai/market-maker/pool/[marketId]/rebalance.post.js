"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),errors_1=require("@b/utils/schema/errors"),error_1=require("@b/utils/error");exports.metadata={summary:"Rebalance AI Market Maker pool assets",operationId:"rebalanceMarketMakerPool",tags:["Admin","AI Market Maker","Pool"],description:"Rebalances the pool's asset allocation between base and quote currencies according to a target ratio. Can only be performed when the market maker is paused or stopped. The operation adjusts balances to match the specified ratio while maintaining total pool value.",logModule:"ADMIN_MM",logTitle:"Rebalance Market Maker Pool",parameters:[{index:0,name:"marketId",in:"path",required:!0,description:"ID of the AI Market Maker",schema:{type:"string"}}],requestBody:{required:!1,content:{"application/json":{schema:{type:"object",properties:{targetRatio:{type:"number",description:"Target ratio of base currency value to total pool value (0-1, default 0.5 for 50/50 split)"}}}}}},responses:{200:{description:"Pool rebalanced successfully",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string",description:"Success message"},rebalanceDetails:{type:"object",description:"Details of the rebalance operation",properties:{targetRatio:{type:"number",description:"Target ratio used for rebalancing"},previousBaseBalance:{type:"number",description:"Base currency balance before rebalance"},previousQuoteBalance:{type:"number",description:"Quote currency balance before rebalance"},newBaseBalance:{type:"number",description:"Base currency balance after rebalance"},newQuoteBalance:{type:"number",description:"Quote currency balance after rebalance"},baseChange:{type:"number",description:"Change in base currency balance"},quoteChange:{type:"number",description:"Change in quote currency balance"},totalValue:{type:"number",description:"Total pool value in quote currency"}}}}}}}},400:errors_1.badRequestResponse,401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("AI Market Maker Pool"),500:errors_1.serverErrorResponse},requiresAuth:!0,permission:"edit.ai.market-maker.pool"};exports.default=async e=>{var a;const{params:r,body:t,ctx:o}=e,n=null!==(a=null==t?void 0:t.targetRatio)&&void 0!==a?a:.5;if(n<0||n>1)throw(0,error_1.createError)(400,"Target ratio must be between 0 and 1");null==o||o.step("Fetch market maker with pool");const s=await db_1.models.aiMarketMaker.findByPk(r.marketId,{include:[{model:db_1.models.aiMarketMakerPool,as:"pool"}]});if(!s)throw(0,error_1.createError)(404,"AI Market Maker not found");const c=s.pool;if(!c)throw(0,error_1.createError)(404,"Pool not found for this market maker");null==o||o.step("Validate market maker is not active");if("ACTIVE"===s.status)throw(0,error_1.createError)(400,"Cannot rebalance active market maker. Please pause it first.");null==o||o.step("Calculate new balances");const l=Number(s.targetPrice),i=Number(c.baseCurrencyBalance),u=Number(c.quoteCurrencyBalance),p=i*l+u;if(p<=0)throw(0,error_1.createError)(400,"Pool has no value to rebalance");const d=p*n/l,b=p*(1-n),m=d-i,y=b-u;null==o||o.step("Update pool balances");await c.update({baseCurrencyBalance:d,quoteCurrencyBalance:b,lastRebalanceAt:new Date});null==o||o.step("Create history record for rebalance");await db_1.models.aiMarketMakerHistory.create({marketMakerId:s.id,action:"REBALANCE",details:{targetRatio:n,previousBaseBalance:i,previousQuoteBalance:u,newBaseBalance:d,newQuoteBalance:b,baseChange:m,quoteChange:y,priceUsed:l},priceAtAction:s.targetPrice,poolValueAtAction:p});null==o||o.success("Pool rebalanced successfully");return{message:"Pool rebalanced successfully",rebalanceDetails:{targetRatio:n,previousBaseBalance:i,previousQuoteBalance:u,newBaseBalance:d,newQuoteBalance:b,baseChange:m,quoteChange:y,totalValue:p}}};