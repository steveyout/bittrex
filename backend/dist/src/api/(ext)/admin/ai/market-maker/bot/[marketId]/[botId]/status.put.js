"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),query_1=require("@b/utils/query"),error_1=require("@b/utils/error");exports.metadata={summary:"Update AI Market Maker bot operational status",operationId:"updateMarketMakerBotStatus",tags:["Admin","AI Market Maker","Bot"],description:"Changes the operational status of an AI bot (ACTIVE, PAUSED, or COOLDOWN). Validates that bots can only be activated when their parent market maker is active. All status changes are logged in the market maker history with previous and new status details.",logModule:"ADMIN_MM",logTitle:"Update Bot Status",parameters:[{index:0,name:"marketId",in:"path",required:!0,description:"ID of the AI Market Maker",schema:{type:"string"}},{index:1,name:"botId",in:"path",required:!0,description:"ID of the bot to update",schema:{type:"string"}}],requestBody:{required:!0,content:{"application/json":{schema:{type:"object",properties:{status:{type:"string",enum:["ACTIVE","PAUSED","COOLDOWN"],description:"New operational status for the bot"},cooldownMinutes:{type:"number",description:"Cooldown duration in minutes (only applicable when status is COOLDOWN)"}},required:["status"]}}}},responses:{200:{description:"Bot status updated successfully with status change details",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string",description:"Success message with new status"},botId:{type:"string",description:"ID of the updated bot"},botName:{type:"string",description:"Name of the updated bot"},previousStatus:{type:"string",description:"Previous bot status"},newStatus:{type:"string",description:"New bot status"}}}}}},400:{description:"Invalid status change request",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string",description:"Error message (e.g., cannot activate bot when market maker is not active)"}}}}}},401:query_1.unauthorizedResponse,404:(0,query_1.notFoundMetadataResponse)("Bot or AI Market Maker"),500:query_1.serverErrorResponse},requiresAuth:!0,permission:"edit.ai.market-maker.bot"};exports.default=async t=>{const{params:e,body:a,ctx:s}=t,{status:r,cooldownMinutes:o}=a;null==s||s.step("Fetch bot from database");const i=await db_1.models.aiBot.findOne({where:{id:e.botId,marketMakerId:e.marketId}});if(!i)throw(0,error_1.createError)(404,"Bot not found");null==s||s.step("Validate market maker status");const n=await db_1.models.aiMarketMaker.findByPk(e.marketId);if(!n)throw(0,error_1.createError)(404,"AI Market Maker not found");if("ACTIVE"===r&&"ACTIVE"!==n.status)throw(0,error_1.createError)(400,"Cannot activate bot when market maker is not active");const d=i.status;null==s||s.step("Update bot status");await i.update({status:r});null==s||s.step("Create history record for status change");await db_1.models.aiMarketMakerHistory.create({marketMakerId:e.marketId,action:"PAUSED"===r?"PAUSE":"RESUME",details:{botId:i.id,botName:i.name,previousStatus:d,newStatus:r,cooldownMinutes:"COOLDOWN"===r?o:void 0},priceAtAction:n.targetPrice,poolValueAtAction:0});null==s||s.success("Bot status updated successfully");return{message:`Bot status updated to ${r}`,botId:i.id,botName:i.name,previousStatus:d,newStatus:r}};