"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),utils_1=require("../../utils"),query_1=require("@b/utils/query"),error_1=require("@b/utils/error"),sequelize_1=require("sequelize");exports.metadata={summary:"Get market performance analytics",operationId:"getAiMarketMakerPerformance",tags:["Admin","AI Market Maker","Analytics"],parameters:[{index:0,name:"marketId",in:"path",required:!0,description:"ID of the AI Market Maker",schema:{type:"string"}},{name:"period",in:"query",required:!1,description:"Time period (1h, 24h, 7d, 30d)",schema:{type:"string",default:"24h"}}],responses:{200:{description:"Market performance data",content:{"application/json":{schema:utils_1.marketPerformanceSchema}}},401:query_1.unauthorizedResponse,404:(0,query_1.notFoundMetadataResponse)("AI Market Maker"),500:query_1.serverErrorResponse},requiresAuth:!0,logModule:"ADMIN_AI",logTitle:"Get Market Maker Performance",permission:"view.ai.market-maker.analytics"};exports.default=async e=>{var r,t;const{params:a,query:i,ctx:o}=e,s=i.period||"24h";null==o||o.step("Get Market Maker Performance");const n=await db_1.models.aiMarketMaker.findByPk(a.marketId,{include:[{model:db_1.models.aiMarketMakerPool,as:"pool"},{model:db_1.models.ecosystemMarket,as:"market"}]});if(!n)throw(0,error_1.createError)(404,"AI Market Maker not found");const d={"1h":36e5,"24h":864e5,"7d":6048e5,"30d":2592e6},l=new Date(Date.now()-(d[s]||d["24h"])),u=await db_1.models.aiMarketMakerHistory.findAll({where:{marketMakerId:a.marketId,createdAt:{[sequelize_1.Op.gte]:l}},order:[["createdAt","ASC"]]}),c=u.filter(e=>"TARGET_CHANGE"===e.action||("TRADE"===e.action&&Number(e.priceAtAction)>0||"START"===e.action&&Number(e.priceAtAction)>0)).map(e=>({timestamp:e.createdAt,price:Number(e.priceAtAction),targetPrice:Number(e.priceAtAction)}));c.push({timestamp:new Date,price:Number(n.targetPrice),targetPrice:Number(n.targetPrice)});const m=u.filter(e=>"TRADE"===e.action),p={};for(const e of m){const a=new Date(e.createdAt).toISOString().slice(0,13),i=(null===(r=e.details)||void 0===r?void 0:r.amount)||(null===(t=e.details)||void 0===t?void 0:t.volume)||0;p[a]=(p[a]||0)+i}const k=Object.entries(p).map(([e,r])=>({timestamp:new Date(e+":00:00Z"),volume:r})),A=n.pool,M=m.length,v=M>0?m.reduce((e,r)=>{var t,a;return e+((null===(t=r.details)||void 0===t?void 0:t.amount)||(null===(a=r.details)||void 0===a?void 0:a.size)||0)},0)/M:0;null==o||o.success("Get Market Maker Performance retrieved successfully");return{marketId:a.marketId,period:s,market:n.market,currentPrice:n.targetPrice,priceHistory:c,volumeHistory:k,targetAchievementRate:85,metrics:{totalTrades:M,avgTradeSize:v,totalVolume:Number(n.currentDailyVolume),tvl:(null==A?void 0:A.totalValueLocked)||0,unrealizedPnL:(null==A?void 0:A.unrealizedPnL)||0,realizedPnL:(null==A?void 0:A.realizedPnL)||0},status:n.status}};