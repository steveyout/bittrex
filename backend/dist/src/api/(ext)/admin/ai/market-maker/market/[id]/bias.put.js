"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),utils_1=require("../../utils"),errors_1=require("@b/utils/schema/errors"),error_1=require("@b/utils/error");exports.metadata={summary:"Update AI Market Maker market bias",operationId:"updateAiMarketMakerMarketBias",tags:["Admin","AI Market Maker","Market"],description:"Updates the market bias settings for an AI Market Maker. The bias influences phase transitions and price target calculations, guiding the market toward bullish or bearish behavior.",logModule:"ADMIN_MM",logTitle:"Update Market Maker Bias",parameters:[{index:0,name:"id",in:"path",required:!0,description:"ID of the AI Market Maker",schema:{type:"string"}}],requestBody:{required:!0,content:{"application/json":{schema:utils_1.biasUpdateSchema}}},responses:{200:{description:"Market bias updated successfully",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"},previousBias:{type:"string"},newBias:{type:"string"},previousStrength:{type:"number"},newStrength:{type:"number"}}}}}},400:errors_1.badRequestResponse,401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("AI Market Maker Market"),500:errors_1.serverErrorResponse},requiresAuth:!0,permission:"edit.ai.market-maker.market"};exports.default=async e=>{const{params:r,body:t,ctx:a}=e,{marketBias:s,biasStrength:i}=t;null==a||a.step("Fetch market maker from database");const o=await db_1.models.aiMarketMaker.findByPk(r.id,{include:[{model:db_1.models.aiMarketMakerPool,as:"pool"}]});if(!o)throw(0,error_1.createError)(404,"AI Market Maker not found");null==a||a.step("Validate bias strength");if(i<0||i>100)throw(0,error_1.createError)(400,"Bias strength must be between 0 and 100");const n=o.marketBias,u=Number(o.biasStrength);null==a||a.step("Update market bias");await o.update({marketBias:s,biasStrength:i});null==a||a.step("Create history record for bias change");const d=o.pool;await db_1.models.aiMarketMakerHistory.create({marketMakerId:o.id,action:"BIAS_CHANGE",details:{previousBias:n,newBias:s,previousStrength:u,newStrength:i},priceAtAction:Number(o.lastKnownPrice)||Number(o.targetPrice),poolValueAtAction:(null==d?void 0:d.totalValueLocked)||0});null==a||a.success("Market bias updated successfully");return{message:"Market bias updated successfully",previousBias:n,newBias:s,previousStrength:u,newStrength:i}};