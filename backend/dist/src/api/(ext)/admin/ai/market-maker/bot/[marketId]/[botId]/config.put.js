"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),utils_1=require("../../../utils"),query_1=require("@b/utils/query"),error_1=require("@b/utils/error");exports.metadata={summary:"Update AI Market Maker bot trading configuration",operationId:"updateMarketMakerBotConfig",tags:["Admin","AI Market Maker","Bot"],description:"Updates the trading configuration parameters for a specific AI bot. Supports modifying risk tolerance, trade frequency, order size settings, and daily trade limits. All configuration changes are tracked in the market maker history with before/after values.",logModule:"ADMIN_MM",logTitle:"Update Bot Configuration",parameters:[{index:0,name:"marketId",in:"path",required:!0,description:"ID of the AI Market Maker",schema:{type:"string"}},{index:1,name:"botId",in:"path",required:!0,description:"ID of the bot to update",schema:{type:"string"}}],requestBody:{required:!0,content:{"application/json":{schema:utils_1.aiBotUpdateSchema}}},responses:{200:{description:"Bot configuration updated successfully with change details",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string",description:"Success message"},bot:{type:"object",description:"Updated bot configuration",properties:utils_1.aiBotSchema},changesApplied:{type:"number",description:"Number of configuration fields that were changed"}}}}}},400:{description:"Invalid configuration parameters",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string",description:"Error message (e.g., risk tolerance out of range)"}}}}}},401:query_1.unauthorizedResponse,404:(0,query_1.notFoundMetadataResponse)("Bot"),500:query_1.serverErrorResponse},requiresAuth:!0,permission:"edit.ai.market-maker.bot"};exports.default=async e=>{const{params:r,body:t,ctx:a}=e;null==a||a.step("Fetch bot from database");const o=await db_1.models.aiBot.findOne({where:{id:r.botId,marketMakerId:r.marketId}});if(!o)throw(0,error_1.createError)(404,"Bot not found");const{riskTolerance:i,tradeFrequency:n,avgOrderSize:s,orderSizeVariance:d,preferredSpread:c,maxDailyTrades:u}=t;null==a||a.step("Validate bot configuration parameters");if(void 0!==i&&(i<0||i>1))throw(0,error_1.createError)(400,"Risk tolerance must be between 0 and 1");if(void 0!==d&&(d<0||d>.5))throw(0,error_1.createError)(400,"Order size variance must be between 0 and 0.5 (50%)");null==a||a.step("Track configuration changes");const p={};void 0!==i&&i!==o.riskTolerance&&(p.riskTolerance={old:o.riskTolerance,new:i});void 0!==n&&n!==o.tradeFrequency&&(p.tradeFrequency={old:o.tradeFrequency,new:n});void 0!==s&&s!==Number(o.avgOrderSize)&&(p.avgOrderSize={old:o.avgOrderSize,new:s});void 0!==u&&u!==o.maxDailyTrades&&(p.maxDailyTrades={old:o.maxDailyTrades,new:u});null==a||a.step("Update bot configuration");await o.update({...void 0!==i&&{riskTolerance:i},...void 0!==n&&{tradeFrequency:n},...void 0!==s&&{avgOrderSize:s},...void 0!==d&&{orderSizeVariance:d},...void 0!==c&&{preferredSpread:c},...void 0!==u&&{maxDailyTrades:u}});if(Object.keys(p).length>0){null==a||a.step("Create history record for configuration changes");const e=await db_1.models.aiMarketMaker.findByPk(r.marketId);await db_1.models.aiMarketMakerHistory.create({marketMakerId:r.marketId,action:"CONFIG_CHANGE",details:{botId:o.id,botName:o.name,changes:p},priceAtAction:(null==e?void 0:e.targetPrice)||0,poolValueAtAction:0})}null==a||a.step("Fetch updated bot data");const l=await db_1.models.aiBot.findByPk(r.botId);null==a||a.success("Bot configuration updated successfully");return{message:"Bot configuration updated successfully",bot:l,changesApplied:Object.keys(p).length}};