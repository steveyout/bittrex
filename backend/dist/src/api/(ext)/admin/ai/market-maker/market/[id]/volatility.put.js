"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),utils_1=require("../../utils"),errors_1=require("@b/utils/schema/errors"),error_1=require("@b/utils/error");exports.metadata={summary:"Update AI Market Maker volatility configuration",operationId:"updateAiMarketMakerVolatility",tags:["Admin","AI Market Maker","Market"],description:"Updates the volatility configuration for an AI Market Maker. Controls base volatility (daily percentage), volatility multiplier (phase-based adjustment), and momentum decay rate.",logModule:"ADMIN_MM",logTitle:"Update Market Maker Volatility",parameters:[{index:0,name:"id",in:"path",required:!0,description:"ID of the AI Market Maker",schema:{type:"string"}}],requestBody:{required:!0,content:{"application/json":{schema:utils_1.volatilityConfigUpdateSchema}}},responses:{200:{description:"Volatility configuration updated successfully",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"},baseVolatility:{type:"number"},volatilityMultiplier:{type:"number"},momentumDecay:{type:"number"}}}}}},400:errors_1.badRequestResponse,401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("AI Market Maker Market"),500:errors_1.serverErrorResponse},requiresAuth:!0,permission:"edit.ai.market-maker.market"};exports.default=async e=>{const{params:t,body:r,ctx:a}=e,{baseVolatility:i,volatilityMultiplier:o,momentumDecay:l}=r;null==a||a.step("Fetch market maker from database");const s=await db_1.models.aiMarketMaker.findByPk(t.id,{include:[{model:db_1.models.aiMarketMakerPool,as:"pool"}]});if(!s)throw(0,error_1.createError)(404,"AI Market Maker not found");null==a||a.step("Validate volatility parameters");if(void 0!==i&&(i<.1||i>20))throw(0,error_1.createError)(400,"Base volatility must be between 0.1 and 20 (representing 0.1% to 20% daily)");if(void 0!==o&&(o<.5||o>2))throw(0,error_1.createError)(400,"Volatility multiplier must be between 0.5 and 2.0");if(void 0!==l&&(l<.8||l>.999))throw(0,error_1.createError)(400,"Momentum decay must be between 0.8 and 0.999");const n=Number(s.baseVolatility),u=Number(s.volatilityMultiplier),d=Number(s.momentumDecay);null==a||a.step("Update volatility configuration");const c={};void 0!==i&&(c.baseVolatility=i);void 0!==o&&(c.volatilityMultiplier=o);void 0!==l&&(c.momentumDecay=l);if(0===Object.keys(c).length)throw(0,error_1.createError)(400,"At least one volatility parameter must be provided");await s.update(c);null==a||a.step("Create history record for config change");const p=s.pool;await db_1.models.aiMarketMakerHistory.create({marketMakerId:s.id,action:"CONFIG_CHANGE",details:{changeType:"VOLATILITY",previousBaseVolatility:n,newBaseVolatility:null!=i?i:n,previousMultiplier:u,newMultiplier:null!=o?o:u,previousDecay:d,newDecay:null!=l?l:d},priceAtAction:Number(s.lastKnownPrice)||Number(s.targetPrice),poolValueAtAction:(null==p?void 0:p.totalValueLocked)||0});null==a||a.success("Volatility configuration updated successfully");return{message:"Volatility configuration updated successfully",baseVolatility:null!=i?i:n,volatilityMultiplier:null!=o?o:u,momentumDecay:null!=l?l:d}};