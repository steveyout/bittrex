"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),utils_1=require("../../utils"),errors_1=require("@b/utils/schema/errors"),error_1=require("@b/utils/error"),wallet_1=require("@b/api/(ext)/ecosystem/utils/wallet"),wallet_2=require("@b/services/wallet");exports.metadata={summary:"Withdraw liquidity from AI Market Maker pool",operationId:"withdrawFromMarketMakerPool",tags:["Admin","AI Market Maker","Pool"],description:"Withdraws liquidity from an AI Market Maker pool back to the admin's wallet. The withdrawal can be in either base or quote currency. Can only be performed when the market maker is paused or stopped. Updates pool balance and TVL accordingly.",logModule:"ADMIN_MM",logTitle:"Withdraw from Market Maker Pool",parameters:[{index:0,name:"marketId",in:"path",required:!0,description:"ID of the AI Market Maker",schema:{type:"string"}}],requestBody:{required:!0,content:{"application/json":{schema:utils_1.poolWithdrawSchema}}},responses:{200:{description:"Pool withdrawal completed successfully",content:{"application/json":{schema:{type:"object",properties:{...utils_1.aiMarketMakerPoolSchema,wallet:{type:"object",properties:{currency:{type:"string",description:"Currency symbol"},balanceAfter:{type:"number",description:"Admin wallet balance after withdrawal"}}}}}}}},400:errors_1.badRequestResponse,401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("AI Market Maker Pool"),500:errors_1.serverErrorResponse},requiresAuth:!0,permission:"edit.ai.market-maker.pool"};exports.default=async e=>{var r;const{params:a,body:t,user:o,ctx:l}=e,{currency:i,amount:n}=t;if(!(null==o?void 0:o.id))throw(0,error_1.createError)(401,"Unauthorized");if(n<=0)throw(0,error_1.createError)(400,"Amount must be greater than 0");null==l||l.step("Fetch market maker with pool and market info");const s=await db_1.models.aiMarketMaker.findByPk(a.marketId,{include:[{model:db_1.models.aiMarketMakerPool,as:"pool"},{model:db_1.models.ecosystemMarket,as:"market"}]});if(!s)throw(0,error_1.createError)(404,"AI Market Maker not found");const c=s.pool;if(!c)throw(0,error_1.createError)(404,"Pool not found for this market maker");const d=s.market;if(!d)throw(0,error_1.createError)(404,"Ecosystem market not found");null==l||l.step("Validate market maker is not active");if("ACTIVE"===s.status)throw(0,error_1.createError)(400,"Cannot withdraw from active market maker. Please pause or stop it first.");null==l||l.step("Validate pool balance");const u=Number("BASE"===i?c.baseCurrencyBalance:c.quoteCurrencyBalance);if(n>u)throw(0,error_1.createError)(400,`Insufficient pool balance. Available: ${u}, Requested: ${n}`);const m="BASE"===i?d.currency:d.pair,p=await(0,wallet_1.getWalletByUserIdAndCurrency)(o.id,m);if(!p)throw(0,error_1.createError)(404,`Wallet not found for ${m}`);null==l||l.step("Execute withdrawal transaction");const k=await db_1.sequelize.transaction(async e=>{const r={};let a;if("BASE"===i){a="baseCurrencyBalance";r.baseCurrencyBalance=u-n}else{a="quoteCurrencyBalance";r.quoteCurrencyBalance=u-n}const t="BASE"===i?r.baseCurrencyBalance:Number(c.baseCurrencyBalance)||0,l="QUOTE"===i?r.quoteCurrencyBalance:Number(c.quoteCurrencyBalance)||0,k=Number(s.targetPrice)||0;r.totalValueLocked=t*k+l;await c.update(r,{transaction:e});const y=await wallet_2.walletService.credit({idempotencyKey:`admin_ai_mm_pool_withdraw_${c.id}_${i}`,userId:o.id,walletId:p.id,walletType:p.type,currency:m,amount:n,operationType:"AI_INVESTMENT_ROI",description:`Withdraw ${n} ${m} from AI Market Maker Pool`,metadata:{poolId:c.id,marketMakerId:s.id,marketSymbol:d.symbol,currencyType:i,action:"WITHDRAW"},transaction:e});await db_1.models.aiMarketMakerHistory.create({marketMakerId:s.id,action:"WITHDRAW",details:{currency:i,currencySymbol:m,amount:n,balanceBefore:u,balanceAfter:r[a],tvlAfter:r.totalValueLocked,toWallet:p.id,userId:o.id},priceAtAction:s.targetPrice,poolValueAtAction:r.totalValueLocked},{transaction:e});return{pool:await db_1.models.aiMarketMakerPool.findByPk(c.id,{transaction:e}),walletBalance:y.newBalance}});null==l||l.success("Withdrawal completed successfully");return{...null===(r=k.pool)||void 0===r?void 0:r.toJSON(),wallet:{currency:m,balanceAfter:k.walletBalance}}};