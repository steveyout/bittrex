"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),utils_1=require("../../utils"),errors_1=require("@b/utils/schema/errors"),error_1=require("@b/utils/error"),trend_1=require("../../utils/engine/trend");exports.metadata={summary:"Force AI Market Maker phase transition",operationId:"forceAiMarketMakerPhaseTransition",tags:["Admin","AI Market Maker","Market"],description:"Forces an immediate phase transition for an AI Market Maker. This is an admin override that bypasses normal phase transition logic. Use with caution as it affects market behavior.",logModule:"ADMIN_MM",logTitle:"Force Market Maker Phase Transition",parameters:[{index:0,name:"id",in:"path",required:!0,description:"ID of the AI Market Maker",schema:{type:"string"}}],requestBody:{required:!0,content:{"application/json":{schema:utils_1.forcePhaseSchema}}},responses:{200:{description:"Phase transition completed successfully",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"},previousPhase:{type:"string"},newPhase:{type:"string"},phaseTargetPrice:{type:"number"},durationHours:{type:"number"},nextPhaseChangeAt:{type:"string",format:"date-time"}}}}}},400:errors_1.badRequestResponse,401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("AI Market Maker Market"),500:errors_1.serverErrorResponse},requiresAuth:!0,permission:"edit.ai.market-maker.market"};exports.default=async e=>{const{params:r,body:t,ctx:a,user:s}=e,{targetPhase:o}=t;null==a||a.step("Fetch market maker from database");const i=await db_1.models.aiMarketMaker.findByPk(r.id,{include:[{model:db_1.models.aiMarketMakerPool,as:"pool"}]});if(!i)throw(0,error_1.createError)(404,"AI Market Maker not found");null==a||a.step("Validate phase transition");const n=["ACCUMULATION","MARKUP","DISTRIBUTION","MARKDOWN"];if(!n.includes(o))throw(0,error_1.createError)(400,`Invalid target phase. Must be one of: ${n.join(", ")}`);const d=i.currentPhase,u=Number(i.lastKnownPrice)||Number(i.targetPrice);null==a||a.step("Execute forced phase transition");const c=new trend_1.TrendManager,p=await c.forcePhaseTransition(i.id,u,d,o,null==s?void 0:s.id);null==a||a.success("Phase transition completed successfully");return{message:`Phase transition from ${d} to ${o} completed successfully`,previousPhase:d,newPhase:p.newPhase,phaseTargetPrice:p.phaseTargetPrice,durationHours:p.durationHours,phaseStartedAt:p.phaseStartedAt,nextPhaseChangeAt:p.nextPhaseChangeAt,warning:"This was a forced admin override. Normal phase transition rules were bypassed."}};