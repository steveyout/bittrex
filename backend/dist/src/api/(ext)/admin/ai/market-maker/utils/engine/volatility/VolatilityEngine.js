"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.VolatilityEngine=void 0;const PerlinNoise_1=require("./PerlinNoise");class VolatilityEngine{constructor(){this.noiseOffset=new Map;this.perlinNoise=new PerlinNoise_1.PerlinNoise}calculatePriceMovement(t,e,a,i,o,s){this.noiseOffset.has(t)||this.noiseOffset.set(t,1e4*Math.random());const n=this.noiseOffset.get(t),r=this.calculateMacroComponent(e,i,a.baseVolatility),l=this.calculateDailyComponent(a.baseVolatility,a.volatilityMultiplier),c=this.calculateMicroComponent(t,n,a.baseVolatility);let h=0;s&&s.strength>0&&(h=this.calculateGravityComponent(e,s));const m=(r+l+c+h+o*a.baseVolatility*.3)/100,M=a.baseVolatility*a.volatilityMultiplier/100,u=this.applyGBM(e,m,M),p=(u-e)/e*100;let y=o*a.momentumDecay;y+=.1*p;y=Math.max(-1,Math.min(1,y));const f=u>e?"BUY":"SELL";this.noiseOffset.set(t,n+.01);return{newPrice:Math.max(1e-8,u),direction:f,magnitude:Math.abs(u-e),percentChange:p,momentum:y}}calculateMacroComponent(t,e,a){const i=(e.targetPrice-t)/t*100;let o;switch(e.phase){case"ACCUMULATION":o=.1;break;case"MARKUP":o=.4;break;case"DISTRIBUTION":o=.15;break;case"MARKDOWN":o=.35}const s=i*o*(.5+.5*e.progress),n=.5*a;return Math.max(-n,Math.min(n,s))}calculateDailyComponent(t,e){const a=(new Date).getUTCHours();let i=1;a>=8&&a<=16||a>=13&&a<=17?i=1.3:a>=0&&a<=6&&(i=.7);return 2*(Math.random()-.5)*t*.2*e*i}calculateMicroComponent(t,e,a){return this.perlinNoise.octaveNoise(e,3,.5)*a*.15}calculateGravityComponent(t,e){return(e.price-t)/t*100*e.strength*.2}applyGBM(t,e,a){const i=1/86400;return t+t*(e*i+a*(this.randomNormal()*Math.sqrt(i)))}randomNormal(){let t=0,e=0;for(;0===t;)t=Math.random();for(;0===e;)e=Math.random();return Math.sqrt(-2*Math.log(t))*Math.cos(2*Math.PI*e)}resetNoise(t){this.noiseOffset.set(t,1e4*Math.random())}getNoiseTime(t){return this.noiseOffset.get(t)||0}}exports.VolatilityEngine=VolatilityEngine;exports.default=VolatilityEngine;