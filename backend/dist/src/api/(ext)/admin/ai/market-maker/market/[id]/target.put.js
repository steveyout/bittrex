"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),utils_1=require("../../utils"),errors_1=require("@b/utils/schema/errors"),error_1=require("@b/utils/error");exports.metadata={summary:"Update AI Market Maker market target price",operationId:"updateAiMarketMakerMarketTargetPrice",tags:["Admin","AI Market Maker","Market"],description:"Updates the target price for an AI Market Maker market. Validates that the new target price falls within the configured price range, calculates percentage change from previous target, warns about large price changes (>5%), and logs the change to history with pool value at time of action.",logModule:"ADMIN_MM",logTitle:"Update Market Maker Target Price",parameters:[{index:0,name:"id",in:"path",required:!0,description:"ID of the AI Market Maker",schema:{type:"string"}}],requestBody:{required:!0,content:{"application/json":{schema:utils_1.targetPriceUpdateSchema}}},responses:{200:{description:"Target price updated successfully",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"},previousTarget:{type:"number"},newTarget:{type:"number"}}}}}},400:errors_1.badRequestResponse,401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("AI Market Maker Market"),500:errors_1.serverErrorResponse},requiresAuth:!0,permission:"edit.ai.market-maker.market"};exports.default=async e=>{const{params:r,body:t,ctx:a}=e,{targetPrice:i}=t;null==a||a.step("Fetch market maker from database");const o=await db_1.models.aiMarketMaker.findByPk(r.id,{include:[{model:db_1.models.aiMarketMakerPool,as:"pool"}]});if(!o)throw(0,error_1.createError)(404,"AI Market Maker not found");null==a||a.step("Validate target price");if(i<Number(o.priceRangeLow)||i>Number(o.priceRangeHigh))throw(0,error_1.createError)(400,`Target price must be within range: ${o.priceRangeLow} - ${o.priceRangeHigh}`);const s=Number(o.targetPrice),n=(i-s)/s*100,c=Math.abs(n)>5;null==a||a.step("Update target price");await o.update({targetPrice:i});null==a||a.step("Create history record for target price change");const p=o.pool;await db_1.models.aiMarketMakerHistory.create({marketMakerId:o.id,action:"TARGET_CHANGE",details:{previousTarget:s,newTarget:i,percentChange:n.toFixed(2),isLargeChange:c},priceAtAction:i,poolValueAtAction:(null==p?void 0:p.totalValueLocked)||0});null==a||a.success("Target price updated successfully");return{message:"Target price updated successfully",previousTarget:s,newTarget:i,percentChange:n.toFixed(2),warning:c?`Large price change detected (${n.toFixed(2)}%). Monitor closely.`:void 0}};