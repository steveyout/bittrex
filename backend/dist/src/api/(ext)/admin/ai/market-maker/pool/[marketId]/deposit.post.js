"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),utils_1=require("../../utils"),errors_1=require("@b/utils/schema/errors"),error_1=require("@b/utils/error"),wallet_1=require("@b/api/(ext)/ecosystem/utils/wallet"),tvl_1=require("../../utils/helpers/tvl"),wallet_2=require("@b/services/wallet");exports.metadata={summary:"Deposit liquidity into AI Market Maker pool",operationId:"depositToMarketMakerPool",tags:["Admin","AI Market Maker","Pool"],description:"Deposits liquidity from the admin's wallet into an AI Market Maker pool. The deposit can be in either base or quote currency, and will update the pool's balance and TVL accordingly. A transaction record is created for auditing purposes.",logModule:"ADMIN_MM",logTitle:"Deposit to Market Maker Pool",parameters:[{index:0,name:"marketId",in:"path",required:!0,description:"ID of the AI Market Maker",schema:{type:"string"}}],requestBody:{required:!0,content:{"application/json":{schema:utils_1.poolDepositSchema}}},responses:{200:{description:"Pool deposit completed successfully",content:{"application/json":{schema:{type:"object",properties:{...utils_1.aiMarketMakerPoolSchema,wallet:{type:"object",properties:{currency:{type:"string",description:"Currency symbol"},balanceAfter:{type:"number",description:"Admin wallet balance after deposit"}}}}}}}},400:errors_1.badRequestResponse,401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("AI Market Maker Pool"),500:errors_1.serverErrorResponse},requiresAuth:!0,permission:"edit.ai.market-maker.pool"};exports.default=async e=>{var r;const{params:t,body:a,user:o,ctx:i}=e,{currency:n,amount:l}=a;if(!(null==o?void 0:o.id))throw(0,error_1.createError)(401,"Unauthorized");if(l<=0)throw(0,error_1.createError)(400,"Amount must be greater than 0");null==i||i.step("Fetch market maker with pool and market info");const s=await db_1.models.aiMarketMaker.findByPk(t.marketId,{include:[{model:db_1.models.aiMarketMakerPool,as:"pool"},{model:db_1.models.ecosystemMarket,as:"market"}]});if(!s)throw(0,error_1.createError)(404,"AI Market Maker not found");const c=s.pool;if(!c)throw(0,error_1.createError)(404,"Pool not found for this market maker");const u=s.market;if(!u)throw(0,error_1.createError)(404,"Ecosystem market not found");null==i||i.step("Validate admin wallet and balance");const d="BASE"===n?u.currency:u.pair,p=await(0,wallet_1.getWalletByUserIdAndCurrency)(o.id,d);if(!p)throw(0,error_1.createError)(404,`Wallet not found for ${d}`);const m=(()=>{if(null===p.balance||void 0===p.balance)return 0;const e=parseFloat(String(p.balance));return isNaN(e)?0:e})();if(m<l)throw(0,error_1.createError)(400,`Insufficient balance. You have ${m.toFixed(8)} ${d}, but trying to deposit ${l} ${d}`);null==i||i.step("Execute deposit transaction");const y=await db_1.sequelize.transaction(async e=>{const r=await wallet_2.walletService.debit({idempotencyKey:`admin_ai_mm_pool_deposit_${c.id}_${n}`,userId:o.id,walletId:p.id,walletType:p.type,currency:d,amount:l,operationType:"AI_INVESTMENT",description:`Deposit ${l} ${d} to AI Market Maker Pool`,metadata:{poolId:c.id,marketMakerId:s.id,marketSymbol:u.symbol,currencyType:n,action:"DEPOSIT"},transaction:e}),t={};let a;if("BASE"===n){a="baseCurrencyBalance";t.baseCurrencyBalance=Number(c.baseCurrencyBalance)+l;0===Number(c.initialBaseBalance)&&(t.initialBaseBalance=l)}else{a="quoteCurrencyBalance";t.quoteCurrencyBalance=Number(c.quoteCurrencyBalance)+l;0===Number(c.initialQuoteBalance)&&(t.initialQuoteBalance=l)}const i="BASE"===n?t.baseCurrencyBalance:Number(c.baseCurrencyBalance)||0,m="QUOTE"===n?t.quoteCurrencyBalance:Number(c.quoteCurrencyBalance)||0,y=Number(s.targetPrice)||0;t.totalValueLocked=(0,tvl_1.calculateTVL)({baseBalance:i,quoteBalance:m,currentPrice:y});await c.update(t,{transaction:e});await db_1.models.aiMarketMakerHistory.create({marketMakerId:s.id,action:"DEPOSIT",details:{currency:n,currencySymbol:d,amount:l,balanceAfter:t[a],tvlAfter:t.totalValueLocked,fromWallet:p.id,userId:o.id},priceAtAction:s.targetPrice,poolValueAtAction:t.totalValueLocked},{transaction:e});return{pool:await db_1.models.aiMarketMakerPool.findByPk(c.id,{transaction:e}),walletBalance:r.newBalance}});null==i||i.success("Deposit completed successfully");return{...null===(r=y.pool)||void 0===r?void 0:r.toJSON(),wallet:{currency:d,balanceAfter:y.walletBalance}}};