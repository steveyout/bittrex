"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.PnLCalculator=void 0;const db_1=require("@b/db"),tvl_1=require("../../helpers/tvl");class PnLCalculator{constructor(){this.unrealizedPnL=new Map;this.realizedPnL=new Map;this.initialPrices=new Map;this.currentPrices=new Map;this.dailyPnL=new Map}setInitialPrice(e,t){this.initialPrices.has(e)||this.initialPrices.set(e,t)}updateCurrentPrice(e,t){this.currentPrices.set(e,t)}async calculatePnL(e,t){try{const a=await t.getBalance(),i=t.getInitialBalances(),r=this.initialPrices.get(e)||1,n=this.currentPrices.get(e)||r,s=(0,tvl_1.calculatePnLFromTVL)(i.base,i.quote,a.baseCurrency,a.quoteCurrency,r,n);this.unrealizedPnL.set(e,s.absolutePnL);await this.updatePnLInDatabase(e)}catch(e){}}recordPnL(e,t,a){if(a){const a=this.realizedPnL.get(e)||0;this.realizedPnL.set(e,a+t);this.recordDailyPnL(e,t)}else this.unrealizedPnL.set(e,t)}async getPnL(e){const t=this.unrealizedPnL.get(e)||0,a=this.realizedPnL.get(e)||0;return{unrealized:t,realized:a,total:t+a}}getDailyPnL(e,t=7){return(this.dailyPnL.get(e)||[]).slice(-t)}getAggregatePnL(e,t){const a=this.dailyPnL.get(e)||[];let i;switch(t){case"day":i=1;break;case"week":i=7;break;case"month":i=30}return a.slice(-i).reduce((e,t)=>e+t,0)}resetDaily(){for(const[e]of this.realizedPnL){const t=this.realizedPnL.get(e)||0;this.recordDailyPnL(e,t)}this.realizedPnL.clear()}recordDailyPnL(e,t){const a=this.dailyPnL.get(e)||[];a.push(t);a.length>30&&a.shift();this.dailyPnL.set(e,a)}async updatePnLInDatabase(e){try{const t=this.unrealizedPnL.get(e)||0,a=this.realizedPnL.get(e)||0;await db_1.models.aiMarketMakerPool.update({unrealizedPnL:t,realizedPnL:a},{where:{marketMakerId:e}})}catch(e){}}}exports.PnLCalculator=PnLCalculator;exports.default=PnLCalculator;