"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),errors_1=require("@b/utils/schema/errors"),error_1=require("@b/utils/error"),console_1=require("@b/utils/console"),queries_1=require("../../utils/scylla/queries"),matchingEngine_1=require("@b/api/(ext)/ecosystem/utils/matchingEngine"),wallet_1=require("@b/api/(ext)/ecosystem/utils/wallet"),MarketMakerEngine_1=__importDefault(require("../../utils/engine/MarketMakerEngine")),wallet_2=require("@b/services/wallet");exports.metadata={summary:"Delete AI Market Maker market",operationId:"deleteAiMarketMakerMarket",tags:["Admin","AI Market Maker","Market"],description:"Permanently deletes an AI Market Maker market. Automatically stops the market if active, cancels all open ecosystem orders, withdraws remaining pool balances to admin wallet, cleans up all ScyllaDB and MySQL data including trade history, and creates withdrawal transaction records. This operation cannot be undone.",logModule:"ADMIN_MM",logTitle:"Delete AI Market Maker",parameters:[{index:0,name:"id",in:"path",required:!0,description:"ID of the AI Market Maker to delete",schema:{type:"string"}}],responses:{200:{description:"AI Market Maker deleted successfully",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"},withdrawal:{type:"object",properties:{baseAmount:{type:"number"},quoteAmount:{type:"number"},baseCurrency:{type:"string"},quoteCurrency:{type:"string"}}},cleanup:{type:"object",properties:{ordersDeleted:{type:"number"},tradesDeleted:{type:"number"},priceHistoryDeleted:{type:"number"},realLiquidityOrdersDeleted:{type:"number"},orderbookEntriesCleared:{type:"number"},ecosystemOrdersCancelled:{type:"number"}}}}}}}},401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("AI Market Maker Market"),500:errors_1.serverErrorResponse},requiresAuth:!0,permission:"delete.ai.market-maker.market"};exports.default=async e=>{const{params:r,user:t,ctx:a}=e;if(!(null==t?void 0:t.id))throw(0,error_1.createError)(401,"Unauthorized");null==a||a.step("Fetch market maker with related data");const o=await db_1.models.aiMarketMaker.findByPk(r.id,{include:[{model:db_1.models.aiMarketMakerPool,as:"pool"},{model:db_1.models.aiBot,as:"bots"},{model:db_1.models.ecosystemMarket,as:"market"}]});if(!o)throw(0,error_1.createError)(404,"AI Market Maker not found");const l=o,n=l.pool,i=l.market,s=i?`${i.currency}/${i.pair}`:null,d=l.marketId;null==a||a.step("Stop market maker if active");if("ACTIVE"===o.status||"PAUSED"===o.status){const e=MarketMakerEngine_1.default.getMarketManager();if(e&&e.isMarketActive(r.id)){console_1.logger.info("AI_MM",`Delete: Stopping market maker ${r.id} through engine...`);await e.stopMarket(r.id)||console_1.logger.warn("AI_MM","Delete: Engine stopMarket returned false, forcing stop...");const t=1e4,a=Date.now();for(;Date.now()-a<t;){const t=e.getMarketStatus(r.id);if(!t||"STOPPED"===t){console_1.logger.info("AI_MM","Delete: Engine confirmed market stopped");break}await new Promise(e=>setTimeout(e,500))}}await o.update({status:"STOPPED"});console_1.logger.info("AI_MM",`Delete: Stopped market maker ${r.id}`)}null==a||a.step("Cancel open ecosystem orders");let c=0,u=[],m=0;if(s)try{const e=await(0,queries_1.getOpenBotEcosystemOrderIds)(s);m=e.length;if(e.length>0){const r=await matchingEngine_1.MatchingEngine.getInstance(),t=await Promise.allSettled(e.map(e=>r.handleOrderCancellation(e,s).then(()=>({orderId:e,success:!0})).catch(r=>({orderId:e,success:!1,error:r.message||String(r)}))));for(const e of t)if("fulfilled"===e.status){const{orderId:r,success:t,error:a}=e.value;t?c++:a&&u.push({orderId:r,error:a})}else console_1.logger.warn("AI_MM",`Delete: Order cancellation promise rejected: ${e.reason}`);console_1.logger.info("AI_MM",`Delete: Cancelled ${c}/${m} orders for ${s}`);u.length>0&&console_1.logger.warn("AI_MM",`Delete: Failed to cancel ${u.length} orders: ${u.map(e=>e.orderId).join(", ")}`)}}catch(e){console_1.logger.error("AI_MM",`Delete: Failed to cancel orders: ${e}`)}null==a||a.step("Auto-withdraw pool balances to admin wallet");let p={baseAmount:0,quoteAmount:0,baseCurrency:(null==i?void 0:i.currency)||"UNKNOWN",quoteCurrency:(null==i?void 0:i.pair)||"UNKNOWN"};if(n&&i){const e=Number(n.baseCurrencyBalance)||0,r=Number(n.quoteCurrencyBalance)||0;if(e>0)try{const r=await(0,wallet_1.getWalletByUserIdAndCurrency)(t.id,i.currency);if(r){await wallet_2.walletService.credit({idempotencyKey:`admin_ai_mm_delete_withdraw_base_${o.id}`,userId:t.id,walletId:r.id,walletType:r.type,currency:i.currency,amount:e,operationType:"AI_INVESTMENT_ROI",description:`Auto-withdraw ${e} ${i.currency} from deleted AI Market Maker Pool`,metadata:{poolId:null==n?void 0:n.id,marketMakerId:o.id,marketSymbol:s,action:"DELETE_WITHDRAW"}});p.baseAmount=e;console_1.logger.info("AI_MM",`Delete: Withdrawn ${e} ${i.currency} to admin wallet`)}else console_1.logger.warn("AI_MM",`Delete: Admin wallet not found for ${i.currency}, funds will be lost`)}catch(e){console_1.logger.error("AI_MM",`Delete: Failed to withdraw base currency: ${e}`)}if(r>0)try{const e=await(0,wallet_1.getWalletByUserIdAndCurrency)(t.id,i.pair);if(e){await wallet_2.walletService.credit({idempotencyKey:`admin_ai_mm_delete_withdraw_quote_${o.id}`,userId:t.id,walletId:e.id,walletType:e.type,currency:i.pair,amount:r,operationType:"AI_INVESTMENT_ROI",description:`Auto-withdraw ${r} ${i.pair} from deleted AI Market Maker Pool`,metadata:{poolId:null==n?void 0:n.id,marketMakerId:o.id,marketSymbol:s,action:"DELETE_WITHDRAW"}});p.quoteAmount=r;console_1.logger.info("AI_MM",`Delete: Withdrawn ${r} ${i.pair} to admin wallet`)}else console_1.logger.warn("AI_MM",`Delete: Admin wallet not found for ${i.pair}, funds will be lost`)}catch(e){console_1.logger.error("AI_MM",`Delete: Failed to withdraw quote currency: ${e}`)}}null==a||a.step("Clean up ScyllaDB data");let M={ordersDeleted:0,tradesDeleted:0,priceHistoryDeleted:0,realLiquidityOrdersDeleted:0,orderbookEntriesCleared:0};if(d&&s)try{M=await(0,queries_1.cleanupMarketMakerData)(d,s)}catch(e){console_1.logger.error("AI_MM",`Delete: ScyllaDB cleanup failed: ${e}`)}null==a||a.step("Clean up MySQL data");const y=await db_1.sequelize.transaction();try{await db_1.models.aiBot.destroy({where:{marketMakerId:o.id},transaction:y});await db_1.models.aiMarketMakerPool.destroy({where:{marketMakerId:o.id},transaction:y});await db_1.models.aiMarketMakerHistory.destroy({where:{marketMakerId:o.id},transaction:y});await o.destroy({transaction:y});await y.commit();null==a||a.success("AI Market Maker deleted successfully");return{message:"AI Market Maker deleted successfully",withdrawal:{baseAmount:p.baseAmount,quoteAmount:p.quoteAmount,baseCurrency:p.baseCurrency,quoteCurrency:p.quoteCurrency},cleanup:{...M,ecosystemOrdersCancelled:c,totalOrdersFound:m,failedCancellations:u.length>0?u:void 0}}}catch(e){await y.rollback();throw e}};