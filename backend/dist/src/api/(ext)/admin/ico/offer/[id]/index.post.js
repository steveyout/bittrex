"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),utils_1=require("../../utils"),notifications_1=require("@b/utils/notifications"),console_1=require("@b/utils/console");exports.metadata={summary:"Manage ICO Offering",description:"Performs an admin action on an ICO offering. The action is determined by the 'action' query parameter, which accepts one of: approve, flag, pause, reject, resume, or unflag. Depending on the action, the offering’s status is updated, admin activity is logged, and an email and in‑app notification is sent to the project owner if applicable.",operationId:"manageIcoOffering",tags:["ICO","Admin","Offerings"],requiresAuth:!0,parameters:[{index:0,name:"id",in:"path",required:!0,schema:{type:"string",description:"The ID of the ICO offering."}},{index:1,name:"action",in:"query",required:!0,schema:{type:"string",enum:["approve","flag","pause","reject","resume","unflag"],description:"The admin action to perform on the ICO offering. Allowed values: approve, flag, pause, reject, resume, unflag."}}],requestBody:{required:!1,content:{"application/json":{schema:{type:"object",properties:{notes:{type:"string",description:"Optional notes for the action (required for rejection, optional for flagging)."}}}}}},responses:{200:{description:"ICO offering updated successfully.",content:{"application/json":{schema:{type:"object",properties:{offering:{type:"object"}}}}}},400:{description:"Bad Request"},401:{description:"Unauthorized – Admin authentication required."},404:{description:"ICO offering not found or the current status is invalid for the requested action."},500:{description:"Internal Server Error"}},permission:"edit.ico.offer",logModule:"ADMIN_ICO",logTitle:"Manage ICO Offering"};const offeringActions={approve:async(e,a)=>{if("PENDING"!==e.status)throw(0,error_1.createError)({statusCode:404,message:"ICO offering not found or not pending."});await e.update({status:"ACTIVE",approvedAt:a});return{emailTemplate:"IcoOfferingApproved",emailData:{OFFERING_NAME:e.name,APPROVED_AT:a.toLocaleString()},message:"ICO offering approved successfully."}},flag:async(e,a,t)=>{await e.update({isFlagged:!0});return{emailTemplate:"IcoOfferingFlagged",emailData:{OFFERING_NAME:e.name,FLAG_REASON:(null==t?void 0:t.notes)||"No additional reason provided"},message:"ICO offering flagged successfully."}},pause:async e=>{if("ACTIVE"!==e.status)throw(0,error_1.createError)({statusCode:404,message:"ICO offering not found or not active."});await e.update({isPaused:!0});return{message:"ICO offering paused successfully."}},reject:async(e,a,t)=>{if("PENDING"!==e.status)throw(0,error_1.createError)({statusCode:404,message:"ICO offering not found or not pending."});if(!(null==t?void 0:t.notes)||!t.notes.trim())throw(0,error_1.createError)({statusCode:400,message:"Rejection notes are required."});await e.update({status:"REJECTED",rejectedAt:a,reviewNotes:t.notes});return{emailTemplate:"IcoOfferingRejected",emailData:{OFFERING_NAME:e.name,REJECTION_REASON:t.notes},message:"ICO offering rejected successfully."}},resume:async e=>{if("ACTIVE"!==e.status||!e.isPaused)throw(0,error_1.createError)({statusCode:404,message:"ICO offering not found or not paused."});await e.update({isPaused:!1});return{message:"ICO offering resumed successfully."}},unflag:async e=>{await e.update({isFlagged:!1});return{emailTemplate:"IcoOfferingUnflagged",emailData:{OFFERING_NAME:e.name},message:"ICO offering unflagged successfully."}}},notifMapping={approve:{title:"Offering Approved",message:e=>`Your ICO offering "${e}" has been approved.`,details:e=>`Your offering was approved on ${e.toLocaleString()}.`},flag:{title:"Offering Flagged",message:e=>`Your ICO offering "${e}" has been flagged.`,details:e=>`Your offering has been flagged for review. Reason: ${e.FLAG_REASON}.`},reject:{title:"Offering Rejected",message:e=>`Your ICO offering "${e}" has been rejected.`,details:e=>`Your offering was rejected. Reason: ${e.REJECTION_REASON}.`},unflag:{title:"Offering Unflagged",message:e=>`Your ICO offering "${e}" has been unflagged.`,details:()=>"The flag has been removed from your offering."},pause:{title:"Offering Paused",message:e=>`Your ICO offering "${e}" has been paused.`,details:()=>"Your offering has been paused."},resume:{title:"Offering Resumed",message:e=>`Your ICO offering "${e}" has been resumed.`,details:()=>"Your offering has been resumed."}};exports.default=async e=>{const{params:a,query:t,body:r,user:i,ctx:o}=e;if(!(null==i?void 0:i.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized: Admin privileges required."});const s=a.id,n=(t.action||"").toLowerCase();if(!["approve","flag","pause","reject","resume","unflag"].includes(n))throw(0,error_1.createError)({statusCode:400,message:"Invalid or missing action. Allowed actions: approve, flag, pause, reject, resume, unflag."});null==o||o.step(`Fetching ICO offering for action: ${n}`);const f=await db_1.models.icoTokenOffering.findOne({where:{id:s}});if(!f)throw(0,error_1.createError)({statusCode:404,message:"ICO offering not found."});const d=new Date;null==o||o.step(`Processing action: ${n}`);let l;try{l=await offeringActions[n](f,d,r)}catch(e){throw(0,error_1.createError)({statusCode:e.statusCode||500,message:e.message})}null==o||o.step("Logging admin activity");await db_1.models.icoAdminActivity.create({type:n,offeringId:f.id,offeringName:f.name,timestamp:d,adminId:i.id,adminName:`${i.firstName} ${i.lastName}`});null==o||o.step("Sending email and notifications");const u=await db_1.models.user.findByPk(f.userId);if(l.emailTemplate&&u){const e={...l.emailData,PROJECT_OWNER_NAME:`${u.firstName} ${u.lastName}`};await(async(e,a,t)=>{if(null==a?void 0:a.email)try{await(0,utils_1.sendIcoEmail)(e,a.email,t,o)}catch(a){console_1.logger.error("ADMIN_ICO_OFFER",`Failed to send ${e} email`,a)}})(l.emailTemplate,u,e)}if(u&&notifMapping[n]){const e=notifMapping[n];try{await(0,notifications_1.createNotification)({userId:u.id,relatedId:f.id,type:"system",title:e.title,message:e.message(f.name),details:"function"==typeof e.details?e.details(l.emailData||d):"",link:`/ico/creator/token/${f.id}`,actions:[{label:"View Offering",link:`/ico/creator/token/${f.id}`,primary:!0}]},o)}catch(e){console_1.logger.error("ADMIN_ICO_OFFER",`Failed to create in-app notification for action ${n}`,e)}}null==o||o.step("Fetching updated offering data");const c=await db_1.models.icoTokenOffering.findOne({where:{id:s},include:[{model:db_1.models.icoTokenDetail,as:"tokenDetail",include:[{model:db_1.models.icoTokenType,as:"tokenTypeData"}]},{model:db_1.models.icoLaunchPlan,as:"plan"}]});null==o||o.success(`ICO offering ${n} action completed successfully`);return{message:l.message||"ICO offering updated successfully.",offering:c}};