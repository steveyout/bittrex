"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error");exports.metadata={summary:"Add ICO Phase (Admin)",description:"Adds a new phase to an existing ICO offering. This allows extending the ICO with additional sale phases.",operationId:"addIcoPhaseAdmin",tags:["ICO","Admin","Offerings"],requiresAuth:!0,logModule:"ADMIN_ICO",logTitle:"Add ICO Phase",parameters:[{name:"id",in:"path",required:!0,schema:{type:"string",description:"The ID of the ICO offering."}}],requestBody:{required:!0,content:{"application/json":{schema:{type:"object",required:["name","tokenPrice","allocation","duration"],properties:{name:{type:"string",description:"Name of the phase (e.g., 'Phase 4', 'Extension Phase')"},tokenPrice:{type:"number",description:"Token price for this phase"},allocation:{type:"number",description:"Number of tokens allocated for this phase"},duration:{type:"integer",description:"Duration of the phase in days"}}}}}},responses:{200:{description:"Phase added successfully",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"},phase:{type:"object"},newEndDate:{type:"string",format:"date-time"}}}}}},400:{description:"Invalid request data"},401:{description:"Unauthorized â€“ Admin privileges required."},404:{description:"ICO offering not found."},500:{description:"Internal Server Error"}},permission:"edit.ico.offer"};exports.default=async e=>{const{user:t,params:a,body:s,ctx:r}=e;null==r||r.step("Validate user authentication");if(!(null==t?void 0:t.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized: Admin privileges required."});const{id:i}=a,{name:o,tokenPrice:n,allocation:d,duration:c}=s;null==r||r.step("Validate request body");if(!o||"string"!=typeof o||0===o.trim().length)throw(0,error_1.createError)({statusCode:400,message:"Phase name is required."});if("number"!=typeof n||n<=0)throw(0,error_1.createError)({statusCode:400,message:"Token price must be a positive number."});if("number"!=typeof d||d<=0)throw(0,error_1.createError)({statusCode:400,message:"Allocation must be a positive number."});if("number"!=typeof c||c<=0||!Number.isInteger(c))throw(0,error_1.createError)({statusCode:400,message:"Duration must be a positive integer (days)."});const u=await db_1.sequelize.transaction();try{null==r||r.step("Fetch ICO offering");const e=await db_1.models.icoTokenOffering.findByPk(i,{include:[{model:db_1.models.icoTokenOfferingPhase,as:"phases"}],transaction:u});if(!e)throw(0,error_1.createError)({statusCode:404,message:"ICO offering not found."});if(!["ACTIVE","PENDING","UPCOMING","SUCCESS"].includes(e.status))throw(0,error_1.createError)({statusCode:400,message:`Cannot add phase to offering with status: ${e.status}`});null==r||r.step("Calculate next sequence number");const a=e.phases||[],s=a.reduce((e,t)=>Math.max(e,t.sequence||0),-1)+1;null==r||r.step("Check for duplicate phase name");if(a.some(e=>e.name.toLowerCase()===o.trim().toLowerCase()))throw(0,error_1.createError)({statusCode:400,message:"A phase with this name already exists."});null==r||r.step("Calculate phase dates");const l=new Date,p=new Date(e.endDate),m=p>l?p:l,h=new Date(m);h.setDate(h.getDate()+c);null==r||r.step("Create new phase");const f=await db_1.models.icoTokenOfferingPhase.create({offeringId:i,name:o.trim(),tokenPrice:n,allocation:d,remaining:d,duration:c,sequence:s,startDate:m,endDate:h},{transaction:u});null==r||r.step("Update offering end date and status");const g={endDate:h};("SUCCESS"===e.status||p<=l)&&(g.status="ACTIVE");await e.update(g,{transaction:u});null==r||r.step("Log admin activity");await db_1.models.icoAdminActivity.create({type:"PHASE_ADDED",offeringId:i,offeringName:e.name,adminId:t.id,details:JSON.stringify({phaseName:o.trim(),tokenPrice:n,allocation:d,duration:c,phaseStartDate:m.toISOString(),newEndDate:h.toISOString(),statusChanged:g.status?`Reactivated to ${g.status}`:null})},{transaction:u});await u.commit();null==r||r.success("Phase added successfully");return{message:"Phase added successfully",phase:f,phaseStartDate:m.toISOString(),newEndDate:h.toISOString(),statusReactivated:!!g.status}}catch(e){await u.rollback();throw e}};