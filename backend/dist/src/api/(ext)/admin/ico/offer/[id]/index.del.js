"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),query_1=require("@b/utils/query"),sequelize_1=require("sequelize"),console_1=require("@b/utils/console");exports.metadata={summary:"Delete an ICO offering",description:"Deletes an ICO token offering. Admin-only endpoint. Cannot delete offerings with active investments.",operationId:"deleteIcoOffering",tags:["ICO","Admin","Offerings"],parameters:[{name:"id",in:"path",description:"ID of the ICO offering to delete",required:!0,schema:{type:"string"}}],requiresAuth:!0,permission:"delete.ico.offer",responses:{200:{description:"Offering deleted successfully"},400:{description:"Bad Request - Cannot delete offering with active investments"},401:query_1.unauthorizedResponse,403:{description:"Forbidden - Admin privileges required"},404:(0,query_1.notFoundMetadataResponse)("Offering"),500:query_1.serverErrorResponse},logModule:"ADMIN_ICO",logTitle:"Delete ICO Offering"};exports.default=async e=>{var r;const{user:t,params:o,ctx:i}=e;if(!(null==t?void 0:t.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized: Admin privileges required"});const{id:s}=o;let n;try{n=await db_1.sequelize.transaction();null==i||i.step("Finding ICO offering");const e=await db_1.models.icoTokenOffering.findByPk(s,{transaction:n});if(!e)throw(0,error_1.createError)({statusCode:404,message:"Offering not found"});null==i||i.step("Checking for active transactions");const r=await db_1.models.icoTransaction.count({where:{offeringId:s,status:{[sequelize_1.Op.in]:["PENDING","VERIFICATION"]}},transaction:n});if(r>0)throw(0,error_1.createError)({statusCode:400,message:`Cannot delete offering with ${r} active investment(s). Please wait for all investments to be released or rejected first.`});if("SUCCESS"===e.status)throw(0,error_1.createError)({statusCode:400,message:"Cannot delete successful offerings. They are kept for historical records."});null==i||i.step("Deleting associated records");await db_1.models.icoTokenOfferingPhase.destroy({where:{offeringId:s},transaction:n});await db_1.models.icoTeamMember.destroy({where:{offeringId:s},transaction:n});await db_1.models.icoRoadmapItem.destroy({where:{offeringId:s},transaction:n});await db_1.models.icoTokenOfferingUpdate.destroy({where:{offeringId:s},transaction:n});await db_1.models.icoAdminActivity.destroy({where:{offeringId:s},transaction:n});await db_1.models.icoTokenDetail.destroy({where:{offeringId:s},transaction:n});await db_1.models.icoTransaction.destroy({where:{offeringId:s},transaction:n});null==i||i.step("Deleting offering");await e.destroy({transaction:n});await n.commit();null==i||i.success("ICO offering deleted successfully");return{message:"ICO offering deleted successfully"}}catch(e){if(n)try{n.finished||await n.rollback()}catch(e){(null===(r=e.message)||void 0===r?void 0:r.includes("already been finished"))||console_1.logger.error("ADMIN_ICO_OFFER","Transaction rollback failed",e)}console_1.logger.error("ADMIN_ICO_OFFER","Error deleting ICO offering",e);if(e.statusCode)throw e;throw(0,error_1.createError)({statusCode:500,message:e.message||"Failed to delete ICO offering"})}};