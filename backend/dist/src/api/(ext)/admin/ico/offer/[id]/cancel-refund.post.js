"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),query_1=require("@b/utils/query"),sequelize_1=require("sequelize"),console_1=require("@b/utils/console"),notification_1=require("@b/services/notification"),wallet_1=require("@b/services/wallet");exports.metadata={summary:"Emergency Cancel & Refund ICO (SuperAdmin Only)",description:"Emergency cancellation endpoint for SuperAdmins only. Cancels an active ICO offering and refunds ALL investors. Use this for scam prevention or critical security issues.",operationId:"emergencyCancelIcoOffering",tags:["ICO","Admin","Offerings","Emergency"],parameters:[{name:"id",in:"path",description:"ID of the ICO offering to cancel",required:!0,schema:{type:"string"}}],requestBody:{required:!0,content:{"application/json":{schema:{type:"object",properties:{reason:{type:"string",description:"Reason for emergency cancellation (required for audit trail, minimum 10 characters)"}},required:["reason"]}}}},requiresAuth:!0,permission:"manage.system",responses:{200:{description:"ICO cancelled and all investors refunded successfully"},401:query_1.unauthorizedResponse,403:{description:"Forbidden - SuperAdmin privileges required"},404:(0,query_1.notFoundMetadataResponse)("Offering"),500:query_1.serverErrorResponse},logModule:"ADMIN_ICO",logTitle:"Emergency Cancel & Refund ICO"};exports.default=async e=>{var r,n,t;const{user:s,params:a,body:i,ctx:o}=e;if(!(null==s?void 0:s.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized: SuperAdmin privileges required"});null==o||o.step("Verifying SuperAdmin privileges");const d=await db_1.models.user.findByPk(s.id,{include:[{model:db_1.models.role,as:"role",attributes:["name"]}]});if(!d||"Super Admin"!==(null===(r=d.role)||void 0===r?void 0:r.name))throw(0,error_1.createError)({statusCode:403,message:"Forbidden: This endpoint is restricted to SuperAdmins only"});const{id:l}=a,{reason:c}=i;if(!c||c.trim().length<10)throw(0,error_1.createError)({statusCode:400,message:"Cancellation reason is required (minimum 10 characters)"});let u;try{u=await db_1.sequelize.transaction();null==o||o.step("Finding ICO offering");const e=await db_1.models.icoTokenOffering.findByPk(l,{transaction:u,include:[{model:db_1.models.user,as:"user",attributes:["id","firstName","lastName","email"]}]});if(!e)throw(0,error_1.createError)({statusCode:404,message:"ICO offering not found"});null==o||o.step("Retrieving all active investments");const r=await db_1.models.icoTransaction.findAll({where:{offeringId:l,status:{[sequelize_1.Op.in]:["PENDING","VERIFICATION","RELEASED"]}},include:[{model:db_1.models.user,as:"user",attributes:["id","firstName","lastName","email"]}],transaction:u});console_1.logger.info("ADMIN_ICO_CANCEL",`Found ${r.length} active investments to refund`);const t=e.purchaseWalletType,a=e.purchaseWalletCurrency;null==o||o.step(`Processing ${r.length} refunds`);let i=0,f=0,m=0;const g=[];for(const n of r)try{const r=await wallet_1.walletService.credit({idempotencyKey:`ico_emergency_refund_${n.id}`,userId:n.userId,walletType:t,currency:a,amount:n.amount,operationType:"REFUND",description:`Emergency ICO refund for: ${e.name}. Reason: ${c}`,referenceId:`ico_refund_${n.id}`,transaction:u,metadata:{offeringId:l,offeringName:e.name,investmentId:n.id,cancelledBy:s.id,emergencyCancellation:!0}});await n.update({status:"REJECTED",notes:`EMERGENCY CANCELLATION - ${c}`},{transaction:u});i+=n.amount;f++;g.push({transactionId:n.id,userId:n.userId,userName:n.user?`${n.user.firstName} ${n.user.lastName}`:"Unknown",amount:n.amount,currency:a,status:"SUCCESS",walletTransactionId:r.transactionId});console_1.logger.success("ADMIN_ICO_CANCEL",`Refunded ${n.amount} ${a} to user ${n.userId}`)}catch(e){if("DuplicateOperationError"===e.name){console_1.logger.warn("ADMIN_ICO_CANCEL",`Investment ${n.id} already refunded, skipping`);f++;g.push({transactionId:n.id,userId:n.userId,amount:n.amount,currency:a,status:"ALREADY_REFUNDED"});continue}console_1.logger.error("ADMIN_ICO_CANCEL",`Failed to refund investment ${n.id}`,e);m++;g.push({transactionId:n.id,userId:n.userId,amount:n.amount,currency:a,status:"FAILED",reason:e.message})}null==o||o.step("Updating offering status to CANCELLED");await e.update({status:"CANCELLED",cancelledAt:new Date,cancelledBy:s.id,cancellationReason:c},{transaction:u});await db_1.models.icoAdminActivity.create({type:"EMERGENCY_CANCEL_REFUND",offeringId:l,offeringName:e.name,adminId:s.id,details:JSON.stringify({reason:c,totalInvestments:r.length,successfulRefunds:f,failedRefunds:m,totalRefunded:i,refundDetails:g,cancelledBy:null===(n=d.role)||void 0===n?void 0:n.name,timestamp:(new Date).toISOString()})},{transaction:u});if(m>0){await u.rollback();throw(0,error_1.createError)({statusCode:500,message:`Failed to refund ${m} investment(s). Transaction rolled back. Please resolve wallet issues and try again.`})}await u.commit();null==o||o.step("Sending notifications to refunded investors");for(const r of g)if("SUCCESS"===r.status)try{await notification_1.notificationService.send({userId:r.userId,type:"ICO",channels:["IN_APP"],idempotencyKey:`ico_refund_${l}_${r.userId}_${r.transactionId}`,data:{title:"ICO Investment Refunded",message:`Your investment of ${r.amount} ${r.currency} in "${e.name}" has been refunded due to: ${c}`},priority:"HIGH"})}catch(e){console_1.logger.error("ADMIN_ICO_CANCEL","Failed to send refund notification",e)}null==o||o.success("Emergency cancellation and refunds completed successfully");return{message:"ICO offering cancelled and all investments refunded successfully",data:{offeringId:l,offeringName:e.name,totalInvestments:r.length,successfulRefunds:f,failedRefunds:m,totalRefunded:i,currency:a||"N/A",cancelledBy:`${d.firstName} ${d.lastName}`,reason:c,refundDetails:g}}}catch(e){if(u)try{u.finished||await u.rollback()}catch(e){(null===(t=e.message)||void 0===t?void 0:t.includes("already been finished"))||console_1.logger.error("ADMIN_ICO_CANCEL","Transaction rollback failed",e)}console_1.logger.error("ADMIN_ICO_CANCEL","Error cancelling ICO offering",e);if(e.statusCode)throw e;throw(0,error_1.createError)({statusCode:500,message:e.message||"Failed to cancel ICO offering and refund investments"})}};