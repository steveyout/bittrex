"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),utils_1=require("@b/api/finance/wallet/utils"),notifications_1=require("@b/utils/notifications"),utils_2=require("../../utils");exports.metadata={summary:"Update Transaction Action",description:"Performs an admin action on a transaction (verify, reject, save-note, remove-note). On verification approval, credits the seller’s wallet with the locked funds; on rejection, refunds the investor’s wallet.",operationId:"adminUpdateTransactionAction",tags:["ICO","Admin","Transaction"],requiresAuth:!0,parameters:[{name:"action",in:"query",description:"Action to perform. Valid values: verify, reject, save-note, remove-note",required:!0,schema:{type:"string"}}],requestBody:{description:"Optional note for actions that require it.",content:{"application/json":{schema:{type:"object",properties:{note:{type:"string"}}}}}},responses:{200:{description:"Transaction updated successfully."},400:{description:"Bad Request – Invalid action or missing parameters."},401:{description:"Unauthorized – Admin privileges required."},404:{description:"Transaction not found."},500:{description:"Internal Server Error"}},permission:"edit.ico.transaction",logModule:"ADMIN_ICO",logTitle:"Update ICO Transaction"};const updateActions={verify:async(e,t,a)=>{if("VERIFICATION"!==e.status)throw(0,error_1.createError)({statusCode:400,message:"Transaction is not pending verification."});const r=await(0,utils_1.getWallet)(e.offering.userId,e.offering.purchaseWalletType,e.offering.purchaseWalletCurrency);if(!r)throw(0,error_1.createError)({statusCode:400,message:"Seller wallet not found."});const n=await db_1.models.wallet.findOne({where:{id:r.id},transaction:t,lock:t.LOCK.UPDATE});await n.update({balance:n.balance+a},{transaction:t});await e.update({status:"RELEASED"},{transaction:t});return{message:"Transaction verified successfully."}},reject:async(e,t,a,r)=>{if("VERIFICATION"!==e.status)throw(0,error_1.createError)({statusCode:400,message:"Transaction is not pending verification."});const n=await(0,utils_1.getWallet)(e.userId,e.offering.purchaseWalletType,e.offering.purchaseWalletCurrency);if(!n)throw(0,error_1.createError)({statusCode:400,message:"Investor wallet not found."});const o=await db_1.models.wallet.findOne({where:{id:n.id},transaction:t,lock:t.LOCK.UPDATE});await o.update({balance:o.balance+a},{transaction:t});await e.update({status:"REJECTED",notes:r||e.notes},{transaction:t});return{message:"Transaction rejected successfully."}},"save-note":async(e,t,a,r)=>{if("RELEASED"===e.status)throw(0,error_1.createError)({statusCode:400,message:"Cannot add note: Transaction already verified and released."});if(!r)throw(0,error_1.createError)({statusCode:400,message:"Note is required for saving transaction note."});await e.update({notes:r},{transaction:t});return{message:"Transaction note saved successfully."}},"remove-note":async(e,t)=>{if(!e.notes||""===e.notes.trim())throw(0,error_1.createError)({statusCode:400,message:"Cannot remove note: No note exists."});await e.update({notes:""},{transaction:t});return{message:"Transaction note removed successfully."}}},emailMapping={verify:{buyer:"TransactionVerifiedBuyer",seller:"TransactionVerifiedSeller"},reject:{buyer:"TransactionRejectedBuyer",seller:"TransactionRejectedSeller"},"save-note":{buyer:"TransactionNoteAddedBuyer",seller:"TransactionNoteAddedSeller"},"remove-note":{buyer:"TransactionNoteRemovedBuyer",seller:"TransactionNoteRemovedSeller"}},notifMapping={verify:{buyer:{title:"Transaction Verified",message:(e,t)=>`Your transaction for offering "${e}" has been verified.${t?" Note: "+t:""}`,link:e=>`/ico/investor/transactions/${e}`},seller:{title:"Transaction Verified",message:(e,t)=>`Transaction for your offering "${e}" has been verified.${t?" Note: "+t:""}`,link:e=>`/ico/creator/token/${e}?tab=transactions`}},reject:{buyer:{title:"Transaction Rejected",message:(e,t)=>`Your transaction for offering "${e}" has been rejected.${t?" Note: "+t:""}`,link:e=>`/ico/investor/transactions/${e}`},seller:{title:"Transaction Rejected",message:(e,t)=>`A transaction for your offering "${e}" has been rejected.${t?" Note: "+t:""}`,link:e=>`/ico/creator/token/${e}?tab=transactions`}},"save-note":{buyer:{title:"Transaction Note Added",message:(e,t)=>`A note has been added to your transaction for offering "${e}".${t?" Note: "+t:""}`,link:e=>`/ico/investor/transactions/${e}`},seller:{title:"Transaction Note Added",message:(e,t)=>`A note has been added to a transaction for your offering "${e}".${t?" Note: "+t:""}`,link:e=>`/ico/creator/token/${e}?tab=transactions`}},"remove-note":{buyer:{title:"Transaction Note Removed",message:e=>`The note on your transaction for offering "${e}" has been removed.`,link:e=>`/ico/investor/transactions/${e}`},seller:{title:"Transaction Note Removed",message:e=>`The note on a transaction for your offering "${e}" has been removed.`,link:e=>`/ico/creator/token/${e}?tab=transactions`}}};exports.default=async e=>{const{params:t,user:a,query:r,body:n,ctx:o}=e;if(!(null==a?void 0:a.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});const i=r.action;if(!i||!updateActions[i])throw(0,error_1.createError)({statusCode:400,message:"Invalid or missing action."});null==o||o.step(`Fetching transaction for action: ${i}`);const s=await db_1.models.icoTransaction.findOne({where:{id:t.id},include:[{model:db_1.models.icoTokenOffering,as:"offering",attributes:["id","name","userId","purchaseWalletType","purchaseWalletCurrency"]}]});if(!s)throw(0,error_1.createError)({statusCode:404,message:"Transaction not found."});const c=s.amount*s.price,d=n.note;null==o||o.step(`Processing ${i} action on transaction`);const l=await db_1.sequelize.transaction();let u;try{u=await updateActions[i](s,l,c,d);null==o||o.step("Logging admin activity");await db_1.models.icoAdminActivity.create({type:i,offeringId:s.offering.id,offeringName:s.offering.name,adminId:a.id},{transaction:l});await l.commit()}catch(e){await l.rollback();throw(0,error_1.createError)({statusCode:500,message:"Internal Server Error: "+e.message})}null==o||o.step("Sending emails and notifications");const f=await db_1.models.user.findByPk(s.userId),m=await db_1.models.user.findByPk(s.offering.userId),p=async(e,t,a)=>{if(null==t?void 0:t.email)try{await(0,utils_2.sendIcoEmail)(e,t.email,a,o)}catch(t){console.error(`Failed to send ${e} email`,t)}};if(emailMapping[i]){const{buyer:e,seller:t}=emailMapping[i];e&&f&&await p(e,f,{INVESTOR_NAME:`${f.firstName} ${f.lastName}`,OFFERING_NAME:s.offering.name,TRANSACTION_ID:s.transactionId||s.id,AMOUNT:c.toString(),NOTE:d?`<p>Note: ${d}</p>`:""});t&&m&&await p(t,m,{SELLER_NAME:`${m.firstName} ${m.lastName}`,OFFERING_NAME:s.offering.name,TRANSACTION_ID:s.transactionId||s.id,AMOUNT:c.toString(),NOTE:d?`<p>Note: ${d}</p>`:""})}const g=async(e,t)=>{try{await(0,notifications_1.createNotification)({userId:e,relatedId:s.offering.id,type:"system",title:t.title,message:t.message(s.offering.name,d),details:`Transaction ID: ${s.id}. Amount: $${c}. Status updated to ${"verify"===i?"RELEASED":"reject"===i?"REJECTED":"save-note"===i?"NOTE ADDED":"remove-note"===i?"NOTE REMOVED":"UPDATED"}.`,link:"verify"===i||"reject"===i?`/ico/investor/transactions/${s.id}`:t.link(s.offering.id),actions:[{label:"View Transaction",link:"verify"===i||"reject"===i?`/ico/investor/transactions/${s.id}`:t.link(s.offering.id),primary:!0}]},o)}catch(e){console.error(`Failed to create notification for ${i}`,e)}};if(notifMapping[i]){const e=notifMapping[i];e.buyer&&f&&await g(f.id,e.buyer);e.seller&&m&&await g(m.id,e.seller)}null==o||o.success(`Transaction ${i} action completed successfully`);return{message:u.message||"Transaction updated successfully."}};