"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),gateway_1=require("@b/utils/gateway"),notifications_1=require("@b/utils/notifications"),console_1=require("@b/utils/console"),errors_1=require("@b/utils/schema/errors");exports.metadata={summary:"Approve gateway payout",description:"Approves a pending payout request and transfers funds from merchant gateway balance to their wallet. Validates merchant balance, processes payout transaction with locking to prevent concurrent approvals, updates status, and sends notification to merchant.",operationId:"approveGatewayPayout",tags:["Admin","Gateway","Payout"],parameters:[{name:"id",in:"path",required:!0,description:"Payout UUID",schema:{type:"string",format:"uuid"}}],responses:{200:{description:"Payout approved successfully",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"},payout:{type:"object",properties:{id:{type:"string"},payoutId:{type:"string"},amount:{type:"number"},currency:{type:"string"},status:{type:"string"},processedAt:{type:"string",format:"date-time"}}}}}}}},400:errors_1.badRequestResponse,401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("Payout"),500:errors_1.serverErrorResponse},requiresAuth:!0,permission:"edit.gateway.payout",logModule:"ADMIN_GATEWAY",logTitle:"Approve payout"};exports.default=async e=>{var t;const{params:a,user:r,ctx:o}=e,{id:s}=a;if(!(null==r?void 0:r.id)){null==o||o.fail("Unauthorized");throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"})}null==o||o.step(`Looking up payout ${s}`);const n=await db_1.models.gatewayPayout.findByPk(s,{include:[{model:db_1.models.gatewayMerchant,as:"merchant"}]});if(!n){null==o||o.fail("Payout not found");throw(0,error_1.createError)({statusCode:404,message:"Payout not found"})}null==o||o.step("Validating payout status");if("PENDING"!==n.status){null==o||o.fail(`Cannot approve payout with status: ${n.status}`);throw(0,error_1.createError)({statusCode:400,message:`Cannot approve payout with status: ${n.status}`})}null==o||o.step("Verifying merchant balance");const u=await db_1.models.gatewayMerchantBalance.findOne({where:{merchantId:n.merchantId,currency:n.currency,walletType:n.walletType}});if(!u){null==o||o.fail("Merchant gateway balance not found");throw(0,error_1.createError)({statusCode:400,message:`Merchant gateway balance not found for ${n.currency} (${n.walletType})`})}const i=parseFloat((null===(t=u.pending)||void 0===t?void 0:t.toString())||"0");if(i<n.amount){null==o||o.fail("Insufficient funds for payout");throw(0,error_1.createError)({statusCode:400,message:`Insufficient funds for payout. Required: ${n.amount}, Available in gateway balance: ${i}. Funds may have been refunded.`})}null==o||o.step(`Processing payout of ${n.amount} ${n.currency}`);await db_1.sequelize.transaction(async e=>{const t=await db_1.models.gatewayPayout.findByPk(n.id,{transaction:e,lock:e.LOCK.UPDATE});if(!t||"PENDING"!==t.status)throw(0,error_1.createError)({statusCode:400,message:"Payout is no longer available for approval"});await(0,gateway_1.processGatewayPayout)({merchantUserId:n.merchant.userId,merchantId:n.merchantId,currency:n.currency,walletType:n.walletType,amount:n.amount,payoutId:n.payoutId,transaction:e});await t.update({status:"COMPLETED",processedAt:new Date,metadata:{...t.metadata||{},approvedBy:r.id,approvedAt:(new Date).toISOString()}},{transaction:e})});null==o||o.step("Sending notification to merchant");try{await(0,notifications_1.createNotification)({userId:n.merchant.userId,relatedId:n.id,type:"system",title:"Payout Approved",message:`Your payout of ${n.amount.toFixed(2)} ${n.currency} has been approved and funds are now available in your wallet.`,link:"/gateway/payouts"},o)}catch(e){console_1.logger.error("ADMIN_GATEWAY_PAYOUT","Failed to send payout approval notification",e)}await n.reload();null==o||o.success(`Payout ${n.payoutId} approved successfully`);return{message:"Payout approved successfully",payout:{id:n.id,payoutId:n.payoutId,amount:n.amount,currency:n.currency,status:n.status,processedAt:n.processedAt}}};