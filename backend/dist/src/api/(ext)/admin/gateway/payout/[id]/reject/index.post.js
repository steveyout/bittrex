"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),notifications_1=require("@b/utils/notifications"),console_1=require("@b/utils/console"),errors_1=require("@b/utils/schema/errors");exports.metadata={summary:"Reject gateway payout",description:"Rejects a pending payout request. Funds remain in merchant's gateway balance (escrow). Requires a rejection reason for audit trail. Updates payout status to CANCELLED and sends notification to merchant.",operationId:"rejectGatewayPayout",tags:["Admin","Gateway","Payout"],parameters:[{name:"id",in:"path",required:!0,description:"Payout UUID",schema:{type:"string",format:"uuid"}}],requestBody:{required:!0,content:{"application/json":{schema:{type:"object",properties:{reason:{type:"string",description:"Reason for rejection (required)"}},required:["reason"]}}}},responses:{200:{description:"Payout rejected successfully",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"},payout:{type:"object",properties:{id:{type:"string"},payoutId:{type:"string"},amount:{type:"number"},currency:{type:"string"},status:{type:"string"},rejectionReason:{type:"string"}}}}}}}},400:errors_1.badRequestResponse,401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("Payout"),500:errors_1.serverErrorResponse},requiresAuth:!0,permission:"edit.gateway.payout",logModule:"ADMIN_GATEWAY",logTitle:"Reject payout"};exports.default=async e=>{var t,r;const{params:a,body:o,user:s,ctx:n}=e,{id:i}=a;if(!(null==s?void 0:s.id)){null==n||n.fail("Unauthorized");throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"})}null==n||n.step("Validating rejection reason");if(!(null===(t=null==o?void 0:o.reason)||void 0===t?void 0:t.trim())){null==n||n.fail("Rejection reason is required");throw(0,error_1.createError)({statusCode:400,message:"Rejection reason is required"})}null==n||n.step(`Looking up payout ${i}`);const u=await db_1.models.gatewayPayout.findByPk(i,{include:[{model:db_1.models.gatewayMerchant,as:"merchant"}]});if(!u){null==n||n.fail("Payout not found");throw(0,error_1.createError)({statusCode:404,message:"Payout not found"})}null==n||n.step("Validating payout status");if("PENDING"!==u.status){null==n||n.fail(`Cannot reject payout with status: ${u.status}`);throw(0,error_1.createError)({statusCode:400,message:`Cannot reject payout with status: ${u.status}`})}null==n||n.step("Verifying merchant balance");const c=await db_1.models.gatewayMerchantBalance.findOne({where:{merchantId:u.merchantId,currency:u.currency,walletType:u.walletType}}),d=parseFloat((null===(r=null==c?void 0:c.pending)||void 0===r?void 0:r.toString())||"0");d<u.amount&&console_1.logger.warn("ADMIN_GATEWAY_PAYOUT",`Payout ${u.payoutId} rejection: Funds mismatch. Expected ${u.amount}, found ${d} in gateway balance.`);null==n||n.step("Updating payout status to CANCELLED");await u.update({status:"CANCELLED",processedAt:new Date,metadata:{...u.metadata||{},rejectedBy:s.id,rejectedAt:(new Date).toISOString(),rejectionReason:o.reason.trim()}});null==n||n.step("Sending notification to merchant");try{await(0,notifications_1.createNotification)({userId:u.merchant.userId,relatedId:u.id,type:"system",title:"Payout Rejected",message:`Your payout request for ${u.amount.toFixed(2)} ${u.currency} has been rejected. Reason: ${o.reason.trim()}`,link:"/gateway/payouts"},n)}catch(e){console_1.logger.error("ADMIN_GATEWAY_PAYOUT","Failed to send payout rejection notification",e)}null==n||n.success(`Payout ${u.payoutId} rejected successfully`);return{message:"Payout rejected",payout:{id:u.id,payoutId:u.payoutId,amount:u.amount,currency:u.currency,status:"CANCELLED",rejectionReason:o.reason.trim()}}};