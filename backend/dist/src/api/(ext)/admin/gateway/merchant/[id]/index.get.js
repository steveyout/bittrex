"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),errors_1=require("@b/utils/schema/errors");exports.metadata={summary:"Get gateway merchant details",description:"Retrieves comprehensive information about a specific gateway merchant including user details, balances, API keys (filtered by mode), and statistics such as payment count, total volume, refunds, and payouts.",operationId:"getGatewayMerchant",tags:["Admin","Gateway","Merchant"],parameters:[{name:"id",in:"path",required:!0,description:"Merchant UUID",schema:{type:"string",format:"uuid"}},{name:"mode",in:"query",description:"Filter API keys by mode (LIVE or TEST)",schema:{type:"string",enum:["LIVE","TEST"]}}],responses:{200:{description:"Merchant details with statistics",content:{"application/json":{schema:{type:"object",description:"Merchant object with associated user, balances, API keys, and statistics",properties:{stats:{type:"object",properties:{paymentCount:{type:"number",description:"Total number of completed payments"},totalVolume:{type:"number",description:"Total payment volume"},refundCount:{type:"number",description:"Total number of refunds"},payoutCount:{type:"number",description:"Total number of completed payouts"},totalPaidOut:{type:"number",description:"Total amount paid out to merchant"}}}}}}}},401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("Merchant"),500:errors_1.serverErrorResponse},requiresAuth:!0,permission:"view.gateway.merchant",demoMask:["user.email","email","phone","webhookSecret"],logModule:"ADMIN_GATEWAY",logTitle:"Get merchant details"};exports.default=async e=>{const{params:t,query:a,ctx:s}=e,{id:r}=t,o=(null==a?void 0:a.mode)||"LIVE",n="TEST"===o;null==s||s.step(`Fetching merchant ${r} details (mode: ${o})`);const i=await db_1.models.gatewayMerchant.findByPk(r,{include:[{model:db_1.models.user,as:"user",attributes:["id","firstName","lastName","email","avatar"]},{model:db_1.models.gatewayMerchantBalance,as:"gatewayMerchantBalances"},{model:db_1.models.gatewayApiKey,as:"gatewayApiKeys",where:{mode:o},required:!1,attributes:["id","name","keyPrefix","lastFourChars","type","mode","permissions","ipWhitelist","allowedWalletTypes","successUrl","cancelUrl","webhookUrl","lastUsedAt","lastUsedIp","status","expiresAt","createdAt"]}]});if(!i){null==s||s.fail("Merchant not found");throw(0,error_1.createError)({statusCode:404,message:"Merchant not found"})}null==s||s.step("Calculating merchant statistics");const[d,u,m,l,c]=await Promise.all([db_1.models.gatewayPayment.count({where:{merchantId:r,status:"COMPLETED",testMode:n}}),db_1.models.gatewayPayment.sum("amount",{where:{merchantId:r,status:"COMPLETED",testMode:n}}),db_1.models.gatewayRefund.count({where:{merchantId:r},include:[{model:db_1.models.gatewayPayment,as:"payment",where:{testMode:n},required:!0,attributes:[]}]}),db_1.models.gatewayPayout.count({where:{merchantId:r,status:"COMPLETED"}}),db_1.models.gatewayPayout.sum("netAmount",{where:{merchantId:r,status:"COMPLETED"}})]);null==s||s.success(`Retrieved merchant details with ${d} payments`);return{...i.toJSON(),stats:{paymentCount:d,totalVolume:u||0,refundCount:m,payoutCount:l,totalPaidOut:c||0}}};