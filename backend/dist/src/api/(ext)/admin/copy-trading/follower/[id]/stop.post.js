"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),errors_1=require("@b/utils/schema/errors"),utils_1=require("@b/api/(ext)/copy-trading/utils");exports.metadata={summary:"Force stop copy trading follower subscription",description:"Administratively forces a follower subscription to stop, returns any unused allocated funds to the user's wallet, creates a deallocation transaction record, decrements the leader's follower count, and creates an audit log entry. This operation uses database transactions to ensure data consistency. Returns an error if the subscription is already stopped.",operationId:"forceStopCopyTradingFollower",tags:["Admin","Copy Trading","Follower"],requiresAuth:!0,permission:"access.copy_trading",middleware:["copyTradingAdmin"],logModule:"ADMIN_COPY",logTitle:"Force Stop Copy Trading Follower Subscription",parameters:[{name:"id",in:"path",required:!0,description:"Unique identifier of the follower subscription to stop",schema:{type:"string",format:"uuid"}}],requestBody:{required:!1,content:{"application/json":{schema:{type:"object",properties:{reason:{type:"string",description:"Administrative reason for force stopping the subscription",example:"Policy violation"}}}}}},responses:{200:{description:"Follower subscription stopped successfully and funds returned",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string",example:"Subscription stopped successfully",description:"Success message"}},required:["message"]}}}},400:{description:"Bad request - Subscription already stopped",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string",example:"Subscription already stopped"}}}}}},401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("Follower"),500:errors_1.serverErrorResponse}};exports.default=async e=>{var r;const{user:o,params:t,body:s,ctx:i}=e;if(!(null==o?void 0:o.id)){null==i||i.fail("Unauthorized");throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"})}const{id:a}=t,{reason:n}=s||{},l=await db_1.sequelize.transaction();try{null==i||i.step("Fetching follower subscription");const t=await db_1.models.copyTradingFollower.findByPk(a,{include:[{model:db_1.models.user,as:"user"},{model:db_1.models.copyTradingLeader,as:"leader"}],transaction:l,lock:l.LOCK.UPDATE});if(!t){await l.rollback();null==i||i.fail("Follower not found");throw(0,error_1.createError)({statusCode:404,message:"Follower not found"})}const s=t;null==i||i.step("Validating follower status");if("STOPPED"===s.status){await l.rollback();null==i||i.fail("Subscription already stopped");throw(0,error_1.createError)({statusCode:400,message:"Subscription already stopped"})}null==i||i.step("Updating follower status");await t.update({status:"STOPPED"},{transaction:l});null==i||i.step("Creating audit log");await(0,utils_1.createAuditLog)({userId:o.id,action:"ADMIN_FORCE_STOP",entityType:"copyTradingFollower",entityId:a,metadata:{reason:n,followerId:s.userId,leaderId:s.leaderId},ipAddress:(null===(r=e.request)||void 0===r?void 0:r.ip)||"unknown"});await l.commit();null==i||i.success("Subscription stopped successfully");return{message:"Subscription stopped successfully"}}catch(e){await l.rollback();null==i||i.fail("Failed to stop subscription");throw e}};