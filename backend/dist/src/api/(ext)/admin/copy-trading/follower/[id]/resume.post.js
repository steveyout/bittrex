"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),errors_1=require("@b/utils/schema/errors"),utils_1=require("@b/api/(ext)/copy-trading/utils");exports.metadata={summary:"Resume copy trading follower subscription",description:"Administratively resumes a paused follower subscription, creates an audit log entry. This operation uses database transactions to ensure data consistency. Returns an error if the subscription is not paused or if the leader is no longer active.",operationId:"resumeCopyTradingFollower",tags:["Admin","Copy Trading","Follower"],requiresAuth:!0,permission:"access.copy_trading",middleware:["copyTradingAdmin"],logModule:"ADMIN_COPY",logTitle:"Resume Copy Trading Follower Subscription",parameters:[{name:"id",in:"path",required:!0,description:"Unique identifier of the follower subscription to resume",schema:{type:"string",format:"uuid"}}],requestBody:{required:!1,content:{"application/json":{schema:{type:"object",properties:{reason:{type:"string",description:"Administrative reason for resuming the subscription",example:"Manual review completed"}}}}}},responses:{200:{description:"Follower subscription resumed successfully",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string",example:"Subscription resumed successfully",description:"Success message"}},required:["message"]}}}},400:{description:"Bad request - Subscription not paused or leader not active",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string",example:"Only paused subscriptions can be resumed"}}}}}},401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("Follower"),500:errors_1.serverErrorResponse}};exports.default=async e=>{var r;const{user:s,params:t,body:o,ctx:a}=e;if(!(null==s?void 0:s.id)){null==a||a.fail("Unauthorized");throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"})}const{id:i}=t,{reason:n}=o||{},l=await db_1.sequelize.transaction();try{null==a||a.step("Fetching follower subscription");const t=await db_1.models.copyTradingFollower.findByPk(i,{include:[{model:db_1.models.user,as:"user"},{model:db_1.models.copyTradingLeader,as:"leader"}],transaction:l,lock:l.LOCK.UPDATE});if(!t){await l.rollback();null==a||a.fail("Follower not found");throw(0,error_1.createError)({statusCode:404,message:"Follower not found"})}const o=t;null==a||a.step("Validating follower status");if("PAUSED"!==o.status){await l.rollback();null==a||a.fail("Only paused subscriptions can be resumed");throw(0,error_1.createError)({statusCode:400,message:"Only paused subscriptions can be resumed"})}null==a||a.step("Validating leader status");if(!o.leader||"ACTIVE"!==o.leader.status){await l.rollback();null==a||a.fail("Cannot resume - leader is no longer active");throw(0,error_1.createError)({statusCode:400,message:"Cannot resume - leader is no longer active"})}null==a||a.step("Updating follower status");const u=o.status;await t.update({status:"ACTIVE"},{transaction:l});null==a||a.step("Creating audit log");await(0,utils_1.createAuditLog)({userId:s.id,action:"ADMIN_RESUME",entityType:"copyTradingFollower",entityId:i,metadata:{reason:n,followerId:o.userId,leaderId:o.leaderId,oldStatus:u,newStatus:"ACTIVE"},ipAddress:(null===(r=e.request)||void 0===r?void 0:r.ip)||"unknown"});await l.commit();null==a||a.success("Subscription resumed successfully");return{message:"Subscription resumed successfully"}}catch(e){await l.rollback();null==a||a.fail("Failed to resume subscription");throw e}};