"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),errors_1=require("@b/utils/schema/errors");exports.metadata={summary:"Update copy trading follower subscription",description:"Updates configuration settings for a specific copy trading follower subscription. Allows modification of allocation amounts, copy mode, risk management parameters, and subscription status. Creates an audit log entry for tracking administrative changes.",operationId:"updateCopyTradingFollower",tags:["Admin","Copy Trading","Follower"],requiresAuth:!0,permission:"access.copy_trading",middleware:["copyTradingAdmin"],logModule:"ADMIN_COPY",logTitle:"Update Copy Trading Follower Subscription",parameters:[{name:"id",in:"path",required:!0,description:"Unique identifier of the follower subscription",schema:{type:"string",format:"uuid"}}],requestBody:{required:!0,content:{"application/json":{schema:{type:"object",properties:{copyMode:{type:"string",enum:["PROPORTIONAL","FIXED_AMOUNT","FIXED_RATIO"],description:"Copy trading mode to use"},fixedAmount:{type:"number",description:"Fixed amount per trade (for FIXED_AMOUNT mode, min: 0)"},fixedRatio:{type:"number",description:"Fixed ratio multiplier (for FIXED_RATIO mode, min: 0)"},maxTradeAmount:{type:"number",description:"Maximum amount per trade (min: 0)"},riskMultiplier:{type:"number",description:"Risk multiplier for position sizing (min: 0)"},stopLossPercent:{type:"number",description:"Stop loss percentage (0-100)"},takeProfitPercent:{type:"number",description:"Take profit percentage (min: 0)"},status:{type:"string",enum:["ACTIVE","PAUSED","STOPPED"],description:"Subscription status"}},description:"All fields are optional - only provided fields will be updated"}}}},responses:{200:{description:"Follower subscription updated successfully",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string",example:"Follower updated successfully"},follower:{type:"object",properties:{...errors_1.commonFields,userId:{type:"string",format:"uuid",description:"ID of the user following the leader"},leaderId:{type:"string",format:"uuid",description:"ID of the leader being followed"},copyMode:{type:"string",enum:["PROPORTIONAL","FIXED_AMOUNT","FIXED_RATIO"],description:"Copy trading mode"},fixedAmount:{type:"number",nullable:!0,description:"Fixed amount per trade"},fixedRatio:{type:"number",nullable:!0,description:"Fixed ratio multiplier"},maxDailyLoss:{type:"number",nullable:!0,description:"Maximum daily loss limit"},maxPositionSize:{type:"number",nullable:!0,description:"Maximum position size limit"},stopLossPercent:{type:"number",nullable:!0,description:"Stop loss percentage"},takeProfitPercent:{type:"number",nullable:!0,description:"Take profit percentage"},totalProfit:{type:"number",description:"Total profit/loss from all trades"},totalTrades:{type:"integer",description:"Total number of trades executed"},winRate:{type:"number",description:"Win rate percentage"},roi:{type:"number",description:"Return on investment percentage"},status:{type:"string",enum:["ACTIVE","PAUSED","STOPPED"],description:"Current subscription status"},user:{type:"object",description:"User details"},leader:{type:"object",description:"Leader details"}}}},required:["message","follower"]}}}},400:errors_1.badRequestResponse,401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("Follower"),500:errors_1.serverErrorResponse}};exports.default=async e=>{var t;const{user:r,params:o,body:i,ctx:s}=e;if(!(null==r?void 0:r.id)){null==s||s.fail("Unauthorized");throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"})}const{id:n}=o;null==s||s.step("Fetching follower subscription");const a=await db_1.models.copyTradingFollower.findByPk(n);if(!a){null==s||s.fail("Follower not found");throw(0,error_1.createError)({statusCode:404,message:"Follower not found"})}null==s||s.step("Preparing update data");const d=["copyMode","fixedAmount","fixedRatio","maxTradeAmount","riskMultiplier","stopLossPercent","takeProfitPercent","status"],l={};for(const e of d)void 0!==i[e]&&(l[e]=i[e]);null==s||s.step("Updating follower subscription");await a.update(l);null==s||s.step("Creating audit log");await db_1.models.copyTradingAuditLog.create({userId:r.id,action:"ADMIN_UPDATE",entityType:"copyTradingFollower",entityId:n,newValue:l,ipAddress:(null===(t=e.request)||void 0===t?void 0:t.ip)||"unknown"});null==s||s.step("Fetching updated follower data");const p=await db_1.models.copyTradingFollower.findByPk(n,{include:[{model:db_1.models.user,as:"user"},{model:db_1.models.copyTradingLeader,as:"leader"}]});null==s||s.success("Follower updated successfully");return{message:"Follower updated successfully",follower:p}};