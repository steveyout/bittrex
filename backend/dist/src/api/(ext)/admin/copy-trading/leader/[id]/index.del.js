"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),utils_1=require("@b/api/(ext)/copy-trading/utils"),wallet_1=require("@b/api/(ext)/ecosystem/utils/wallet");exports.metadata={summary:"Delete Leader (Admin)",description:"Deactivates a leader and optionally returns funds to followers from all their allocations.",operationId:"adminDeleteCopyTradingLeader",tags:["Admin","Copy Trading"],requiresAuth:!0,permission:"access.copy_trading",middleware:["copyTradingAdmin"],logModule:"ADMIN_COPY",logTitle:"Delete copy trading leader",parameters:[{name:"id",in:"path",required:!0,schema:{type:"string"}}],requestBody:{content:{"application/json":{schema:{type:"object",properties:{refundFollowers:{type:"boolean",default:!0,description:"Return allocated funds to followers"},reason:{type:"string",description:"Reason for deletion"}}}}}},responses:{200:{description:"Leader deleted successfully"},400:{description:"Bad Request"},401:{description:"Unauthorized"},403:{description:"Forbidden"},404:{description:"Leader not found"},500:{description:"Internal Server Error"}}};exports.default=async e=>{const{params:t,body:a,user:o,ctx:s}=e,{id:r}=t,{refundFollowers:l=!0,reason:n="Admin deleted"}=a||{};null==s||s.step("Fetching leader");const d=await db_1.models.copyTradingLeader.findByPk(r);if(!d){null==s||s.fail("Leader not found");throw(0,error_1.createError)({statusCode:404,message:"Leader not found"})}null==s||s.step("Checking for open positions");const i=await db_1.models.copyTradingTrade.count({where:{leaderId:r,status:{[db_1.models.sequelize.Op.in]:["OPEN","PENDING","PARTIALLY_FILLED"]}}});if(i>0)throw(0,error_1.createError)({statusCode:400,message:`Cannot delete leader with ${i} open positions. Please close all positions first.`});null==s||s.step("Fetching active followers");const c=await db_1.models.copyTradingFollower.findAll({where:{leaderId:r,status:{[db_1.models.sequelize.Op.ne]:"STOPPED"}},include:[{model:db_1.models.copyTradingFollowerAllocation,as:"allocations",where:{isActive:!0},required:!1}]});let u=0,p=0;await db_1.sequelize.transaction(async e=>{if(l){null==s||s.step(`Processing ${c.length} followers`);for(const t of c){const a=t,o=a.allocations||[];if(o.length>0){null==s||s.step(`Refunding ${o.length} allocations for follower ${a.userId}`);for(const t of o){const o=t,[s,l]=o.symbol.split("/"),n=Math.max(0,o.baseAmount-o.baseUsedAmount),d=Math.max(0,o.quoteAmount-o.quoteUsedAmount);if(n>0){const t=await(0,wallet_1.getWalletByUserIdAndCurrency)(a.userId,s);if(t){const l=parseFloat(t.balance.toString());await(0,wallet_1.updateWalletBalance)(t,n,"add",`ct_admin_leader_delete_base_${r}_${o.id}`,e);await db_1.models.copyTradingTransaction.create({userId:a.userId,leaderId:r,followerId:a.id,type:"REFUND",amount:n,currency:s,balanceBefore:l,balanceAfter:l+n,description:`Refund: Leader deleted by admin - ${n} ${s} from ${o.symbol}`,metadata:JSON.stringify({allocationId:o.id,symbol:o.symbol,reason:"ADMIN_LEADER_DELETED"})},{transaction:e})}}if(d>0){const t=await(0,wallet_1.getWalletByUserIdAndCurrency)(a.userId,l);if(t){const s=parseFloat(t.balance.toString());await(0,wallet_1.updateWalletBalance)(t,d,"add",`ct_admin_leader_delete_quote_${r}_${o.id}`,e);await db_1.models.copyTradingTransaction.create({userId:a.userId,leaderId:r,followerId:a.id,type:"REFUND",amount:d,currency:l,balanceBefore:s,balanceAfter:s+d,description:`Refund: Leader deleted by admin - ${d} ${l} from ${o.symbol}`,metadata:JSON.stringify({allocationId:o.id,symbol:o.symbol,reason:"ADMIN_LEADER_DELETED"})},{transaction:e})}}if(n>0||d>0){await o.update({isActive:!1,baseAmount:o.baseUsedAmount,quoteAmount:o.quoteUsedAmount},{transaction:e});p++}}u++}await t.update({status:"STOPPED"},{transaction:e})}}else for(const t of c)await t.update({status:"STOPPED"},{transaction:e});null==s||s.step("Soft deleting leader");await d.update({status:"INACTIVE"},{transaction:e});await d.destroy({transaction:e});null==s||s.step("Creating audit log");await(0,utils_1.createAuditLog)({entityType:"LEADER",entityId:r,action:"DELETE",oldValue:{status:d.status},newValue:{status:"DELETED",refundedFollowers:u,refundedAllocations:p},adminId:null==o?void 0:o.id,reason:n},e)});null==s||s.success(`Leader deleted successfully. Processed ${c.length} followers, refunded ${p} allocations`);return{message:"Leader deleted successfully",totalFollowers:c.length,refundedFollowers:u,refundedAllocations:p}};