"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),utils_1=require("@b/api/(ext)/copy-trading/utils"),sequelize_1=require("sequelize");exports.metadata={summary:"Recalculate Leader Statistics",description:"Forces a recalculation of all statistics for a leader.",operationId:"adminRecalculateCopyTradingLeaderStats",tags:["Admin","Copy Trading","Leaders"],requiresAuth:!0,permission:"access.copy_trading",middleware:["copyTradingAdmin"],logModule:"ADMIN_COPY",logTitle:"Recalculate leader statistics",parameters:[{name:"id",in:"path",required:!0,schema:{type:"string"},description:"Leader ID"}],responses:{200:{description:"Statistics recalculated successfully"},401:{description:"Unauthorized"},403:{description:"Forbidden"},404:{description:"Leader not found"},500:{description:"Internal Server Error"}}};exports.default=async e=>{const{user:t,params:a,ctx:o}=e,{id:r}=a;if(!(null==t?void 0:t.id)){null==o||o.fail("Unauthorized");throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"})}null==o||o.step("Fetching leader");const l=await db_1.models.copyTradingLeader.findByPk(r);if(!l){null==o||o.fail("Leader not found");throw(0,error_1.createError)({statusCode:404,message:"Leader not found"})}null==o||o.step("Storing old statistics");const i={totalTrades:l.totalTrades,winRate:l.winRate,totalProfit:l.totalProfit,totalVolume:l.totalVolume,totalFollowers:l.totalFollowers,roi:l.roi};null==o||o.step("Fetching leader's closed trades");const d=await db_1.models.copyTradingTrade.findAll({where:{leaderId:r,followerId:null,status:"CLOSED"}});null==o||o.step("Calculating trade statistics");const s=d.length,n=d.filter(e=>(e.profit||0)>0).length,u=s>0?n/s*100:0,c=d.reduce((e,t)=>e+(t.profit||0),0),p=d.reduce((e,t)=>e+(t.cost||0),0);null==o||o.step("Calculating follower metrics");const w=await db_1.models.copyTradingFollower.count({where:{leaderId:r,status:"ACTIVE"}}),f=(await db_1.models.copyTradingFollowerAllocation.findAll({where:{isActive:!0},include:[{model:db_1.models.copyTradingFollower,as:"follower",where:{leaderId:r,status:{[sequelize_1.Op.in]:["ACTIVE","PAUSED"]}},required:!0}]})).reduce((e,t)=>e+(parseFloat(t.baseAmount)||0)+(parseFloat(t.quoteAmount)||0),0),m=p>0?c/p*100:0,g=d.filter(e=>(e.profit||0)<0),h=g.length>0?Math.min(...g.map(e=>e.profit||0)):0;let T=0;const A=d.filter(e=>e.closedAt&&e.createdAt);if(A.length>0){T=A.reduce((e,t)=>e+(new Date(t.closedAt).getTime()-new Date(t.createdAt).getTime()),0)/A.length/6e4}null==o||o.step("Calculating follower trade statistics");const y=await db_1.models.copyTradingTrade.findAll({where:{leaderId:r,followerId:{[sequelize_1.Op.ne]:null},status:"CLOSED"}}),C=y.length,_=y.reduce((e,t)=>e+(t.cost||0),0),M=y.reduce((e,t)=>e+(t.profit||0),0);null==o||o.step("Updating leader with new statistics");const F={totalTrades:s,winRate:Math.round(100*u)/100,totalProfit:Math.round(100*c)/100,totalVolume:Math.round(100*p)/100,totalFollowers:w,roi:Math.round(100*m)/100,maxDrawdown:Math.round(100*h)/100};await l.update(F);null==o||o.step("Creating audit log");await(0,utils_1.createAuditLog)({entityType:"LEADER",entityId:r,action:"RECALCULATE_STATS",oldValue:i,newValue:F,adminId:t.id,reason:"Manual statistics recalculation",metadata:{totalCopiedTrades:C,totalCopiedVolume:_,totalCopiedProfit:M,totalAllocated:f,avgTradeDuration:T}});null==o||o.success("Statistics recalculated successfully");return{message:"Statistics recalculated successfully",leader:{id:l.id,displayName:l.displayName},oldStats:i,newStats:F,changes:{totalTrades:F.totalTrades-i.totalTrades,winRate:Math.round(100*(F.winRate-i.winRate))/100,totalProfit:Math.round(100*(F.totalProfit-i.totalProfit))/100,totalFollowers:F.totalFollowers-i.totalFollowers,roi:Math.round(100*(F.roi-i.roi))/100},additionalMetrics:{totalCopiedTrades:C,totalCopiedVolume:Math.round(100*_)/100,totalCopiedProfit:Math.round(100*M)/100,totalAllocated:Math.round(100*f)/100,avgTradeDurationMinutes:Math.round(100*T)/100}}};