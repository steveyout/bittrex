"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),utils_1=require("@b/api/(ext)/copy-trading/utils");exports.metadata={summary:"Suspend Leader (Admin)",description:"Suspends an active leader. All followers will be paused.",operationId:"adminSuspendCopyTradingLeader",tags:["Admin","Copy Trading"],requiresAuth:!0,permission:"access.copy_trading",middleware:["copyTradingAdmin"],logModule:"ADMIN_COPY",logTitle:"Suspend copy trading leader",parameters:[{name:"id",in:"path",required:!0,schema:{type:"string"}}],requestBody:{required:!0,content:{"application/json":{schema:{type:"object",properties:{reason:{type:"string",description:"Reason for suspension"}},required:["reason"]}}}},responses:{200:{description:"Leader suspended successfully"},400:{description:"Bad Request"},401:{description:"Unauthorized"},403:{description:"Forbidden"},404:{description:"Leader not found"},500:{description:"Internal Server Error"}}};exports.default=async e=>{const{params:s,body:t,user:r,ctx:a}=e,{id:i}=s,{reason:d}=t;if(!(0,utils_1.isValidUUID)(i))throw(0,error_1.createError)({statusCode:400,message:"Invalid leader ID format"});null==a||a.step("Validating suspension reason");if(!d){null==a||a.fail("Suspension reason is required");throw(0,error_1.createError)({statusCode:400,message:"Suspension reason is required"})}null==a||a.step("Fetching leader");const n=await db_1.models.copyTradingLeader.findByPk(i);if(!n){null==a||a.fail("Leader not found");throw(0,error_1.createError)({statusCode:404,message:"Leader not found"})}null==a||a.step("Validating leader status");if("ACTIVE"!==n.status){null==a||a.fail(`Cannot suspend leader with status: ${n.status}`);throw(0,error_1.createError)({statusCode:400,message:`Cannot suspend leader with status: ${n.status}`})}const o=n.status;null==a||a.step("Suspending leader");await n.update({status:"SUSPENDED"});null==a||a.step("Pausing all active followers");await db_1.models.copyTradingFollower.update({status:"PAUSED"},{where:{leaderId:i,status:"ACTIVE"}});null==a||a.step("Creating audit log");await(0,utils_1.createAuditLog)({entityType:"LEADER",entityId:i,action:"SUSPEND",oldValue:{status:o},newValue:{status:"SUSPENDED"},adminId:null==r?void 0:r.id,reason:d});null==a||a.step("Updating leader statistics");await(0,utils_1.updateLeaderStats)(i);null==a||a.step("Sending suspension notification to leader");await(0,utils_1.notifyLeaderApplicationEvent)(n.userId,i,"SUSPENDED",{reason:d},a);null==a||a.step("Notifying affected followers");const l=await db_1.models.copyTradingFollower.findAll({where:{leaderId:i},attributes:["id","userId"]});for(const e of l)await(0,utils_1.notifyFollowerSubscriptionEvent)(e.id,"PAUSED",{reason:`Leader suspended: ${d}`},a);await(0,utils_1.notifyCopyTradingAdmins)("LEADER_SUSPENDED",{leaderId:i,leaderName:`User ${n.userId}`,reason:d},a);null==a||a.success("Leader suspended successfully");return{message:"Leader suspended successfully",leader:n.toJSON()}};