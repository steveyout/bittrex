"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),utils_1=require("@b/api/(ext)/copy-trading/utils");exports.metadata={summary:"Approve Leader Application (Admin)",description:"Approves a pending leader application.",operationId:"adminApproveCopyTradingLeader",tags:["Admin","Copy Trading"],requiresAuth:!0,permission:"access.copy_trading",middleware:["copyTradingAdmin"],logModule:"ADMIN_COPY",logTitle:"Approve copy trading leader",parameters:[{name:"id",in:"path",required:!0,schema:{type:"string"}}],responses:{200:{description:"Leader approved successfully"},400:{description:"Bad Request"},401:{description:"Unauthorized"},403:{description:"Forbidden"},404:{description:"Leader not found"},500:{description:"Internal Server Error"}}};exports.default=async e=>{const{params:t,user:r,ctx:a}=e,{id:i}=t;if(!(0,utils_1.isValidUUID)(i))throw(0,error_1.createError)({statusCode:400,message:"Invalid leader ID format"});null==a||a.step("Fetching leader application");const s=await db_1.models.copyTradingLeader.findByPk(i);if(!s){null==a||a.fail("Leader not found");throw(0,error_1.createError)({statusCode:404,message:"Leader not found"})}null==a||a.step("Validating leader status");if("PENDING"!==s.status){null==a||a.fail(`Cannot approve leader with status: ${s.status}`);throw(0,error_1.createError)({statusCode:400,message:`Cannot approve leader with status: ${s.status}`})}null==a||a.step("Approving leader application");const o=s.status;await s.update({status:"ACTIVE"});null==a||a.step("Creating audit log");await(0,utils_1.createAuditLog)({entityType:"LEADER",entityId:i,action:"APPROVE",oldValue:{status:o},newValue:{status:"ACTIVE"},adminId:null==r?void 0:r.id});null==a||a.step("Sending approval notification");await(0,utils_1.notifyLeaderApplicationEvent)(s.userId,i,"APPROVED",void 0,a);null==a||a.success("Leader approved successfully");return{message:"Leader approved successfully",leader:s.toJSON()}};