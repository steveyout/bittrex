"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),utils_1=require("@b/api/(ext)/copy-trading/utils");exports.metadata={summary:"Reject Leader Application (Admin)",description:"Rejects a pending leader application.",operationId:"adminRejectCopyTradingLeader",tags:["Admin","Copy Trading"],requiresAuth:!0,permission:"access.copy_trading",middleware:["copyTradingAdmin"],logModule:"ADMIN_COPY",logTitle:"Reject copy trading leader",parameters:[{name:"id",in:"path",required:!0,schema:{type:"string"}}],requestBody:{required:!0,content:{"application/json":{schema:{type:"object",properties:{reason:{type:"string",description:"Reason for rejection"}},required:["reason"]}}}},responses:{200:{description:"Leader rejected successfully"},400:{description:"Bad Request"},401:{description:"Unauthorized"},403:{description:"Forbidden"},404:{description:"Leader not found"},500:{description:"Internal Server Error"}}};exports.default=async e=>{const{params:t,body:r,user:a,ctx:s}=e,{id:i}=t,{reason:n}=r;if(!(0,utils_1.isValidUUID)(i))throw(0,error_1.createError)({statusCode:400,message:"Invalid leader ID format"});null==s||s.step("Validating rejection reason");if(!n){null==s||s.fail("Rejection reason is required");throw(0,error_1.createError)({statusCode:400,message:"Rejection reason is required"})}null==s||s.step("Fetching leader application");const o=await db_1.models.copyTradingLeader.findByPk(i);if(!o){null==s||s.fail("Leader not found");throw(0,error_1.createError)({statusCode:404,message:"Leader not found"})}null==s||s.step("Validating leader status");if("PENDING"!==o.status){null==s||s.fail(`Cannot reject leader with status: ${o.status}`);throw(0,error_1.createError)({statusCode:400,message:`Cannot reject leader with status: ${o.status}`})}null==s||s.step("Rejecting leader application");const d=o.status;await o.update({status:"REJECTED",rejectionReason:n});null==s||s.step("Creating audit log");await(0,utils_1.createAuditLog)({entityType:"LEADER",entityId:i,action:"REJECT",oldValue:{status:d},newValue:{status:"REJECTED",rejectionReason:n},adminId:null==a?void 0:a.id,reason:n});null==s||s.step("Sending rejection notification");await(0,utils_1.notifyLeaderApplicationEvent)(o.userId,i,"REJECTED",{rejectionReason:n},s);null==s||s.success("Leader rejected successfully");return{message:"Leader rejected successfully",leader:o.toJSON()}};