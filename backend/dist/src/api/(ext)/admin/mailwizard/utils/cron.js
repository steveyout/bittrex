"use strict";async function processMailwizardCampaigns(){const a="processMailwizardCampaigns",r=Date.now();try{(0,broadcast_1.broadcastStatus)(a,"running");(0,broadcast_1.broadcastLog)(a,"Starting Mailwizard campaigns processing");const t=await db_1.models.mailwizardCampaign.findAll({where:{status:"ACTIVE"},include:[{model:db_1.models.mailwizardTemplate,as:"template"}]});(0,broadcast_1.broadcastLog)(a,`Found ${t.length} active campaigns`);for(const r of t){(0,broadcast_1.broadcastLog)(a,`Processing campaign id ${r.id}`);let t=0;if(!r.targets){(0,broadcast_1.broadcastLog)(a,`No targets found for campaign ${r.id}`,"info");continue}let s=[];try{s=JSON.parse(r.targets);(0,broadcast_1.broadcastLog)(a,`Parsed ${s.length} targets for campaign ${r.id}`)}catch(t){console_1.logger.error("CRON",`Error parsing targets for campaign ${r.id}`,t);(0,broadcast_1.broadcastLog)(a,`Error parsing targets for campaign ${r.id}: ${t.message}`,"error");continue}for(const o of s)if("PENDING"===o.status&&t<r.speed){(0,broadcast_1.broadcastLog)(a,`Attempting to send email to ${o.email} for campaign ${r.id}`);try{await(0,emails_1.sendEmailToTargetWithTemplate)(o.email,r.subject,r.template.content);o.status="SENT";t++;(0,broadcast_1.broadcastLog)(a,`Email sent to ${o.email} for campaign ${r.id}`,"success")}catch(t){console_1.logger.error("CRON","Error sending email to target",t);o.status="FAILED";(0,broadcast_1.broadcastLog)(a,`Error sending email to ${o.email} for campaign ${r.id}: ${t.message}`,"error")}}try{(0,broadcast_1.broadcastLog)(a,`Updating targets for campaign ${r.id}`);await updateMailwizardCampaignTargets(r.id,JSON.stringify(s));(0,broadcast_1.broadcastLog)(a,`Targets updated for campaign ${r.id}`,"success");if(s.every(a=>"PENDING"!==a.status)){(0,broadcast_1.broadcastLog)(a,`All targets processed for campaign ${r.id}, updating status to COMPLETED`);await updateMailwizardCampaignStatus(r.id,"COMPLETED");(0,broadcast_1.broadcastLog)(a,`Campaign ${r.id} marked as COMPLETED`,"success")}else(0,broadcast_1.broadcastLog)(a,`Campaign ${r.id} still has pending targets`,"info")}catch(t){console_1.logger.error("CRON",`Error updating campaign ${r.id}`,t);(0,broadcast_1.broadcastLog)(a,`Error updating campaign ${r.id}: ${t.message}`,"error")}}(0,broadcast_1.broadcastStatus)(a,"completed",{duration:Date.now()-r});(0,broadcast_1.broadcastLog)(a,"Mailwizard campaigns processing completed","success")}catch(r){console_1.logger.error("CRON","Mailwizard campaigns processing failed",r);(0,broadcast_1.broadcastStatus)(a,"failed");(0,broadcast_1.broadcastLog)(a,`Mailwizard campaigns processing failed: ${r.message}`,"error");throw r}}async function updateMailwizardCampaignTargets(a,r){try{(0,broadcast_1.broadcastLog)("processMailwizardCampaigns",`Updating targets for campaign ${a}`);await db_1.models.mailwizardCampaign.update({targets:r},{where:{id:a}});(0,broadcast_1.broadcastLog)("processMailwizardCampaigns",`Targets updated for campaign ${a}`,"success")}catch(a){console_1.logger.error("CRON","Error updating mailwizard campaign targets",a);throw a}}async function updateMailwizardCampaignStatus(a,r){try{(0,broadcast_1.broadcastLog)("processMailwizardCampaigns",`Updating status to ${r} for campaign ${a}`);await db_1.models.mailwizardCampaign.update({status:r},{where:{id:a}});(0,broadcast_1.broadcastLog)("processMailwizardCampaigns",`Status updated to ${r} for campaign ${a}`,"success")}catch(a){console_1.logger.error("CRON","Error updating mailwizard campaign status",a);throw a}}Object.defineProperty(exports,"__esModule",{value:!0});exports.processMailwizardCampaigns=processMailwizardCampaigns;exports.updateMailwizardCampaignTargets=updateMailwizardCampaignTargets;exports.updateMailwizardCampaignStatus=updateMailwizardCampaignStatus;const db_1=require("@b/db"),console_1=require("@b/utils/console"),emails_1=require("@b/utils/emails"),broadcast_1=require("@b/cron/broadcast");