"use strict";function calculateTimeRemaining(e){const t=new Date,r=e.getTime()-t.getTime();if(r<=0)return"Expired";const i=Math.floor(r/6e4),a=Math.floor(i/60),s=Math.floor(a/24);return s>0?`${s}d ${a%24}h`:a>0?`${a}h ${i%60}m`:`${i}m`}Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),console_1=require("@b/utils/console");exports.metadata={summary:"Get P2P Trade Details (Admin)",description:"Retrieves detailed information about a specific trade.",operationId:"getAdminP2PTradeById",tags:["Admin","Trades","P2P"],requiresAuth:!0,logModule:"ADMIN_P2P",logTitle:"Get P2P Trade",demoMask:["buyer.email","seller.email"],parameters:[{index:0,name:"id",in:"path",description:"Trade ID",required:!0,schema:{type:"string"}}],responses:{200:{description:"Trade details retrieved successfully."},401:{description:"Unauthorized."},404:{description:"Trade not found."},500:{description:"Internal Server Error."}},permission:"view.p2p.trade"};exports.default=async e=>{var t,r,i,a,s,l;const{params:n,ctx:d}=e,{id:o}=n;try{null==d||d.step("Fetching data");const e=await db_1.models.p2pTrade.findByPk(o,{include:[{association:"buyer",attributes:["id","firstName","lastName","email","avatar"]},{association:"seller",attributes:["id","firstName","lastName","email","avatar"]},{association:"offer",attributes:["id","type","currency","amountConfig","priceConfig"]},{association:"dispute"},{association:"paymentMethodDetails",attributes:["id","name","instructions","icon"]}]});if(!e)throw(0,error_1.createError)({statusCode:404,message:"Trade not found"});const n=e.toJSON(),u=e=>{var t,r;if(!e)return"?";return(((null===(t=e.firstName)||void 0===t?void 0:t.charAt(0))||"")+((null===(r=e.lastName)||void 0===r?void 0:r.charAt(0))||"")).toUpperCase()||"?"},m=e=>e&&`${e.firstName||""} ${e.lastName||""}`.trim()||"Unknown";let c=n.timeline;if("string"==typeof c)try{c=JSON.parse(c)}catch(e){console_1.logger.error("P2P","Failed to parse timeline JSON",e);c=[]}Array.isArray(c)||(c=[]);const p=c.filter(e=>"MESSAGE"!==(e.event||e.type||"")).map(e=>{const t=e.event||e.type||"Event";return{event:t.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()),type:t,timestamp:e.timestamp||e.createdAt||(new Date).toISOString(),details:e.message||e.details||"",userId:e.userId||null,adminName:e.adminName||null}}),v=c.filter(e=>"MESSAGE"===e.event||"MESSAGE"===e.type).map(e=>{var t,r,i,a;let s=e.senderName||"Unknown",l=null,d=e.isAdminMessage||!1;if(e.senderId===(null===(t=n.buyer)||void 0===t?void 0:t.id)){s=m(n.buyer);l=null===(r=n.buyer)||void 0===r?void 0:r.avatar}else if(e.senderId===(null===(i=n.seller)||void 0===i?void 0:i.id)){s=m(n.seller);l=null===(a=n.seller)||void 0===a?void 0:a.avatar}else e.senderName&&(s=e.senderName);return{id:e.id||`msg-${e.createdAt||Date.now()}`,sender:s,senderId:e.senderId||null,content:e.message||e.details||"",timestamp:new Date(e.createdAt||e.timestamp).toLocaleString(),avatar:l,isAdmin:d,attachments:e.attachments||[]}}),y=n.dispute||null;null==d||d.success("Trade details retrieved successfully");return{...n,crypto:n.currency,fiatValue:n.total?`${n.total} ${n.priceCurrency||"USD"}`:"N/A",escrowFee:n.escrowFee||"0",timeRemaining:n.expiresAt?calculateTimeRemaining(new Date(n.expiresAt)):null,buyer:{id:null===(t=n.buyer)||void 0===t?void 0:t.id,name:m(n.buyer),initials:u(n.buyer),avatar:null===(r=n.buyer)||void 0===r?void 0:r.avatar,email:null===(i=n.buyer)||void 0===i?void 0:i.email},seller:{id:null===(a=n.seller)||void 0===a?void 0:a.id,name:m(n.seller),initials:u(n.seller),avatar:null===(s=n.seller)||void 0===s?void 0:s.avatar,email:null===(l=n.seller)||void 0===l?void 0:l.email},timeline:p,messages:v,disputeId:(null==y?void 0:y.id)||null,disputeReason:(null==y?void 0:y.reason)||null,disputeDetails:(null==y?void 0:y.details)||null,disputeEvidence:(null==y?void 0:y.evidence)||null,disputeFiledBy:(null==y?void 0:y.reportedById)||null}}catch(e){throw(0,error_1.createError)({statusCode:500,message:"Internal Server Error: "+e.message})}};