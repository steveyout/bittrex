"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r);var o=Object.getOwnPropertyDescriptor(t,r);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[r]}});Object.defineProperty(e,a,o)}:function(e,t,r,a){void 0===a&&(a=r);e[a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var e=function(t){e=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t};return e(t)};return function(t){if(t&&t.__esModule)return t;var r={};if(null!=t)for(var a=e(t),o=0;o<a.length;o++)"default"!==a[o]&&__createBinding(r,t,a[o]);__setModuleDefault(r,t);return r}}();Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),console_1=require("@b/utils/console"),wallet_1=require("@b/services/wallet"),Middleware_1=require("@b/handler/Middleware"),ownership_1=require("../../../../p2p/utils/ownership");exports.metadata={summary:"Resolve Trade (Admin)",description:"Resolves a disputed trade by updating its status, handling funds based on resolution outcome.",operationId:"resolveAdminP2PTrade",tags:["Admin","Trades","P2P"],requiresAuth:!0,middleware:[Middleware_1.p2pAdminTradeRateLimit],logModule:"ADMIN_P2P",logTitle:"Resolve P2P trade",parameters:[{index:0,name:"id",in:"path",description:"Trade ID",required:!0,schema:{type:"string"}}],requestBody:{description:"Resolution details",required:!0,content:{"application/json":{schema:{type:"object",properties:{resolution:{type:"string",enum:["BUYER_WINS","SELLER_WINS","SPLIT","CANCELLED"],description:"Resolution outcome"},notes:{type:"string",description:"Admin notes about the resolution"}},required:["resolution"]}}}},responses:{200:{description:"Trade resolved successfully."},401:{description:"Unauthorized."},404:{description:"Trade not found."},500:{description:"Internal Server Error."}},permission:"edit.p2p.trade"};exports.default=async e=>{var t,r;const{params:a,body:o,user:i,ctx:n}=e,{id:s}=a,{resolution:l,notes:d}=o,{notifyTradeEvent:u}=await Promise.resolve().then(()=>__importStar(require("../../../../p2p/utils/notifications"))),{broadcastP2PTradeEvent:c}=await Promise.resolve().then(()=>__importStar(require("../../../../p2p/trade/[id]/index.ws"))),{getWalletSafe:f}=await Promise.resolve().then(()=>__importStar(require("@b/api/finance/wallet/utils"))),{sanitizeInput:p}=await Promise.resolve().then(()=>__importStar(require("../../../../p2p/utils/validation"))),{parseAmountConfig:m}=await Promise.resolve().then(()=>__importStar(require("../../../../p2p/utils/json-parser"))),_=await db_1.sequelize.transaction();try{null==n||n.step("Fetching trade");const e=await db_1.models.p2pTrade.findByPk(s,{include:[{model:db_1.models.p2pOffer,as:"offer",attributes:["currency","walletType","type","id"]}],lock:!0,transaction:_});if(!e){await _.rollback();null==n||n.fail("Trade not found");throw(0,error_1.createError)({statusCode:404,message:"Trade not found"})}null==n||n.step("Validating trade status");if(!["DISPUTED","PAYMENT_SENT","PENDING"].includes(e.status)){await _.rollback();null==n||n.fail(`Cannot resolve trade with status: ${e.status}`);throw(0,error_1.createError)({statusCode:400,message:`Cannot resolve trade with status: ${e.status}`})}const a=d?p(d):"",o=e.status;let E="COMPLETED",w=!1;null==n||n.step(`Processing resolution: ${l}`);if("BUYER_WINS"===l||"SPLIT"===l){if(e.offer&&"COMPLETED"!==e.status){const t=await f(e.sellerId,e.offer.walletType,e.offer.currency);if(t){const r=Math.min(e.amount,t.inOrder);if(r>0){const a=parseFloat(e.escrowFee||"0"),o=Math.max(0,e.amount-a),n=`p2p_resolve_seller_${e.id}`;await wallet_1.walletService.executeFromHold({idempotencyKey:n,userId:e.sellerId,walletId:t.id,walletType:e.offer.walletType,currency:e.offer.currency,amount:e.amount,operationType:"P2P_TRADE_RESOLVE",fee:a,description:`P2P trade resolved by admin - ${l}`,metadata:{tradeId:e.id,resolution:l,adminId:i.id},transaction:_});r<e.amount&&console_1.logger.warn("P2P_RESOLVE",`Partial fund handling for trade ${e.id}: unlocked=${r}`);const s=await wallet_1.walletCreationService.getOrCreateWallet(e.buyerId,e.offer.walletType,e.offer.currency),d=`p2p_resolve_buyer_${e.id}_${Date.now()}`;await wallet_1.walletService.credit({idempotencyKey:d,userId:e.buyerId,walletId:s.id,walletType:e.offer.walletType,currency:e.offer.currency,amount:o,operationType:"P2P_TRADE_RECEIVE",description:"P2P trade resolved - buyer wins",metadata:{tradeId:e.id,resolution:l,adminId:i.id,originalAmount:e.amount,platformFee:a},transaction:_});if(a>0){await db_1.models.p2pCommission.create({adminId:i.id,amount:a,description:`P2P escrow fee for resolved trade #${e.id.slice(0,8)}... - ${e.amount} ${e.offer.currency}`,tradeId:e.id},{transaction:_});console_1.logger.info("P2P_RESOLVE",`Platform commission recorded for trade ${e.id}: ${a} ${e.offer.currency}`)}w=!0}else console_1.logger.warn("P2P_RESOLVE",`No funds available to transfer for trade ${e.id}`)}}E="COMPLETED"}else if("SELLER_WINS"===l||"CANCELLED"===l){if(e.offer&&"COMPLETED"!==e.status){if("BUY"===e.offer.type){const t=await f(e.sellerId,e.offer.walletType,e.offer.currency);if(t){const r=Math.min(e.amount,t.inOrder);if(r>0){const a=`p2p_resolve_release_${e.id}_${Date.now()}`;await wallet_1.walletService.release({idempotencyKey:a,userId:e.sellerId,walletId:t.id,walletType:e.offer.walletType,currency:e.offer.currency,amount:r,operationType:"P2P_TRADE_RESOLVE",description:`P2P trade resolved - ${l}`,metadata:{tradeId:e.id,resolution:l,adminId:i.id},transaction:_});w=!0;console_1.logger.info("P2P_RESOLVE",`${l}: Unlocked ${r} for trade ${e.id} (BUY offer)`);r<e.amount&&console_1.logger.warn("P2P_RESOLVE",`${l}: Partial unlock for trade ${e.id}: ${r}/${e.amount}`)}else console_1.logger.warn("P2P_RESOLVE",`${l}: No funds to unlock for trade ${e.id}`)}}else console_1.logger.info("P2P_RESOLVE",`${l}: SELL offer - funds remain locked for offer ${e.offerId}`);if(e.offerId){const r=await db_1.models.p2pOffer.findByPk(e.offerId,{lock:!0,transaction:_});if(r&&["ACTIVE","PAUSED"].includes(r.status)){const a=m(r.amountConfig),o=null!==(t=a.originalTotal)&&void 0!==t?t:a.total+e.amount,i=a.total+e.amount,n=Math.min(i,o);if(n>a.total){await r.update({amountConfig:{...a,total:n,originalTotal:o}},{transaction:_});console_1.logger.info("P2P_RESOLVE",`${l}: Restored offer ${r.id} amount: ${a.total} -> ${n}`)}}}}E="CANCELLED"}let y=e.timeline||[];if("string"==typeof y)try{y=JSON.parse(y)}catch(e){y=[]}Array.isArray(y)||(y=[]);y.push({event:"ADMIN_RESOLVED",message:`Trade resolved by admin: ${l}${a?` - ${a}`:""}`,userId:i.id,adminName:`${i.firstName} ${i.lastName}`,resolution:l,createdAt:(new Date).toISOString()});null==n||n.step("Updating trade status");await e.update({status:E,timeline:y,resolution:{outcome:l,notes:a,resolvedBy:i.id},completedAt:"COMPLETED"===E?new Date:null,cancelledAt:"CANCELLED"===E?new Date:null},{transaction:_});null==n||n.step("Updating related dispute if exists");const P=await db_1.models.p2pDispute.findOne({where:{tradeId:s},transaction:_});P&&await P.update({status:"RESOLVED",resolution:{outcome:l,notes:a,resolvedBy:i.id,resolvedAt:(new Date).toISOString()},resolvedOn:new Date},{transaction:_});null==n||n.step("Logging activity");await db_1.models.p2pActivityLog.create({userId:i.id,type:"ADMIN_TRADE_RESOLVED",action:"ADMIN_TRADE_RESOLVED",relatedEntity:"TRADE",relatedEntityId:e.id,details:JSON.stringify({previousStatus:o,finalStatus:E,resolution:l,notes:a,fundsReleased:w,adminId:i.id,adminName:`${i.firstName} ${i.lastName}`})},{transaction:_});await(0,ownership_1.logP2PAdminAction)(i.id,"TRADE_RESOLVED","TRADE",e.id,{previousStatus:o,finalStatus:E,resolution:l,fundsReleased:w});await _.commit();null==n||n.step("Sending notifications");u(e.id,"COMPLETED"===E?"TRADE_COMPLETED":"TRADE_CANCELLED",{buyerId:e.buyerId,sellerId:e.sellerId,amount:e.amount,currency:(null===(r=e.offer)||void 0===r?void 0:r.currency)||e.currency,adminResolved:!0,resolution:l}).catch(e=>console_1.logger.error("P2P_RESOLVE",`Notification error: ${e}`));c(e.id,{type:"STATUS_CHANGE",data:{status:E,previousStatus:o,resolution:l,adminResolved:!0,timeline:y}});null==n||n.success("Trade resolved successfully");return{message:"Trade resolved successfully.",trade:{id:e.id,status:E,resolution:l,fundsReleased:w}}}catch(e){await _.rollback();if(e.statusCode)throw e;null==n||n.fail("Failed to resolve trade");throw(0,error_1.createError)({statusCode:500,message:"Internal Server Error: "+e.message})}};