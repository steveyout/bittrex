"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}});Object.defineProperty(e,s,n)}:function(e,t,r,s){void 0===s&&(s=r);e[s]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var e=function(t){e=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t};return e(t)};return function(t){if(t&&t.__esModule)return t;var r={};if(null!=t)for(var s=e(t),n=0;n<s.length;n++)"default"!==s[n]&&__createBinding(r,t,s[n]);__setModuleDefault(r,t);return r}}();Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),console_1=require("@b/utils/console");exports.metadata={summary:"Add Admin Note or Message to Trade",description:"Adds a note or message to a trade as an admin. Notes are internal, messages are visible to users.",operationId:"adminAddNoteToP2PTrade",tags:["Admin","Trades","P2P"],requiresAuth:!0,logModule:"ADMIN_P2P",logTitle:"Add note to trade",parameters:[{index:0,name:"id",in:"path",description:"Trade ID",required:!0,schema:{type:"string"}}],requestBody:{description:"Note or message data",required:!0,content:{"application/json":{schema:{type:"object",properties:{note:{type:"string"},isMessage:{type:"boolean",default:!1}},required:["note"]}}}},responses:{200:{description:"Admin note/message added successfully."},401:{description:"Unauthorized."},404:{description:"Trade not found."},500:{description:"Internal Server Error."}},permission:"edit.p2p.trade"};exports.default=async e=>{const{params:t,body:r,ctx:s}=e,{id:n}=t,{note:i,isMessage:a=!1}=r;try{null==s||s.step("Fetching trade");const t=await db_1.models.p2pTrade.findByPk(n,{include:[{model:db_1.models.user,as:"buyer",attributes:["id","email"]},{model:db_1.models.user,as:"seller",attributes:["id","email"]}]});if(!t){null==s||s.fail("Trade not found");throw(0,error_1.createError)({statusCode:404,message:"Trade not found"})}null==s||s.step("Getting admin information");const r=await db_1.models.user.findByPk(e.user.id,{attributes:["firstName","lastName"]}),o=r?`${r.firstName} ${r.lastName}`.trim():"Admin";null==s||s.step("Processing timeline");let d=t.timeline||[];if("string"==typeof d)try{d=JSON.parse(d)}catch(e){console_1.logger.error("P2P","Failed to parse timeline JSON",e);d=[]}Array.isArray(d)||(d=[]);null==s||s.step(`Adding ${a?"message":"note"} to timeline`);const l=a?{event:"MESSAGE",message:i,senderId:e.user.id,senderName:o,isAdminMessage:!0,createdAt:(new Date).toISOString()}:{event:"Admin Note",message:i,details:`Note added by ${o}`,adminId:e.user.id,timestamp:(new Date).toISOString()};d.push(l);null==s||s.step("Updating trade");await t.update({timeline:d});if(a){null==s||s.step("Sending notifications to participants");const{notifyTradeEvent:e}=await Promise.resolve().then(()=>__importStar(require("../../../../p2p/utils/notifications")));e(t.id,"ADMIN_MESSAGE",{buyerId:t.buyerId,sellerId:t.sellerId,amount:t.amount,currency:t.currency,adminName:o,message:i}).catch(e=>console_1.logger.error("P2P","Failed to send admin message notification",e))}null==s||s.success(a?"Admin message sent successfully":"Admin note added successfully");return{message:a?"Admin message sent successfully.":"Admin note added successfully."}}catch(e){null==s||s.fail("Failed to add "+(a?"message":"note"));throw(0,error_1.createError)({statusCode:500,message:"Internal Server Error: "+e.message})}};