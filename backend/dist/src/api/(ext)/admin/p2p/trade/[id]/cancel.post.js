"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}});Object.defineProperty(e,a,n)}:function(e,t,r,a){void 0===a&&(a=r);e[a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var e=function(t){e=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t};return e(t)};return function(t){if(t&&t.__esModule)return t;var r={};if(null!=t)for(var a=e(t),n=0;n<a.length;n++)"default"!==a[n]&&__createBinding(r,t,a[n]);__setModuleDefault(r,t);return r}}();Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),console_1=require("@b/utils/console"),ownership_1=require("../../../../p2p/utils/ownership"),wallet_1=require("@b/services/wallet");exports.metadata={summary:"Cancel Trade (Admin)",description:"Cancels a trade with a provided cancellation reason, releases locked funds back to seller.",operationId:"cancelAdminP2PTrade",tags:["Admin","Trades","P2P"],requiresAuth:!0,logModule:"ADMIN_P2P",logTitle:"Cancel P2P trade",parameters:[{index:0,name:"id",in:"path",description:"Trade ID",required:!0,schema:{type:"string"}}],requestBody:{description:"Cancellation reason",required:!0,content:{"application/json":{schema:{type:"object",properties:{reason:{type:"string",description:"Reason for cancellation"}},required:["reason"]}}}},responses:{200:{description:"Trade cancelled successfully."},401:{description:"Unauthorized."},404:{description:"Trade not found."},500:{description:"Internal Server Error."}},permission:"edit.p2p.trade"};exports.default=async e=>{var t,r,a;const{params:n,body:o,user:i,ctx:l}=e,{id:s}=n,{reason:d}=o,{notifyTradeEvent:c}=await Promise.resolve().then(()=>__importStar(require("../../../../p2p/utils/notifications"))),{broadcastP2PTradeEvent:u}=await Promise.resolve().then(()=>__importStar(require("../../../../p2p/trade/[id]/index.ws"))),{getWalletSafe:f}=await Promise.resolve().then(()=>__importStar(require("@b/api/finance/wallet/utils"))),{sanitizeInput:p}=await Promise.resolve().then(()=>__importStar(require("../../../../p2p/utils/validation"))),{parseAmountConfig:_}=await Promise.resolve().then(()=>__importStar(require("../../../../p2p/utils/json-parser"))),m=await db_1.sequelize.transaction();try{null==l||l.step("Fetching trade");const e=await db_1.models.p2pTrade.findByPk(s,{include:[{model:db_1.models.p2pOffer,as:"offer",attributes:["id","currency","walletType","amountConfig","status","type"]}],lock:!0,transaction:m});if(!e){await m.rollback();null==l||l.fail("Trade not found");throw(0,error_1.createError)({statusCode:404,message:"Trade not found"})}null==l||l.step("Validating trade status");if(["COMPLETED","CANCELLED","EXPIRED"].includes(e.status)){await m.rollback();null==l||l.fail(`Cannot cancel trade with status: ${e.status}`);throw(0,error_1.createError)({statusCode:400,message:`Cannot cancel trade with status: ${e.status}`})}const n=d?p(d):"Cancelled by admin",o=e.status;null==l||l.step("Processing fund unlocking and offer restoration");if(["PENDING","PAYMENT_SENT","DISPUTED"].includes(e.status)&&e.offer){if("BUY"===e.offer.type)try{const t=await f(e.sellerId,e.offer.walletType,e.offer.currency);if(t){const r=Math.min(e.amount,t.inOrder);if(r>0){const a=`p2p_admin_cancel_release_${e.id}`;await wallet_1.walletService.release({idempotencyKey:a,userId:e.sellerId,walletId:t.id,walletType:e.offer.walletType,currency:e.offer.currency,amount:r,operationType:"P2P_ADMIN_TRADE_CANCEL",description:`Release ${r} ${e.offer.currency} - P2P trade cancelled by admin`,metadata:{tradeId:e.id,offerId:e.offerId,adminId:i.id,reason:n},transaction:m});console_1.logger.info("P2P_ADMIN_CANCEL",`Released ${r} ${e.offer.currency} for seller ${e.sellerId} (BUY offer)`);r<e.amount&&console_1.logger.warn("P2P_ADMIN_CANCEL",`Partial unlock for trade ${e.id}: ${r}/${e.amount}`)}else console_1.logger.warn("P2P_ADMIN_CANCEL",`No funds to unlock for trade ${e.id} - inOrder is already 0`)}}catch(e){console_1.logger.error("P2P_ADMIN_CANCEL",`Failed to release wallet funds: ${e}`)}else console_1.logger.info("P2P_ADMIN_CANCEL",`SELL offer - funds remain locked for offer ${e.offerId}`);if(e.offerId){const r=await db_1.models.p2pOffer.findByPk(e.offerId,{lock:!0,transaction:m});if(r&&["ACTIVE","PAUSED"].includes(r.status)){const a=_(r.amountConfig),n=null!==(t=a.originalTotal)&&void 0!==t?t:a.total+e.amount,o=a.total+e.amount,i=Math.min(o,n);if(i>a.total){await r.update({amountConfig:{...a,total:i,originalTotal:n}},{transaction:m});console_1.logger.info("P2P_ADMIN_CANCEL",`Restored offer ${r.id} amount: ${a.total} -> ${i}`)}else console_1.logger.debug("P2P_ADMIN_CANCEL",`Skipped offer ${r.id} restoration - at or above limit`)}}}let y=e.timeline||[];if("string"==typeof y)try{y=JSON.parse(y)}catch(e){y=[]}Array.isArray(y)||(y=[]);y.push({event:"ADMIN_CANCELLED",message:`Trade cancelled by admin: ${n}`,userId:i.id,adminName:`${i.firstName} ${i.lastName}`,createdAt:(new Date).toISOString()});null==l||l.step("Updating trade status");await e.update({status:"CANCELLED",timeline:y,cancelledBy:i.id,cancellationReason:n,cancelledAt:new Date},{transaction:m});null==l||l.step("Logging activity");await db_1.models.p2pActivityLog.create({userId:i.id,type:"ADMIN_TRADE_CANCELLED",action:"ADMIN_TRADE_CANCELLED",relatedEntity:"TRADE",relatedEntityId:e.id,details:JSON.stringify({previousStatus:o,reason:n,amount:e.amount,currency:null===(r=e.offer)||void 0===r?void 0:r.currency,buyerId:e.buyerId,sellerId:e.sellerId,adminId:i.id,adminName:`${i.firstName} ${i.lastName}`})},{transaction:m});await(0,ownership_1.logP2PAdminAction)(i.id,"TRADE_CANCELLED","TRADE",e.id,{previousStatus:o,reason:n,amount:e.amount});await m.commit();null==l||l.step("Sending notifications");c(e.id,"TRADE_CANCELLED",{buyerId:e.buyerId,sellerId:e.sellerId,amount:e.amount,currency:(null===(a=e.offer)||void 0===a?void 0:a.currency)||e.currency,cancelledBy:i.id,reason:n,adminCancelled:!0}).catch(e=>console_1.logger.error("P2P_ADMIN_CANCEL",`Notification error: ${e}`));u(e.id,{type:"STATUS_CHANGE",data:{status:"CANCELLED",previousStatus:o,cancelledAt:new Date,cancellationReason:n,adminCancelled:!0,timeline:y}});null==l||l.success("Trade cancelled successfully");return{message:"Trade cancelled successfully.",trade:{id:e.id,status:"CANCELLED",cancelledAt:e.cancelledAt}}}catch(e){await m.rollback();if(e.statusCode)throw e;null==l||l.fail("Failed to cancel trade");throw(0,error_1.createError)({statusCode:500,message:"Internal Server Error: "+e.message})}};