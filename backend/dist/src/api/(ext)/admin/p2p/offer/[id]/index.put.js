"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[r]}});Object.defineProperty(e,a,i)}:function(e,t,r,a){void 0===a&&(a=r);e[a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var e=function(t){e=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t};return e(t)};return function(t){if(t&&t.__esModule)return t;var r={};if(null!=t)for(var a=e(t),i=0;i<a.length;i++)"default"!==a[i]&&__createBinding(r,t,a[i]);__setModuleDefault(r,t);return r}}();Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),Middleware_1=require("@b/handler/Middleware"),notifications_1=require("@b/utils/notifications"),console_1=require("@b/utils/console"),utils_1=require("../../utils"),errors_1=require("@b/utils/schema/errors");exports.metadata={summary:"Update P2P offer",description:"Updates a P2P offer with admin privileges. Handles status transitions (approval, rejection, etc.), sends email notifications to users, and manages locked funds for SELL offers.",operationId:"updateAdminP2POffer",tags:["Admin","P2P","Offer"],requiresAuth:!0,middleware:[Middleware_1.p2pAdminOfferRateLimit],logModule:"ADMIN_P2P",logTitle:"Update P2P offer",parameters:[{index:0,name:"id",in:"path",description:"Offer ID",required:!0,schema:{type:"string"}}],requestBody:{description:"Offer update data",required:!0,content:{"application/json":{schema:{type:"object",properties:{type:{type:"string",enum:["BUY","SELL"],description:"Trade type"},currency:{type:"string",description:"Cryptocurrency"},walletType:{type:"string",enum:["SPOT","FIAT","ECO"],description:"Wallet type"},status:{type:"string",enum:["ACTIVE","PENDING_APPROVAL","PAUSED","DISABLED","FLAGGED","REJECTED","DRAFT","COMPLETED","CANCELLED","EXPIRED"],description:"Offer status"},amountConfig:{type:"string",description:"JSON string of amount configuration"},priceConfig:{type:"string",description:"JSON string of price configuration"},tradeSettings:{type:"string",description:"JSON string of trade settings"},locationSettings:{type:"string",description:"JSON string of location settings"},userRequirements:{type:"string",description:"JSON string of user requirements"},paymentMethodIds:{type:"array",items:{type:"string"},description:"Array of payment method IDs"},adminNotes:{type:"string",description:"Admin notes about the offer"},rejectionReason:{type:"string",description:"Reason for rejection (used when status is set to REJECTED)"}}}}}},responses:{200:{description:"Offer updated successfully"},401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("Resource"),500:errors_1.serverErrorResponse},permission:"edit.p2p.offer"};exports.default=async e=>{const{params:t,body:r,user:a,ctx:i}=e,{id:s}=t;try{null==i||i.step("Fetching P2P offer");const e=await db_1.models.p2pOffer.findByPk(s);if(!e){null==i||i.fail("Offer not found");throw(0,error_1.createError)({statusCode:404,message:"Offer not found"})}const t=await db_1.models.user.findByPk(e.userId,{attributes:["id","firstName","lastName","email"]}),o=await db_1.models.user.findByPk(a.id,{attributes:["id","firstName","lastName","email"]});null==i||i.step("Preparing update data");const n=e.status,d={};void 0!==r.type&&(d.type=r.type);void 0!==r.currency&&(d.currency=r.currency);void 0!==r.walletType&&(d.walletType=r.walletType);void 0!==r.status&&(d.status=r.status);void 0!==r.adminNotes&&(d.adminNotes=r.adminNotes);if(void 0!==r.amountConfig)try{const e="string"==typeof r.amountConfig?JSON.parse(r.amountConfig):r.amountConfig;d.amountConfig=e}catch(e){throw(0,error_1.createError)({statusCode:400,message:"Invalid amountConfig format"})}if(void 0!==r.priceConfig)try{const e="string"==typeof r.priceConfig?JSON.parse(r.priceConfig):r.priceConfig;d.priceConfig=e}catch(e){throw(0,error_1.createError)({statusCode:400,message:"Invalid priceConfig format"})}if(void 0!==r.tradeSettings)try{const e="string"==typeof r.tradeSettings?JSON.parse(r.tradeSettings):r.tradeSettings;d.tradeSettings=e}catch(e){throw(0,error_1.createError)({statusCode:400,message:"Invalid tradeSettings format"})}if(void 0!==r.locationSettings)try{const e="string"==typeof r.locationSettings?JSON.parse(r.locationSettings):r.locationSettings;d.locationSettings=e}catch(e){throw(0,error_1.createError)({statusCode:400,message:"Invalid locationSettings format"})}if(void 0!==r.userRequirements)try{const e="string"==typeof r.userRequirements?JSON.parse(r.userRequirements):r.userRequirements;d.userRequirements=e}catch(e){throw(0,error_1.createError)({statusCode:400,message:"Invalid userRequirements format"})}if(d.amountConfig||d.priceConfig){null==i||i.step("Validating trade amounts");const{CacheManager:t}=await Promise.resolve().then(()=>__importStar(require("@b/utils/cache"))),r=t.getInstance(),a=await r.getSetting("p2pMinimumTradeAmount"),s=await r.getSetting("p2pMaximumTradeAmount"),o=d.amountConfig||e.amountConfig,n=d.priceConfig||e.priceConfig,u=(null==n?void 0:n.currency)||"USD",c=(null==o?void 0:o.min)||0,f=(null==o?void 0:o.max)||(null==o?void 0:o.total)||0;if(a&&c<a)throw(0,error_1.createError)({statusCode:400,message:`Minimum trade amount cannot be less than platform minimum of ${a} ${u}`});if(s&&f>s)throw(0,error_1.createError)({statusCode:400,message:`Maximum trade amount cannot exceed platform maximum of ${s} ${u}`});const{validateMinimumTradeAmount:l}=await Promise.resolve().then(()=>__importStar(require("../../../../p2p/utils/fees")));if((null==o?void 0:o.min)&&(null==n?void 0:n.finalPrice)){const t=d.currency||e.currency,r=o.min/n.finalPrice,a=await l(r,t);if(!a.valid&&a.minimum)throw(0,error_1.createError)({statusCode:400,message:`Minimum trade amount for ${t} is ${a.minimum} ${t}. Current minimum converts to ${r.toFixed(8)} ${t}.`})}}let u="ADMIN_UPDATE",c=!1,f="",l={};if(r.status&&r.status!==n)switch(r.status){case"ACTIVE":if("PENDING_APPROVAL"===n){u="OFFER_APPROVED";c=!0;f="approval";l={OFFER_TYPE:e.type,CURRENCY:e.currency,APPROVED_BY:o&&`${o.firstName||""} ${o.lastName||""}`.trim()||"Admin",NOTES:r.adminNotes||"",USER_NAME:t&&`${t.firstName||""} ${t.lastName||""}`.trim()||"User"}}break;case"REJECTED":u="OFFER_REJECTED";c=!0;f="rejection";l={OFFER_TYPE:e.type,CURRENCY:e.currency,REJECTED_BY:o&&`${o.firstName||""} ${o.lastName||""}`.trim()||"Admin",REASON:r.rejectionReason||"Does not meet platform requirements",USER_NAME:t&&`${t.firstName||""} ${t.lastName||""}`.trim()||"User"};d.adminNotes=`Rejected: ${r.rejectionReason||"No reason provided"}\n${r.adminNotes||""}`;break;case"FLAGGED":u="OFFER_FLAGGED";c=!0;f="flagged";l={OFFER_TYPE:e.type,CURRENCY:e.currency,FLAGGED_BY:o&&`${o.firstName||""} ${o.lastName||""}`.trim()||"Admin",REASON:r.adminNotes||"Flagged for review",USER_NAME:t&&`${t.firstName||""} ${t.lastName||""}`.trim()||"User"};break;case"DISABLED":u="OFFER_DISABLED";c=!0;f="disabled";l={OFFER_TYPE:e.type,CURRENCY:e.currency,DISABLED_BY:o&&`${o.firstName||""} ${o.lastName||""}`.trim()||"Admin",REASON:r.adminNotes||"Disabled by admin",USER_NAME:t&&`${t.firstName||""} ${t.lastName||""}`.trim()||"User"}}null==i||i.step("Updating offer");await e.update(d);if(r.paymentMethodIds&&Array.isArray(r.paymentMethodIds)){null==i||i.step("Updating payment methods");try{const e=await db_1.models.p2pOffer.findByPk(s);if(e&&e.setPaymentMethods)await e.setPaymentMethods(r.paymentMethodIds);else{await db_1.models.sequelize.query("DELETE FROM p2p_offer_payment_method WHERE offerId = :offerId",{replacements:{offerId:s},type:db_1.models.sequelize.QueryTypes.DELETE});for(const e of r.paymentMethodIds)await db_1.models.sequelize.query("INSERT INTO p2p_offer_payment_method (offerId, paymentMethodId) VALUES (:offerId, :methodId)",{replacements:{offerId:s,methodId:e},type:db_1.models.sequelize.QueryTypes.INSERT})}}catch(e){console_1.logger.error("P2P_OFFER","Failed to update payment methods",e)}}if(c&&(null==t?void 0:t.email)){null==i||i.step("Sending email notification");try{switch(f){case"approval":await(0,utils_1.sendOfferApprovalEmail)(t.email,l);break;case"rejection":await(0,utils_1.sendOfferRejectionEmail)(t.email,l);break;case"flagged":await(0,utils_1.sendOfferFlaggedEmail)(t.email,l);break;case"disabled":await(0,utils_1.sendOfferDisabledEmail)(t.email,l)}}catch(e){console_1.logger.error("P2P_OFFER","Failed to send email notification",e)}}if(r.status&&r.status!==n&&t)try{let a="",s="";switch(r.status){case"ACTIVE":a="Offer Approved";s=`Your ${e.type} offer for ${e.currency} has been approved and is now active.`;break;case"REJECTED":a="Offer Rejected";s=`Your ${e.type} offer for ${e.currency} has been rejected. Reason: ${r.rejectionReason||"Does not meet requirements"}`;break;case"FLAGGED":a="Offer Flagged";s=`Your ${e.type} offer for ${e.currency} has been flagged for review.`;break;case"DISABLED":a="Offer Disabled";s=`Your ${e.type} offer for ${e.currency} has been disabled by an administrator.`}s&&await(0,notifications_1.createNotification)({userId:t.id,type:"system",title:a,message:s,link:`/p2p/offer/${e.id}`},i)}catch(e){console_1.logger.error("P2P_OFFER","Failed to create notification",e)}const m=await db_1.models.p2pOffer.findByPk(s);m&&t&&(m.dataValues.user=t.dataValues);if(m&&r.paymentMethodIds&&r.paymentMethodIds.length>0)try{const e=await db_1.models.p2pPaymentMethod.findAll({where:{id:r.paymentMethodIds},attributes:["id","name","icon"],raw:!0});m.dataValues.paymentMethods=e}catch(e){console_1.logger.error("P2P_OFFER","Failed to fetch payment methods",e);m.dataValues.paymentMethods=[]}else m.dataValues.paymentMethods=[];null==i||i.step("Logging admin action");try{const{logP2PAdminAction:t}=await Promise.resolve().then(()=>__importStar(require("../../../../p2p/utils/ownership"))),i=o&&`${o.firstName||""} ${o.lastName||""}`.trim()||"Admin";await t(a.id,u,"OFFER",e.id,{offerUserId:e.userId,offerType:e.type,currency:e.currency,changes:Object.keys(d).filter(e=>"activityLog"!==e),updatedBy:i,statusChange:r.status&&n!==r.status?`${n} -> ${r.status}`:null})}catch(e){console_1.logger.error("P2P_OFFER","Failed to log admin action",e)}null==i||i.success("Offer updated successfully");return{message:r.status&&r.status!==n?`Offer ${r.status.toLowerCase()} successfully`:"Offer updated successfully",data:m}}catch(e){if(e.statusCode)throw e;null==i||i.fail("Failed to update offer");throw(0,error_1.createError)({statusCode:500,message:e.message||"Internal Server Error"})}};