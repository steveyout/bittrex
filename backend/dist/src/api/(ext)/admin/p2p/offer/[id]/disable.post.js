"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,t,i){void 0===i&&(i=t);var a=Object.getOwnPropertyDescriptor(r,t);a&&!("get"in a?!r.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return r[t]}});Object.defineProperty(e,i,a)}:function(e,r,t,i){void 0===i&&(i=t);e[i]=r[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(){var e=function(r){e=Object.getOwnPropertyNames||function(e){var r=[];for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(r[r.length]=t);return r};return e(r)};return function(r){if(r&&r.__esModule)return r;var t={};if(null!=r)for(var i=e(r),a=0;a<i.length;a++)"default"!==i[a]&&__createBinding(t,r,i[a]);__setModuleDefault(t,r);return t}}();Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),Middleware_1=require("@b/handler/Middleware"),ownership_1=require("../../../../p2p/utils/ownership"),json_parser_1=require("../../../../p2p/utils/json-parser"),utils_1=require("@b/api/finance/wallet/utils"),console_1=require("@b/utils/console"),wallet_1=require("@b/services/wallet"),errors_1=require("@b/utils/schema/errors");exports.metadata={summary:"Disable P2P offer",description:"Disables a P2P offer and sets it to CANCELLED status. For SELL offers, releases any locked funds from escrow back to the user. Sends notification with disable reason.",operationId:"disableAdminP2POffer",tags:["Admin","P2P","Offer"],requiresAuth:!0,middleware:[Middleware_1.p2pAdminOfferRateLimit],logModule:"ADMIN_P2P",logTitle:"Disable P2P offer",parameters:[{index:0,name:"id",in:"path",description:"Offer ID",required:!0,schema:{type:"string"}}],requestBody:{description:"Reason for disabling",required:!0,content:{"application/json":{schema:{type:"object",properties:{reason:{type:"string"}},required:["reason"]}}}},responses:{200:{description:"Offer disabled successfully."},401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("Resource"),500:errors_1.serverErrorResponse},permission:"edit.p2p.offer"};exports.default=async e=>{const{params:r,body:t,user:i,ctx:a}=e,{id:s}=r,{reason:n}=t,{sanitizeInput:o}=await Promise.resolve().then(()=>__importStar(require("../../../../p2p/utils/validation"))),{notifyOfferEvent:d}=await Promise.resolve().then(()=>__importStar(require("../../../../p2p/utils/notifications"))),l=await db_1.sequelize.transaction();try{null==a||a.step("Fetching offer");const e=await db_1.models.p2pOffer.findByPk(s,{include:[{model:db_1.models.user,as:"user",attributes:["id","firstName","lastName","email"]}],lock:!0,transaction:l});if(!e){await l.rollback();null==a||a.fail("Offer not found");throw(0,error_1.createError)({statusCode:404,message:"Offer not found"})}null==a||a.step("Getting admin information");const r=await db_1.models.user.findByPk(i.id,{attributes:["id","firstName","lastName","email"],transaction:l}),t=o(n),u=r&&`${r.firstName||""} ${r.lastName||""}`.trim()||"Admin",f=e.status;let c=!1,p=0;null==a||a.step("Checking for locked funds to release");if("SELL"===e.type){const r=(0,json_parser_1.parseAmountConfig)(e.amountConfig).total;if(r>0){const s=await(0,utils_1.getWalletSafe)(e.userId,e.walletType,e.currency,!1,a);if(s&&s.inOrder>=r){null==a||a.step("Releasing locked funds");const n=`p2p_admin_disable_offer_${e.id}`;await wallet_1.walletService.release({idempotencyKey:n,userId:e.userId,walletId:s.id,walletType:e.walletType,currency:e.currency,amount:r,operationType:"P2P_ADMIN_OFFER_DISABLE",description:`Release ${r} ${e.currency} - P2P offer disabled by admin`,metadata:{offerId:e.id,adminId:i.id,reason:t},transaction:l});c=!0;p=r}}}null==a||a.step("Disabling offer");await e.update({status:"CANCELLED",adminNotes:t,disabledBy:i.id,disabledAt:new Date,activityLog:[...e.activityLog||[],{type:"DISABLED",reason:t,adminId:i.id,adminName:u,fundsReleased:c,releasedAmount:p,createdAt:(new Date).toISOString()}]},{transaction:l});null==a||a.step("Logging admin activity");await(0,ownership_1.logP2PAdminAction)(i.id,"OFFER_DISABLED","OFFER",e.id,{offerUserId:e.userId,offerType:e.type,currency:e.currency,previousStatus:f,reason:t,disabledBy:u,fundsReleased:c,releasedAmount:p});await l.commit();null==a||a.step("Sending notification");d(e.id,"OFFER_DISABLED",{reason:t,disabledBy:u,fundsReleased:c,releasedAmount:p}).catch(e=>console_1.logger.error("P2P","Failed to send offer disabled notification",e));null==a||a.success("Offer disabled successfully");return{message:"Offer disabled successfully.",offer:{id:e.id,status:"CANCELLED",disabledAt:e.disabledAt,fundsReleased:c,releasedAmount:p}}}catch(e){await l.rollback();if(e.statusCode)throw e;null==a||a.fail("Failed to disable offer");throw(0,error_1.createError)({statusCode:500,message:"Internal Server Error: "+e.message})}};