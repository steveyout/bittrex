"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,t,i){void 0===i&&(i=t);var a=Object.getOwnPropertyDescriptor(r,t);a&&!("get"in a?!r.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return r[t]}});Object.defineProperty(e,i,a)}:function(e,r,t,i){void 0===i&&(i=t);e[i]=r[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(){var e=function(r){e=Object.getOwnPropertyNames||function(e){var r=[];for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(r[r.length]=t);return r};return e(r)};return function(r){if(r&&r.__esModule)return r;var t={};if(null!=r)for(var i=e(r),a=0;a<i.length;a++)"default"!==i[a]&&__createBinding(t,r,i[a]);__setModuleDefault(t,r);return t}}();Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),Middleware_1=require("@b/handler/Middleware"),ownership_1=require("../../../../p2p/utils/ownership"),console_1=require("@b/utils/console"),errors_1=require("@b/utils/schema/errors");exports.metadata={summary:"Flag P2P offer for review",description:"Flags a P2P offer for administrative review. Marks the offer as flagged with a reason and notifies the offer owner. Does not change the offer status.",operationId:"flagAdminP2POffer",tags:["Admin","P2P","Offer"],requiresAuth:!0,middleware:[Middleware_1.p2pAdminOfferRateLimit],logModule:"ADMIN_P2P",logTitle:"Flag P2P offer",parameters:[{index:0,name:"id",in:"path",description:"Offer ID",required:!0,schema:{type:"string"}}],requestBody:{description:"Reason for flagging",required:!0,content:{"application/json":{schema:{type:"object",properties:{reason:{type:"string"}},required:["reason"]}}}},responses:{200:{description:"Offer flagged successfully."},401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("Resource"),500:errors_1.serverErrorResponse},permission:"edit.p2p.offer"};exports.default=async e=>{const{params:r,body:t,user:i,ctx:a}=e,{id:o}=r,{reason:s}=t,{sanitizeInput:n}=await Promise.resolve().then(()=>__importStar(require("../../../../p2p/utils/validation"))),{notifyOfferEvent:f}=await Promise.resolve().then(()=>__importStar(require("../../../../p2p/utils/notifications")));try{null==a||a.step("Fetching offer");const e=await db_1.models.p2pOffer.findByPk(o,{include:[{model:db_1.models.user,as:"user",attributes:["id","firstName","lastName","email"]}]});if(!e){null==a||a.fail("Offer not found");throw(0,error_1.createError)({statusCode:404,message:"Offer not found"})}null==a||a.step("Getting admin information");const r=await db_1.models.user.findByPk(i.id,{attributes:["id","firstName","lastName","email"]}),t=n(s),d=r&&`${r.firstName||""} ${r.lastName||""}`.trim()||"Admin";null==a||a.step("Flagging offer");await e.update({isFlagged:!0,flagReason:t,flaggedBy:i.id,flaggedAt:new Date,activityLog:[...e.activityLog||[],{type:"FLAGGED",reason:t,adminId:i.id,adminName:d,createdAt:(new Date).toISOString()}]});null==a||a.step("Logging admin activity");await(0,ownership_1.logP2PAdminAction)(i.id,"OFFER_FLAGGED","OFFER",e.id,{offerUserId:e.userId,offerType:e.type,currency:e.currency,previousStatus:e.status,reason:t,flaggedBy:d});null==a||a.step("Sending notification");f(e.id,"OFFER_FLAGGED",{reason:t,flaggedBy:d}).catch(e=>console_1.logger.error("P2P","Failed to send offer flagged notification",e));null==a||a.success("Offer flagged successfully");return{message:"Offer flagged successfully.",offer:{id:e.id,isFlagged:!0,flaggedAt:e.flaggedAt}}}catch(e){if(e.statusCode)throw e;null==a||a.fail("Failed to flag offer");throw(0,error_1.createError)({statusCode:500,message:"Internal Server Error: "+e.message})}};