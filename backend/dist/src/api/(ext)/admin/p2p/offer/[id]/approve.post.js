"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var a=Object.getOwnPropertyDescriptor(t,r);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[r]}});Object.defineProperty(e,o,a)}:function(e,t,r,o){void 0===o&&(o=r);e[o]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var e=function(t){e=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t};return e(t)};return function(t){if(t&&t.__esModule)return t;var r={};if(null!=t)for(var o=e(t),a=0;a<o.length;a++)"default"!==o[a]&&__createBinding(r,t,o[a]);__setModuleDefault(r,t);return r}}();Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),Middleware_1=require("@b/handler/Middleware"),ownership_1=require("../../../../p2p/utils/ownership"),console_1=require("@b/utils/console"),errors_1=require("@b/utils/schema/errors");exports.metadata={summary:"Approve P2P offer",description:"Approves a pending P2P offer and sets it to ACTIVE status. Validates offer requirements (amount, payment methods) and sends approval notification to the offer owner.",operationId:"approveAdminP2POffer",tags:["Admin","P2P","Offer"],requiresAuth:!0,middleware:[Middleware_1.p2pAdminOfferRateLimit],logModule:"ADMIN_P2P",logTitle:"Approve P2P offer",parameters:[{index:0,name:"id",in:"path",description:"Offer ID",required:!0,schema:{type:"string"}}],requestBody:{description:"Optional notes for approval",required:!1,content:{"application/json":{schema:{type:"object",properties:{notes:{type:"string"}}}}}},responses:{200:{description:"Offer approved successfully."},401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("Resource"),500:errors_1.serverErrorResponse},permission:"edit.p2p.offer"};exports.default=async e=>{var t;const{params:r,body:o,user:a,ctx:i}=e,{id:s}=r,{notes:n}=o,{sanitizeInput:d,validateOfferStatusTransition:u}=await Promise.resolve().then(()=>__importStar(require("../../../../p2p/utils/validation"))),{notifyOfferEvent:f}=await Promise.resolve().then(()=>__importStar(require("../../../../p2p/utils/notifications")));try{null==i||i.step("Fetching offer");const e=await db_1.models.p2pOffer.findByPk(s,{include:[{model:db_1.models.user,as:"user",attributes:["id","firstName","lastName","email"]},{model:db_1.models.p2pPaymentMethod,as:"paymentMethods",through:{attributes:[]}}]});if(!e){null==i||i.fail("Offer not found");throw(0,error_1.createError)({statusCode:404,message:"Offer not found"})}null==i||i.step("Getting admin information");const r=await db_1.models.user.findByPk(a.id,{attributes:["id","firstName","lastName","email"]});null==i||i.step("Validating offer status transition");if(!u(e.status,"ACTIVE")){null==i||i.fail(`Cannot approve offer from status: ${e.status}`);throw(0,error_1.createError)({statusCode:400,message:`Cannot approve offer from status: ${e.status}`})}null==i||i.step("Validating offer requirements");if(!(null===(t=e.amountConfig)||void 0===t?void 0:t.total)||e.amountConfig.total<=0){null==i||i.fail("Offer has invalid amount");throw(0,error_1.createError)({statusCode:400,message:"Cannot approve offer with zero or invalid amount"})}if(!e.paymentMethods||0===e.paymentMethods.length){null==i||i.fail("Offer has no payment methods");throw(0,error_1.createError)({statusCode:400,message:"Cannot approve offer without payment methods"})}const o=n?d(n):null,p=r&&`${r.firstName||""} ${r.lastName||""}`.trim()||"Admin";null==i||i.step("Approving offer");await e.update({status:"ACTIVE",adminNotes:o,approvedBy:a.id,approvedAt:new Date,activityLog:[...e.activityLog||[],{type:"APPROVAL",notes:o,adminId:a.id,adminName:p,createdAt:(new Date).toISOString()}]});null==i||i.step("Logging admin activity");await(0,ownership_1.logP2PAdminAction)(a.id,"OFFER_APPROVED","OFFER",e.id,{offerUserId:e.userId,offerType:e.type,currency:e.currency,amount:e.amountConfig.total,previousStatus:e.status,adminNotes:o,approvedBy:p});null==i||i.step("Sending notification");f(e.id,"OFFER_APPROVED",{adminNotes:o,approvedBy:p}).catch(e=>console_1.logger.error("P2P","Failed to send offer approved notification",e));null==i||i.success("Offer approved successfully");return{message:"Offer approved successfully.",offer:{id:e.id,status:"ACTIVE",approvedAt:e.approvedAt}}}catch(e){if(e.statusCode)throw e;null==i||i.fail("Failed to approve offer");throw(0,error_1.createError)({statusCode:500,message:"Internal Server Error: "+e.message})}};