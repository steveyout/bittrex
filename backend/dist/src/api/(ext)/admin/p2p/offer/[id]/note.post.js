"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),errors_1=require("@b/utils/schema/errors");exports.metadata={summary:"Add admin note to P2P offer",description:"Adds an internal timestamped admin note to a P2P offer. Notes are stored in the adminNotes field and logged in admin activity for audit purposes.",operationId:"addAdminNoteToP2POffer",tags:["Admin","P2P","Offer"],requiresAuth:!0,logModule:"ADMIN_P2P",logTitle:"Add note to offer",parameters:[{index:0,name:"id",in:"path",description:"Offer ID",required:!0,schema:{type:"string"}}],requestBody:{description:"Note data",required:!0,content:{"application/json":{schema:{type:"object",properties:{note:{type:"string"}},required:["note"]}}}},responses:{200:{description:"Admin note added successfully."},401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("Resource"),500:errors_1.serverErrorResponse},permission:"edit.p2p.offer"};exports.default=async e=>{const{params:t,body:r,ctx:o}=e,{id:s}=t,{note:i}=r;try{null==o||o.step("Fetching offer");const t=await db_1.models.p2pOffer.findByPk(s);if(!t){null==o||o.fail("Offer not found");throw(0,error_1.createError)({statusCode:404,message:"Offer not found"})}null==o||o.step("Getting admin information");const r=await db_1.models.user.findByPk(e.user.id,{attributes:["firstName","lastName"]}),n=r?`${r.firstName} ${r.lastName}`.trim():"Admin";null==o||o.step("Creating timestamped note");const a=(new Date).toISOString(),d=`[${a}] ${n}: ${i}`,u=t.adminNotes||"",m=u?`${u}\n${d}`:d;null==o||o.step("Updating offer with note");await t.update({adminNotes:m});null==o||o.step("Logging admin activity");await db_1.models.p2pAdminActivity.create({adminId:e.user.id,offerId:t.id,actionType:"NOTE_ADDED",actionDetails:{note:i,timestamp:a}});null==o||o.success("Admin note added successfully");return{message:"Admin note added successfully."}}catch(e){null==o||o.fail("Failed to add admin note");throw(0,error_1.createError)({statusCode:500,message:"Internal Server Error: "+e.message})}};