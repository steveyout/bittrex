"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),sequelize_1=require("sequelize");exports.metadata={summary:"Delete P2P Payment Method (Admin)",description:"Soft deletes a payment method. Admin can delete any payment method.",operationId:"deleteP2PPaymentMethod",tags:["Admin","P2P","Payment Method"],requiresAuth:!0,permission:"delete.p2p.payment_method",logModule:"ADMIN_P2P",logTitle:"Delete payment method",parameters:[{name:"id",in:"path",description:"Payment method ID",required:!0,schema:{type:"string"}}],responses:{200:{description:"Payment method deleted successfully."},401:{description:"Unauthorized."},403:{description:"Forbidden - Admin access required."},404:{description:"Payment method not found."},500:{description:"Internal Server Error."}}};exports.default=async e=>{var t;const{params:o,user:d,ctx:a}=e;if(!(null==d?void 0:d.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});try{null==a||a.step("Fetching payment method");const e=await db_1.models.p2pPaymentMethod.findByPk(o.id);if(!e){null==a||a.fail("Payment method not found");throw(0,error_1.createError)({statusCode:404,message:"Payment method not found"})}null==a||a.step("Checking for active offers using payment method");const n=await db_1.sequelize.query("SELECT COUNT(*) as count\n       FROM p2p_offer_payment_method opm\n       JOIN p2p_offers o ON opm.offerId = o.id\n       WHERE opm.paymentMethodId = :methodId\n       AND o.status = 'ACTIVE'\n       AND o.deletedAt IS NULL",{replacements:{methodId:o.id},type:sequelize_1.QueryTypes.SELECT}),r=parseInt((null===(t=n[0])||void 0===t?void 0:t.count)||"0",10);if(r>0){null==a||a.fail(`Payment method is in use by ${r} active offers`);throw(0,error_1.createError)({statusCode:400,message:`Cannot delete payment method. It is being used in ${r} active offer(s).`})}null==a||a.step("Deleting payment method");await e.destroy();console.log(`[P2P Admin] Deleted payment method: ${e.id} by admin ${d.id}`);null==a||a.step("Logging admin activity");await db_1.models.p2pActivityLog.create({userId:d.id,type:"ADMIN_PAYMENT_METHOD",action:"DELETED",relatedEntity:"PAYMENT_METHOD",relatedEntityId:e.id,details:JSON.stringify({name:e.name,isGlobal:e.isGlobal,adminAction:!0,updatedBy:`${d.firstName} ${d.lastName}`,action:"deleted"})});null==a||a.success("Payment method deleted successfully");return{message:"Payment method deleted successfully."}}catch(e){if(e.statusCode)throw e;null==a||a.fail("Failed to delete payment method");throw(0,error_1.createError)({statusCode:500,message:"Failed to delete payment method: "+e.message})}};