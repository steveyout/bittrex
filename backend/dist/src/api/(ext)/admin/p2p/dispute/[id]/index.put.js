"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[r]}});Object.defineProperty(e,a,i)}:function(e,t,r,a){void 0===a&&(a=r);e[a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var e=function(t){e=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t};return e(t)};return function(t){if(t&&t.__esModule)return t;var r={};if(null!=t)for(var a=e(t),i=0;i<a.length;i++)"default"!==a[i]&&__createBinding(r,t,a[i]);__setModuleDefault(r,t);return r}}();Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),console_1=require("@b/utils/console"),Middleware_1=require("@b/handler/Middleware"),ownership_1=require("../../../../p2p/utils/ownership"),wallet_1=require("@b/services/wallet"),errors_1=require("@b/utils/schema/errors");exports.metadata={summary:"Update P2P dispute",description:"Updates a P2P dispute including status changes, resolution details, and admin messages. Handles fund distribution when resolving disputes based on the outcome (BUYER_WINS, SELLER_WINS, SPLIT, CANCELLED).",operationId:"updateAdminP2PDispute",tags:["Admin","P2P","Dispute"],requiresAuth:!0,middleware:[Middleware_1.p2pAdminDisputeRateLimit],logModule:"ADMIN_P2P",logTitle:"Update P2P dispute",parameters:[{index:0,name:"id",in:"path",description:"Dispute ID",required:!0,schema:{type:"string"}}],requestBody:{description:"Dispute update data",required:!0,content:{"application/json":{schema:{type:"object",properties:{status:{type:"string",enum:["PENDING","IN_PROGRESS","RESOLVED"]},resolution:{type:"object",properties:{outcome:{type:"string",enum:["BUYER_WINS","SELLER_WINS","SPLIT","CANCELLED"],description:"Resolution outcome - determines how funds are handled"},notes:{type:"string"}}},message:{type:"string",description:"Admin message to add to dispute"}}}}}},responses:{200:{description:"Dispute updated successfully."},401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("P2P resource"),500:errors_1.serverErrorResponse},permission:"edit.p2p.dispute"};exports.default=async e=>{var t,r,a;const{params:i,body:s,user:o,ctx:n}=e,{id:d}=i,{status:l,resolution:u,message:c}=s,{sanitizeInput:m}=await Promise.resolve().then(()=>__importStar(require("../../../../p2p/utils/validation"))),{notifyTradeEvent:p}=await Promise.resolve().then(()=>__importStar(require("../../../../p2p/utils/notifications"))),{broadcastP2PTradeEvent:f}=await Promise.resolve().then(()=>__importStar(require("../../../../p2p/trade/[id]/index.ws"))),{getWalletSafe:_}=await Promise.resolve().then(()=>__importStar(require("@b/api/finance/wallet/utils"))),{parseAmountConfig:P}=await Promise.resolve().then(()=>__importStar(require("../../../../p2p/utils/json-parser"))),y=await db_1.sequelize.transaction();try{null==n||n.step("Fetching dispute");const e=await db_1.models.p2pDispute.findByPk(d,{include:[{model:db_1.models.p2pTrade,as:"trade",include:[{model:db_1.models.p2pOffer,as:"offer",attributes:["currency","walletType"]}]}],lock:!0,transaction:y});if(!e){await y.rollback();null==n||n.fail("Dispute not found");throw(0,error_1.createError)({statusCode:404,message:"Dispute not found"})}const i=e.trade;let s,E=!1,g=!1;null==n||n.step("Processing dispute update");if(l){if(!["PENDING","IN_PROGRESS","RESOLVED"].includes(l)){await y.rollback();throw(0,error_1.createError)({statusCode:400,message:"Invalid status. Must be PENDING, IN_PROGRESS, or RESOLVED"})}e.status=l}if(u&&u.outcome){null==n||n.step(`Resolving dispute with outcome: ${u.outcome}`);const r=u.notes?m(u.notes):"",a=u.outcome;if(!["BUYER_WINS","SELLER_WINS","SPLIT","CANCELLED"].includes(a)){await y.rollback();throw(0,error_1.createError)({statusCode:400,message:"Invalid resolution outcome"})}if(i&&"DISPUTED"===i.status&&i.offer){let s="COMPLETED";if("BUYER_WINS"===a||"SPLIT"===a){const t=await _(i.sellerId,i.offer.walletType,i.offer.currency);if(t){const r=Math.min(i.amount,t.inOrder);if(r>0){const s=parseFloat(i.escrowFee||"0"),n=Math.min(s,i.amount),d=Math.max(0,i.amount-n),l=`p2p_dispute_seller_${i.id}_${Date.now()}`;await wallet_1.walletService.executeFromHold({idempotencyKey:l,userId:i.sellerId,walletId:t.id,walletType:i.offer.walletType,currency:i.offer.currency,amount:i.amount,operationType:"P2P_DISPUTE_RESOLVE",fee:n,description:`P2P dispute resolved (${a}) - seller debit`,metadata:{tradeId:i.id,disputeId:e.id,resolution:a,adminId:o.id},transaction:y});r<i.amount&&console_1.logger.warn("P2P_DISPUTE",`Partial fund handling for trade ${i.id}: unlocked=${r}, expected=${i.amount}`);const u=await wallet_1.walletCreationService.getOrCreateWallet(i.buyerId,i.offer.walletType,i.offer.currency),c=`p2p_dispute_buyer_${i.id}_${Date.now()}`;await wallet_1.walletService.credit({idempotencyKey:c,userId:i.buyerId,walletId:u.id,walletType:i.offer.walletType,currency:i.offer.currency,amount:d,operationType:"P2P_DISPUTE_RECEIVE",description:`P2P dispute resolved (${a}) - buyer credit`,metadata:{tradeId:i.id,disputeId:e.id,resolution:a,adminId:o.id,originalAmount:i.amount,platformFee:n},transaction:y});if(n>0){const e=await db_1.models.user.findOne({include:[{model:db_1.models.role,as:"role",where:{name:"Super Admin"}}],order:[["createdAt","ASC"]],transaction:y});if(e){await db_1.models.p2pCommission.create({adminId:e.id,amount:n,description:`P2P escrow fee for disputed trade #${i.id.slice(0,8)}... - ${i.amount} ${i.offer.currency} (${a})`,tradeId:i.id},{transaction:y});console_1.logger.info("P2P_DISPUTE",`Platform commission recorded for trade ${i.id}: ${n} ${i.offer.currency}`)}else console_1.logger.warn("P2P_DISPUTE","No super admin found to assign commission")}g=!0;console_1.logger.success("P2P_DISPUTE",`Funds transferred to buyer for trade ${i.id}: ${d} ${i.offer.currency} (fee: ${n})`)}else console_1.logger.warn("P2P_DISPUTE",`No funds available to transfer for trade ${i.id}`)}s="COMPLETED"}else if("SELLER_WINS"===a||"CANCELLED"===a){const r=await _(i.sellerId,i.offer.walletType,i.offer.currency);if(r){const t=Math.min(i.amount,r.inOrder);if(t>0){const s=`p2p_dispute_release_${i.id}_${Date.now()}`;await wallet_1.walletService.release({idempotencyKey:s,userId:i.sellerId,walletId:r.id,walletType:i.offer.walletType,currency:i.offer.currency,amount:t,operationType:"P2P_DISPUTE_RESOLVE",description:`P2P dispute resolved (${a}) - funds returned to seller`,metadata:{tradeId:i.id,disputeId:e.id,resolution:a,adminId:o.id},transaction:y});g=!0;t<i.amount&&console_1.logger.warn("P2P_DISPUTE",`Partial unlock for trade ${i.id}: ${t}/${i.amount}`)}else console_1.logger.warn("P2P_DISPUTE",`No funds to unlock for trade ${i.id}`)}if(i.offerId){const e=await db_1.models.p2pOffer.findByPk(i.offerId,{lock:!0,transaction:y});if(e&&["ACTIVE","PAUSED"].includes(e.status)){const r=P(e.amountConfig),a=null!==(t=r.originalTotal)&&void 0!==t?t:r.total+i.amount,s=r.total+i.amount,o=Math.min(s,a);if(o>r.total){await e.update({amountConfig:{...r,total:o,originalTotal:a}},{transaction:y});console_1.logger.info("P2P_DISPUTE",`Restored offer ${e.id} amount: ${r.total} -> ${o}`)}else console_1.logger.debug("P2P_DISPUTE",`Skipped offer ${e.id} restoration - at or above limit`)}}s="CANCELLED"}let n=i.timeline||[];if("string"==typeof n)try{n=JSON.parse(n)}catch(e){n=[]}Array.isArray(n)||(n=[]);n.push({event:"DISPUTE_RESOLVED",message:`Dispute resolved by admin: ${a}${r?` - ${r}`:""}`,userId:o.id,adminName:`${o.firstName} ${o.lastName}`,resolution:a,createdAt:(new Date).toISOString()});await i.update({status:s,timeline:n,resolution:{outcome:a,notes:r,resolvedBy:o.id},completedAt:"COMPLETED"===s?new Date:null,cancelledAt:"CANCELLED"===s?new Date:null},{transaction:y});E=!0}e.resolution={outcome:a,notes:r,resolvedBy:o.id,resolvedAt:(new Date).toISOString(),fundsHandled:g};e.resolvedOn=new Date;e.status="RESOLVED"}if(c){s=m(c);if(!s||0===s.length){await y.rollback();throw(0,error_1.createError)({statusCode:400,message:"Message cannot be empty"})}const t=`msg-${Date.now()}-${o.id}`,a=(new Date).toISOString();let n=e.messages;Array.isArray(n)||(n=[]);n.push({id:t,sender:o.id,senderName:`${o.firstName} ${o.lastName}`,content:s,createdAt:a,isAdmin:!0});e.messages=n;if(i){let e=i.timeline||[];if("string"==typeof e)try{e=JSON.parse(e)}catch(t){e=[]}Array.isArray(e)||(e=[]);e.push({id:t,event:"MESSAGE",message:s,senderId:o.id,senderName:`${o.firstName} ${o.lastName}`,isAdminMessage:!0,createdAt:a});await i.update({timeline:e},{transaction:y});f(i.id,{type:"MESSAGE",data:{id:t,message:s,senderId:o.id,senderName:`${o.firstName} ${o.lastName}`,isAdminMessage:!0,createdAt:a}});p(i.id,"ADMIN_MESSAGE",{buyerId:i.buyerId,sellerId:i.sellerId,amount:i.amount,currency:(null===(r=i.offer)||void 0===r?void 0:r.currency)||i.currency,message:s}).catch(e=>console_1.logger.error("P2P_DISPUTE",`Notification error: ${e}`))}}await e.save({transaction:y});null==n||n.step("Logging activity");await db_1.models.p2pActivityLog.create({userId:o.id,type:"ADMIN_DISPUTE_UPDATE",action:"ADMIN_DISPUTE_UPDATE",relatedEntity:"DISPUTE",relatedEntityId:e.id,details:JSON.stringify({status:e.status,hasResolution:!!u,resolution:null==u?void 0:u.outcome,hasMessage:!!c,tradeUpdated:E,fundsHandled:g,adminId:o.id,adminName:`${o.firstName} ${o.lastName}`})},{transaction:y});await(0,ownership_1.logP2PAdminAction)(o.id,"DISPUTE_UPDATE","DISPUTE",e.id,{status:l||e.status,hasResolution:!!u,resolution:null==u?void 0:u.outcome,hasMessage:!!c,tradeUpdated:E,fundsHandled:g,adminName:`${o.firstName} ${o.lastName}`});await y.commit();null==n||n.step("Broadcasting updates");if(E&&i){const e="BUYER_WINS"===(null==u?void 0:u.outcome)||"SPLIT"===(null==u?void 0:u.outcome)?"COMPLETED":"CANCELLED";f(i.id,{type:"STATUS_CHANGE",data:{status:e,previousStatus:"DISPUTED",disputeResolved:!0,resolution:null==u?void 0:u.outcome}});p(i.id,"COMPLETED"===e?"TRADE_COMPLETED":"TRADE_CANCELLED",{buyerId:i.buyerId,sellerId:i.sellerId,amount:i.amount,currency:(null===(a=i.offer)||void 0===a?void 0:a.currency)||i.currency,disputeResolved:!0,resolution:null==u?void 0:u.outcome}).catch(e=>console_1.logger.error("P2P_DISPUTE",`Trade notification error: ${e}`))}const I=await db_1.models.p2pDispute.findByPk(d,{include:[{model:db_1.models.p2pTrade,as:"trade",include:[{model:db_1.models.p2pOffer,as:"offer",attributes:["id","type","currency","walletType"]},{model:db_1.models.user,as:"buyer",attributes:["id","firstName","lastName","email","avatar"]},{model:db_1.models.user,as:"seller",attributes:["id","firstName","lastName","email","avatar"]}]},{model:db_1.models.user,as:"reportedBy",attributes:["id","firstName","lastName","email","avatar"]},{model:db_1.models.user,as:"against",attributes:["id","firstName","lastName","email","avatar"]}]}),w=(null==I?void 0:I.get({plain:!0}))||e.toJSON(),S=Array.isArray(w.messages)?w.messages.map(e=>({id:e.id||`${e.createdAt}-${e.sender}`,sender:e.senderName||e.sender||"Unknown",senderId:e.sender,content:e.content||e.message||"",timestamp:e.createdAt||e.timestamp,isAdmin:e.isAdmin||!1,avatar:e.avatar,senderInitials:e.senderName?e.senderName.split(" ").map(e=>e[0]).join("").toUpperCase():"?"})):[],D=(Array.isArray(w.activityLog)?w.activityLog:[]).filter(e=>"note"===e.type).map(e=>({content:e.content||e.note,createdAt:e.createdAt,createdBy:e.adminName||"Admin",adminId:e.adminId})),b=Array.isArray(w.evidence)?w.evidence.map(e=>({...e,submittedBy:e.submittedBy||"admin",timestamp:e.createdAt||e.timestamp})):[];null==n||n.success("Dispute updated successfully");return{...w,messages:S,adminNotes:D,evidence:b}}catch(e){await y.rollback();if(e.statusCode)throw e;null==n||n.fail("Failed to update dispute");throw(0,error_1.createError)({statusCode:500,message:"Internal Server Error: "+e.message})}};