"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),errors_1=require("@b/utils/schema/errors");exports.metadata={summary:"Get P2P dispute by ID",description:"Retrieves detailed information about a specific P2P dispute including trade details, involved parties, messages, evidence, and admin notes.",operationId:"getAdminP2PDisputeById",tags:["Admin","P2P","Dispute"],requiresAuth:!0,logModule:"ADMIN_P2P",logTitle:"Get P2P Dispute",parameters:[{index:0,name:"id",in:"path",description:"Dispute ID",required:!0,schema:{type:"string",format:"uuid"}}],responses:{200:{description:"Dispute retrieved successfully",content:{"application/json":{schema:{type:"object",properties:{id:{type:"string",format:"uuid"},tradeId:{type:"string",format:"uuid"},amount:{type:"string"},reportedById:{type:"string",format:"uuid"},againstId:{type:"string",format:"uuid"},reason:{type:"string"},details:{type:"string",nullable:!0},filedOn:{type:"string",format:"date-time"},status:{type:"string",enum:["PENDING","IN_PROGRESS","RESOLVED"]},priority:{type:"string",enum:["HIGH","MEDIUM","LOW"]},resolution:{type:"object",nullable:!0},resolvedOn:{type:"string",format:"date-time",nullable:!0},messages:{type:"array",description:"Transformed dispute messages"},adminNotes:{type:"array",description:"Admin notes extracted from activity log"},evidence:{type:"array",description:"Submitted evidence files"},trade:{type:"object",description:"Associated trade with offer and user details"},reportedBy:{type:"object",description:"User who reported dispute"},against:{type:"object",description:"User against whom dispute was filed"}}}}}},401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("Dispute"),500:errors_1.serverErrorResponse},permission:"view.p2p.dispute",demoMask:["reportedBy.email","against.email","trade.buyer.email","trade.seller.email"]};exports.default=async e=>{const{params:t,ctx:r}=e,{id:s}=t;try{null==r||r.step("Fetching data");const e=await db_1.models.p2pDispute.findByPk(s,{include:[{model:db_1.models.p2pTrade,as:"trade",include:[{model:db_1.models.p2pOffer,as:"offer",attributes:["id","type","currency","walletType","priceConfig","amountConfig"]},{model:db_1.models.user,as:"buyer",attributes:["id","firstName","lastName","email","avatar"]},{model:db_1.models.user,as:"seller",attributes:["id","firstName","lastName","email","avatar"]}]},{model:db_1.models.user,as:"reportedBy",attributes:["id","firstName","lastName","email","avatar"]},{model:db_1.models.user,as:"against",attributes:["id","firstName","lastName","email","avatar"]}]});if(!e)throw(0,error_1.createError)({statusCode:404,message:"Dispute not found"});const t=e.get({plain:!0}),a=Array.isArray(t.messages)?t.messages.map(e=>({id:e.id||`${e.createdAt}-${e.sender}`,sender:e.senderName||e.sender||"Unknown",senderId:e.sender,content:e.content||e.message||"",timestamp:e.createdAt||e.timestamp,isAdmin:e.isAdmin||!1,avatar:e.avatar,senderInitials:e.senderName?e.senderName.split(" ").map(e=>e[0]).join("").toUpperCase():"?"})):[],i=(Array.isArray(t.activityLog)?t.activityLog:[]).filter(e=>"note"===e.type).map(e=>({content:e.content||e.note,createdAt:e.createdAt,createdBy:e.adminName||"Admin",adminId:e.adminId})),d=Array.isArray(t.evidence)?t.evidence.map(e=>({...e,submittedBy:e.submittedBy||"admin",timestamp:e.createdAt||e.timestamp})):[];null==r||r.success("Operation completed successfully");return{...t,messages:a,adminNotes:i,evidence:d}}catch(e){if(e.statusCode)throw e;throw(0,error_1.createError)({statusCode:500,message:"Internal Server Error: "+e.message})}};