"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),errors_1=require("@b/utils/schema/errors");exports.metadata={summary:"Add admin note to P2P dispute",description:"Adds an internal admin note to a P2P dispute activity log. Notes are timestamped and attributed to the admin user for tracking purposes.",operationId:"addNoteToAdminP2PDispute",tags:["Admin","P2P","Dispute"],requiresAuth:!0,permissions:["p2p.dispute.note.add"],logModule:"ADMIN_P2P",logTitle:"Add note to dispute",parameters:[{index:0,name:"id",in:"path",description:"Dispute ID",required:!0,schema:{type:"string"}}],requestBody:{description:"Note data",required:!0,content:{"application/json":{schema:{type:"object",properties:{note:{type:"string"}},required:["note"]}}}},responses:{200:{description:"Note added successfully."},401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("Resource"),500:errors_1.serverErrorResponse},permission:"edit.p2p.dispute"};exports.default=async e=>{const{params:t,body:a,user:s,ctx:r}=e,{id:i}=t,{note:d}=a;try{null==r||r.step("Fetching dispute");const e=await db_1.models.p2pDispute.findByPk(i,{include:[{model:db_1.models.p2pTrade,as:"trade",include:[{model:db_1.models.p2pOffer,as:"offer",attributes:["id","type","currency","walletType"]},{model:db_1.models.user,as:"buyer",attributes:["id","firstName","lastName","email","avatar"]},{model:db_1.models.user,as:"seller",attributes:["id","firstName","lastName","email","avatar"]}]},{model:db_1.models.user,as:"reportedBy",attributes:["id","firstName","lastName","email","avatar"]},{model:db_1.models.user,as:"against",attributes:["id","firstName","lastName","email","avatar"]}]});if(!e){null==r||r.fail("Dispute not found");throw(0,error_1.createError)({statusCode:404,message:"Dispute not found"})}null==r||r.step("Adding note to activity log");let t=e.activityLog;Array.isArray(t)||(t=[]);const a=s.firstName&&s.lastName?`${s.firstName} ${s.lastName}`:s.email||"Admin";t.push({type:"note",content:d,createdAt:(new Date).toISOString(),adminId:s.id,adminName:a});null==r||r.step("Updating dispute");await e.update({activityLog:t});await e.reload();const o=e.get({plain:!0}),n=(Array.isArray(o.activityLog)?o.activityLog:[]).filter(e=>"note"===e.type).map(e=>({content:e.content||e.note,createdAt:e.createdAt,createdBy:e.adminName||"Admin",adminId:e.adminId})),m=Array.isArray(o.messages)?o.messages.map(e=>({id:e.id||`${e.createdAt}-${e.sender}`,sender:e.senderName||e.sender||"Unknown",senderId:e.sender,content:e.content||e.message||"",timestamp:e.createdAt||e.timestamp,isAdmin:e.isAdmin||!1,avatar:e.avatar,senderInitials:e.senderName?e.senderName.split(" ").map(e=>e[0]).join("").toUpperCase():"?"})):[],p=Array.isArray(o.evidence)?o.evidence.map(e=>({...e,submittedBy:e.submittedBy||"admin",timestamp:e.createdAt||e.timestamp})):[];null==r||r.success("Note added successfully");return{...o,messages:m,adminNotes:n,evidence:p}}catch(e){if(e.statusCode)throw e;null==r||r.fail("Failed to add note");throw(0,error_1.createError)({statusCode:500,message:"Internal Server Error: "+e.message})}};