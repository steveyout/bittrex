"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),errors_1=require("@b/utils/schema/errors");exports.metadata={summary:"Add evidence to P2P dispute",description:"Uploads and attaches evidence files (images only) to a P2P dispute. Evidence is stored with admin information and timestamps for audit trail.",operationId:"addEvidenceToAdminP2PDispute",tags:["Admin","P2P","Dispute"],requiresAuth:!0,logModule:"ADMIN_P2P",logTitle:"Add evidence to dispute",parameters:[{index:0,name:"id",in:"path",description:"Dispute ID",required:!0,schema:{type:"string"}}],requestBody:{description:"Evidence data",required:!0,content:{"application/json":{schema:{type:"object",properties:{fileUrl:{type:"string"},fileName:{type:"string"},fileType:{type:"string"},title:{type:"string"},description:{type:"string"}},required:["fileUrl","fileName"]}}}},responses:{200:{description:"Evidence added successfully."},401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("Resource"),500:errors_1.serverErrorResponse},permission:"edit.p2p.dispute"};exports.default=async e=>{const{params:t,body:i,user:s,ctx:a}=e,{id:r}=t,{fileUrl:d,fileName:n,fileType:o,title:l,description:m}=i;try{null==a||a.step("Fetching dispute");const e=await db_1.models.p2pDispute.findByPk(r,{include:[{model:db_1.models.p2pTrade,as:"trade",include:[{model:db_1.models.p2pOffer,as:"offer",attributes:["id","type","currency","walletType"]},{model:db_1.models.user,as:"buyer",attributes:["id","firstName","lastName","email","avatar"]},{model:db_1.models.user,as:"seller",attributes:["id","firstName","lastName","email","avatar"]}]},{model:db_1.models.user,as:"reportedBy",attributes:["id","firstName","lastName","email","avatar"]},{model:db_1.models.user,as:"against",attributes:["id","firstName","lastName","email","avatar"]}]});if(!e){null==a||a.fail("Dispute not found");throw(0,error_1.createError)({statusCode:404,message:"Dispute not found"})}null==a||a.step("Validating file type");if(o&&!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(o.toLowerCase())){null==a||a.fail("Invalid file type");throw(0,error_1.createError)({statusCode:400,message:"Only image files are allowed (JPEG, PNG, GIF, WebP)"})}null==a||a.step("Adding evidence");let t=e.evidence;if("string"==typeof t)try{t=JSON.parse(t)}catch(e){t=[]}Array.isArray(t)||(t=[]);const i=s.firstName&&s.lastName?`${s.firstName} ${s.lastName}`:s.email||"Admin";t.push({fileUrl:d,fileName:n,fileType:o,title:l||n,description:m||"",submittedBy:"admin",adminId:s.id,adminName:i,createdAt:(new Date).toISOString()});null==a||a.step("Saving dispute");e.evidence=t;await e.save();const p=e.get({plain:!0}),u=Array.isArray(p.messages)?p.messages.map(e=>({id:e.id||`${e.createdAt}-${e.sender}`,sender:e.senderName||e.sender||"Unknown",senderId:e.sender,content:e.content||e.message||"",timestamp:e.createdAt||e.timestamp,isAdmin:e.isAdmin||!1,avatar:e.avatar,senderInitials:e.senderName?e.senderName.split(" ").map(e=>e[0]).join("").toUpperCase():"?"})):[],c=(Array.isArray(p.activityLog)?p.activityLog:[]).filter(e=>"note"===e.type).map(e=>({content:e.content||e.note,createdAt:e.createdAt,createdBy:e.adminName||"Admin",adminId:e.adminId})),y=Array.isArray(p.evidence)?p.evidence.map(e=>({...e,submittedBy:e.submittedBy||"admin",timestamp:e.createdAt||e.timestamp})):[];null==a||a.success("Evidence added successfully");return{...p,messages:u,adminNotes:c,evidence:y}}catch(e){if(e.statusCode)throw e;null==a||a.fail("Failed to add evidence");throw(0,error_1.createError)({statusCode:500,message:"Internal Server Error: "+e.message})}};