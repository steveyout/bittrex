"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),notifications_1=require("@b/utils/notifications");exports.metadata={summary:"Update Staking Pool",description:"Updates an existing staking pool with the provided details.",operationId:"updateStakingPool",tags:["Staking","Admin","Pools"],requiresAuth:!0,logModule:"ADMIN_STAKE",logTitle:"Update Staking Pool",parameters:[{index:0,name:"id",in:"path",required:!0,schema:{type:"string"},description:"Pool ID"}],requestBody:{description:"Updated staking pool data",required:!0,content:{"application/json":{schema:{type:"object",properties:{name:{type:"string"},token:{type:"string"},symbol:{type:"string"},icon:{type:"string"},description:{type:"string"},apr:{type:"number"},lockPeriod:{type:"number"},minStake:{type:"number"},maxStake:{type:"number",nullable:!0},totalStaked:{type:"number"},availableToStake:{type:"number"},earlyWithdrawalFee:{type:"number"},adminFeePercentage:{type:"number"},status:{type:"string",enum:["ACTIVE","INACTIVE","COMING_SOON"]},isPromoted:{type:"boolean"},order:{type:"number"},earningFrequency:{type:"string",enum:["DAILY","WEEKLY","MONTHLY","END_OF_TERM"]},autoCompound:{type:"boolean"},externalPoolUrl:{type:"string"},profitSource:{type:"string"},fundAllocation:{type:"string"},risks:{type:"string"},rewards:{type:"string"}}}}}},responses:{200:{description:"Pool updated successfully",content:{"application/json":{schema:{type:"object"}}}},400:{description:"Bad Request"},401:{description:"Unauthorized"},404:{description:"Pool not found"},500:{description:"Internal Server Error"}},permission:"edit.staking.pool"};exports.default=async e=>{const{user:t,params:o,body:r,ctx:i}=e;if(!(null==t?void 0:t.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});const a=o.id;if(!a)throw(0,error_1.createError)({statusCode:400,message:"Pool ID is required"});if(!r)throw(0,error_1.createError)({statusCode:400,message:"Request body is required"});try{null==i||i.step("Find pool to update");const e=await db_1.models.stakingPool.findOne({where:{id:a}});if(!e)throw(0,error_1.createError)({statusCode:404,message:"Pool not found"});null==i||i.step("Update pool");await e.update(r);null==i||i.step("Reload pool with associations");const o=await db_1.models.stakingPool.findOne({where:{id:a},include:[{model:db_1.models.stakingPosition,as:"positions",required:!1},{model:db_1.models.stakingAdminEarning,as:"adminEarnings",required:!1},{model:db_1.models.stakingExternalPoolPerformance,as:"performances",required:!1}]});try{await(0,notifications_1.createNotification)({userId:t.id,relatedId:e.id,type:"system",title:"Staking Pool Updated",message:`Staking pool "${e.name}" has been updated successfully.`,details:"The changes are now reflected in the admin dashboard.",link:`/admin/staking/pools/${e.id}`,actions:[{label:"View Pool",link:`/admin/staking/pools/${e.id}`,primary:!0}]},i)}catch(e){console.error("Failed to create notification for pool update",e)}null==i||i.success("Staking pool updated successfully");return o}catch(e){if(404===e.statusCode)throw e;console.error(`Error updating staking pool ${a}:`,e);if("SequelizeValidationError"===e.name){const t={};e.errors.forEach(e=>{t[e.path]=e.message});const o=(0,error_1.createError)({statusCode:400,message:"Validation failed. Please check the required fields."});o.validationErrors=t;throw o}if("SequelizeUniqueConstraintError"===e.name)throw(0,error_1.createError)({statusCode:400,message:"A pool with this name or symbol already exists"});throw(0,error_1.createError)({statusCode:500,message:e.message||"Failed to update staking pool"})}};