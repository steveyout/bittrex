"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),sequelize_1=require("sequelize");exports.metadata={summary:"Get detailed pool performance data for admin",operationId:"getAdminPoolPerformance",tags:["Admin","Staking","Pool","Performance"],parameters:[{name:"id",in:"path",required:!0,description:"Pool ID",schema:{type:"string",format:"uuid"}},{name:"timeframe",in:"query",required:!1,description:"Timeframe for performance data",schema:{type:"string",enum:["24h","7d","30d","90d","all"],default:"30d"}}],responses:{200:{description:"Pool performance data retrieved successfully",content:{"application/json":{schema:{type:"object",properties:{pool:{type:"object",properties:{id:{type:"string"},name:{type:"string"},symbol:{type:"string"},apr:{type:"number"},status:{type:"string"},createdAt:{type:"string"}}},metrics:{type:"object",properties:{totalValueLocked:{type:"number"},activePositions:{type:"integer"},totalPositions:{type:"integer"},uniqueUsers:{type:"integer"},totalRewardsDistributed:{type:"number"},platformFeesCollected:{type:"number"},averagePositionSize:{type:"number"},averageStakingDuration:{type:"number"},utilizationRate:{type:"number"}}},userMetrics:{type:"object",properties:{newUsers:{type:"integer"},returningUsers:{type:"integer"},userRetentionRate:{type:"number"},topUsers:{type:"array",items:{type:"object",properties:{userId:{type:"string"},totalStaked:{type:"number"},totalEarned:{type:"number"},positionCount:{type:"integer"}}}}}},financialMetrics:{type:"object",properties:{totalInflow:{type:"number"},totalOutflow:{type:"number"},netFlow:{type:"number"},rewardsDistributionRate:{type:"number"},effectiveAPY:{type:"number"}}},historicalData:{type:"object",properties:{tvlHistory:{type:"array",items:{type:"object",properties:{date:{type:"string"},value:{type:"number"}}}},positionHistory:{type:"array",items:{type:"object",properties:{date:{type:"string"},new:{type:"integer"},completed:{type:"integer"},active:{type:"integer"}}}},rewardsHistory:{type:"array",items:{type:"object",properties:{date:{type:"string"},distributed:{type:"number"},claimed:{type:"number"}}}}}}}}}}},401:{description:"Unauthorized"},403:{description:"Forbidden - Admin access required"},404:{description:"Pool not found"},500:{description:"Internal Server Error"}},requiresAuth:!0,logModule:"ADMIN_STAKE",logTitle:"Get Pool Performance",permission:"access.staking.management"};exports.default=async e=>{const{user:t,params:o,query:a,ctx:i}=e;if(!(null==t?void 0:t.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});const{id:r}=o,{timeframe:s="30d"}=a;try{null==i||i.step("Fetching data");const e=await db_1.models.stakingPool.findByPk(r);if(!e)throw(0,error_1.createError)({statusCode:404,message:"Staking pool not found"});const t=new Date;let o=new Date;switch(s){case"24h":o.setHours(t.getHours()-24);break;case"7d":o.setDate(t.getDate()-7);break;case"30d":o.setDate(t.getDate()-30);break;case"90d":o.setDate(t.getDate()-90);break;case"all":o=new Date(e.createdAt)}const a=await db_1.models.stakingPosition.findOne({where:{poolId:r,status:"ACTIVE"},attributes:[[(0,sequelize_1.fn)("SUM",(0,sequelize_1.col)("amount")),"totalLocked"]],raw:!0}),n=parseFloat((null==a?void 0:a.totalLocked)||"0"),l=await db_1.models.stakingPosition.count({where:{poolId:r,status:"ACTIVE"}}),d=await db_1.models.stakingPosition.count({where:{poolId:r}}),u=await db_1.models.stakingPosition.count({where:{poolId:r},distinct:!0,col:"userId"}),p=await db_1.models.stakingEarningRecord.findOne({include:[{model:db_1.models.stakingPosition,as:"position",where:{poolId:r},attributes:[]}],where:"all"!==s?{createdAt:{[sequelize_1.Op.gte]:o}}:{},attributes:[[(0,sequelize_1.fn)("SUM",(0,sequelize_1.col)("amount")),"totalRewards"]],raw:!0}),c=parseFloat((null==p?void 0:p.totalRewards)||"0"),m=await db_1.models.stakingAdminEarning.findOne({where:{poolId:r,..."all"!==s?{createdAt:{[sequelize_1.Op.gte]:o}}:{}},attributes:[[(0,sequelize_1.fn)("SUM",(0,sequelize_1.col)("amount")),"totalFees"]],raw:!0}),g=parseFloat((null==m?void 0:m.totalFees)||"0"),b=await db_1.models.stakingPosition.findOne({where:{poolId:r,status:"ACTIVE"},attributes:[[(0,sequelize_1.fn)("AVG",(0,sequelize_1.col)("amount")),"avgSize"]],raw:!0}),w=parseFloat((null==b?void 0:b.avgSize)||"0"),y=await db_1.models.stakingPosition.findAll({where:{poolId:r,status:["COMPLETED","ACTIVE"]},attributes:["startDate","endDate","completedAt"],raw:!0});let f=0;y.forEach(e=>{const t=new Date(e.startDate),o=e.completedAt?new Date(e.completedAt):new Date(e.endDate);f+=(o.getTime()-t.getTime())/864e5});const _=y.length>0?f/y.length:0,h=e.maxCapacity>0?n/e.maxCapacity*100:0,q=await db_1.models.stakingPosition.count({where:{poolId:r,createdAt:{[sequelize_1.Op.gte]:o}},distinct:!0,col:"userId"}),z=(await db_1.models.stakingPosition.findAll({where:{poolId:r},attributes:["userId",[(0,sequelize_1.fn)("COUNT",(0,sequelize_1.col)("id")),"positionCount"]],group:["userId"],having:(0,sequelize_1.literal)("COUNT(id) > 1"),raw:!0})).length,I=u>0?z/u*100:0,P=await db_1.models.stakingPosition.findAll({where:{poolId:r},attributes:["userId",[(0,sequelize_1.fn)("SUM",(0,sequelize_1.col)("amount")),"totalStaked"],[(0,sequelize_1.fn)("COUNT",(0,sequelize_1.col)("id")),"positionCount"]],group:["userId"],order:[[(0,sequelize_1.fn)("SUM",(0,sequelize_1.col)("amount")),"DESC"]],limit:10,raw:!0}),k=await Promise.all(P.map(async e=>{const t=await db_1.models.stakingEarningRecord.findOne({include:[{model:db_1.models.stakingPosition,as:"position",where:{poolId:r,userId:e.userId},attributes:[]}],attributes:[[(0,sequelize_1.fn)("SUM",(0,sequelize_1.col)("amount")),"totalEarned"]],raw:!0});return{userId:e.userId,totalStaked:parseFloat(e.totalStaked),totalEarned:parseFloat((null==t?void 0:t.totalEarned)||"0"),positionCount:parseInt(e.positionCount)}})),D=await db_1.models.stakingPosition.findOne({where:{poolId:r,createdAt:{[sequelize_1.Op.gte]:o}},attributes:[[(0,sequelize_1.fn)("SUM",(0,sequelize_1.col)("amount")),"totalInflow"]],raw:!0}),v=parseFloat((null==D?void 0:D.totalInflow)||"0"),A=await db_1.models.stakingPosition.findOne({where:{poolId:r,status:"COMPLETED",completedAt:{[sequelize_1.Op.gte]:o}},attributes:[[(0,sequelize_1.fn)("SUM",(0,sequelize_1.col)("amount")),"totalOutflow"]],raw:!0}),M=await db_1.models.stakingEarningRecord.findOne({include:[{model:db_1.models.stakingPosition,as:"position",where:{poolId:r},attributes:[]}],where:{isClaimed:!0,claimedAt:{[sequelize_1.Op.gte]:o}},attributes:[[(0,sequelize_1.fn)("SUM",(0,sequelize_1.col)("amount")),"totalClaimed"]],raw:!0}),C=parseFloat((null==A?void 0:A.totalOutflow)||"0")+parseFloat((null==M?void 0:M.totalClaimed)||"0"),S=v-C,O=n>0&&c>0?c/n*100:0,E=365,U=e.apr>0?100*(Math.pow(1+e.apr/100/E,E)-1):0,F="24h"===s?1:"7d"===s?7:"30d"===s?30:90,R=[],T=[],j=[];for(let e=F-1;e>=0;e--){const t=new Date;t.setDate(t.getDate()-e);const o=t.toISOString().split("T")[0];R.push({date:o,value:n*(1-.01*e)});T.push({date:o,new:Math.floor(10*Math.random()),completed:Math.floor(5*Math.random()),active:l-Math.floor(20*Math.random())});j.push({date:o,distributed:c/F,claimed:c/F*.8})}null==i||i.success("Pool performance data retrieved successfully");return{pool:{id:e.id,name:e.name,symbol:e.symbol,apr:e.apr,status:e.status,createdAt:e.createdAt},metrics:{totalValueLocked:n,activePositions:l,totalPositions:d,uniqueUsers:u,totalRewardsDistributed:c,platformFeesCollected:g,averagePositionSize:w,averageStakingDuration:Math.round(_),utilizationRate:Math.round(100*h)/100},userMetrics:{newUsers:q,returningUsers:z,userRetentionRate:Math.round(100*I)/100,topUsers:k},financialMetrics:{totalInflow:v,totalOutflow:C,netFlow:S,rewardsDistributionRate:Math.round(100*O)/100,effectiveAPY:Math.round(100*U)/100},historicalData:{tvlHistory:R,positionHistory:T,rewardsHistory:j}}}catch(e){if(404===e.statusCode)throw e;throw(0,error_1.createError)({statusCode:500,message:e.message||"Failed to fetch pool performance data"})}};