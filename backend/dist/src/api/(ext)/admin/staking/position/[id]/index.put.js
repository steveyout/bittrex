"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),notifications_1=require("@b/utils/notifications"),sequelize_1=require("sequelize");exports.metadata={summary:"Update Staking Position",description:"Updates an existing staking position with the provided details.",operationId:"updateStakingPosition",tags:["Staking","Admin","Positions"],requiresAuth:!0,logModule:"ADMIN_STAKE",logTitle:"Update Staking Position",parameters:[{index:0,name:"id",in:"path",required:!0,schema:{type:"string"},description:"Position ID"}],requestBody:{description:"Updated staking position data",required:!0,content:{"application/json":{schema:{type:"object",properties:{amount:{type:"number"},startDate:{type:"string",format:"date-time"},endDate:{type:"string",format:"date-time"},status:{type:"string",enum:["ACTIVE","COMPLETED","CANCELLED","PENDING_WITHDRAWAL"]},withdrawalRequested:{type:"boolean"},withdrawalRequestDate:{type:"string",format:"date-time",nullable:!0},adminNotes:{type:"string",nullable:!0},completedAt:{type:"string",format:"date-time",nullable:!0}}}}}},responses:{200:{description:"Position updated successfully",content:{"application/json":{schema:{type:"object"}}}},400:{description:"Bad Request"},401:{description:"Unauthorized"},404:{description:"Position not found"},500:{description:"Internal Server Error"}},permission:"edit.staking.position"};exports.default=async e=>{var t,i,o,a;const{user:s,params:n,body:r,ctx:d}=e;if(!(null==s?void 0:s.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});const l=n.id;if(!l)throw(0,error_1.createError)({statusCode:400,message:"Position ID is required"});if(!r)throw(0,error_1.createError)({statusCode:400,message:"Request body is required"});try{null==d||d.step("Find position to update");const e=await db_1.models.stakingPosition.findOne({where:{id:l},include:[{model:db_1.models.stakingPool,as:"pool"}]});if(!e)throw(0,error_1.createError)({statusCode:404,message:"Position not found"});const s="COMPLETED"!==e.status&&"COMPLETED"===r.status;null==d||d.step("Update position");await e.update({...r,completedAt:s&&!r.completedAt?new Date:r.completedAt});null==d||d.step("Reload position with associations");const n=await db_1.models.stakingPosition.findOne({where:{id:l},include:[{model:db_1.models.stakingPool,as:"pool"},{model:db_1.models.stakingEarningRecord,as:"earningHistory",required:!1}]});null==d||d.step("Calculate additional properties");const u=await db_1.models.stakingEarningRecord.findOne({attributes:[[(0,sequelize_1.fn)("SUM",(0,sequelize_1.col)("amount")),"pendingRewards"]],where:{positionId:e.id,isClaimed:!1},raw:!0}),p=(null==u?void 0:u.pendingRewards)||0,c=await db_1.models.stakingEarningRecord.findOne({attributes:[[(0,sequelize_1.fn)("SUM",(0,sequelize_1.col)("amount")),"earningsToDate"]],where:{positionId:e.id},raw:!0}),m=(null==c?void 0:c.earningsToDate)||0,g=await db_1.models.stakingEarningRecord.findOne({attributes:["createdAt"],where:{positionId:e.id},order:[["createdAt","DESC"]],raw:!0}),w=(null==g?void 0:g.createdAt)||null;try{const t=e.userId;let i,o,a;if(s){i="Staking Position Completed";o=`Your staking position in ${e.pool.name} has been completed.`;a="Your staked amount and earnings are now available for withdrawal."}else if("CANCELLED"===r.status){i="Staking Position Cancelled";o=`Your staking position in ${e.pool.name} has been cancelled.`;a="Please contact support if you have any questions."}else if(r.withdrawalRequested&&!e.withdrawalRequested){i="Withdrawal Request Received";o=`Your withdrawal request for ${e.pool.name} has been received.`;a="We are processing your request and will update you soon."}else{i="Staking Position Updated";o=`Your staking position in ${e.pool.name} has been updated.`;a="Check your dashboard for the latest information."}await(0,notifications_1.createNotification)({userId:t,relatedId:e.id,type:"system",title:i,message:o,details:a,link:`/staking/positions/${e.id}`,actions:[{label:"View Position",link:`/staking/positions/${e.id}`,primary:!0}]},d)}catch(e){console.error("Failed to create notification for position update",e)}null==d||d.success("Staking position updated successfully");return{...n.toJSON(),pendingRewards:p,earningsToDate:m,lastEarningDate:w,rewardTokenSymbol:null===(t=n.pool)||void 0===t?void 0:t.symbol,tokenSymbol:null===(i=n.pool)||void 0===i?void 0:i.symbol,poolName:null===(o=n.pool)||void 0===o?void 0:o.name,lockPeriodEnd:n.endDate,apr:null===(a=n.pool)||void 0===a?void 0:a.apr}}catch(e){if(404===e.statusCode)throw e;console.error(`Error updating staking position ${l}:`,e);throw(0,error_1.createError)({statusCode:500,message:e.message})}};