"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),notifications_1=require("@b/utils/notifications"),errors_1=require("@b/utils/schema/errors");exports.metadata={summary:"Claim Admin Earning",operationId:"claimAdminEarning",description:"Marks an admin earning record as claimed. This updates the isClaimed flag to true, indicating that the platform has processed and claimed this earning. Once claimed, the earning cannot be claimed again.",tags:["Admin","Staking","Earnings"],requiresAuth:!0,logModule:"ADMIN_STAKE",logTitle:"Claim Admin Earning",parameters:[{index:0,name:"id",in:"path",required:!0,schema:{type:"string",format:"uuid"},description:"Admin earning record ID"}],responses:{200:(0,errors_1.successMessageResponse)("Admin earning claimed successfully"),400:errors_1.badRequestResponse,401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("Admin Earning"),500:errors_1.serverErrorResponse},permission:"edit.staking.earning"};exports.default=async e=>{const{user:r,params:i,ctx:a}=e;if(!(null==r?void 0:r.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});const n=i.id;if(!n)throw(0,error_1.createError)({statusCode:400,message:"Earning ID is required"});try{null==a||a.step("Find earning to claim");const e=await db_1.models.stakingAdminEarning.findOne({where:{id:n},include:[{model:db_1.models.stakingPool,as:"pool"}]});if(!e)throw(0,error_1.createError)({statusCode:404,message:"Earning not found"});if(e.isClaimed){null==a||a.success("Earning already claimed");return{message:"Earning already claimed"}}null==a||a.step("Mark earning as claimed");await e.update({isClaimed:!0});try{await(0,notifications_1.createNotification)({userId:r.id,relatedId:e.id,type:"system",title:"Admin Earning Claimed",message:`Admin earning of ${e.amount} ${e.currency} for ${e.pool.name} has been claimed.`,details:"The earning has been marked as claimed.",link:"/admin/staking/earnings",actions:[{label:"View Earnings",link:"/admin/staking/earnings",primary:!0}]},a)}catch(e){console.error("Failed to create notification for claiming admin earning",e)}null==a||a.success("Earning claimed successfully");return{message:"Earning claimed successfully"}}catch(e){if(404===e.statusCode)throw e;console.error(`Error claiming admin earning ${n}:`,e);throw(0,error_1.createError)({statusCode:500,message:e.message})}};