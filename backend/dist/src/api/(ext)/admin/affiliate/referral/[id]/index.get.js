"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),utils_1=require("@b/api/(ext)/affiliate/utils"),sequelize_1=require("sequelize"),errors_1=require("@b/utils/schema/errors");exports.metadata={summary:"Gets detailed affiliate referral information",description:"Retrieves comprehensive information about a specific affiliate referral, including referrer profile, network structure, rewards history, and earnings. The network structure varies based on MLM system (DIRECT/BINARY/UNILEVEL).",operationId:"getAffiliateReferralDetail",tags:["Admin","Affiliate","Referral"],requiresAuth:!0,permission:"view.affiliate.referral",demoMask:["affiliate.email","affiliate.phone","network.email"],parameters:[{name:"id",in:"path",required:!0,schema:{type:"string",format:"uuid"},description:"The affiliate referral ID"}],responses:{200:{description:"Affiliate referral details retrieved successfully",content:{"application/json":{schema:{type:"object",properties:{affiliate:{type:"object",description:"Referrer user information and metrics"},network:{type:"array",description:"Network of referred users"},rewards:{type:"array",description:"Reward history"},monthlyEarnings:{type:"array",description:"Last 6 months earnings"}}}}}},401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("Affiliate Referral"),500:errors_1.serverErrorResponse},logModule:"ADMIN_AFFILIATE",logTitle:"Get affiliate referral details"};exports.default=async e=>{var r,t,a;const{user:i,params:s,ctx:l}=e;if(!(null==i?void 0:i.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized: Admin privileges required."});const d=s.id;null==l||l.step(`Loading referral record with ID: ${d}`);const n=await db_1.models.mlmReferral.findOne({where:{id:d},include:[{model:db_1.models.user,as:"referrer",attributes:["id","firstName","lastName","email","phone","status"]}],raw:!1});if(!(null==n?void 0:n.referrer))throw(0,error_1.createError)({statusCode:404,message:"Referral record not found."});const o=n.referrer,f=o.id;null==l||l.step("Building affiliate profile");const m={id:f,name:`${o.firstName||""} ${o.lastName||""}`.trim(),email:o.email||"",phone:o.phone||null,location:null,status:null===(r=o.status)||void 0===r?void 0:r.toLowerCase(),joinDate:n.createdAt.toISOString(),referralCode:n.id};null==l||l.step("Calculating summary metrics");const u=await db_1.models.mlmReferral.count({where:{referrerId:f}}),c=await db_1.models.mlmReferralReward.findOne({attributes:[[(0,sequelize_1.fn)("SUM",(0,sequelize_1.col)("reward")),"totalEarnings"]],where:{referrerId:f},raw:!0}),p=parseFloat(c.totalEarnings)||0,w=await db_1.models.mlmReferralReward.count({where:{referrerId:f}}),h=u?Math.round(w/u*100):0;Object.assign(m,{referrals:u,earnings:p,conversionRate:h});null==l||l.step("Determining MLM system");const{mlmSystem:g}=await(0,utils_1.getMlmSystemAndSettings)();null==l||l.step(`Building network structure for ${g} system`);let I=[];if("UNILEVEL"===g){const e=await db_1.models.mlmUnilevelNode.findOne({where:{referralId:d}});if(e){const r=await db_1.models.mlmUnilevelNode.findAll({raw:!0}),a={};r.forEach(e=>{a[e.parentId]=a[e.parentId]||[];e.parentId&&a[e.parentId].push(e)});const i=[{node:e,level:1}];for(;i.length;){const{node:e,level:r}=i.shift();for(const s of a[e.id]||[]){i.push({node:s,level:r+1});const e=await db_1.models.mlmReferral.findOne({where:{id:s.referralId},include:[{model:db_1.models.user,as:"referred",attributes:["id","firstName","lastName","email","status","createdAt"]}],raw:!1});(null==e?void 0:e.referred)&&I.push({nodeId:s.id,referralId:s.referralId,id:e.referred.id,name:`${e.referred.firstName} ${e.referred.lastName}`.trim(),email:e.referred.email,level:r,status:null===(t=e.referred.status)||void 0===t?void 0:t.toLowerCase(),earnings:0,referrals:0,joinDate:e.referred.createdAt.toISOString()})}}}}else if("BINARY"===g){const e=await db_1.models.mlmBinaryNode.findOne({where:{referralId:d}});if(e){const r=[{node:e,level:1}];for(;r.length;){const{node:e,level:t}=r.shift();for(const i of["leftChildId","rightChildId"]){const s=e[i];if(s){const e=await db_1.models.mlmBinaryNode.findByPk(s,{raw:!0});if(e){r.push({node:e,level:t+1});const i=await db_1.models.mlmReferral.findOne({where:{id:e.referralId},include:[{model:db_1.models.user,as:"referred",attributes:["id","firstName","lastName","email","status","createdAt"]}],raw:!1});(null==i?void 0:i.referred)&&I.push({nodeId:e.id,referralId:e.referralId,id:i.referred.id,name:`${i.referred.firstName} ${i.referred.lastName}`.trim(),email:i.referred.email,level:t,status:null===(a=i.referred.status)||void 0===a?void 0:a.toLowerCase(),earnings:0,referrals:0,joinDate:i.referred.createdAt.toISOString()})}}}}}}else{I=(await db_1.models.mlmReferral.findAll({where:{referrerId:f},include:[{model:db_1.models.user,as:"referred",attributes:["id","firstName","lastName","email","status","createdAt"]}],raw:!1})).map(e=>{var r;return{nodeId:null,referralId:e.id,id:e.referred.id,name:`${e.referred.firstName} ${e.referred.lastName}`.trim(),email:e.referred.email,level:1,status:null===(r=e.referred.status)||void 0===r?void 0:r.toLowerCase(),earnings:0,referrals:0,joinDate:e.createdAt.toISOString()}})}null==l||l.step("Enriching network with metrics");if(I.length){const[e,r]=await Promise.all([db_1.models.mlmReferral.findAll({attributes:["referrerId",[(0,sequelize_1.fn)("COUNT",(0,sequelize_1.literal)("*")),"cnt"]],group:["referrerId"],raw:!0}),db_1.models.mlmReferralReward.findAll({attributes:["referrerId",[(0,sequelize_1.fn)("SUM",(0,sequelize_1.col)("reward")),"sum"]],group:["referrerId"],raw:!0})]),t=Object.fromEntries(e.map(e=>[e.referrerId,parseInt(e.cnt,10)])),a=Object.fromEntries(r.map(e=>[e.referrerId,parseFloat(e.sum)]));I=I.map(e=>({...e,referrals:t[e.id]||0,earnings:a[e.id]||0}))}null==l||l.step("Fetching reward history");const _=(await db_1.models.mlmReferralReward.findAll({where:{referrerId:f},include:[{model:db_1.models.mlmReferralCondition,as:"condition",attributes:["name"]}],order:[["createdAt","DESC"]],raw:!1})).map(e=>{var r;return{id:e.id,date:e.createdAt.toISOString(),type:(null===(r=e.condition)||void 0===r?void 0:r.name)||"",description:e.description||"",status:e.isClaimed?"paid":"pending",amount:e.reward}});null==l||l.step("Calculating monthly earnings");const b=[];for(let e=5;e>=0;e--){const r=new Date;r.setMonth(r.getMonth()-e,1);b.push(`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}`)}const v=await db_1.models.mlmReferralReward.findAll({attributes:[[(0,sequelize_1.fn)("DATE_FORMAT",(0,sequelize_1.col)("createdAt"),"%Y-%m"),"month"],[(0,sequelize_1.fn)("SUM",(0,sequelize_1.col)("reward")),"amount"]],where:{referrerId:f,createdAt:{[sequelize_1.Op.gte]:new Date((new Date).setMonth((new Date).getMonth()-5,1))}},group:["month"],raw:!0}),A={};v.forEach(e=>{A[e.month]=parseFloat(e.amount)});const R=b.map(e=>({month:e,earnings:A[e]||0}));null==l||l.success("Affiliate details retrieved successfully");return{affiliate:m,network:I,rewards:_,monthlyEarnings:R}};