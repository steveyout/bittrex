"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const query_1=require("@b/utils/query"),utils_1=require("../utils"),db_1=require("@b/db"),utils_2=require("@b/api/(ext)/affiliate/utils"),affiliate_1=require("@b/utils/affiliate"),errors_1=require("@b/utils/schema/errors"),error_1=require("@b/utils/error");exports.metadata={summary:"Updates a specific affiliate referral",description:"Updates an existing affiliate referral record. When referrer or referred user changes, the MLM node structure (binary/unilevel) is automatically rebuilt to maintain network integrity.",operationId:"updateAffiliateReferral",tags:["Admin","Affiliate","Referral"],parameters:[{name:"id",in:"path",description:"ID of the affiliate referral to update",required:!0,schema:{type:"string",format:"uuid"}}],requestBody:{description:"New data for the affiliate referral",content:{"application/json":{schema:utils_1.mlmReferralUpdateSchema}}},responses:{200:{description:"Affiliate referral updated successfully",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string",description:"Success message"}}}}}},400:errors_1.badRequestResponse,401:errors_1.unauthorizedResponse,404:(0,errors_1.notFoundResponse)("Affiliate Referral"),500:errors_1.serverErrorResponse},requiresAuth:!0,permission:"edit.affiliate.referral",logModule:"ADMIN_AFFILIATE",logTitle:"Update affiliate referral"};exports.default=async e=>{const{body:r,params:t,ctx:a}=e,{id:s}=t,{status:i,referrerId:l,referredId:d}=r;null==a||a.step("Validating referral update data");if(l===d)throw(0,error_1.createError)({statusCode:400,message:"Referrer and referred user cannot be the same"});null==a||a.step("Verifying users exist");if(!await db_1.models.user.findOne({where:{id:l}}))throw(0,error_1.createError)({statusCode:404,message:"Referrer not found"});if(!await db_1.models.user.findOne({where:{id:d}}))throw(0,error_1.createError)({statusCode:404,message:"Referred user not found"});null==a||a.step("Fetching existing referral record");const o=await db_1.models.mlmReferral.findOne({where:{id:s}});if(!o)throw(0,error_1.createError)({statusCode:404,message:"Referral record not found"});null==a||a.step("Loading MLM system settings");const{mlmSystem:n}=await(0,utils_2.getMlmSystemAndSettings)();if("DIRECT"!==n&&(o.referrerId!==l||o.referredId!==d))if("BINARY"===n){null==a||a.step("Updating binary node structure");await db_1.models.mlmBinaryNode.destroy({where:{referralId:s}});await(0,affiliate_1.handleBinaryMlmReferralRegister)(l,{id:s,referredId:d},db_1.models.mlmBinaryNode)}else if("UNILEVEL"===n){null==a||a.step("Updating unilevel node structure");await db_1.models.mlmUnilevelNode.destroy({where:{referralId:s}});await(0,affiliate_1.handleUnilevelMlmReferralRegister)(l,{id:s,referredId:d},db_1.models.mlmUnilevelNode)}null==a||a.step("Updating referral record");const f=await(0,query_1.updateRecord)("mlmReferral",s,{status:i,referrerId:l,referredId:d});null==a||a.success("Referral updated successfully");return f};