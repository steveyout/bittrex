"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const query_1=require("@b/utils/query"),db_1=require("@b/db"),utils_1=require("@b/api/finance/transaction/utils"),emails_1=require("@b/utils/emails"),error_1=require("@b/utils/error"),utils_2=require("../../utils");exports.metadata={summary:"Updates a Forex deposit",operationId:"updateForexDeposit",tags:["Admin","Forex","Deposit"],parameters:[{index:0,name:"id",in:"path",description:"The ID of the transaction to update",required:!0,schema:{type:"string"}}],requestBody:{required:!0,description:"Updated data for the transaction",content:{"application/json":{schema:utils_1.transactionUpdateSchema}}},responses:(0,query_1.updateRecordResponses)("Transaction"),requiresAuth:!0,permission:"edit.forex.deposit",logModule:"ADMIN_FOREX",logTitle:"Update forex deposit"};exports.default=async e=>{const{body:t,params:a,ctx:s}=e,{id:r}=a,{status:i,amount:n,fee:o,description:d,referenceId:u,metadata:c}=t;null==s||s.step(`Validating forex deposit ${r}`);const l=await db_1.models.transaction.findOne({where:{id:r}});if(!l)throw(0,error_1.createError)({statusCode:404,message:"Transaction not found"});if("PENDING"!==l.status)throw(0,error_1.createError)({statusCode:400,message:"Only pending transactions can be updated"});null==s||s.step("Updating transaction fields");l.amount=n;l.fee=o;l.description=d;l.referenceId=u;null==s||s.step("Processing deposit status update");return await db_1.sequelize.transaction(async e=>{const t=(0,utils_2.parseMetadata)(l.metadata),a=Number(l.amount)*Number(t.price);if("PENDING"===l.status){const t=await db_1.models.forexAccount.findOne({where:{userId:l.userId,type:"LIVE"},transaction:e});if(!t)throw(0,error_1.createError)({statusCode:404,message:"Forex account not found"});const r=await db_1.models.wallet.findOne({where:{id:l.walletId},transaction:e});if(!r)throw(0,error_1.createError)({statusCode:404,message:"Wallet not found"});if("REJECTED"===i){null==s||s.step("Refunding to wallet");await(0,utils_2.updateWalletBalance)(r,a,!0,e,s)}else if("COMPLETED"===i){null==s||s.step("Updating forex account balance");await(0,utils_2.updateForexAccountBalance)(t,a,!0,e,s)}null==s||s.step("Sending notification email");const n=await db_1.models.user.findOne({where:{id:l.userId}});n&&await(0,emails_1.sendForexTransactionEmail)(n,l,t,r.currency,l.type,s)}c&&(t.message=c.message);l.metadata=JSON.stringify(t);l.status=i;null==s||s.step("Saving transaction");await l.save({transaction:e});null==s||s.success("Forex deposit updated successfully");return{message:"Transaction updated successfully"}})};