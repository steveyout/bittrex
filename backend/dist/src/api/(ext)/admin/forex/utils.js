"use strict";function parseMetadata(e){let a={};if(!e)return a;try{const t=e.replace(/\\/g,"");a=JSON.parse(t)||{}}catch(e){console_1.logger.error("FOREX","Invalid JSON in metadata",e)}return a}async function updateForexAccountBalance(e,a,t,l,r){var n,c,o,i,d,u;try{null===(n=null==r?void 0:r.step)||void 0===n||n.call(r,"Validating forex account");if(!e||!e.id)throw(0,error_1.createError)({statusCode:400,message:"Invalid forex account provided"});null===(c=null==r?void 0:r.step)||void 0===c||c.call(r,`${t?"Refunding":"Deducting"} ${a} from forex account balance`);let u=Number(e.balance)||0;u=t?u+a:u-a;if(u<0)throw(0,error_1.createError)({statusCode:400,message:"Insufficient forex account balance"});null===(o=null==r?void 0:r.step)||void 0===o||o.call(r,"Updating forex account balance in database");await db_1.models.forexAccount.update({balance:u},{where:{id:e.id},transaction:l});null===(i=null==r?void 0:r.step)||void 0===i||i.call(r,"Fetching updated forex account");const s=await db_1.models.forexAccount.findOne({where:{id:e.id},transaction:l});null===(d=null==r?void 0:r.success)||void 0===d||d.call(r,"Forex account balance updated successfully");return s}catch(e){null===(u=null==r?void 0:r.fail)||void 0===u||u.call(r,e.message);throw e}}async function updateWalletBalance(e,a,t,l,r){var n,c,o,i;try{null===(n=null==r?void 0:r.step)||void 0===n||n.call(r,"Validating wallet");if(!e||!e.id)throw(0,error_1.createError)({statusCode:400,message:"Invalid wallet provided"});null===(c=null==r?void 0:r.step)||void 0===c||c.call(r,`${t?"Refunding":"Deducting"} ${a} from wallet balance via wallet service`);if(!t){if((Number(e.balance)||0)<a)throw(0,error_1.createError)({statusCode:400,message:"Insufficient wallet balance"})}const i=`admin_forex_wallet_${e.id}_${t?"credit":"debit"}`;t?await wallet_1.walletService.credit({idempotencyKey:i,userId:e.userId,walletId:e.id,walletType:e.type,currency:e.currency,amount:a,operationType:"REFUND",description:`Admin forex withdrawal refund - ${a} ${e.currency}`,metadata:{source:"admin_forex",action:"refund"},transaction:l}):await wallet_1.walletService.debit({idempotencyKey:i,userId:e.userId,walletId:e.id,walletType:e.type,currency:e.currency,amount:a,operationType:"FOREX_WITHDRAW",description:`Admin forex withdrawal - ${a} ${e.currency}`,metadata:{source:"admin_forex",action:"debit"},transaction:l});null===(o=null==r?void 0:r.success)||void 0===o||o.call(r,"Wallet balance updated successfully");return e}catch(e){null===(i=null==r?void 0:r.fail)||void 0===i||i.call(r,e.message);throw e}}Object.defineProperty(exports,"__esModule",{value:!0});exports.parseMetadata=parseMetadata;exports.updateForexAccountBalance=updateForexAccountBalance;exports.updateWalletBalance=updateWalletBalance;const db_1=require("@b/db"),error_1=require("@b/utils/error"),console_1=require("@b/utils/console"),wallet_1=require("@b/services/wallet");