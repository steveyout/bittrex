"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const query_1=require("@b/utils/query"),db_1=require("@b/db"),utils_1=require("@b/api/finance/transaction/utils"),emails_1=require("@b/utils/emails"),error_1=require("@b/utils/error"),utils_2=require("../../utils");exports.metadata={summary:"Updates a Forex withdrawal transaction",description:"Updates a pending Forex withdrawal transaction including status, amount, fee, and description. Handles balance adjustments and sends notification emails based on status changes (COMPLETED or REJECTED).",operationId:"updateForexWithdrawal",tags:["Admin","Forex","Withdraw"],parameters:[{index:0,name:"id",in:"path",description:"The ID of the transaction to update",required:!0,schema:{type:"string"}}],requestBody:{required:!0,description:"Updated data for the transaction",content:{"application/json":{schema:utils_1.transactionUpdateSchema}}},responses:(0,query_1.updateRecordResponses)("Transaction"),requiresAuth:!0,permission:"edit.forex.withdraw",logModule:"ADMIN_FOREX",logTitle:"Update forex withdrawal"};exports.default=async e=>{const{body:t,params:a,ctx:r}=e,{id:s}=a,{status:n,amount:i,fee:o,description:d,referenceId:u,metadata:c}=t;null==r||r.step("Validating data");null==r||r.step(`Updating record ${s}`);const l=await db_1.models.transaction.findOne({where:{id:s}});if(!l)throw(0,error_1.createError)({statusCode:404,message:"Transaction not found"});if("PENDING"!==l.status)throw(0,error_1.createError)({statusCode:400,message:"Only pending transactions can be updated"});l.amount=i;l.fee=o;l.description=d;l.referenceId=u;return await db_1.sequelize.transaction(async e=>{const t=(0,utils_2.parseMetadata)(l.metadata),a=Number(l.amount)*Number(t.price);if("PENDING"===l.status){const t=await db_1.models.forexAccount.findOne({where:{userId:l.userId,type:"LIVE"},transaction:e});if(!t)throw(0,error_1.createError)({statusCode:404,message:"Forex account not found"});const s=await db_1.models.wallet.findOne({where:{id:l.walletId},transaction:e});if(!s)throw(0,error_1.createError)({statusCode:404,message:"Wallet not found"});"REJECTED"===n?await(0,utils_2.updateForexAccountBalance)(t,a,!0,e,r):"COMPLETED"===n&&await(0,utils_2.updateWalletBalance)(s,a,!0,e,r);const i=await db_1.models.user.findOne({where:{id:l.userId}});i&&await(0,emails_1.sendForexTransactionEmail)(i,l,t,s.currency,l.type,r)}c&&(t.message=c.message);l.metadata=JSON.stringify(t);l.status=n;await l.save({transaction:e});return{message:"Transaction updated successfully"}})};