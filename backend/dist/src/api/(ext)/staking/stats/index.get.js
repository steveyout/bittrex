"use strict";async function getStakingStats(){var t,e,s,a,o;try{const[r]=await db_1.sequelize.query("\n      SELECT SUM(sp.`amount`) AS total\n      FROM staking_positions AS sp\n      INNER JOIN staking_pools AS p ON sp.`poolId` = p.`id`\n      WHERE p.`status` = 'ACTIVE' AND sp.`deletedAt` IS NULL\n    "),i=Number(null!==(e=null===(t=r[0])||void 0===t?void 0:t.total)&&void 0!==e?e:0),[n]=await db_1.sequelize.query("\n      SELECT COUNT(DISTINCT sp.`userId`) AS count\n      FROM staking_positions AS sp\n      INNER JOIN staking_pools AS p ON sp.`poolId` = p.`id`\n      WHERE p.`status` = 'ACTIVE' AND sp.`deletedAt` IS NULL\n    "),l=Number(null!==(a=null===(s=n[0])||void 0===s?void 0:s.count)&&void 0!==a?a:0),u=await db_1.models.stakingPool.findAll({where:{status:"ACTIVE"},attributes:["id","apr"]});let d=0,p=0;for(const t of u){const e=await db_1.models.stakingPosition.findOne({attributes:[[(0,sequelize_1.fn)("SUM",(0,sequelize_1.col)("amount")),"total"]],where:{poolId:t.id,deletedAt:null},raw:!0}),s=Number(null!==(o=null==e?void 0:e.total)&&void 0!==o?o:0);d+=(t.apr||0)*s;p+=s}d=p?d/p:0;const c=await db_1.models.stakingEarningRecord.sum("amount",{});return{totalStaked:i,activeUsers:l,avgApr:Number(d.toFixed(2)),totalRewards:Number(c||0)}}catch(t){return(0,error_1.createError)({statusCode:500,message:"Failed to fetch staking stats"})}}Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;exports.default=getStakingStats;const db_1=require("@b/db"),sequelize_1=require("sequelize"),error_1=require("@b/utils/error");exports.metadata={summary:"Get Staking Platform Statistics",description:"Returns total staked value, active users, and average APR.",tags:["Staking","Stats"],responses:{200:{description:"Staking stats returned successfully.",content:{"application/json":{schema:{type:"object",properties:{totalStaked:{type:"number"},activeUsers:{type:"number"},avgApr:{type:"number"},totalRewards:{type:"number"}}}}}}}};