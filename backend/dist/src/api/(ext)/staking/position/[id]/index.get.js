"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error");exports.metadata={summary:"Get Staking Position Details",description:"Retrieves detailed information about a specific staking position.",operationId:"getStakingPositionById",tags:["Staking","Positions"],requiresAuth:!0,parameters:[{index:0,name:"id",in:"path",required:!0,schema:{type:"string"},description:"Position ID"}],responses:{200:{description:"Position details retrieved successfully",content:{"application/json":{schema:{type:"object",properties:{position:{type:"object"}}}}}},401:{description:"Unauthorized"},403:{description:"Forbidden - Not position owner"},404:{description:"Position not found"},500:{description:"Internal Server Error"}}};exports.default=async e=>{const{user:t,params:i,ctx:o}=e;if(!(null==t?void 0:t.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});const{id:s}=i;null==o||o.step(`Fetching staking position ${s}`);const r=await db_1.models.stakingPosition.findOne({where:{id:s},include:[{model:db_1.models.stakingPool,as:"pool",attributes:["id","name","symbol","icon","apr","lockPeriod","walletType","walletChain"]}]});if(!r)throw(0,error_1.createError)({statusCode:404,message:"Position not found"});if(r.userId!==t.id)throw(0,error_1.createError)({statusCode:403,message:"You don't have access to this position"});const n=await db_1.models.stakingEarningRecord.findAll({where:{positionId:r.id},order:[["createdAt","DESC"]]}),a=n.reduce((e,t)=>e+t.amount,0),d=n.filter(e=>!e.isClaimed).reduce((e,t)=>e+t.amount,0);let c=null;if("LOCKED"===r.status&&r.lockEndDate){const e=new Date,t=new Date(r.lockEndDate);c=Math.max(0,Math.floor((t.getTime()-e.getTime())/864e5))}const l={...r.toJSON(),earnings:{records:n,total:a,unclaimed:d},timeRemaining:c};null==o||o.success(`Staking position ${s} retrieved successfully`);return{position:l}};