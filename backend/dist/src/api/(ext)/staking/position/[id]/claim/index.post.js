"use strict";async function safeImportEcosystemUtils(){if(!ecosystemUtilsChecked){try{const e="@b/api/(ext)/ecosystem/utils/tokens",t="@b/api/(ext)/ecosystem/utils/wallet",i=await Promise.resolve(`${e}`).then(e=>__importStar(require(e))),o=await Promise.resolve(`${t}`).then(e=>__importStar(require(e)));ecosystemTokenUtils=i;ecosystemWalletUtils=o}catch(e){ecosystemTokenUtils=null;ecosystemWalletUtils=null}ecosystemUtilsChecked=!0}return{tokenUtils:ecosystemTokenUtils,walletUtils:ecosystemWalletUtils}}var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,o){void 0===o&&(o=i);var s=Object.getOwnPropertyDescriptor(t,i);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[i]}});Object.defineProperty(e,o,s)}:function(e,t,i,o){void 0===o&&(o=i);e[o]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var e=function(t){e=Object.getOwnPropertyNames||function(e){var t=[];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[t.length]=i);return t};return e(t)};return function(t){if(t&&t.__esModule)return t;var i={};if(null!=t)for(var o=e(t),s=0;s<o.length;s++)"default"!==o[s]&&__createBinding(i,t,o[s]);__setModuleDefault(i,t);return i}}();Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const cache_1=require("@b/utils/cache"),console_1=require("@b/utils/console"),wallet_1=require("@b/services/wallet");let ecosystemTokenUtils=null,ecosystemWalletUtils=null,ecosystemUtilsChecked=!1;const notifications_1=require("@b/utils/notifications"),db_1=require("@b/db"),error_1=require("@b/utils/error"),sequelize_1=require("sequelize");exports.metadata={summary:"Claim Staking Position Earnings",description:"Claims all unclaimed earnings for a specific staking position.",operationId:"claimStakingPositionEarnings",tags:["Staking","Positions","Earnings"],requiresAuth:!0,logModule:"STAKING",logTitle:"Claim earnings",rateLimit:{windowMs:36e5,max:10},parameters:[{index:0,name:"id",in:"path",required:!0,schema:{type:"string"},description:"Position ID"}],responses:{200:{description:"Earnings claimed successfully",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"},claimedAmount:{type:"number"},transactionId:{type:"string"}}}}}},401:{description:"Unauthorized"},403:{description:"Forbidden - Not position owner"},404:{description:"Position not found"},400:{description:"No earnings to claim"},500:{description:"Internal Server Error"}}};exports.default=async e=>{const{user:t,params:i,ctx:o}=e;if(!(null==t?void 0:t.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});const{id:s}=i;null==o||o.step("Validating claim request");if(!s||"string"!=typeof s)throw(0,error_1.createError)({statusCode:400,message:"Valid position ID is required"});if(await db_1.models.stakingEarningRecord.count({where:{positionId:{[sequelize_1.Op.in]:(0,sequelize_1.literal)(`(\n          SELECT id FROM staking_position WHERE userId = '${t.id}'\n        )`)},isClaimed:!0,claimedAt:{[sequelize_1.Op.gte]:new Date(Date.now()-36e5)}}})>=10)throw(0,error_1.createError)({statusCode:429,message:"Too many claim requests. Please wait before trying again."});null==o||o.step("Retrieving staking position");const a=await db_1.models.stakingPosition.findOne({where:{id:s},include:[{model:db_1.models.stakingPool,as:"pool"}]});if(!a)throw(0,error_1.createError)({statusCode:404,message:"Position not found"});null==o||o.step("Verifying position ownership");if(a.userId!==t.id)throw(0,error_1.createError)({statusCode:403,message:"You don't have access to this position"});null==o||o.step("Retrieving unclaimed earnings");const r=await db_1.models.stakingEarningRecord.findAll({where:{positionId:a.id,isClaimed:!1}});if(0===r.length)throw(0,error_1.createError)({statusCode:400,message:"No earnings to claim"});null==o||o.step("Calculating total claim amount");const n=r.reduce((e,t)=>e+t.amount,0);null==o||o.step("Retrieving or creating user wallet");let l;if("ECO"===a.pool.walletType){const e=cache_1.CacheManager.getInstance(),i=await e.getExtensions();if(!a.pool.walletChain)throw(0,error_1.createError)({statusCode:400,message:"Chain not found in trade offer"});const{tokenUtils:o,walletUtils:s}=await safeImportEcosystemUtils();if(o&&s&&i.has("ecosystem"))try{await o.getTokenContractAddress(a.pool.walletChain,a.pool.symbol);l=await s.getWalletByUserIdAndCurrency(t.id,a.pool.symbol)}catch(e){console_1.logger.error("STAKING","Failed to create or retrieve wallet",e);throw(0,error_1.createError)({statusCode:500,message:"Failed to create or retrieve wallet, please contact support"})}else{l=(await wallet_1.walletCreationService.getOrCreateWallet(t.id,"ECO",a.pool.symbol)).wallet}}else{l=(await wallet_1.walletCreationService.getOrCreateWallet(t.id,a.pool.walletType,a.pool.symbol)).wallet}null==o||o.step("Processing earnings claim");const c=await db_1.sequelize.transaction();try{null==o||o.step("Marking earnings as claimed");await Promise.all(r.map(e=>db_1.models.stakingEarningRecord.update({isClaimed:!0,claimedAt:new Date},{where:{id:e.id},transaction:c})));null==o||o.step("Crediting wallet with claimed earnings");await wallet_1.walletService.credit({idempotencyKey:`staking_claim_${a.id}`,userId:t.id,walletId:l.id,walletType:a.pool.walletType,currency:a.pool.symbol,amount:n,operationType:"STAKING_REWARD",description:`Staking rewards claim from position ${a.id}`,metadata:{source:"STAKING_CLAIM",positionId:a.id,earningIds:r.map(e=>e.id)},transaction:c});null==o||o.step("Creating claim notification");await(0,notifications_1.createNotification)({userId:t.id,relatedId:a.id,title:"Staking Rewards Claimed",message:`You have successfully claimed ${n} ${a.pool.symbol} from your staking position.`,type:"system",link:`/staking/positions/${a.id}`,actions:[{label:"View Position",link:`/staking/positions/${a.id}`,primary:!0}]},o);await c.commit();null==o||o.success(`Claimed ${n} ${a.pool.symbol} in staking rewards`);return{success:!0,claimedAmount:n}}catch(e){await c.rollback();null==o||o.fail(e.message||"Failed to claim earnings");throw e}};