"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),wallet_1=require("@b/api/(ext)/ecosystem/utils/wallet"),error_1=require("@b/utils/error"),wallet_2=require("@b/services/wallet"),query_1=require("@b/utils/query");exports.metadata={summary:"Transfers funds between user wallets",description:"Allows a user to transfer funds to another user's wallet.",operationId:"transferFunds",tags:["Wallet","Transfer"],logModule:"ECO_TRANSFER",logTitle:"Transfer funds between wallets",parameters:[{name:"id",in:"path",required:!0,schema:{type:"string",description:"UUID of the recipient's wallet or user"}}],requestBody:{required:!0,content:{"application/json":{schema:{type:"object",properties:{amount:{type:"number",description:"Amount to transfer"},currency:{type:"string",description:"Currency for the transfer"}},required:["amount","currency"]}}}},responses:{200:{description:"Transfer completed successfully",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string",description:"Success message indicating the transfer has been processed."}}}}}},401:query_1.unauthorizedResponse,404:(0,query_1.notFoundMetadataResponse)("Wallet"),500:query_1.serverErrorResponse},requiresAuth:!0};exports.default=async e=>{const{params:r,body:t,user:s,ctx:a}=e;if(!(null==s?void 0:s.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});try{const{id:e}=r,{currency:n,amount:o}=t;null==a||a.step("Validating transfer request");if(!e||!n||!o)throw(0,error_1.createError)({statusCode:400,message:"Missing required parameters"});null==a||a.step("Retrieving sender wallet");const i=await(0,wallet_1.getWalletByUserIdAndCurrency)(s.id,n);if(!i){null==a||a.fail(`Sender wallet not found for currency ${n}`);throw(0,error_1.createError)({statusCode:404,message:"User wallet not found"})}null==a||a.step("Verifying recipient user");const l=await db_1.models.user.findOne({where:{id:e}});if(!l){null==a||a.fail("Recipient user not found");throw(0,error_1.createError)({statusCode:404,message:"Recipient user not found"})}null==a||a.step("Retrieving or creating recipient wallet");let u=await(0,wallet_1.getWalletByUserIdAndCurrency)(l.id,n);u||(u=await(0,wallet_1.storeWallet)(l,n));null==a||a.step("Verifying sender balance");if(i.balance<o){null==a||a.fail(`Insufficient funds: ${i.balance} < ${o}`);throw(0,error_1.createError)({statusCode:400,message:"Insufficient funds"})}null==a||a.step("Processing transfer transaction");const d=`eco_transfer_${s.id}_${e}_${n}_${o}`;await wallet_2.walletService.transfer({idempotencyKey:d,fromUserId:s.id,toUserId:l.id,fromWalletType:"ECO",toWalletType:"ECO",fromCurrency:n,toCurrency:n,amount:o,description:`Transfer ${o} ${n} to user ${e}`,metadata:{recipientId:l.id,senderId:s.id}});null==a||a.success(`Transferred ${o} ${n} to user ${e}`);return{message:"Transfer successful"}}catch(e){console.log(`Failed to transfer: ${e.message}`);null==a||a.fail(`Transfer failed: ${e.message}`);throw(0,error_1.createError)({statusCode:500,message:`Failed to transfer: ${e.message}`})}};