"use strict";async function getCustodialWalletBalances(e,t,a=!0){try{const r=t.map(e=>e.contract),[o,s]=await e.getAllBalances(r),l=s.map((e,r)=>({...t[r],balance:a?ethers_1.ethers.formatUnits(e,t[r].decimals):e}));return{balances:l,native:a?ethers_1.ethers.formatEther(o):o}}catch(e){console_1.logger.error("ECOSYSTEM","Failed to get custodial wallet balances",e);throw(0,error_1.createError)({statusCode:500,message:`Failed to get custodial wallet balances: ${e.message}`})}}async function getCustodialWalletTokenBalance(e,t){try{return await e.getTokenBalance(t)}catch(e){console_1.logger.error("ECOSYSTEM","Failed to get custodial wallet token balance",e);throw(0,error_1.createError)({statusCode:500,message:`Failed to get token balance: ${e.message}`})}}async function getCustodialWalletNativeBalance(e){try{return await e.getNativeBalance()}catch(e){console_1.logger.error("ECOSYSTEM","Failed to get custodial wallet native balance",e);throw(0,error_1.createError)({statusCode:500,message:`Failed to get native balance: ${e.message}`})}}async function getCustodialWalletContract(e,t){try{const{abi:a}=await(0,smartContract_1.getSmartContract)("wallet","CustodialWalletERC20");if(!a)throw(0,error_1.createError)({statusCode:404,message:"Smart contract ABI or Bytecode not found"});return new ethers_1.ethers.Contract(e,a,t)}catch(e){console_1.logger.error("ECOSYSTEM","Failed to get custodial wallet contract",e);throw(0,error_1.createError)({statusCode:500,message:`Failed to get custodial wallet contract: ${e.message}`})}}async function deployCustodialContract(e){try{const t=await(0,provider_1.getProvider)(e.chain);if(!t)throw(0,error_1.createError)({statusCode:503,message:"Provider not initialized"});let a;try{a=JSON.parse((0,encrypt_1.decrypt)(e.data))}catch(e){throw(0,error_1.createError)({statusCode:500,message:`Failed to decrypt mnemonic: ${e.message}`})}if(!a||!a.privateKey)throw(0,error_1.createError)({statusCode:404,message:"Decrypted data or Mnemonic not found"});const{privateKey:r}=a,o=new ethers_1.ethers.Wallet(r).connect(t),{abi:s,bytecode:l}=await(0,smartContract_1.getSmartContract)("wallet","CustodialWalletERC20");if(!s||!l)throw(0,error_1.createError)({statusCode:404,message:"Smart contract ABI or Bytecode not found"});const c=new ethers_1.ContractFactory(s,l,o),n=await(0,gas_1.getAdjustedGasPrice)(t),i=await c.deploy(e.address,{gasPrice:n}),d=await i.waitForDeployment();return await d.getAddress()}catch(e){console_1.logger.error("ECOSYSTEM","Failed to deploy custodial wallet contract",e);if((0,ethers_1.isError)(e,"INSUFFICIENT_FUNDS"))throw(0,error_1.createError)({statusCode:400,message:"Not enough funds to deploy the contract"});throw(0,error_1.createError)({statusCode:500,message:e.message})}}async function getActiveCustodialWallets(e){try{const t=await db_1.models.ecosystemCustodialWallet.findAll({where:{chain:e,status:!0}});if(!t)throw(0,error_1.createError)({statusCode:404,message:"No active custodial wallets found"});return t}catch(e){console_1.logger.error("ECOSYSTEM","Failed to get active custodial wallets",e);throw(0,error_1.createError)({statusCode:500,message:`Failed to get active custodial wallets: ${e.message}`})}}Object.defineProperty(exports,"__esModule",{value:!0});exports.getCustodialWalletBalances=getCustodialWalletBalances;exports.getCustodialWalletTokenBalance=getCustodialWalletTokenBalance;exports.getCustodialWalletNativeBalance=getCustodialWalletNativeBalance;exports.getCustodialWalletContract=getCustodialWalletContract;exports.deployCustodialContract=deployCustodialContract;exports.getActiveCustodialWallets=getActiveCustodialWallets;const ethers_1=require("ethers"),smartContract_1=require("./smartContract"),provider_1=require("./provider"),encrypt_1=require("../../../../utils/encrypt"),gas_1=require("./gas"),db_1=require("@b/db"),console_1=require("@b/utils/console"),error_1=require("@b/utils/error");