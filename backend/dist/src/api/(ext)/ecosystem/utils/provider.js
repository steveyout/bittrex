"use strict";async function isProviderHealthy(e){try{return await e.getBlockNumber()>0}catch(e){return!1}}Object.defineProperty(exports,"__esModule",{value:!0});exports.getWssProvider=exports.getProvider=exports.initializeProvider=exports.chainConfigs=void 0;exports.isProviderHealthy=isProviderHealthy;const ethers_1=require("ethers"),chains_1=require("./chains");Object.defineProperty(exports,"chainConfigs",{enumerable:!0,get:function(){return chains_1.chainConfigs}});const console_1=require("@b/utils/console"),error_1=require("@b/utils/error"),providerCache=new Map,initializeProvider=e=>{const r=(0,exports.getProvider)(e);if(!r)throw(0,error_1.createError)({statusCode:503,message:`Failed to initialize provider for chain ${e}`});return r};exports.initializeProvider=initializeProvider;const getEnv=(e,r="")=>process.env[e]||r,getProvider=async e=>{try{const r=chains_1.chainConfigs[e];if(!r)throw(0,error_1.createError)({statusCode:400,message:`Unsupported chain: ${e}`});const t=getEnv(`${e}_NETWORK`);if(!t)throw(0,error_1.createError)({statusCode:500,message:`Environment variable ${e}_NETWORK is not set`});const o=getEnv(`${e}_${t.toUpperCase()}_RPC`);if(!o)throw(0,error_1.createError)({statusCode:500,message:`Environment variable ${o} is not set`});const i=`${e}_${t}`;if(providerCache.has(i))return providerCache.get(i);const s=r.networks[t];if(!(null==s?void 0:s.chainId))throw(0,error_1.createError)({statusCode:500,message:`Chain ID not found for ${e} on ${t}`});const n=ethers_1.Network.from({name:t,chainId:s.chainId}),a=new ethers_1.JsonRpcProvider(o,n,{staticNetwork:!0,batchMaxCount:1});providerCache.set(i,a);return a}catch(e){console_1.logger.error("PROVIDER","Failed to get provider",e);throw e}};exports.getProvider=getProvider;const getWssProvider=async e=>{try{if(!chains_1.chainConfigs[e])throw(0,error_1.createError)({statusCode:400,message:`Unsupported chain: ${e}`});const r=getEnv(`${e}_NETWORK`);if(!r)throw(0,error_1.createError)({statusCode:500,message:`Environment variable ${e}_NETWORK is not set`});const t=`${e}_${r.toUpperCase()}_RPC_WSS`,o=getEnv(t);if(!o){console_1.logger.warn("WSS_PROVIDER",`Environment variable ${t} is not set, skipping WebSocket provider`);return null}const i=new ethers_1.WebSocketProvider(o),s=1e4;await Promise.race([i._waitUntilReady(),new Promise((r,t)=>setTimeout(()=>t(new Error(`WebSocket connection timeout for ${e}`)),s))]);return i}catch(r){console_1.logger.error("WSS_PROVIDER",`Failed to get WSS provider for ${e}: ${r.message}`);return null}};exports.getWssProvider=getWssProvider;