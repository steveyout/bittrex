"use strict";function quoteColumn(e){return/[A-Z]/.test(e)?`"${e}"`:e}function formatUuid(e){return e.substr(0,8)+"-"+e.substr(8,4)+"-"+e.substr(12,4)+"-"+e.substr(16,4)+"-"+e.substr(20,12)}function buildWhereClause(e,r=[]){if("string"==typeof e)try{e=JSON.parse(decodeURIComponent(e))}catch(r){e={}}if(!e||"object"!=typeof e)return{whereClause:"",values:[]};const t=[],o=[];for(const s in e)if(Object.prototype.hasOwnProperty.call(e,s)){const a=quoteColumn(s),n=e[s];if("object"==typeof n&&n.operator&&void 0!==n.value){if("startsWith"===n.operator||"like"===n.operator){if(r.includes(s)){const e=n.value.toString();if(e.length<36){const r=e.replace(/-/g,""),s=r.padEnd(32,"0"),n=r.padEnd(32,"f"),u=formatUuid(s),i=formatUuid(n);try{const e=cassandra_driver_1.types.Uuid.fromString(u),r=cassandra_driver_1.types.Uuid.fromString(i);t.push(`${a} >= ?`);o.push(e);t.push(`${a} <= ?`);o.push(r)}catch(e){t.push(`${a} = ?`);o.push(cassandra_driver_1.types.Uuid.fromString("00000000-0000-0000-0000-000000000000"))}}else try{const e=cassandra_driver_1.types.Uuid.fromString(n.value);t.push(`${a} = ?`);o.push(e)}catch(e){t.push(`${a} = ?`);o.push(cassandra_driver_1.types.Uuid.fromString("00000000-0000-0000-0000-000000000000"))}continue}t.push(`${a} LIKE ?`);o.push(`${n.value}%`);continue}if(r.includes(s)){if(["notEqual","endsWith","substring","regexp","notRegexp"].includes(n.operator))throw(0,error_1.createError)({statusCode:400,message:`Operator "${n.operator}" is not supported for column "${s}" of non-string type`})}const e=operatorMap[n.operator];if(!e)continue;t.push(`${a} ${e} ?`);o.push(n.value)}else{t.push(`${a} = ?`);o.push(n)}}return{whereClause:t.join(" AND "),values:o}}async function getFiltered({table:e,query:r,filter:t,sortField:o="createdAt",sortOrder:s="DESC",perPage:a=10,allowFiltering:n=!0,keyspace:u,partitionKeys:i,transformColumns:c,nonStringLikeColumns:l=[]}){const p=u?`${u}.${e}`:e,{whereClause:d,values:g}=buildWhereClause(t,l),h=[...g];let f=`SELECT count(*) FROM ${p}`;d&&(f+=` WHERE ${d}`);n&&(f+=" ALLOW FILTERING");let _=0;try{const e=await client_1.default.execute(f,h,{prepare:!0});_=Number(e.rows[0].count)||0}catch(e){console_1.logger.error("SCYLLA","Error executing count query",e);throw(0,error_1.createError)({statusCode:500,message:"Error executing count query: "+e.message})}const m=r.page?Number(r.page):1,E=(m-1)*a;let y=`SELECT * FROM ${p}`;d&&(y+=` WHERE ${d}`);let b=!1;o&&i&&i.length>0&&(b=i.every(e=>{const r=t&&t[e];return r&&("equal"===r.operator||"in"===r.operator)}));b&&(y+=` ORDER BY ${quoteColumn(o)} ${s.toUpperCase()}`);n&&(y+=" ALLOW FILTERING");let C=[];try{C=(await client_1.default.execute(y,h,{prepare:!0})).rows}catch(e){console_1.logger.error("SCYLLA","Error executing data query",e);throw(0,error_1.createError)({statusCode:500,message:"Error executing data query: "+e.message})}if(!b&&o){C.sort((e,r)=>{const t=e[o],s=r[o],a=Number(t),n=Number(s);return isNaN(a)||isNaN(n)?String(t).localeCompare(String(s)):a-n});"DESC"===s.toUpperCase()&&C.reverse()}let v=C.slice(E,E+a);const $=Math.ceil(_/a);c&&c.length>0&&(v=v.map(e=>{c.forEach(r=>{if(void 0!==e[r]&&null!==e[r])try{e[r]="bigint"==typeof e[r]?(0,blockchain_1.fromBigInt)(e[r]):(0,blockchain_1.fromBigInt)(BigInt(e[r]))}catch(e){}});return e}));return{items:v,pagination:{totalItems:_,currentPage:m,perPage:a,totalPages:$}}}var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});exports.getFiltered=getFiltered;const client_1=__importDefault(require("./client")),console_1=require("@b/utils/console"),blockchain_1=require("../blockchain"),cassandra_driver_1=require("cassandra-driver"),error_1=require("@b/utils/error"),operatorMap={equal:"=",greaterThan:">",greaterThanOrEqual:">=",lessThan:"<",lessThanOrEqual:"<=",like:"LIKE",notLike:"NOT LIKE"};