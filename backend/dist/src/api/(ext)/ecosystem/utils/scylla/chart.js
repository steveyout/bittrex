"use strict";function extractAggregations(e,t){const a=[];t.forEach(e=>{e.aggregation&&e.aggregation.field&&e.aggregation.value&&a.push({alias:e.metric,field:String(e.aggregation.field),value:String(e.aggregation.value)})});e.forEach(e=>{if("pie"===e.type&&e.config&&e.config.field&&e.config.status){const t=String(e.config.field);e.config.status.forEach(e=>{a.push({alias:String(e.value),field:t,value:String(e.value)})})}});const r=new Map;a.forEach(e=>{const t=`${e.alias}:${e.field}:${e.value}`;r.set(t,e)});return Array.from(r.values())}async function fetchRowsForInterval(e,t,a,r,n={}){let c=`SELECT * FROM ${t?`${t}.${e}`:e} WHERE "createdAt" >= ? AND "createdAt" <= ?`;const o=[a,r];for(const[e,t]of Object.entries(n)){c+=` AND "${e}" = ?`;o.push(t)}c+=" ALLOW FILTERING";return(await client_1.default.execute(c,o,{prepare:!0})).rows.map(e=>{const t={createdAt:new Date(e.createdAt),total:void 0!==e.total?Number(e.total):1};Object.keys(e).forEach(a=>{"createdAt"!==a&&"total"!==a&&(t[a]=e[a])});return t})}function aggregateDataByPeriod(e,t,a){if("hour"===t||"day"===t)return e;const r=[];if(!e.length)return r;let n=(0,date_fns_1.startOfWeek)(e[0].createdAt);const c=e[e.length-1].createdAt;for(;n<=c;){const t=(0,date_fns_1.endOfWeek)(n),c=e.filter(e=>e.createdAt>=n&&e.createdAt<=t);if(c.length){const e={createdAt:n,total:c.length};a.forEach(t=>{e[t.alias]=c.filter(e=>{const a=String(e[t.field]).toLowerCase(),r=t.value.toLowerCase();return"cancelled"===r?"cancelled"===a||"canceled"===a:a===r}).length});r.push(e)}n=(0,date_fns_1.addDays)(n,7)}return r}function generateCompleteTimeline(e,t,a,r,n){let c;c="hour"===a?(0,date_fns_1.eachHourOfInterval)({start:e,end:t}):"day"===a?(0,date_fns_1.eachDayOfInterval)({start:e,end:t}):(0,date_fns_1.eachWeekOfInterval)({start:e,end:t});const o=new Map;r.forEach(e=>{let t;t="week"===a?(0,date_fns_1.startOfWeek)(e.createdAt).getTime():"hour"===a?new Date(e.createdAt.getFullYear(),e.createdAt.getMonth(),e.createdAt.getDate(),e.createdAt.getHours()).getTime():new Date(e.createdAt.getFullYear(),e.createdAt.getMonth(),e.createdAt.getDate()).getTime();const r=o.get(t);if(r){r.total+=e.total;n.forEach(t=>{r[t.alias]=(r[t.alias]||0)+(e[t.alias]||0)})}else o.set(t,{...e,createdAt:new Date(t)})});return c.map(e=>{const t=e.getTime(),a=o.get(t);if(a)return a;const r={createdAt:e,total:0};n.forEach(e=>{r[e.alias]=0});return r})}async function getChartData({model:e,keyspace:t,timeframe:a,charts:r,kpis:n,where:c={}}){const o=t?`${t}.${e}`:e;let s,i,l,d=new Date;try{const e=`SELECT max("createdAt") as maxCreatedAt FROM ${o}`,t=await client_1.default.execute(e,[],{prepare:!0});t.rows.length&&t.rows[0].maxCreatedAt&&(d=new Date(t.rows[0].maxCreatedAt))}catch(e){console.error("Failed to fetch max createdAt, using current date",e)}switch(a){case"24h":s=(0,date_fns_1.subDays)(d,1);i="hour";l="hour";break;case"7d":s=(0,date_fns_1.subDays)(d,7);i="day";l="day";break;case"30d":s=(0,date_fns_1.subDays)(d,30);i="day";l="day";break;case"3m":s=(0,date_fns_1.subMonths)(d,3);i="day";l="week";break;case"6m":s=(0,date_fns_1.subMonths)(d,6);i="day";l="week";break;default:s=(0,date_fns_1.subMonths)(d,12);i="day";l="week"}const u=extractAggregations(r,n),f=await fetchRowsForInterval(e,t||"",s,d,c);f.sort((e,t)=>e.createdAt.getTime()-t.createdAt.getTime());const g=generateCompleteTimeline(s,d,l,aggregateDataByPeriod(f,l,u),u),h={kpis:[]};n.forEach(e=>{if(!g.length){h.kpis.push({id:e.id,title:e.title,value:0,change:0,trend:[],icon:e.icon});return}const t=g.reduce((t,a)=>t+Number(a[e.metric]||0),0),a=Math.floor(g.length/2),r=g.slice(0,a),n=g.slice(a),c=r.reduce((t,a)=>t+Number(a[e.metric]||0),0),o=n.reduce((t,a)=>t+Number(a[e.metric]||0),0);let s=0;s=0===c?0===o?0:100:(o-c)/c*100;const i=Math.round(100*s)/100,l=g.map(t=>({date:t.createdAt.toISOString(),value:Number(t[e.metric]||0)}));h.kpis.push({id:e.id,title:e.title,value:t,change:i,trend:l,icon:e.icon})});r.forEach(e=>{var t,a;"pie"===e.type?h[e.id]=(null===(a=null===(t=e.config)||void 0===t?void 0:t.status)||void 0===a?void 0:a.map(e=>{const t=g.reduce((t,a)=>t+(Number(a[String(e.value)])||0),0);return{id:String(e.value),name:e.label,value:t,color:e.color}}))||[]:h[e.id]=g.map(t=>{const a={date:t.createdAt.toISOString()};e.metrics.forEach(e=>{var r;a[e]=null!==(r=t[e])&&void 0!==r?r:0});return a})});return h}var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});exports.getChartData=getChartData;const client_1=__importDefault(require("./client")),date_fns_1=require("date-fns");