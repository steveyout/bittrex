"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),query_1=require("@b/utils/query"),wallet_1=require("@b/services/wallet");let getWalletByUserIdAndCurrency;try{const e=require("@b/api/(ext)/ecosystem/utils/wallet");getWalletByUserIdAndCurrency=e.getWalletByUserIdAndCurrency}catch(e){getWalletByUserIdAndCurrency=null}exports.metadata={summary:"Claims a specific referral reward",description:"Processes the claim of a specified referral reward.",operationId:"claimReward",tags:["MLM","Rewards"],requiresAuth:!0,logModule:"AFFILIATE",logTitle:"Claim affiliate reward",parameters:[{name:"id",in:"path",required:!0,schema:{type:"string",description:"Referral reward UUID"}}],responses:{200:{description:"Reward claimed successfully",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string",description:"Success message"}}}}}},401:query_1.unauthorizedResponse,404:(0,query_1.notFoundMetadataResponse)("Affiliate Reward"),500:query_1.serverErrorResponse}};exports.default=async e=>{const{params:r,user:a,ctx:t}=e,{id:i}=r;if(!(null==a?void 0:a.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});null==t||t.step("Fetching reward details and validating ownership");const d=await db_1.models.mlmReferralReward.findOne({where:{id:i,isClaimed:!1,referrerId:a.id},include:[{model:db_1.models.mlmReferralCondition,as:"condition"}]});if(!d)throw(0,error_1.createError)({statusCode:404,message:"Reward not found or already claimed"});let n;null==t||t.step(`Retrieving or creating ${d.condition.rewardWalletType} wallet for ${d.condition.rewardCurrency}`);if("ECO"===d.condition.rewardWalletType)if(getWalletByUserIdAndCurrency)n=await getWalletByUserIdAndCurrency(a.id,d.condition.rewardCurrency);else{const e=await wallet_1.walletCreationService.getOrCreateWallet(a.id,"ECO",d.condition.rewardCurrency);n=e.wallet}else{const e=await wallet_1.walletCreationService.getOrCreateWallet(a.id,d.condition.rewardWalletType,d.condition.rewardCurrency);n=e.wallet}if(!n)throw(0,error_1.createError)({statusCode:500,message:"Wallet not found or could not be created"});null==t||t.step("Processing reward claim in transaction");await db_1.sequelize.transaction(async e=>{var r,l;null==t||t.step("Verifying reward is still available (preventing race conditions)");const o=await db_1.models.mlmReferralReward.findOne({where:{id:i,isClaimed:!1,referrerId:a.id},transaction:e,lock:e.LOCK.UPDATE});if(!o)throw(0,error_1.createError)({statusCode:404,message:"Reward not found or already claimed"});null==t||t.step(`Crediting reward via wallet service: ${o.reward} ${d.condition.rewardCurrency}`);const s=`affiliate_reward_${i}`;await wallet_1.walletService.credit({idempotencyKey:s,userId:a.id,walletId:n.id,walletType:d.condition.rewardWalletType,currency:d.condition.rewardCurrency,amount:o.reward,operationType:"REFERRAL_REWARD",referenceId:i,description:`Referral reward for ${null===(r=d.condition)||void 0===r?void 0:r.type}`,metadata:{rewardId:i,conditionId:d.conditionId,conditionType:null===(l=d.condition)||void 0===l?void 0:l.type},transaction:e});null==t||t.step("Marking reward as claimed");await o.update({isClaimed:!0},{transaction:e})});null==t||t.success(`Claimed ${d.reward} ${d.condition.rewardCurrency} in referral rewards`);return{message:"Reward claimed successfully"}};