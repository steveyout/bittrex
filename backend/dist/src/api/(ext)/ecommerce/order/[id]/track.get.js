"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),query_1=require("@b/utils/query");exports.metadata={summary:"Track an ecommerce order",description:"Retrieves tracking information for a specific order including shipping status and timeline.",operationId:"trackEcommerceOrder",tags:["Ecommerce","Orders"],logModule:"ECOM",logTitle:"Track Order",requiresAuth:!0,parameters:[{index:0,name:"id",in:"path",required:!0,schema:{type:"string"},description:"Order ID to track"}],responses:{200:{description:"Order tracking information retrieved successfully",content:{"application/json":{schema:{type:"object",properties:{orderId:{type:"string"},status:{type:"string"},shipping:{type:"object",properties:{id:{type:"string"},loadId:{type:"string"},loadStatus:{type:"string"},shipper:{type:"string"},transporter:{type:"string"},vehicle:{type:"string"},trackingNumber:{type:"string"}}},timeline:{type:"array",items:{type:"object",properties:{status:{type:"string"},timestamp:{type:"string"},description:{type:"string"}}}}}}}}},401:query_1.unauthorizedResponse,404:(0,query_1.notFoundMetadataResponse)("Order"),500:query_1.serverErrorResponse}};exports.default=async e=>{const{user:t,params:r,ctx:s}=e;if(!(null==t?void 0:t.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});const{id:i}=r;null==s||s.step("Processing request");const a=await db_1.models.ecommerceOrder.findOne({where:{id:i,userId:t.id},include:[{model:db_1.models.ecommerceShipping,as:"shipping",attributes:["id","loadId","loadStatus","shipper","transporter","vehicle","createdAt","updatedAt"]},{model:db_1.models.ecommerceProduct,as:"products",attributes:["id","name","type"],through:{attributes:["quantity"]}}]});if(!a)throw(0,error_1.createError)({statusCode:404,message:"Order not found"});const d=a.get({plain:!0}),n=[];n.push({status:"ORDER_PLACED",timestamp:d.createdAt,description:"Order has been placed successfully"});"PENDING"!==d.status&&n.push({status:"ORDER_CONFIRMED",timestamp:d.updatedAt,description:"Order has been confirmed and is being processed"});if(d.shipping){const e=d.shipping;"TRANSIT"===e.loadStatus&&n.push({status:"IN_TRANSIT",timestamp:e.updatedAt,description:`Package is in transit with ${e.transporter}`});"DELIVERED"===e.loadStatus&&n.push({status:"DELIVERED",timestamp:e.updatedAt,description:"Package has been delivered successfully"});"CANCELLED"===e.loadStatus&&n.push({status:"CANCELLED",timestamp:e.updatedAt,description:"Shipment has been cancelled"})}null==s||s.success(`Retrieved tracking information for order ${i}`);return{orderId:d.id,status:d.status,shipping:d.shipping,timeline:n.sort((e,t)=>new Date(e.timestamp).getTime()-new Date(t.timestamp).getTime())}};