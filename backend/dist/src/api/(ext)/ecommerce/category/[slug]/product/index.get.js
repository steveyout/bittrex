"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),query_1=require("@b/utils/query"),utils_1=require("../../../utils");exports.metadata={summary:"Get products by category slug",description:"Retrieves all active products within a specific category identified by its slug.",operationId:"getProductsByCategorySlug",tags:["Ecommerce","Categories","Products"],logModule:"ECOM",logTitle:"Get Category Products",parameters:[{index:0,name:"slug",in:"path",required:!0,schema:{type:"string"},description:"Category slug"}],responses:{200:{description:"Products retrieved successfully",content:{"application/json":{schema:{type:"array",items:{type:"object",properties:{...utils_1.baseProductSchema,rating:{type:"number",description:"Average rating"},reviewsCount:{type:"number",description:"Number of reviews"}}}}}}},404:(0,query_1.notFoundMetadataResponse)("Category"),500:query_1.serverErrorResponse}};exports.default=async e=>{const{params:r,ctx:t}=e;null==t||t.step("Fetching Category Products");const{slug:s}=r;try{const e=await db_1.models.ecommerceCategory.findOne({where:{slug:s,status:!0},attributes:["id","name","slug"]});if(!e)throw(0,error_1.createError)({statusCode:404,message:"Category not found"});const r=await db_1.models.ecommerceProduct.findAll({where:{categoryId:e.get("id"),status:!0},include:[{model:db_1.models.ecommerceCategory,as:"category",attributes:["id","name","slug"]},{model:db_1.models.ecommerceReview,as:"ecommerceReviews",attributes:["id","rating","status"],where:{status:"APPROVED"},required:!1}],order:[["createdAt","DESC"]]});if(!r||0===r.length){null==t||t.success("No products found in category");return[]}const o=r.map(e=>{const r=e.toJSON(),t=r.ecommerceReviews||[],s=t.length>0?t.reduce((e,r)=>e+r.rating,0)/t.length:0;return{...r,rating:Math.round(10*s)/10,reviewsCount:t.length}});null==t||t.success(`Retrieved ${o.length} products from category`);return o}catch(e){console.error("Error fetching category products:",e);throw(0,error_1.createError)({statusCode:500,message:"Error fetching category products"})}};