"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),query_1=require("@b/utils/query"),utils_1=require("../utils");exports.metadata={summary:"Retrieves a specific ecommerce category by slug",description:"Fetches a single ecommerce category by its slug, including all active products in that category with calculated ratings and review counts.",operationId:"getEcommerceCategoryBySlug",tags:["Ecommerce","Categories"],logModule:"ECOM",logTitle:"Get Category",parameters:[{index:0,name:"slug",in:"path",required:!0,schema:{type:"string",description:"Category slug"}}],responses:{200:{description:"Ecommerce category retrieved successfully",content:{"application/json":{schema:{type:"object",properties:utils_1.baseCategorySchema}}}},401:query_1.unauthorizedResponse,404:(0,query_1.notFoundMetadataResponse)("Ecommerce Category"),500:query_1.serverErrorResponse}};exports.default=async e=>{const{params:r,ctx:t}=e;null==t||t.step("Fetching Category");const o=await db_1.models.ecommerceCategory.findOne({where:{slug:r.slug,status:!0},include:[{model:db_1.models.ecommerceProduct,as:"ecommerceProducts",where:{status:!0},attributes:["id","name","slug","description","shortDescription","type","price","status","image","currency","inventoryQuantity","createdAt"],include:[{model:db_1.models.ecommerceReview,as:"ecommerceReviews",attributes:["id","productId","userId","rating","status","createdAt"]}],order:[["name","ASC"]]}]});if(!o)throw(0,error_1.createError)({statusCode:404,message:"Category not found"});const s=o.toJSON(),{ecommerceProducts:c,...a}=s;try{const e={...a,products:null==c?void 0:c.map(e=>{var r,t,o;return{...e,rating:(null===(r=e.ecommerceReviews)||void 0===r?void 0:r.length)?e.ecommerceReviews.reduce((e,r)=>e+r.rating,0)/e.ecommerceReviews.length:0,reviewsCount:null!==(o=null===(t=e.ecommerceReviews)||void 0===t?void 0:t.length)&&void 0!==o?o:0}})};null==t||t.success("Get Category fetched successfully");return JSON.parse(JSON.stringify(e))}catch(e){console.error("Error fetching category:",e);throw(0,error_1.createError)({statusCode:500,message:"Error fetching category data"})}};