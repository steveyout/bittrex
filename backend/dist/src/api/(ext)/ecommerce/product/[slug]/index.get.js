"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),query_1=require("@b/utils/query"),utils_1=require("../../utils");exports.metadata={summary:"Retrieves a specific ecommerce product by slug",description:"Fetches a single ecommerce product by its slug, including details such as category and reviews.",operationId:"getEcommerceProductBySlug",tags:["Ecommerce","Products"],requiresAuth:!1,logModule:"ECOM",logTitle:"Get Product",parameters:[{index:0,name:"slug",in:"path",required:!0,schema:{type:"string",description:"Product slug"}}],responses:{200:{description:"Ecommerce product retrieved successfully",content:{"application/json":{schema:{type:"object",properties:utils_1.baseProductSchema}}}},401:query_1.unauthorizedResponse,404:(0,query_1.notFoundMetadataResponse)("Ecommerce Product"),500:query_1.serverErrorResponse}};exports.default=async e=>{var r,t,s;const{user:o,params:c,ctx:u}=e;null==u||u.step("Fetching Product");let i=[];(null==o?void 0:o.id)&&(i=[{model:db_1.models.ecommerceOrder,as:"orders",where:{userId:o.id},attributes:["status"],required:!1,through:{attributes:["quantity","filePath","key"]}}]);const d=await db_1.models.ecommerceProduct.findOne({where:{slug:c.slug,status:!0},include:[{model:db_1.models.ecommerceCategory,as:"category",attributes:["id","name","slug"]},{model:db_1.models.ecommerceReview,as:"ecommerceReviews",required:!1,include:[{model:db_1.models.user,as:"user",attributes:["id","firstName","lastName","avatar"]}]},...i]});if(!d)throw(0,error_1.createError)({statusCode:404,message:"Product not found"});const a=d.toJSON();try{const e={...a,rating:(null===(r=a.ecommerceReviews)||void 0===r?void 0:r.length)?a.ecommerceReviews.reduce((e,r)=>e+r.rating,0)/a.ecommerceReviews.length:0,reviewsCount:null!==(s=null===(t=a.ecommerceReviews)||void 0===t?void 0:t.length)&&void 0!==s?s:0};null==u||u.success("Get Product fetched successfully");return JSON.parse(JSON.stringify(e))}catch(e){throw(0,error_1.createError)({statusCode:500,message:"Error processing product data"})}};