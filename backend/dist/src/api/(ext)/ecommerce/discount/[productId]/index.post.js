"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),sequelize_1=require("sequelize"),query_1=require("@b/utils/query"),utils_1=require("../../utils");exports.metadata={summary:"Applies a discount code to a product",description:"Allows a user to apply a discount code to a product if the discount is active and has not expired.",operationId:"applyEcommerceDiscount",tags:["Ecommerce","Discounts"],requiresAuth:!0,logModule:"ECOM",logTitle:"Apply discount code",parameters:[{index:0,name:"productId",in:"path",required:!0,schema:{type:"string",description:"Product ID to which the discount is applied"}}],requestBody:{required:!0,content:{"application/json":{schema:{type:"object",properties:{code:{type:"string",description:"Discount code"}},required:["code"]}}}},responses:{200:{description:"Discount applied successfully",content:{"application/json":{schema:{type:"object",properties:utils_1.baseDiscountSchema,required:["id","code","status"]}}}},401:query_1.unauthorizedResponse,404:(0,query_1.notFoundMetadataResponse)("Ecommerce Discount"),500:query_1.serverErrorResponse}};exports.default=async e=>{const{user:t,params:o,body:s,ctx:r}=e;if(!(null==t?void 0:t.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});const{productId:i}=o,{code:d}=s;null==r||r.step("Looking up discount code for product");const u=await db_1.models.ecommerceDiscount.findOne({where:{productId:i,code:d,status:!0,validUntil:{[sequelize_1.Op.gte]:new Date}}});if(!u){null==r||r.fail("Discount not found or has expired");throw(0,error_1.createError)({statusCode:404,message:"Discount not found or has expired"})}null==r||r.step("Checking existing discount usage");const c=await db_1.models.ecommerceUserDiscount.findOne({where:{userId:t.id,discountId:u.id}});if(c&&c.status){null==r||r.fail("Discount already applied and used");throw(0,error_1.createError)({statusCode:400,message:"Discount already applied and is no longer active"})}null==r||r.step("Creating user discount record");c||await db_1.models.ecommerceUserDiscount.create({userId:t.id,discountId:u.id,status:!1});null==r||r.success(`Discount code "${d}" applied to product`);return{id:u.id,code:u.code,status:u.status,percentage:u.percentage}};