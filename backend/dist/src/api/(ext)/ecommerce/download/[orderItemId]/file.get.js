"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),query_1=require("@b/utils/query"),path_1=__importDefault(require("path")),fs_1=__importDefault(require("fs")),promises_1=require("stream/promises"),Middleware_1=require("@b/handler/Middleware");exports.metadata={summary:"Stream digital product file",description:"Streams the actual file content for purchased digital products",operationId:"streamDigitalProductFile",tags:["Ecommerce","Downloads"],logModule:"ECOM",logTitle:"Download File",requiresAuth:!0,parameters:[{index:0,name:"orderItemId",in:"path",required:!0,schema:{type:"string"},description:"Order item ID for the digital product to download"}],responses:{200:{description:"File streamed successfully",content:{"application/octet-stream":{schema:{type:"string",format:"binary"}}}},401:query_1.unauthorizedResponse,404:(0,query_1.notFoundMetadataResponse)("Digital Product File"),500:query_1.serverErrorResponse}};exports.default=async e=>{const{ctx:r}=e;await Middleware_1.rateLimiters.download(e);const{user:t,params:o}=e,{res:s}=e;if(!(null==t?void 0:t.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});null==r||r.step("Download File");const{orderItemId:a}=o,d=await db_1.models.ecommerceOrderItem.findOne({where:{id:a},include:[{model:db_1.models.ecommerceOrder,as:"order",where:{userId:t.id},attributes:["id","status","userId"]},{model:db_1.models.ecommerceProduct,as:"product",attributes:["id","name","type","status"]}]});if(!d)throw(0,error_1.createError)({statusCode:404,message:"Order item not found or access denied"});const i=d.get({plain:!0});if("COMPLETED"!==i.order.status)throw(0,error_1.createError)({statusCode:403,message:"Order must be completed before downloading"});if("DOWNLOADABLE"!==i.product.type)throw(0,error_1.createError)({statusCode:400,message:"This product is not downloadable"});if(!i.product.status)throw(0,error_1.createError)({statusCode:410,message:"This product is no longer available for download"});if(!i.filePath)throw(0,error_1.createError)({statusCode:404,message:"Download file not found"});try{const e=path_1.default.resolve(process.env.UPLOAD_DIR||"./uploads/ecommerce/products"),r=path_1.default.normalize(i.filePath),t=path_1.default.resolve(e,r);if(!t.startsWith(e))throw(0,error_1.createError)({statusCode:403,message:"Access denied"});if(!fs_1.default.existsSync(t))throw(0,error_1.createError)({statusCode:404,message:"Download file not found on server"});const o=fs_1.default.statSync(t),d=path_1.default.basename(t);s.setHeader("Content-Type","application/octet-stream");s.setHeader("Content-Disposition",`attachment; filename="${d}"`);s.setHeader("Content-Length",o.size.toString());const n=fs_1.default.createReadStream(t);await(0,promises_1.pipeline)(n,s);await db_1.models.ecommerceOrderItem.update({updatedAt:new Date},{where:{id:a}})}catch(e){console.error("File streaming error:",e);if(!s.headersSent)throw(0,error_1.createError)({statusCode:500,message:"Error streaming file"})}};