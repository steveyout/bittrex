"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),query_1=require("@b/utils/query"),path_1=__importDefault(require("path")),fs_1=__importDefault(require("fs")),Middleware_1=require("@b/handler/Middleware");exports.metadata={summary:"Download digital product file",description:"Provides download access to purchased digital products for authenticated users.",operationId:"downloadDigitalProduct",tags:["Ecommerce","Downloads"],logModule:"ECOM",logTitle:"Get Download",requiresAuth:!0,parameters:[{index:0,name:"orderItemId",in:"path",required:!0,schema:{type:"string"},description:"Order item ID for the digital product to download"}],responses:{200:{description:"Download URL or file content provided successfully",content:{"application/json":{schema:{type:"object",properties:{downloadUrl:{type:"string"},fileName:{type:"string"},fileSize:{type:"number"},expiresAt:{type:"string"}}}}}},401:query_1.unauthorizedResponse,404:(0,query_1.notFoundMetadataResponse)("Digital Product"),500:query_1.serverErrorResponse}};exports.default=async e=>{const{user:r,params:t,ctx:o}=e;await Middleware_1.rateLimiters.download(e);if(!(null==r?void 0:r.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});null==o||o.step("Fetching Download");const{orderItemId:s}=t,a=await db_1.models.ecommerceOrderItem.findOne({where:{id:s},include:[{model:db_1.models.ecommerceOrder,as:"order",where:{userId:r.id},attributes:["id","status","userId"]},{model:db_1.models.ecommerceProduct,as:"product",attributes:["id","name","type","status"]}]});if(!a)throw(0,error_1.createError)({statusCode:404,message:"Order item not found or access denied"});const d=a.get({plain:!0});if("COMPLETED"!==d.order.status)throw(0,error_1.createError)({statusCode:403,message:"Order must be completed before downloading"});if("DOWNLOADABLE"!==d.product.type)throw(0,error_1.createError)({statusCode:400,message:"This product is not downloadable"});if(!d.product.status)throw(0,error_1.createError)({statusCode:410,message:"This product is no longer available for download"});if(!d.filePath)throw(0,error_1.createError)({statusCode:404,message:"Download file not found"});try{const e=path_1.default.resolve(process.env.UPLOAD_DIR||"./uploads/ecommerce/products"),r=path_1.default.normalize(d.filePath),t=path_1.default.resolve(e,r);if(!t.startsWith(e))throw(0,error_1.createError)({statusCode:403,message:"Access denied"});if(!fs_1.default.existsSync(t))throw(0,error_1.createError)({statusCode:404,message:"Download file not found on server"});const o=fs_1.default.statSync(t),a=path_1.default.basename(t),i=`/api/ecommerce/download/${s}/file`,n=new Date(Date.now()+864e5).toISOString();return{downloadUrl:i,fileName:a,fileSize:o.size,expiresAt:n,key:d.key}}catch(e){console.error("Download error:",e);throw(0,error_1.createError)({statusCode:500,message:"Error preparing download"})}};