"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),query_1=require("@b/utils/query");exports.metadata={summary:"Creates or updates a review for a product",description:"Allows a user to submit a review for a product they have purchased. Users can only review products once, but they can update their review.",operationId:"createEcommerceReview",tags:["Ecommerce","Reviews"],logModule:"ECOM",logTitle:"Create or update review",parameters:[{index:0,name:"productId",in:"path",required:!0,schema:{type:"string",description:"Product ID for the review"}}],requestBody:{required:!0,content:{"application/json":{schema:{type:"object",properties:{rating:{type:"number",description:"Rating given to the product"},comment:{type:"string",description:"Comment about the product",nullable:!0}},required:["rating"]}}}},responses:(0,query_1.createRecordResponses)("Review"),requiresAuth:!0};exports.default=async e=>{const{user:r,params:t,body:o,ctx:s}=e;if(!(null==r?void 0:r.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});const{productId:a}=t,{rating:i,comment:d}=o;null==s||s.step("Verifying product purchase");if(!await db_1.models.ecommerceOrder.findOne({where:{userId:r.id,status:"COMPLETED"},include:[{model:db_1.models.ecommerceProduct,as:"products",through:{attributes:[]},where:{id:a}}]})){null==s||s.fail("User has not purchased this product");throw(0,error_1.createError)({statusCode:400,message:"You have not purchased this product"})}null==s||s.step("Creating or updating review");const u=await db_1.sequelize.transaction(async e=>{const[t,o]=await db_1.models.ecommerceReview.upsert({productId:a,userId:r.id,rating:i,comment:d},{returning:!0,transaction:e});return{review:t,created:o}});null==s||s.success(`Review ${u.created?"created":"updated"} with rating ${i}`);return{message:`Review successfully ${u.created?"created":"updated"}.`}};