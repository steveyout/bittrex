"use strict";async function calculateTransactionFees(e,r,t,a,n,c){var o,l,s,i,u,d,f,v,h,w,p,g,y;try{null===(o=null==c?void 0:c.step)||void 0===o||o.call(c,`Calculating transaction fees for ${e} currency ${r}`);let y,_=0,x=8;switch(e){case"FIAT":null===(l=null==c?void 0:c.step)||void 0===l||l.call(c,"Fetching FIAT currency data");y=await db_1.models.currency.findOne({where:{id:r},transaction:n});if(!y||!y.price){null===(s=null==c?void 0:c.step)||void 0===s||s.call(c,"Currency data not found, fetching FIAT prices");await(0,cron_1.fetchFiatCurrencyPrices)();y=await db_1.models.currency.findOne({where:{id:r},transaction:n});if(!y||!y.price)throw(0,error_1.createError)({statusCode:500,message:"Currency processing failed"})}x=2;break;case"SPOT":null===(i=null==c?void 0:c.step)||void 0===i||i.call(c,"Fetching SPOT currency data");y=await db_1.models.exchangeCurrency.findOne({where:{currency:r},transaction:n});if(!y||!y.price){null===(u=null==c?void 0:c.step)||void 0===u||u.call(c,"Currency data not found, processing currencies prices");await(0,cron_1.processCurrenciesPrices)();y=await db_1.models.exchangeCurrency.findOne({where:{currency:r},transaction:n});if(!y||!y.price)throw(0,error_1.createError)({statusCode:500,message:"Currency processing failed"})}null===(d=null==c?void 0:c.step)||void 0===d||d.call(c,"Starting exchange manager");const e=await exchange_1.default.startExchange(c),o=await exchange_1.default.getProvider();if(!e)throw(0,error_1.createError)(500,"Exchange not found");null===(f=null==c?void 0:c.step)||void 0===f||f.call(c,"Fetching exchange currencies");const g=await e.fetchCurrencies(),m="xt"===o,F=Object.values(g).find(e=>m?e.code===r:e.id===r);if(!F)throw(0,error_1.createError)(404,"Currency not found");null===(v=null==c?void 0:c.step)||void 0===v||v.call(c,"Calculating transaction fees");let C=0;switch(o){case"binance":case"kucoin":t&&F.networks&&(C=(null===(h=F.networks[t])||void 0===h?void 0:h.fee)||(null===(p=null===(w=F.networks[t])||void 0===w?void 0:w.fees)||void 0===p?void 0:p.withdraw)||0)}const b=parseFloat(a.toString()),O=y.fee||0;_=parseFloat(Math.max(b*O/100+C,0).toFixed(2));x=y.precision||8;break;default:throw(0,error_1.createError)({statusCode:400,message:"Invalid wallet type"})}const m=a+_;null===(g=null==c?void 0:c.success)||void 0===g||g.call(c,`Transaction fees calculated successfully: ${_}`);return{currencyData:y,taxAmount:_,total:m,precision:x}}catch(e){null===(y=null==c?void 0:c.fail)||void 0===y||y.call(c,e.message);throw e}}async function validateAccountOwnership(e,r,t,a){var n,c,o,l;try{null===(n=null==a?void 0:a.step)||void 0===n||n.call(a,`Validating account ownership for account ${e}`);const l=await db_1.models.forexAccount.findByPk(e,{transaction:t});if(!l)throw(0,error_1.createError)({statusCode:404,message:"Account not found"});null===(c=null==a?void 0:a.step)||void 0===c||c.call(a,"Checking account ownership");if(l.userId!==r)throw(0,error_1.createError)({statusCode:403,message:"Access denied: You can only access your own forex accounts"});null===(o=null==a?void 0:a.success)||void 0===o||o.call(a,"Account ownership validated successfully");return l}catch(e){null===(l=null==a?void 0:a.fail)||void 0===l||l.call(a,e.message);throw e}}async function getUserWallet(e,r,t,a,n){var c,o,l;try{null===(c=null==n?void 0:n.step)||void 0===c||c.call(n,`Fetching wallet for user ${e} (${r} ${t})`);const l=await db_1.models.wallet.findOne({where:{userId:e,type:r,currency:t},transaction:a});if(!l)throw(0,error_1.createError)({statusCode:404,message:"Wallet not found"});null===(o=null==n?void 0:n.success)||void 0===o||o.call(n,"Wallet fetched successfully");return l}catch(e){null===(l=null==n?void 0:n.fail)||void 0===l||l.call(n,e.message);throw e}}async function createForexTransaction(e,r,t,a,n,c,o,l,s){var i,u,d;try{null===(i=null==s?void 0:s.step)||void 0===i||i.call(s,`Creating ${t} transaction for account ${c}`);const d="FOREX_DEPOSIT"===t?`Deposit to Forex account ${c}`:`Withdraw from Forex account ${c}`,f=await db_1.models.transaction.create({userId:e,walletId:r,type:t,status:"PENDING",amount:a,fee:n,description:d,metadata:JSON.stringify(o)},{transaction:l});null===(u=null==s?void 0:s.success)||void 0===u||u.call(s,"Forex transaction created successfully");return f}catch(e){null===(d=null==s?void 0:s.fail)||void 0===d||d.call(s,e.message);throw e}}var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});exports.calculateTransactionFees=calculateTransactionFees;exports.validateAccountOwnership=validateAccountOwnership;exports.getUserWallet=getUserWallet;exports.createForexTransaction=createForexTransaction;const exchange_1=__importDefault(require("@b/utils/exchange")),db_1=require("@b/db"),error_1=require("@b/utils/error"),cron_1=require("@b/cron");