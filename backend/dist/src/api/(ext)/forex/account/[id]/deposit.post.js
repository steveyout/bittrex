"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const exchange_1=__importDefault(require("@b/utils/exchange")),cron_1=require("@b/cron"),db_1=require("@b/db"),error_1=require("@b/utils/error"),console_1=require("@b/utils/console"),forex_fraud_detector_1=require("@b/api/(ext)/forex/utils/forex-fraud-detector"),wallet_1=require("@b/services/wallet"),query_1=require("@b/utils/query");exports.metadata={summary:"Deposits money into a specified Forex account",description:"Allows a user to deposit money from their wallet into a Forex account.",operationId:"depositForexAccount",tags:["Forex","Accounts"],rateLimit:{windowMs:6e4,max:5},parameters:[{index:0,name:"id",in:"path",required:!0,schema:{type:"string",description:"Forex account ID"}}],requiresAuth:!0,logModule:"FOREX",logTitle:"Deposit to forex account",requestBody:{required:!0,content:{"application/json":{schema:{type:"object",properties:{type:{type:"string",description:"Wallet type"},currency:{type:"string",description:"Currency code"},chain:{type:"string",description:"Blockchain network",nullable:!0},amount:{type:"number",description:"Amount to deposit"}},required:["type","currency","amount"]}}}},responses:{201:{description:"Deposit successfully processed",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string",description:"Success message"},transaction:{type:"object",properties:{id:{type:"string",description:"Transaction ID"},type:{type:"string",description:"Transaction type"},status:{type:"string",description:"Transaction status"},amount:{type:"number",description:"Transaction amount"},fee:{type:"number",description:"Transaction fee"},description:{type:"string",description:"Transaction description"},metadata:{type:"object",description:"Transaction metadata"},createdAt:{type:"string",format:"date-time",description:"Transaction creation date"}}},balance:{type:"number",description:"Wallet balance"},currency:{type:"string",description:"Currency code"},chain:{type:"string",description:"Blockchain network",nullable:!0},type:{type:"string",description:"Deposit method type"}}}}}},401:query_1.unauthorizedResponse,404:(0,query_1.notFoundMetadataResponse)("Forex Account"),500:query_1.serverErrorResponse}};exports.default=async e=>{const{user:r,params:t,body:o,req:a,ctx:n}=e;if(!(null==r?void 0:r.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});const{id:s}=t,{amount:i,type:c,currency:u,chain:d}=o;try{null==n||n.step("Validating deposit amount");if(!i||i<=0)throw(0,error_1.createError)({statusCode:400,message:"Amount is required and must be greater than zero"});if(i<=0)throw(0,error_1.createError)({statusCode:400,message:"Amount must be greater than zero"});let e,t=0;const o=await db_1.sequelize.transaction(async a=>{var l,p,f;null==n||n.step("Verifying forex account");const y=await db_1.models.forexAccount.findByPk(s,{transaction:a});if(!y)throw(0,error_1.createError)({statusCode:404,message:"Account not found"});null==n||n.step("Running fraud detection checks");const m=await forex_fraud_detector_1.ForexFraudDetector.checkDeposit(r.id,i,u,n);if(!m.isValid)throw(0,error_1.createError)({statusCode:400,message:m.reason||"Deposit flagged for security review"});if(y.userId!==r.id)throw(0,error_1.createError)({statusCode:403,message:"Access denied: You can only deposit to your own forex accounts"});null==n||n.step(`Fetching ${c} wallet for ${u}`);const w=await db_1.models.wallet.findOne({where:{userId:r.id,type:c,currency:u},transaction:a});if(!w)throw(0,error_1.createError)({statusCode:404,message:"Wallet not found"});null==n||n.step("Checking wallet balance");if(w.balance<i)throw(0,error_1.createError)({statusCode:400,message:"Insufficient balance"});null==n||n.step("Calculating transaction fees");let _;switch(c){case"FIAT":_=await db_1.models.currency.findOne({where:{id:w.currency},transaction:a});if(!_||!_.price){await(0,cron_1.fetchFiatCurrencyPrices)();_=await db_1.models.currency.findOne({where:{id:w.currency},transaction:a});if(!_||!_.price)throw(0,error_1.createError)({statusCode:500,message:"Currency processing failed"})}break;case"SPOT":{_=await db_1.models.exchangeCurrency.findOne({where:{currency:w.currency},transaction:a});if(!_||!_.price){await(0,cron_1.processCurrenciesPrices)();_=await db_1.models.exchangeCurrency.findOne({where:{currency:w.currency},transaction:a});if(!_||!_.price)throw(0,error_1.createError)({statusCode:500,message:"Currency processing failed"})}const e=await exchange_1.default.startExchange(n),r=await exchange_1.default.getProvider();if(!e)throw(0,error_1.createError)(500,"Exchange not found");const o=await e.fetchCurrencies(),s="xt"===r,c=Object.values(o).find(e=>s?e.code===u:e.id===u);if(!c)throw(0,error_1.createError)(404,"Currency not found");let y=0;switch(r){case"binance":case"kucoin":d&&c.networks&&(y=(null===(l=c.networks[d])||void 0===l?void 0:l.fee)||(null===(f=null===(p=c.networks[d])||void 0===p?void 0:p.fees)||void 0===f?void 0:f.withdraw)||0)}const m=parseFloat(i),h=_.fee||0;t=parseFloat(Math.max(m*h/100+y,0).toFixed(2))}break;default:throw(0,error_1.createError)({statusCode:400,message:"Invalid wallet type"})}const h=i+t;if(w.balance<h)throw(0,error_1.createError)({statusCode:400,message:"Insufficient funds"});null==n||n.step(`Deducting ${h} ${u} from wallet`);const g=`forex_deposit_${s}_${r.id}_${i}`,b=await wallet_1.walletService.debit({idempotencyKey:g,userId:r.id,walletId:w.id,walletType:c,currency:u,amount:h,operationType:"FOREX_DEPOSIT",fee:t,description:`Deposit to Forex account ${y.accountId}`,metadata:{forexAccountId:s,accountId:y.accountId,walletType:c,chain:d,price:_.price},transaction:a});e=b.newBalance;console_1.logger.info("FOREX_DEPOSIT",`User ${r.id} deposited ${i} ${u} to forex account ${y.id}. Transaction ID: ${o.id}, Wallet Type: ${c}, Chain: ${d||"N/A"}`);return o});null==n||n.success(`Deposited ${i} ${u} to forex account ${s}${t>0?` (fee: ${t})`:""}`);return{message:"Deposit successful",transaction:o,balance:e,currency:u,chain:d,type:c}}catch(e){null==n||n.fail(e.message||"Failed to deposit to forex account");console_1.logger.error("FOREX_DEPOSIT_ERROR",`Forex deposit failed for user ${r.id}, account ${s}: ${e.message}. Details: amount=${i}, currency=${u}, type=${c}, chain=${d||"N/A"}`,e);throw e}};