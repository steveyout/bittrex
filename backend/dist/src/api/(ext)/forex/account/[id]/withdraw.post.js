"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const exchange_1=__importDefault(require("@b/utils/exchange")),cron_1=require("@b/cron"),db_1=require("@b/db"),error_1=require("@b/utils/error"),console_1=require("@b/utils/console"),forex_fraud_detector_1=require("@b/api/(ext)/forex/utils/forex-fraud-detector"),query_1=require("@b/utils/query");exports.metadata={summary:"Withdraws money from the specified Forex account",description:"Allows a user to withdraw money from their Forex account into their wallet.",operationId:"withdrawForexAccount",tags:["Forex","Accounts"],rateLimit:{windowMs:6e4,max:5},parameters:[{index:0,name:"id",in:"path",required:!0,schema:{type:"string",description:"Forex account ID"}}],requiresAuth:!0,logModule:"FOREX",logTitle:"Withdraw from forex account",requestBody:{required:!0,content:{"application/json":{schema:{type:"object",properties:{type:{type:"string",description:"Wallet type"},currency:{type:"string",description:"Currency code"},chain:{type:"string",description:"Blockchain network",nullable:!0},amount:{type:"number",description:"Amount to withdraw"}},required:["type","currency","amount"]}}}},responses:{201:{description:"Withdrawal successfully processed",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string",description:"Success message"},transaction:{type:"object",properties:{id:{type:"string",description:"Transaction ID"},userId:{type:"string",description:"User ID"},walletId:{type:"string",description:"Wallet ID"},type:{type:"string",description:"Transaction type"},status:{type:"string",description:"Transaction status"},amount:{type:"number",description:"Transaction amount"},fee:{type:"number",description:"Transaction fee"},description:{type:"string",description:"Transaction description"},metadata:{type:"object",description:"Transaction metadata"},createdAt:{type:"string",description:"Transaction creation date"},updatedAt:{type:"string",description:"Transaction update date"}}},balance:{type:"number",description:"Wallet balance"},currency:{type:"string",description:"Currency code"},chain:{type:"string",description:"Blockchain network",nullable:!0},type:{type:"string",description:"Wallet type"}}}}}},401:query_1.unauthorizedResponse,404:(0,query_1.notFoundMetadataResponse)("Forex Account"),500:query_1.serverErrorResponse}};exports.default=async e=>{const{user:r,params:t,body:a,req:o,ctx:i}=e;if(!(null==r?void 0:r.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});const{id:n}=t,{amount:s,type:c,currency:d,chain:u}=a;try{null==i||i.step("Validating withdrawal amount");if(!s||s<=0)throw(0,error_1.createError)({statusCode:400,message:"Amount is required and must be greater than zero"});if(s<=0)throw(0,error_1.createError)({statusCode:400,message:"Amount must be greater than zero"});let e,t=0;const a=await db_1.sequelize.transaction(async a=>{var o,l,p;null==i||i.step("Verifying forex account");const w=await db_1.models.forexAccount.findByPk(n,{transaction:a});if(!w)throw(0,error_1.createError)({statusCode:404,message:"Account not found"});if(w.userId!==r.id)throw(0,error_1.createError)({statusCode:403,message:"Access denied: You can only withdraw from your own forex accounts"});null==i||i.step("Checking account balance");if(w.balance<s)throw(0,error_1.createError)({statusCode:400,message:"Insufficient balance"});null==i||i.step("Checking withdrawal limits");const h=new Date,y=w.lastWithdrawReset?new Date(w.lastWithdrawReset):new Date,f=(h.getTime()-y.getTime())/864e5;if(f>=1){w.dailyWithdrawn=0;f>=30&&(w.monthlyWithdrawn=0);w.lastWithdrawReset=h}const m=w.dailyWithdrawLimit||5e3,g=w.dailyWithdrawn||0;if(g+s>m)throw(0,error_1.createError)({statusCode:400,message:`Daily withdrawal limit exceeded. You can withdraw up to ${m-g} more today.`});const _=w.monthlyWithdrawLimit||5e4,b=w.monthlyWithdrawn||0;if(b+s>_)throw(0,error_1.createError)({statusCode:400,message:`Monthly withdrawal limit exceeded. You can withdraw up to ${_-b} more this month.`});null==i||i.step(`Fetching ${c} wallet for ${d}`);const x=await db_1.models.wallet.findOne({where:{userId:r.id,type:c,currency:d},transaction:a});if(!x)throw(0,error_1.createError)({statusCode:404,message:"Wallet not found"});null==i||i.step("Calculating transaction fees");let W;switch(c){case"FIAT":W=await db_1.models.currency.findOne({where:{id:x.currency},transaction:a});if(!W||!W.price){await(0,cron_1.fetchFiatCurrencyPrices)();W=await db_1.models.currency.findOne({where:{id:x.currency},transaction:a});if(!W||!W.price)throw(0,error_1.createError)({statusCode:500,message:"Currency processing failed"})}break;case"SPOT":W=await db_1.models.exchangeCurrency.findOne({where:{currency:x.currency},transaction:a});if(!W||!W.price){await(0,cron_1.processCurrenciesPrices)();W=await db_1.models.exchangeCurrency.findOne({where:{currency:x.currency},transaction:a});if(!W||!W.price)throw(0,error_1.createError)({statusCode:500,message:"Currency processing failed"})}{const e=await exchange_1.default.startExchange(i),r=await exchange_1.default.getProvider();if(!e)throw(0,error_1.createError)(500,"Exchange not found");const a=await e.fetchCurrencies(),n="xt"===r,c=Object.values(a).find(e=>n?e.code===d:e.id===d);if(!c)throw(0,error_1.createError)(404,"Currency not found");let w=0;switch(r){case"binance":case"kucoin":u&&c.networks&&(w=(null===(o=c.networks[u])||void 0===o?void 0:o.fee)||(null===(p=null===(l=c.networks[u])||void 0===l?void 0:l.fees)||void 0===p?void 0:p.withdraw)||0)}const h=parseFloat(s),y=W.fee||0;t=parseFloat(Math.max(h*y/100+w,0).toFixed(2))}break;default:throw(0,error_1.createError)({statusCode:400,message:"Invalid wallet type"})}const C=s+t;if(w.balance<C)throw(0,error_1.createError)({statusCode:400,message:"Insufficient funds"});null==i||i.step("Running fraud detection checks");const E=await forex_fraud_detector_1.ForexFraudDetector.checkWithdrawal(r.id,s,d,i);if(!E.isValid)throw(0,error_1.createError)({statusCode:400,message:E.reason||"Transaction flagged for security review"});if(E.riskScore>=.75)throw(0,error_1.createError)({statusCode:403,message:"This withdrawal requires additional verification. Please contact support."});null==i||i.step(`Deducting ${C} from forex account`);e=parseFloat((w.balance-C).toFixed(2));await w.update({balance:e,dailyWithdrawn:(w.dailyWithdrawn||0)+s,monthlyWithdrawn:(w.monthlyWithdrawn||0)+s,lastWithdrawReset:w.lastWithdrawReset},{transaction:a});null==i||i.step("Creating withdrawal transaction record");const $=await db_1.models.transaction.create({userId:r.id,walletId:x.id,type:"FOREX_WITHDRAW",status:"PENDING",amount:s,fee:t,description:`Withdraw from Forex account ${w.accountId}`,metadata:JSON.stringify({id:n,accountId:w.accountId,type:c,currency:d,chain:u,price:W.price})},{transaction:a});console_1.logger.info("FOREX_WITHDRAWAL",`User ${r.id} withdrew ${s} ${d} from forex account ${w.id}. Transaction ID: ${$.id}, Wallet Type: ${c}, Chain: ${u||"N/A"}`);return $});null==i||i.success(`Withdrew ${s} ${d} from forex account ${n}${t>0?` (fee: ${t})`:""}`);return{message:"Withdraw successful",transaction:a,balance:e,currency:d,chain:u,type:c}}catch(e){null==i||i.fail(e.message||"Failed to withdraw from forex account");console_1.logger.error("FOREX_WITHDRAWAL_ERROR",`Forex withdrawal failed for user ${r.id}, account ${n}: ${e.message}. Details: amount=${s}, currency=${d}, type=${c}, chain=${u||"N/A"}`,e);throw e}};