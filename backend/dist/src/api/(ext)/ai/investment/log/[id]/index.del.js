"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),query_1=require("@b/utils/query"),wallet_1=require("@b/services/wallet");exports.metadata={summary:"Deletes an AI investment",description:"Deletes an existing AI trading investment for the currently authenticated user.",operationId:"deleteInvestment",tags:["AI Trading"],parameters:[{index:0,name:"id",in:"path",required:!0,schema:{type:"string",description:"Investment ID"}}],responses:(0,query_1.deleteRecordResponses)("AI Investment"),logModule:"AI_INVEST",logTitle:"Cancel AI investment",requiresAuth:!0};exports.default=async e=>{const{user:t,params:n,ctx:r}=e;null==r||r.step("Validating user authentication");if(!(null==t?void 0:t.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});const{id:s}=n;null==r||r.step("Fetching user details");if(!await db_1.models.user.findByPk(t.id))throw(0,error_1.createError)({statusCode:404,message:"User not found"});null==r||r.step("Fetching investment details");const a=await db_1.models.aiInvestment.findByPk(s);if(!a)throw(0,error_1.createError)({statusCode:404,message:"Investment not found"});null==r||r.step("Verifying investment ownership");if(a.userId!==t.id)throw(0,error_1.createError)({statusCode:403,message:"Forbidden"});null==r||r.step("Processing cancellation transaction");await db_1.sequelize.transaction(async e=>{null==r||r.step("Locating user wallet for refund");const n=await db_1.models.wallet.findOne({where:{userId:t.id,currency:a.symbol.split("/")[1],type:a.type},transaction:e});if(!n)throw(0,error_1.createError)({statusCode:404,message:"Wallet not found"});null==r||r.step("Deleting investment record");await db_1.models.aiInvestment.destroy({where:{id:s},force:!0,transaction:e});null==r||r.step("Refunding investment amount to wallet via wallet service");const i=`ai_invest_cancel_${s}`,o=a.symbol.split("/")[1];await wallet_1.walletService.credit({idempotencyKey:i,userId:t.id,walletId:n.id,walletType:a.type,currency:o,amount:a.amount,operationType:"REFUND",referenceId:s,description:`AI Investment cancelled - refund ${a.amount} ${o}`,metadata:{investmentId:s,symbol:a.symbol},transaction:e});null==r||r.step("Removing associated transaction");await db_1.models.transaction.destroy({where:{referenceId:s},force:!0,transaction:e})});null==r||r.success(`Cancelled investment of ${a.amount} ${a.symbol.split("/")[1]} and refunded to wallet`);return{message:"Investment cancelled successfully"}};