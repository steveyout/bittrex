"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),query_1=require("@b/utils/query"),sequelize_1=require("sequelize"),error_1=require("@b/utils/error");exports.metadata={summary:"Get P2P Offer by ID",description:"Retrieves detailed offer data by its ID, including computed seller metrics and ratings.",operationId:"getP2POfferById",tags:["P2P","Offer"],logModule:"P2P",logTitle:"Get offer by ID",parameters:[{index:0,name:"id",in:"path",description:"Offer ID",required:!0,schema:{type:"string"}}],responses:{200:{description:"Offer retrieved successfully."},404:{description:"Offer not found."},500:query_1.serverErrorResponse},requiresAuth:!1};exports.default=async e=>{const{id:r}=e.params||{},{ctx:t}=e||{};null==t||t.step("Fetching offer details");try{const e=await db_1.models.p2pOffer.findByPk(r,{include:[{model:db_1.models.user,as:"user",attributes:["id","firstName","lastName","email","avatar"]},{model:db_1.models.p2pPaymentMethod,as:"paymentMethods",attributes:["id","name","icon"],through:{attributes:[]}},{model:db_1.models.p2pOfferFlag,as:"flag",attributes:["id","isFlagged","reason","flaggedAt"]}]});if(!e)return{error:"Offer not found"};const s=e.get({plain:!0}),a=s.user.id;null==t||t.step("Calculating seller metrics");!s.priceCurrency&&s.priceConfig&&(s.priceCurrency=s.priceConfig.currency||"USD");const i=await db_1.models.p2pTrade.count({where:{sellerId:a}}),l=await db_1.models.p2pTrade.count({where:{sellerId:a,status:"COMPLETED"}}),n=await db_1.models.p2pTrade.sum("amount",{where:{sellerId:a,status:"COMPLETED"}})||0,o=i?Math.round(l/i*100):0,u=await db_1.models.p2pTrade.findOne({where:{sellerId:a,paymentConfirmedAt:{[sequelize_1.Op.ne]:null}},attributes:[[(0,sequelize_1.fn)("AVG",(0,sequelize_1.literal)("TIMESTAMPDIFF(MINUTE, `createdAt`, `paymentConfirmedAt`)")),"avgResponseTime"]],raw:!0}),d=(null==u?void 0:u.avgResponseTime)?Math.round(u.avgResponseTime):null,m=await db_1.models.p2pReview.findOne({where:{revieweeId:a},attributes:[[(0,sequelize_1.fn)("AVG",(0,sequelize_1.col)("communicationRating")),"avgCommunication"],[(0,sequelize_1.fn)("AVG",(0,sequelize_1.col)("speedRating")),"avgSpeed"],[(0,sequelize_1.fn)("AVG",(0,sequelize_1.col)("trustRating")),"avgTrust"]],raw:!0}),p=null!=(null==m?void 0:m.avgCommunication)?Math.round(m.avgCommunication):null,c=null!=(null==m?void 0:m.avgSpeed)?Math.round(m.avgSpeed):null,f=null!=(null==m?void 0:m.avgTrust)?Math.round(m.avgTrust):null,g=null!=p&&null!=c&&null!=f?Math.round((p+c+f)/3):null;s.user.stats={totalTrades:i,volume:n,completionRate:o,avgResponseTime:d,ratings:{communication:p,speed:c,trust:f,overall:g}};null==t||t.success(`Retrieved offer ${r.slice(0,8)}...`);return s}catch(e){null==t||t.fail(e.message||"Failed to retrieve offer");throw(0,error_1.createError)({statusCode:500,message:"Internal Server Error: "+e.message})}};