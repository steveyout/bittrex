"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),query_1=require("@b/utils/query"),sequelize_1=require("sequelize"),utils_1=require("@b/api/finance/wallet/utils"),json_parser_1=require("@b/api/(ext)/p2p/utils/json-parser"),console_1=require("@b/utils/console"),wallet_1=require("@b/services/wallet");exports.metadata={summary:"Delete a P2P offer",description:"Deletes a P2P offer. Only the owner can delete their offer.",operationId:"deleteP2POffer",tags:["P2P","Offers"],logModule:"P2P_OFFER",logTitle:"Delete P2P offer",parameters:[{name:"id",in:"path",description:"ID of the offer to delete",required:!0,schema:{type:"string"}}],requiresAuth:!0,responses:{200:{description:"Offer deleted successfully"},401:query_1.unauthorizedResponse,403:{description:"Forbidden - You don't have permission to delete this offer"},404:(0,query_1.notFoundMetadataResponse)("Offer"),500:query_1.serverErrorResponse}};exports.default=async e=>{const{user:r,params:t,ctx:o}=e;if(!(null==r?void 0:r.id))throw(0,error_1.createError)(401,"Unauthorized");const{id:a}=t;null==o||o.step("Finding and validating offer");const i=await db_1.sequelize.transaction();try{const e=await db_1.models.p2pOffer.findByPk(a,{lock:!0,transaction:i});if(!e){await i.rollback();throw(0,error_1.createError)(404,"Offer not found")}if(e.userId!==r.id){await i.rollback();throw(0,error_1.createError)(403,"You don't have permission to delete this offer")}if(await db_1.models.p2pTrade.count({where:{offerId:a,status:{[sequelize_1.Op.in]:["PENDING","ACTIVE","ESCROW","PAID","PAYMENT_SENT","ESCROW_RELEASED"],[sequelize_1.Op.notIn]:["COMPLETED","CANCELLED","DISPUTED","EXPIRED"]}},transaction:i})>0){await i.rollback();throw(0,error_1.createError)(400,"Cannot delete offer with active trades. Please wait for all trades to complete, expire, or cancel them first.")}null==o||o.step("Checking for funds to unlock");if("SELL"===e.type){const t=(0,json_parser_1.parseAmountConfig)(e.amountConfig).total;if(t>0){null==o||o.step(`Unlocking ${t} ${e.currency} from wallet`);const s=await(0,utils_1.getWalletSafe)(r.id,e.walletType,e.currency,!1,o);if(s&&s.inOrder>=t){const o=`p2p_offer_delete_release_${a}`;await wallet_1.walletService.release({idempotencyKey:o,userId:r.id,walletId:s.id,walletType:e.walletType,currency:e.currency,amount:t,operationType:"P2P_OFFER_DELETE",description:`Release ${t} ${e.currency} - P2P offer deleted`,metadata:{offerId:a,offerType:e.type},transaction:i});console_1.logger.info("P2P_OFFER",`Unlocked funds: ${t} ${e.currency} for user ${r.id} (${e.walletType})`)}}}null==o||o.step("Deleting offer");await e.destroy({transaction:i});await i.commit();null==o||o.success(`Deleted ${e.type} offer for ${e.currency}`);return{message:"Offer deleted successfully"}}catch(e){if(i)try{await i.rollback()}catch(e){}console_1.logger.error("P2P_OFFER","Error deleting P2P offer",e);throw e}};