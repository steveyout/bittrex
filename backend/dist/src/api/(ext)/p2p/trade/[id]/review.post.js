"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),sequelize_1=require("sequelize"),error_1=require("@b/utils/error");exports.metadata={summary:"Submit Trade Review",description:"Submits a review for a trade with rating and feedback.",operationId:"reviewP2PTrade",tags:["P2P","Trade"],requiresAuth:!0,logModule:"P2P_REVIEW",logTitle:"Submit review",parameters:[{index:0,name:"id",in:"path",description:"Trade ID",required:!0,schema:{type:"string"}}],requestBody:{description:"Review data",required:!0,content:{"application/json":{schema:{type:"object",properties:{rating:{type:"number"},feedback:{type:"string"}},required:["rating","feedback"]}}}},responses:{200:{description:"Review submitted successfully."},401:{description:"Unauthorized."},404:{description:"Trade not found."},500:{description:"Internal Server Error."}}};exports.default=async e=>{const{id:r}=e.params||{},{rating:t,feedback:i}=e.body,{user:d,ctx:a}=e;if(!(null==d?void 0:d.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});null==a||a.step("Finding trade and validating review");const s=await db_1.models.p2pTrade.findOne({where:{id:r,[sequelize_1.Op.or]:[{buyerId:d.id},{sellerId:d.id}]}});if(!s)throw(0,error_1.createError)({statusCode:404,message:"Trade not found"});try{null==a||a.step("Creating review record");await db_1.models.p2pReview.create({reviewerId:d.id,revieweeId:s.sellerId,tradeId:r,rating:t,comment:i});null==a||a.success(`Submitted review for trade ${s.id.slice(0,8)}... (rating: ${t})`);return{message:"Review submitted successfully."}}catch(e){throw(0,error_1.createError)({statusCode:500,message:"Internal Server Error: "+e.message})}};