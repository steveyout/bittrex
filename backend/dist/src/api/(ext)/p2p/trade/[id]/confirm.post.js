"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}});Object.defineProperty(e,a,n)}:function(e,t,r,a){void 0===a&&(a=r);e[a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var e=function(t){e=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t};return e(t)};return function(t){if(t&&t.__esModule)return t;var r={};if(null!=t)for(var a=e(t),n=0;n<a.length;n++)"default"!==a[n]&&__createBinding(r,t,a[n]);__setModuleDefault(r,t);return r}}();Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),console_1=require("@b/utils/console");exports.metadata={summary:"Confirm Payment for Trade",description:"Updates the trade status to 'PAYMENT_SENT' to confirm that payment has been made.",operationId:"confirmP2PTradePayment",tags:["P2P","Trade"],requiresAuth:!0,logModule:"P2P_TRADE",logTitle:"Confirm payment",parameters:[{index:0,name:"id",in:"path",description:"Trade ID",required:!0,schema:{type:"string"}}],responses:{200:{description:"Payment confirmed successfully."},401:{description:"Unauthorized."},404:{description:"Trade not found."},500:{description:"Internal Server Error."}}};exports.default=async e=>{const{id:t}=e.params||{},{user:r,body:a,ctx:n}=e;if(!(null==r?void 0:r.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});null==n||n.step("Finding and validating trade");const{validateTradeStatusTransition:i}=await Promise.resolve().then(()=>__importStar(require("../../utils/validation"))),{notifyTradeEvent:o}=await Promise.resolve().then(()=>__importStar(require("../../utils/notifications"))),{broadcastP2PTradeEvent:s}=await Promise.resolve().then(()=>__importStar(require("./index.ws"))),d=await db_1.models.p2pTrade.findOne({where:{id:t,buyerId:r.id},include:[{model:db_1.models.p2pOffer,as:"offer",attributes:["currency"]}]});if(!d)throw(0,error_1.createError)({statusCode:404,message:"Trade not found"});if(!i(d.status,"PAYMENT_SENT"))throw(0,error_1.createError)({statusCode:400,message:`Cannot confirm payment from status: ${d.status}`});if(d.expiresAt&&new Date(d.expiresAt)<new Date)throw(0,error_1.createError)({statusCode:400,message:"Trade has expired"});try{null==n||n.step("Updating trade status to PAYMENT_SENT");let e=d.timeline||[];if("string"==typeof e)try{e=JSON.parse(e)}catch(t){console_1.logger.error("P2P_TRADE","Failed to parse timeline JSON",t);e=[]}Array.isArray(e)||(e=[]);e.push({event:"PAYMENT_CONFIRMED",message:"Buyer confirmed payment sent",userId:r.id,createdAt:(new Date).toISOString(),paymentReference:null==a?void 0:a.paymentReference});const t=d.status;await d.update({status:"PAYMENT_SENT",timeline:e,paymentConfirmedAt:new Date});await d.reload();if("PAYMENT_SENT"!==d.status){console_1.logger.error("P2P_TRADE",`Status update failed! Expected PAYMENT_SENT, got ${d.status}`);throw(0,error_1.createError)({statusCode:500,message:"Failed to update trade status"})}console_1.logger.info("P2P_TRADE",`Trade ${d.id} status updated: ${t} -> ${d.status}`);null==n||n.step("Logging activity and sending notifications");await db_1.models.p2pActivityLog.create({userId:r.id,type:"PAYMENT_CONFIRMED",action:"PAYMENT_CONFIRMED",relatedEntity:"TRADE",relatedEntityId:d.id,details:JSON.stringify({previousStatus:t,newStatus:d.status,paymentReference:null==a?void 0:a.paymentReference})});o(d.id,"PAYMENT_CONFIRMED",{buyerId:d.buyerId,sellerId:d.sellerId,amount:d.amount,currency:d.offer.currency}).catch(console.error);s(d.id,{type:"STATUS_CHANGE",data:{status:"PAYMENT_SENT",previousStatus:"PENDING",paymentConfirmedAt:d.paymentConfirmedAt,timeline:e}});null==n||n.success(`Payment confirmed for trade ${d.id.slice(0,8)}... (${d.amount} ${d.offer.currency})`);return{message:"Payment confirmed successfully.",trade:{id:d.id,status:d.status,paymentConfirmedAt:d.paymentConfirmedAt}}}catch(e){throw(0,error_1.createError)({statusCode:500,message:"Failed to confirm payment: "+e.message})}};