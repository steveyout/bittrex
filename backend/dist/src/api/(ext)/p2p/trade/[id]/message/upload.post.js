"use strict";async function ensureDirExists(e){try{await promises_1.default.access(e)}catch(t){if("ENOENT"!==t.code)throw t;await promises_1.default.mkdir(e,{recursive:!0})}}var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[r]}});Object.defineProperty(e,a,i)}:function(e,t,r,a){void 0===a&&(a=r);e[a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var e=function(t){e=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t};return e(t)};return function(t){if(t&&t.__esModule)return t;var r={};if(null!=t)for(var a=e(t),i=0;i<a.length;i++)"default"!==a[i]&&__createBinding(r,t,a[i]);__setModuleDefault(r,t);return r}}(),__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),sequelize_1=require("sequelize"),error_1=require("@b/utils/error"),uuid_1=require("uuid"),path_1=__importDefault(require("path")),promises_1=__importDefault(require("fs/promises")),sharp_1=__importDefault(require("sharp")),console_1=require("@b/utils/console"),isProduction="production"===process.env.NODE_ENV;exports.metadata={summary:"Upload Image in Trade Chat",description:"Uploads an image as a message attachment in the trade chat.",operationId:"uploadP2PTradeImage",tags:["P2P","Trade"],requiresAuth:!0,middleware:["p2pMessageRateLimit"],logModule:"P2P_MESSAGE",logTitle:"Upload trade message image",parameters:[{index:0,name:"id",in:"path",description:"Trade ID",required:!0,schema:{type:"string"}}],requestBody:{description:"File upload payload (base64 encoded)",required:!0,content:{"application/json":{schema:{type:"object",properties:{file:{type:"string",description:"Base64 encoded file data with mime type prefix"},filename:{type:"string",description:"Original filename"}},required:["file"]}}}},responses:{200:{description:"File uploaded successfully."},400:{description:"Bad request - Invalid file."},401:{description:"Unauthorized."},404:{description:"Trade not found."},500:{description:"Internal Server Error."}}};const generateFileUrl=e=>`/uploads/${e}`;exports.default=async e=>{var t;const{id:r}=e.params||{},{file:a,filename:i}=e.body,{user:s,ctx:o}=e;if(!(null==s?void 0:s.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});null==o||o.step("Validating file upload");if(!a)throw(0,error_1.createError)({statusCode:400,message:"No file provided"});const d=a.match(/^data:(.*);base64,(.*)$/);if(!d)throw(0,error_1.createError)({statusCode:400,message:"Invalid file format. Expected base64 encoded file."});const n=d[1],l=d[2];if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(n))throw(0,error_1.createError)({statusCode:400,message:"Invalid file type. Only images allowed: JPEG, PNG, GIF, WebP"});const u=Buffer.from(l,"base64");if(u.length>5242880)throw(0,error_1.createError)({statusCode:400,message:"File too large. Maximum size: 5MB"});const c=await db_1.models.p2pTrade.findOne({where:{id:r,[sequelize_1.Op.or]:[{buyerId:s.id},{sellerId:s.id}]},include:[{model:db_1.models.p2pOffer,as:"offer",attributes:["currency"]}]});if(!c)throw(0,error_1.createError)({statusCode:404,message:"Trade not found"});if(["COMPLETED","CANCELLED","EXPIRED"].includes(c.status))throw(0,error_1.createError)({statusCode:400,message:`Cannot send files on ${c.status.toLowerCase()} trades`});try{null==o||o.step("Processing and saving image");const e=isProduction?path_1.default.resolve(process.cwd(),"frontend","public"):path_1.default.resolve(process.cwd(),"..","frontend","public"),a=path_1.default.join(e,"uploads","p2p","trade",r);await ensureDirExists(a);let d=`${Date.now()}-${Math.round(1e9*Math.random())}`,l=u;if(n.includes("gif"))d+=".gif";else{l=await(0,sharp_1.default)(u).resize({width:1200,height:1200,fit:"inside"}).webp({quality:80}).toBuffer();d+=".webp"}const p=path_1.default.join(a,d);await promises_1.default.writeFile(p,l);const f=generateFileUrl(`p2p/trade/${r}/${d}`);null==o||o.step("Adding image message to trade timeline");let m=c.timeline||[];if("string"==typeof m)try{m=JSON.parse(m)}catch(e){console_1.logger.error("P2P_TRADE","Failed to parse timeline JSON",e);m=[]}Array.isArray(m)||(m=[]);const _=`![Image](${f})`,g={id:(0,uuid_1.v4)(),event:"MESSAGE",message:_,senderId:s.id,senderName:s.firstName||"User",createdAt:(new Date).toISOString(),attachment:{url:f,type:n,name:i||d,size:u.length}};m.push(g);await c.update({timeline:m,lastMessageAt:new Date});await db_1.models.p2pActivityLog.create({userId:s.id,type:"FILE_SENT",action:"FILE_SENT",relatedEntity:"TRADE",relatedEntityId:c.id,details:JSON.stringify({fileType:n,fileSize:u.length,recipientId:s.id===c.buyerId?c.sellerId:c.buyerId,timestamp:(new Date).toISOString()})});const{notifyTradeEvent:h}=await Promise.resolve().then(()=>__importStar(require("../../../utils/notifications")));h(c.id,"TRADE_MESSAGE",{buyerId:c.buyerId,sellerId:c.sellerId,amount:c.amount,currency:(null===(t=c.offer)||void 0===t?void 0:t.currency)||c.currency,senderId:s.id,hasAttachment:!0}).catch(console.error);const{broadcastP2PTradeEvent:y}=await Promise.resolve().then(()=>__importStar(require("../index.ws")));y(c.id,{type:"MESSAGE",data:{id:g.id,message:_,senderId:s.id,senderName:g.senderName,createdAt:g.createdAt,attachment:g.attachment}});null==o||o.success(`Uploaded ${n} to trade ${c.id.slice(0,8)}...`);return{message:"File uploaded successfully.",data:{id:g.id,message:_,createdAt:g.createdAt,senderId:s.id,senderName:g.senderName,attachment:g.attachment}}}catch(e){if(e.statusCode)throw e;throw(0,error_1.createError)({statusCode:500,message:"Failed to upload file: "+e.message})}};