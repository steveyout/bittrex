"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,t,a){void 0===a&&(a=t);var o=Object.getOwnPropertyDescriptor(r,t);o&&!("get"in o?!r.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return r[t]}});Object.defineProperty(e,a,o)}:function(e,r,t,a){void 0===a&&(a=t);e[a]=r[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(){var e=function(r){e=Object.getOwnPropertyNames||function(e){var r=[];for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(r[r.length]=t);return r};return e(r)};return function(r){if(r&&r.__esModule)return r;var t={};if(null!=r)for(var a=e(r),o=0;o<a.length;o++)"default"!==a[o]&&__createBinding(t,r,a[o]);__setModuleDefault(t,r);return t}}();Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),sequelize_1=require("sequelize"),error_1=require("@b/utils/error"),json_parser_1=require("@b/api/(ext)/p2p/utils/json-parser"),console_1=require("@b/utils/console"),wallet_1=require("@b/services/wallet");exports.metadata={summary:"Cancel Trade",description:"Cancels a trade with a provided cancellation reason.",operationId:"cancelP2PTrade",tags:["P2P","Trade"],requiresAuth:!0,logModule:"P2P_TRADE",logTitle:"Cancel trade",parameters:[{index:0,name:"id",in:"path",description:"Trade ID",required:!0,schema:{type:"string"}}],requestBody:{description:"Cancellation reason",required:!0,content:{"application/json":{schema:{type:"object",properties:{reason:{type:"string",description:"Reason for cancellation"}},required:["reason"]}}}},responses:{200:{description:"Trade cancelled successfully."},401:{description:"Unauthorized."},404:{description:"Trade not found."},500:{description:"Internal Server Error."}}};exports.default=async e=>{var r;const{id:t}=e.params||{},{reason:a}=e.body,{user:o,ctx:n}=e;if(!(null==o?void 0:o.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});null==n||n.step("Validating cancellation reason");const{validateTradeStatusTransition:i,sanitizeInput:s}=await Promise.resolve().then(()=>__importStar(require("../../utils/validation"))),{notifyTradeEvent:l}=await Promise.resolve().then(()=>__importStar(require("../../utils/notifications"))),{broadcastP2PTradeEvent:c}=await Promise.resolve().then(()=>__importStar(require("./index.ws"))),{sequelize:d}=await Promise.resolve().then(()=>__importStar(require("@b/db"))),{getWalletSafe:u}=await Promise.resolve().then(()=>__importStar(require("@b/api/finance/wallet/utils"))),f=s(a);if(!f||f.length<10)throw(0,error_1.createError)({statusCode:400,message:"Cancellation reason must be at least 10 characters"});null==n||n.step("Finding and locking trade");const p=await d.transaction();try{const e=await db_1.models.p2pTrade.findOne({where:{id:t,[sequelize_1.Op.or]:[{buyerId:o.id},{sellerId:o.id}]},include:[{model:db_1.models.p2pOffer,as:"offer",attributes:["currency","walletType","id","type"]}],lock:!0,transaction:p});if(!e){await p.rollback();throw(0,error_1.createError)({statusCode:404,message:"Trade not found"})}if(!i(e.status,"CANCELLED")){await p.rollback();throw(0,error_1.createError)({statusCode:400,message:`Cannot cancel trade from status: ${e.status}`})}if("PAYMENT_SENT"===e.status&&o.id===e.buyerId){await p.rollback();throw(0,error_1.createError)({statusCode:403,message:"Buyer cannot cancel after confirming payment. Please open a dispute instead."})}null==n||n.step("Processing fund unlocking and offer restoration");if(["PENDING","PAYMENT_SENT"].includes(e.status)){if("BUY"===e.offer.type){null==n||n.step(`Unlocking funds for BUY offer (${e.amount} ${e.offer.currency})`);const r=await u(e.sellerId,e.offer.walletType,e.offer.currency);if(r){const t=Math.min(e.amount,r.inOrder);if(t>0){const a=`p2p_cancel_release_${e.id}`;await wallet_1.walletService.release({idempotencyKey:a,userId:e.sellerId,walletId:r.id,walletType:e.offer.walletType,currency:e.offer.currency,amount:t,operationType:"P2P_TRADE_CANCEL",description:`Release ${t} ${e.offer.currency} - P2P trade cancelled`,metadata:{tradeId:e.id,offerId:e.offerId,cancelledBy:o.id,reason:f},transaction:p});console_1.logger.info("P2P_CANCEL",`Unlocked ${t} ${e.offer.currency} for seller ${e.sellerId} (BUY offer)`);t<e.amount&&console_1.logger.warn("P2P_CANCEL",`Partial unlock for trade ${e.id}: ${t}/${e.amount}`)}else console_1.logger.warn("P2P_CANCEL",`No funds to unlock for trade ${e.id} - inOrder is already 0`)}}else console_1.logger.info("P2P_CANCEL",`SELL offer - funds remain locked for offer ${e.offerId}`);if(e.offerId){const t=await db_1.models.p2pOffer.findByPk(e.offerId,{lock:!0,transaction:p});if(t&&["ACTIVE","PAUSED"].includes(t.status)){const a=(0,json_parser_1.parseAmountConfig)(t.amountConfig),o=null!==(r=a.originalTotal)&&void 0!==r?r:a.total+e.amount,n=o,i=a.total+e.amount,s=Math.min(i,n);if(s>a.total){await t.update({amountConfig:{...a,total:s,originalTotal:o}},{transaction:p});console_1.logger.info("P2P_CANCEL",`Restored offer ${t.id} amount: ${a.total} -> ${s}`)}else console_1.logger.debug("P2P_CANCEL",`Skipped offer ${t.id} restoration - at or above safe limit`)}}}let a=e.timeline||[];if("string"==typeof a)try{a=JSON.parse(a)}catch(e){console_1.logger.error("P2P_CANCEL",`Failed to parse timeline JSON: ${e}`);a=[]}Array.isArray(a)||(a=[]);a.push({event:"TRADE_CANCELLED",message:`Trade cancelled: ${f}`,userId:o.id,createdAt:(new Date).toISOString()});await e.update({status:"CANCELLED",cancelledBy:o.id,cancellationReason:f,cancelledAt:new Date,timeline:a},{transaction:p});await db_1.models.p2pActivityLog.create({userId:o.id,type:"TRADE_CANCELLED",action:"TRADE_CANCELLED",relatedEntity:"TRADE",relatedEntityId:e.id,details:JSON.stringify({previousStatus:e.status,reason:f,amount:e.amount,currency:e.offer.currency,counterpartyId:o.id===e.buyerId?e.sellerId:e.buyerId})},{transaction:p});await p.commit();null==n||n.success(`Cancelled trade ${e.id.slice(0,8)}... (${e.amount} ${e.offer.currency})`);l(e.id,"TRADE_CANCELLED",{buyerId:e.buyerId,sellerId:e.sellerId,amount:e.amount,currency:e.offer.currency,cancelledBy:o.id,reason:f}).catch(e=>console_1.logger.error("P2P_CANCEL",`Notification error: ${e}`));c(e.id,{type:"STATUS_CHANGE",data:{status:"CANCELLED",previousStatus:e.status,cancelledAt:e.cancelledAt,cancellationReason:f,cancelledBy:o.id}});return{message:"Trade cancelled successfully.",trade:{id:e.id,status:"CANCELLED",cancelledAt:e.cancelledAt,cancellationReason:f}}}catch(e){await p.rollback();if(e.statusCode)throw e;throw(0,error_1.createError)({statusCode:500,message:"Failed to cancel trade: "+e.message})}};