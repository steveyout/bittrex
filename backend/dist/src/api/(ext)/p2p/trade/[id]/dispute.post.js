"use strict";function determinePriority(e,t){return["FRAUDULENT_ACTIVITY","PAYMENT_NOT_RECEIVED"].includes(e)||t>1e3?"HIGH":t>100?"MEDIUM":"LOW"}var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var a=Object.getOwnPropertyDescriptor(t,r);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[r]}});Object.defineProperty(e,i,a)}:function(e,t,r,i){void 0===i&&(i=r);e[i]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var e=function(t){e=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t};return e(t)};return function(t){if(t&&t.__esModule)return t;var r={};if(null!=t)for(var i=e(t),a=0;a<i.length;a++)"default"!==i[a]&&__createBinding(r,t,i[a]);__setModuleDefault(r,t);return r}}();Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),sequelize_1=require("sequelize"),error_1=require("@b/utils/error"),console_1=require("@b/utils/console");exports.metadata={summary:"Dispute Trade",description:"Creates a dispute for a trade by providing a reason and description.",operationId:"disputeP2PTrade",tags:["P2P","Trade"],requiresAuth:!0,middleware:["p2pDisputeCreateRateLimit"],logModule:"P2P_DISPUTE",logTitle:"Create dispute",parameters:[{index:0,name:"id",in:"path",description:"Trade ID",required:!0,schema:{type:"string",format:"uuid"}}],requestBody:{description:"Dispute details",required:!0,content:{"application/json":{schema:{type:"object",properties:{reason:{type:"string",enum:["PAYMENT_NOT_RECEIVED","PAYMENT_INCORRECT_AMOUNT","CRYPTO_NOT_RELEASED","SELLER_UNRESPONSIVE","BUYER_UNRESPONSIVE","FRAUDULENT_ACTIVITY","TERMS_VIOLATION","OTHER"]},description:{type:"string",minLength:20,maxLength:1e3},evidence:{type:"array",items:{type:"object",properties:{type:{type:"string",enum:["screenshot","document","text"]},content:{type:"string"},description:{type:"string"}}},maxItems:5}},required:["reason","description"]}}}},responses:{200:{description:"Dispute created successfully."},400:{description:"Bad Request - Invalid dispute data."},401:{description:"Unauthorized."},404:{description:"Trade not found."},409:{description:"Conflict - Trade already disputed."},500:{description:"Internal Server Error."}}};exports.default=async e=>{const{id:t}=e.params||{},{reason:r,description:i,evidence:a}=e.body,{user:s,ctx:d}=e;if(!(null==s?void 0:s.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});null==d||d.step("Validating dispute details");const{validateDisputeReason:n,sanitizeInput:o,validateTradeStatusTransition:u}=await Promise.resolve().then(()=>__importStar(require("../../utils/validation"))),{notifyTradeEvent:c}=await Promise.resolve().then(()=>__importStar(require("../../utils/notifications"))),{broadcastP2PTradeEvent:p}=await Promise.resolve().then(()=>__importStar(require("./index.ws"))),l=n(r),m=o(i);if(!m||m.length<20)throw(0,error_1.createError)({statusCode:400,message:"Dispute description must be at least 20 characters"});null==d||d.step("Finding and locking trade");const _=await db_1.sequelize.transaction();let f=!1;try{const e=await db_1.models.p2pTrade.findOne({where:{id:t,[sequelize_1.Op.or]:[{buyerId:s.id},{sellerId:s.id}]},include:[{model:db_1.models.p2pOffer,as:"offer",attributes:["currency","type"]}],lock:!0,transaction:_});if(!e)throw(0,error_1.createError)({statusCode:404,message:"Trade not found"});if(!u(e.status,"DISPUTED"))throw(0,error_1.createError)({statusCode:400,message:`Cannot dispute trade with status: ${e.status}`});if("COMPLETED"===e.status&&e.completedAt){const t=6048e5;if(Date.now()-new Date(e.completedAt).getTime()>t)throw(0,error_1.createError)({statusCode:400,message:"Dispute time limit exceeded (7 days after completion)"})}if(await db_1.models.p2pDispute.findOne({where:{tradeId:e.id,status:{[sequelize_1.Op.ne]:"RESOLVED"}},transaction:_}))throw(0,error_1.createError)({statusCode:409,message:"Trade is already under dispute"});null==d||d.step(`Creating dispute record (reason: ${l})`);const r=e.buyerId===s.id?e.sellerId:e.buyerId,i=await db_1.models.p2pDispute.create({tradeId:t,amount:(e.amount||0).toString(),reportedById:s.id,againstId:r,reason:l,details:m,filedOn:new Date,status:"PENDING",priority:determinePriority(l,e.amount),evidence:a||[],metadata:{tradeAmount:e.amount,tradeCurrency:e.offer.currency,tradeType:e.offer.type,originalTradeStatus:e.status}},{transaction:_});let n=e.timeline||[];if("string"==typeof n)try{n=JSON.parse(n)}catch(e){console_1.logger.error("P2P_TRADE","Failed to parse timeline JSON",e);n=[]}Array.isArray(n)||(n=[]);n.push({event:"DISPUTE_OPENED",message:`Dispute opened: ${l}`,userId:s.id,disputeId:i.id,createdAt:(new Date).toISOString()});await e.update({status:"DISPUTED",timeline:n,disputedAt:new Date},{transaction:_});await db_1.models.p2pActivityLog.create({userId:s.id,type:"DISPUTE_CREATED",action:"DISPUTE_CREATED",relatedEntity:"DISPUTE",relatedEntityId:i.id,details:JSON.stringify({tradeId:e.id,reason:l,againstId:r})},{transaction:_});await _.commit();f=!0;null==d||d.success(`Created dispute for trade ${e.id.slice(0,8)}... (${l})`);c(e.id,"TRADE_DISPUTED",{buyerId:e.buyerId,sellerId:e.sellerId,amount:e.amount,currency:e.offer.currency,reason:l,disputeId:i.id}).catch(console.error);p(e.id,{type:"DISPUTE",data:{status:"DISPUTED",previousStatus:e.status,disputeId:i.id,reason:l,filedBy:s.id}});return{message:"Dispute created successfully.",disputeId:i.id,dispute:{id:i.id,tradeId:i.tradeId,reason:i.reason,status:i.status,priority:i.priority,createdAt:i.filedOn}}}catch(e){f||await _.rollback();if(e.statusCode)throw e;throw(0,error_1.createError)({statusCode:500,message:"Failed to create dispute: "+e.message})}};