"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,t,a){void 0===a&&(a=t);var o=Object.getOwnPropertyDescriptor(r,t);o&&!("get"in o?!r.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return r[t]}});Object.defineProperty(e,a,o)}:function(e,r,t,a){void 0===a&&(a=t);e[a]=r[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(){var e=function(r){e=Object.getOwnPropertyNames||function(e){var r=[];for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(r[r.length]=t);return r};return e(r)};return function(r){if(r&&r.__esModule)return r;var t={};if(null!=r)for(var a=e(r),o=0;o<a.length;o++)"default"!==a[o]&&__createBinding(t,r,a[o]);__setModuleDefault(t,r);return t}}();Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),console_1=require("@b/utils/console"),wallet_1=require("@b/services/wallet"),affiliate_1=require("@b/utils/affiliate");exports.metadata={summary:"Release Funds for Trade",description:"Releases funds and updates the trade status to 'COMPLETED' for the authenticated seller.",operationId:"releaseP2PTradeFunds",tags:["P2P","Trade"],requiresAuth:!0,logModule:"P2P_TRADE",logTitle:"Release funds",parameters:[{index:0,name:"id",in:"path",description:"Trade ID",required:!0,schema:{type:"string"}}],responses:{200:{description:"Funds released successfully."},401:{description:"Unauthorized."},404:{description:"Trade not found."},500:{description:"Internal Server Error."}}};exports.default=async e=>{const{id:r}=e.params||{},{user:t,ctx:a}=e;if(!(null==t?void 0:t.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});null==a||a.step("Checking idempotency and validating trade");const{validateTradeStatusTransition:o}=await Promise.resolve().then(()=>__importStar(require("../../utils/validation"))),{notifyTradeEvent:i}=await Promise.resolve().then(()=>__importStar(require("../../utils/notifications"))),{broadcastP2PTradeEvent:s}=await Promise.resolve().then(()=>__importStar(require("./index.ws"))),{sequelize:n}=await Promise.resolve().then(()=>__importStar(require("@b/db"))),{getWalletSafe:l}=await Promise.resolve().then(()=>__importStar(require("@b/api/finance/wallet/utils"))),{RedisSingleton:d}=await Promise.resolve().then(()=>__importStar(require("@b/utils/redis"))),{createP2PAuditLog:c,P2PAuditEventType:u,P2PRiskLevel:f}=await Promise.resolve().then(()=>__importStar(require("../../utils/audit"))),m=`p2p:release:${r}:${t.id}`,p=d.getInstance();try{const e=await p.get(m);if(e)return JSON.parse(e);const r=`${m}:lock`;if(!await p.set(r,"1","EX",30,"NX"))throw(0,error_1.createError)({statusCode:409,message:"Operation already in progress. Please try again."})}catch(e){console_1.logger.error("P2P","Redis error in idempotency check",e)}const y=await n.transaction({isolationLevel:n.constructor.Transaction.ISOLATION_LEVELS.SERIALIZABLE});try{const e=await db_1.models.p2pTrade.findOne({where:{id:r,sellerId:t.id},include:[{model:db_1.models.p2pOffer,as:"offer",attributes:["currency","walletType"]}],lock:!0,transaction:y});if(!e){await y.rollback();throw(0,error_1.createError)({statusCode:404,message:"Trade not found"})}if(["COMPLETED","DISPUTED","CANCELLED","EXPIRED"].includes(e.status)){await y.rollback();throw(0,error_1.createError)({statusCode:400,message:`Funds already released or trade is in final state: ${e.status}`})}if(!o(e.status,"COMPLETED")){await y.rollback();throw(0,error_1.createError)({statusCode:400,message:`Cannot release funds from status: ${e.status}`})}null==a||a.step("Processing fund transfer from seller to buyer");if("PAYMENT_SENT"===e.status){const r=await l(e.sellerId,e.offer.walletType,e.offer.currency);if(!r){await y.rollback();throw(0,error_1.createError)({statusCode:500,message:"Seller wallet not found"})}if(r.inOrder<e.amount){await y.rollback();throw(0,error_1.createError)({statusCode:400,message:"Insufficient locked funds available to release"})}const o=parseFloat(e.escrowFee||"0"),i=Math.min(o,e.amount),s=Math.max(0,e.amount-i),n=`p2p_release_${e.id}`;null==a||a.step(`Releasing ${e.amount} ${e.offer.currency} from seller's escrow`);await wallet_1.walletService.executeFromHold({idempotencyKey:`${n}_seller_execute`,userId:e.sellerId,walletId:r.id,walletType:e.offer.walletType,currency:e.offer.currency,amount:e.amount,operationType:"P2P_TRADE_RELEASE",fee:i,description:`P2P trade release #${e.id}`,metadata:{tradeId:e.id,buyerId:e.buyerId,escrowFee:o},transaction:y});await c({userId:t.id,eventType:u.FUNDS_UNLOCKED,entityType:"WALLET",entityId:r.id,metadata:{tradeId:e.id,amount:e.amount,currency:e.offer.currency,platformFee:i},riskLevel:f.HIGH});null==a||a.step(`Transferring ${s} ${e.offer.currency} to buyer`);const d=await wallet_1.walletCreationService.getOrCreateWallet(e.buyerId,e.offer.walletType,e.offer.currency);await wallet_1.walletService.credit({idempotencyKey:`${n}_buyer_credit`,userId:e.buyerId,walletId:d.id,walletType:e.offer.walletType,currency:e.offer.currency,amount:s,operationType:"P2P_TRADE_RECEIVE",description:`P2P trade receive #${e.id}`,metadata:{tradeId:e.id,sellerId:e.sellerId,originalAmount:e.amount,platformFee:i},transaction:y});await c({userId:t.id,eventType:u.FUNDS_TRANSFERRED,entityType:"TRADE",entityId:e.id,metadata:{fromUserId:e.sellerId,toUserId:e.buyerId,requestedAmount:e.amount,buyerNetAmount:s,platformFee:i,escrowFee:o,currency:e.offer.currency,walletType:e.offer.walletType},riskLevel:f.CRITICAL});if(i>0){const r=await db_1.models.user.findOne({include:[{model:db_1.models.role,as:"role",where:{name:"Super Admin"}}],order:[["createdAt","ASC"]],transaction:y});if(r){await db_1.models.p2pCommission.create({adminId:r.id,amount:i,description:`P2P escrow fee for trade #${e.id.slice(0,8)}... - ${e.amount} ${e.offer.currency}`,tradeId:e.id},{transaction:y});console_1.logger.debug("P2P",`Platform commission recorded: tradeId=${e.id}, adminId=${r.id}, fee=${i} ${e.offer.currency}`)}else console_1.logger.warn("P2P","No super admin found to assign commission")}console_1.logger.info("P2P",`Funds transferred: tradeId=${e.id}, seller=${e.sellerId}, buyer=${e.buyerId}, ${e.offer.walletType} ${e.offer.currency}, amount=${e.amount}, fee=${i}, buyerReceives=${s}`)}null==a||a.step("Updating trade status to COMPLETED");let n=e.timeline||[];if("string"==typeof n)try{n=JSON.parse(n)}catch(e){console_1.logger.error("P2P","Failed to parse timeline JSON",e);n=[]}Array.isArray(n)||(n=[]);n.push({event:"FUNDS_RELEASED",message:"Seller released funds - Trade completed",userId:t.id,createdAt:(new Date).toISOString()});const d=e.status,_=new Date;await e.update({status:"COMPLETED",timeline:n,completedAt:_},{transaction:y});await db_1.models.p2pActivityLog.create({userId:t.id,type:"TRADE_COMPLETED",action:"TRADE_COMPLETED",relatedEntity:"TRADE",relatedEntityId:e.id,details:JSON.stringify({previousStatus:d,amount:e.amount,currency:e.offer.currency})},{transaction:y});await y.commit();i(e.id,"TRADE_COMPLETED",{buyerId:e.buyerId,sellerId:e.sellerId,amount:e.amount,currency:e.offer.currency}).catch(e=>console_1.logger.error("P2P","Failed to notify trade event",e));s(e.id,{type:"STATUS_CHANGE",data:{status:"COMPLETED",previousStatus:d,completedAt:_,timeline:n}});const w={message:"Funds released successfully. Trade completed.",trade:{id:e.id,status:"COMPLETED",completedAt:_}};null==a||a.success(`Released funds for trade ${e.id.slice(0,8)}... (${e.amount} ${e.offer.currency})`);try{await(0,affiliate_1.processRewards)(e.buyerId,e.amount,"P2P_TRADE",e.offer.currency);await(0,affiliate_1.processRewards)(e.sellerId,e.amount,"P2P_TRADE_COMPLETION",e.offer.currency)}catch(e){console_1.logger.error("P2P","Failed to process affiliate rewards",e)}try{await p.setex(m,3600,JSON.stringify(w));await p.del(`${m}:lock`)}catch(e){console_1.logger.error("P2P","Redis error in caching result",e)}return w}catch(e){await y.rollback();try{await p.del(`${m}:lock`)}catch(e){console_1.logger.error("P2P","Redis error in releasing lock",e)}if(e.statusCode)throw e;throw(0,error_1.createError)({statusCode:500,message:"Failed to release funds: "+e.message})}};