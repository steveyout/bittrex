"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),sequelize_1=require("sequelize"),query_1=require("@b/utils/query"),console_1=require("@b/utils/console"),error_1=require("@b/utils/error");exports.metadata={summary:"Get Trade Messages",description:"Retrieves messages (stored in timeline) for the specified trade.",operationId:"getP2PTradeMessages",tags:["P2P","Trade"],logModule:"P2P",logTitle:"Get trade messages",parameters:[{index:0,name:"id",in:"path",description:"Trade ID",required:!0,schema:{type:"string"}}],responses:{200:{description:"Trade messages retrieved successfully."},401:query_1.unauthorizedResponse,404:{description:"Trade not found."},500:query_1.serverErrorResponse},requiresAuth:!0};exports.default=async e=>{const{id:r}=e.params||{},{user:s,ctx:t}=e;if(!(null==s?void 0:s.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});null==t||t.step("Fetching trade messages");try{const e=await db_1.models.p2pTrade.findOne({where:{id:r,[sequelize_1.Op.or]:[{buyerId:s.id},{sellerId:s.id}]},raw:!0});if(!e)return{error:"Trade not found"};let a=e.timeline||[];if("string"==typeof a)try{a=JSON.parse(a)}catch(e){console_1.logger.error("P2P_TRADE","Failed to parse timeline JSON",e);a=[]}const i=Array.isArray(a)?a.filter(e=>"MESSAGE"===e.event).map(e=>({id:e.id||e.createdAt,message:e.message,senderId:e.senderId,senderName:e.senderName||"User",isAdminMessage:e.isAdminMessage||!1,createdAt:e.createdAt})):[];null==t||t.success(`Retrieved ${i.length} messages for trade ${r.slice(0,8)}...`);return i}catch(e){null==t||t.fail(e.message||"Failed to retrieve trade messages");throw(0,error_1.createError)({statusCode:500,message:"Internal Server Error: "+e.message})}};