"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r);var a=Object.getOwnPropertyDescriptor(t,r);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[r]}});Object.defineProperty(e,s,a)}:function(e,t,r,s){void 0===s&&(s=r);e[s]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var e=function(t){e=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t};return e(t)};return function(t){if(t&&t.__esModule)return t;var r={};if(null!=t)for(var s=e(t),a=0;a<s.length;a++)"default"!==s[a]&&__createBinding(r,t,s[a]);__setModuleDefault(r,t);return r}}();Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),sequelize_1=require("sequelize"),error_1=require("@b/utils/error"),uuid_1=require("uuid"),console_1=require("@b/utils/console");exports.metadata={summary:"Send Trade Message",description:"Sends a message within a trade (appended to the timeline).",operationId:"sendP2PTradeMessage",tags:["P2P","Trade"],requiresAuth:!0,middleware:["p2pMessageRateLimit"],logModule:"P2P_MESSAGE",logTitle:"Send trade message",parameters:[{index:0,name:"id",in:"path",description:"Trade ID",required:!0,schema:{type:"string"}}],requestBody:{description:"Message payload",required:!0,content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}},required:["message"]}}}},responses:{200:{description:"Message sent successfully."},401:{description:"Unauthorized."},404:{description:"Trade not found."},500:{description:"Internal Server Error."}}};exports.default=async e=>{const{id:t}=e.params||{},{message:r}=e.body,{user:s,ctx:a}=e;if(!(null==s?void 0:s.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});null==a||a.step("Validating message content");const{validateMessage:i}=await Promise.resolve().then(()=>__importStar(require("../../../utils/validation"))),{notifyTradeEvent:n}=await Promise.resolve().then(()=>__importStar(require("../../../utils/notifications"))),{broadcastP2PTradeEvent:d}=await Promise.resolve().then(()=>__importStar(require("../index.ws"))),o=i(r);null==a||a.step("Finding trade and checking permissions");const u=await db_1.models.p2pTrade.findOne({where:{id:t,[sequelize_1.Op.or]:[{buyerId:s.id},{sellerId:s.id}]},include:[{model:db_1.models.p2pOffer,as:"offer",attributes:["currency"]}]});if(!u)throw(0,error_1.createError)({statusCode:404,message:"Trade not found"});if(["COMPLETED","CANCELLED","EXPIRED"].includes(u.status))throw(0,error_1.createError)({statusCode:400,message:`Cannot send messages on ${u.status.toLowerCase()} trades`});try{null==a||a.step("Adding message to trade timeline");let e=u.timeline||[];if("string"==typeof e)try{e=JSON.parse(e)}catch(t){console_1.logger.error("P2P_TRADE","Failed to parse timeline JSON",t);e=[]}Array.isArray(e)||(e=[]);const t={id:(0,uuid_1.v4)(),event:"MESSAGE",message:o,senderId:s.id,senderName:s.firstName||"User",createdAt:(new Date).toISOString()};e.push(t);await u.update({timeline:e,lastMessageAt:new Date});await db_1.models.p2pActivityLog.create({userId:s.id,type:"MESSAGE_SENT",action:"MESSAGE_SENT",relatedEntity:"TRADE",relatedEntityId:u.id,details:JSON.stringify({messageLength:o.length,recipientId:s.id===u.buyerId?u.sellerId:u.buyerId,timestamp:(new Date).toISOString()})});n(u.id,"TRADE_MESSAGE",{buyerId:u.buyerId,sellerId:u.sellerId,amount:u.amount,currency:u.offer.currency,senderId:s.id}).catch(console.error);d(u.id,{type:"MESSAGE",data:{id:t.id,message:o,senderId:s.id,senderName:t.senderName,createdAt:t.createdAt}});null==a||a.success(`Sent message in trade ${u.id.slice(0,8)}...`);return{message:"Message sent successfully.",data:{id:t.id,message:o,createdAt:t.createdAt,senderId:s.id,senderName:t.senderName}}}catch(e){if(e.statusCode)throw e;throw(0,error_1.createError)({statusCode:500,message:"Failed to send message: "+e.message})}};