"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[r]}});Object.defineProperty(e,a,i)}:function(e,t,r,a){void 0===a&&(a=r);e[a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var e=function(t){e=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t};return e(t)};return function(t){if(t&&t.__esModule)return t;var r={};if(null!=t)for(var a=e(t),i=0;i<a.length;i++)"default"!==a[i]&&__createBinding(r,t,a[i]);__setModuleDefault(r,t);return r}}();Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),sequelize_1=require("sequelize"),query_1=require("@b/utils/query"),error_1=require("@b/utils/error");exports.metadata={summary:"Get Trade by ID",description:"Retrieves detailed trade data for the given trade ID.",operationId:"getP2PTradeById",tags:["P2P","Trade"],logModule:"P2P",logTitle:"Get trade by ID",parameters:[{index:0,name:"id",in:"path",description:"Trade ID",required:!0,schema:{type:"string"}}],responses:{200:{description:"Trade retrieved successfully."},401:query_1.unauthorizedResponse,404:{description:"Trade not found."},500:query_1.serverErrorResponse},requiresAuth:!0};exports.default=async e=>{var t,r,a,i,s;const{id:o}=e.params||{},{user:n,ctx:d}=e;if(!(null==n?void 0:n.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});null==d||d.step("Verifying trade access");try{const e=await db_1.models.p2pTrade.findOne({where:{id:o},attributes:["id","buyerId","sellerId"]});if(!e)throw(0,error_1.createError)({statusCode:404,message:"Trade not found"});if(!(e.buyerId===n.id||e.sellerId===n.id))throw(0,error_1.createError)({statusCode:403,message:"You don't have permission to view this trade"});null==d||d.step("Fetching trade details with counterparty info");const l=await db_1.models.p2pTrade.findOne({where:{id:o},include:[{association:"buyer",attributes:["id","firstName","lastName","email","avatar"]},{association:"seller",attributes:["id","firstName","lastName","email","avatar"]},{association:"dispute"},{association:"paymentMethodDetails",attributes:["id","name","icon","processingTime","instructions"],required:!1},{association:"offer",attributes:["id","currency","priceCurrency","walletType","type","tradeSettings"],required:!1}]});if(!l)throw(0,error_1.createError)({statusCode:404,message:"Trade not found"});const u=l.toJSON(),c=async e=>{const t=await db_1.models.p2pTrade.count({where:{[sequelize_1.Op.or]:[{buyerId:e},{sellerId:e}],status:{[sequelize_1.Op.in]:["COMPLETED","DISPUTE_RESOLVED","CANCELLED","EXPIRED"]}}}),r=await db_1.models.p2pTrade.count({where:{[sequelize_1.Op.or]:[{buyerId:e},{sellerId:e}],status:"COMPLETED"}});return{completedTrades:r,completionRate:t>0?Math.round(r/t*100):100}};if(u.buyer){u.buyer.name=`${u.buyer.firstName||""} ${u.buyer.lastName||""}`.trim();const e=await c(u.buyer.id);u.buyer.completedTrades=e.completedTrades;u.buyer.completionRate=e.completionRate}if(u.seller){u.seller.name=`${u.seller.firstName||""} ${u.seller.lastName||""}`.trim();const e=await c(u.seller.id);u.seller.completedTrades=e.completedTrades;u.seller.completionRate=e.completionRate}if(u.paymentDetails&&"string"==typeof u.paymentDetails)try{u.paymentDetails=JSON.parse(u.paymentDetails)}catch(e){}if(u.timeline&&"string"==typeof u.timeline)try{u.timeline=JSON.parse(u.timeline)}catch(e){}if((null===(t=u.offer)||void 0===t?void 0:t.tradeSettings)&&"string"==typeof u.offer.tradeSettings)try{u.offer.tradeSettings=JSON.parse(u.offer.tradeSettings)}catch(e){}const{CacheManager:p}=await Promise.resolve().then(()=>__importStar(require("@b/utils/cache"))),f=p.getInstance(),m=await f.getSetting("p2pDefaultPaymentWindow")||240;u.paymentWindow=(null===(a=null===(r=u.offer)||void 0===r?void 0:r.tradeSettings)||void 0===a?void 0:a.autoCancel)||(null===(s=null===(i=u.offer)||void 0===i?void 0:i.tradeSettings)||void 0===s?void 0:s.paymentWindow)||m;null==d||d.success(`Retrieved trade ${o.slice(0,8)}... (${u.status})`);return u}catch(e){null==d||d.fail(e.message||"Failed to retrieve trade");throw(0,error_1.createError)({statusCode:500,message:e.message||"Internal Server Error"})}};