"use strict";function broadcastP2PTradeEvent(e,t){exports.p2pTradeHandler.broadcastEvent(e,t)}var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}});Object.defineProperty(e,a,s)}:function(e,t,r,a){void 0===a&&(a=r);e[a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var e=function(t){e=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t};return e(t)};return function(t){if(t&&t.__esModule)return t;var r={};if(null!=t)for(var a=e(t),s=0;s<a.length;s++)"default"!==a[s]&&__createBinding(r,t,a[s]);__setModuleDefault(r,t);return r}}();Object.defineProperty(exports,"__esModule",{value:!0});exports.onClose=exports.p2pTradeHandler=exports.metadata=void 0;exports.broadcastP2PTradeEvent=broadcastP2PTradeEvent;const Websocket_1=require("@b/handler/Websocket"),db_1=require("@b/db"),sequelize_1=require("sequelize"),console_1=require("@b/utils/console");exports.metadata={requiresAuth:!0};class P2PTradeDataHandler{constructor(){this.activeSubscriptions=new Map}static getInstance(){P2PTradeDataHandler.instance||(P2PTradeDataHandler.instance=new P2PTradeDataHandler);return P2PTradeDataHandler.instance}async getCounterpartyStats(e){const t=await db_1.models.p2pTrade.count({where:{[sequelize_1.Op.or]:[{buyerId:e},{sellerId:e}],status:{[sequelize_1.Op.in]:["COMPLETED","DISPUTE_RESOLVED","CANCELLED","EXPIRED"]}}}),r=await db_1.models.p2pTrade.count({where:{[sequelize_1.Op.or]:[{buyerId:e},{sellerId:e}],status:"COMPLETED"}});return{completedTrades:r,completionRate:t>0?Math.round(r/t*100):100}}async sendInitialData(e,t,r=!1){var a,s,i,n;try{const o=r?{id:e}:{id:e,[sequelize_1.Op.or]:[{buyerId:t},{sellerId:t}]},d=await db_1.models.p2pTrade.findOne({where:o,include:[{association:"buyer",attributes:["id","firstName","lastName","email","avatar"]},{association:"seller",attributes:["id","firstName","lastName","email","avatar"]},{association:"dispute"},{association:"paymentMethodDetails",attributes:["id","name","icon","processingTime","instructions"],required:!1},{association:"offer",attributes:["id","currency","priceCurrency","walletType","type","tradeSettings"],required:!1}]});if(!d){console_1.logger.warn("P2P_WS",`Trade ${e} not found or user ${t} not authorized`);return}const c=d.toJSON();if(c.buyer){c.buyer.name=`${c.buyer.firstName||""} ${c.buyer.lastName||""}`.trim();const e=await this.getCounterpartyStats(c.buyer.id);c.buyer.completedTrades=e.completedTrades;c.buyer.completionRate=e.completionRate}if(c.seller){c.seller.name=`${c.seller.firstName||""} ${c.seller.lastName||""}`.trim();const e=await this.getCounterpartyStats(c.seller.id);c.seller.completedTrades=e.completedTrades;c.seller.completionRate=e.completionRate}const{CacheManager:l}=await Promise.resolve().then(()=>__importStar(require("@b/utils/cache"))),u=l.getInstance(),p=await u.getSetting("p2pDefaultPaymentWindow")||240;c.paymentWindow=(null===(s=null===(a=c.offer)||void 0===a?void 0:a.tradeSettings)||void 0===s?void 0:s.autoCancel)||(null===(n=null===(i=c.offer)||void 0===i?void 0:i.tradeSettings)||void 0===n?void 0:n.paymentWindow)||p;let m=c.timeline||[];if("string"==typeof m)try{m=JSON.parse(m)}catch(e){console_1.logger.error("P2P_WS",`Failed to parse timeline JSON: ${e}`);m=[]}c.timeline=m;const b=Array.isArray(m)?m.filter(e=>"MESSAGE"===e.event).map(e=>({id:e.id||e.createdAt,message:e.message,senderId:e.senderId,senderName:e.senderName||"User",isAdminMessage:e.isAdminMessage||!1,createdAt:e.createdAt})):[];Websocket_1.messageBroker.broadcastToSubscribedClients(`/api/p2p/trade/${e}`,{tradeId:e,userId:t},{stream:"p2p-trade-data",data:{...c,messages:b}})}catch(t){console_1.logger.error("P2P_WS",`Error sending initial data for trade ${e}: ${t}`)}}async isAdmin(e){try{const t=await db_1.models.user.findByPk(e,{include:[{model:db_1.models.role,as:"role",include:[{model:db_1.models.permission,as:"permissions",through:{attributes:[]}}]}]});if(!t||!t.role)return!1;const r=t.role.permissions||[];return r.some(e=>"view.p2p.trade"===e.name||"edit.p2p.trade"===e.name||"view.p2p.dispute"===e.name||"edit.p2p.dispute"===e.name||"Access P2P Trade Management"===e.name||"Access P2P Dispute Management"===e.name)}catch(e){console_1.logger.error("P2P_WS",`Error checking admin status: ${e}`);return!1}}async addSubscription(e,t,r=!1){if(!e||!t){console_1.logger.warn("P2P_WS","No tradeId or userId provided in subscription request");return}const a=r||await this.isAdmin(t);let s;s=a?await db_1.models.p2pTrade.findByPk(e,{attributes:["id"]}):await db_1.models.p2pTrade.findOne({where:{id:e,[sequelize_1.Op.or]:[{buyerId:t},{sellerId:t}]},attributes:["id"]});if(s){this.activeSubscriptions.has(e)||this.activeSubscriptions.set(e,new Set);this.activeSubscriptions.get(e).add(t);await this.sendInitialData(e,t,a);console_1.logger.info("P2P_WS",`${a?"Admin":"User"} ${t} subscribed to trade ${e}`)}else console_1.logger.warn("P2P_WS",`Trade ${e} not found or user ${t} not authorized`)}removeSubscription(e,t){if(this.activeSubscriptions.has(e)){this.activeSubscriptions.get(e).delete(t);0===this.activeSubscriptions.get(e).size&&this.activeSubscriptions.delete(e);console_1.logger.debug("P2P_WS",`User ${t} unsubscribed from trade ${e}`)}}broadcastEvent(e,t){const r=this.activeSubscriptions.get(e);if(r&&0!==r.size)for(const a of r)Websocket_1.messageBroker.broadcastToSubscribedClients(`/api/p2p/trade/${e}`,{tradeId:e,userId:a},{stream:"p2p-trade-event",data:{tradeId:e,timestamp:(new Date).toISOString(),...t}})}hasSubscribers(e){const t=this.activeSubscriptions.get(e);return!!t&&t.size>0}removeClientFromAllSubscriptions(e){const t=[];for(const[r,a]of this.activeSubscriptions)if(a.has(e)){a.delete(e);0===a.size&&t.push(r)}for(const e of t)this.activeSubscriptions.delete(e);t.length>0&&console_1.logger.debug("P2P_WS",`Cleaned up subscriptions for disconnected client ${e}`)}}exports.p2pTradeHandler=P2PTradeDataHandler.getInstance();exports.default=async(e,t)=>{var r;"string"==typeof t&&(t=JSON.parse(t));const{action:a,payload:s}=t,{tradeId:i,isAdmin:n}=s||{},o=null===(r=e.user)||void 0===r?void 0:r.id;if(!o){console_1.logger.error("P2P_WS","No user ID found - authentication required");return}if(!i){console_1.logger.error("P2P_WS","No tradeId in payload");return}const d=P2PTradeDataHandler.getInstance();"SUBSCRIBE"===a?await d.addSubscription(i,o,!0===n):"UNSUBSCRIBE"===a&&d.removeSubscription(i,o)};const onClose=(e,t,r)=>{P2PTradeDataHandler.getInstance().removeClientFromAllSubscriptions(r)};exports.onClose=onClose;