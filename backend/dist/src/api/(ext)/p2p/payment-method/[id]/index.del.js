"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),query_1=require("@b/utils/query"),sequelize_1=require("sequelize");exports.metadata={summary:"Delete Payment Method",description:"Deletes an existing custom payment method by its ID. Prevents deletion if the payment method is being used by active offers or ongoing trades.",operationId:"deletePaymentMethod",tags:["P2P","Payment Method"],logModule:"P2P",logTitle:"Delete payment method",requiresAuth:!0,parameters:[{index:0,name:"id",in:"path",description:"Payment Method ID",required:!0,schema:{type:"string"}}],responses:{200:{description:"Payment method deleted successfully."},400:{description:"Cannot delete payment method that is being used by active offers or ongoing trades."},401:{description:"Unauthorized."},404:{description:"Payment method not found or not owned by user."},500:query_1.serverErrorResponse}};exports.default=async e=>{const{params:t,user:r,ctx:s}=e,o=null==t?void 0:t.id;if(!(null==r?void 0:r.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});null==s||s.step("Finding and validating payment method ownership");try{const e=await db_1.models.p2pPaymentMethod.findByPk(o);if(!e)throw(0,error_1.createError)({statusCode:404,message:"Payment method not found"});if(!e.userId||e.userId!==r.id)throw(0,error_1.createError)({statusCode:401,message:"Unauthorized - you can only delete your own payment methods"});const t=await db_1.models.p2pOffer.findAll({include:[{model:db_1.models.p2pPaymentMethod,as:"paymentMethods",where:{id:e.id},attributes:["id"],through:{attributes:[]}}],where:{status:{[sequelize_1.Op.in]:["ACTIVE","PENDING_APPROVAL","PAUSED"]}},attributes:["id","status"]});if(t.length>0)throw(0,error_1.createError)({statusCode:400,message:`Cannot delete payment method. It is currently being used by ${t.length} active offer(s). Please remove this payment method from these offers first.`});const a=await db_1.models.p2pTrade.findAll({where:{paymentMethod:o,status:{[sequelize_1.Op.in]:["PENDING","PAYMENT_SENT","DISPUTED"]}},attributes:["id","status"]});if(a.length>0)throw(0,error_1.createError)({statusCode:400,message:`Cannot delete payment method. It is currently being used by ${a.length} ongoing trade(s). Please wait for these trades to complete or be cancelled.`});null==s||s.step("Deleting payment method");await e.destroy();null==s||s.success(`Deleted payment method: ${e.name}`);return{message:"Payment method deleted successfully."}}catch(e){if(e.statusCode)throw e;throw(0,error_1.createError)({statusCode:500,message:"Internal Server Error: "+e.message})}};