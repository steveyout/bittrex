"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),query_1=require("@b/utils/query"),sequelize_1=require("sequelize");exports.metadata={summary:"Update Payment Method",description:"Updates an existing custom payment method by its ID.",operationId:"updatePaymentMethod",tags:["P2P","Payment Method"],requiresAuth:!0,logModule:"P2P_PAYMENT",logTitle:"Update payment method",parameters:[{index:0,name:"id",in:"path",description:"Payment Method ID",required:!0,schema:{type:"string"}}],requestBody:{description:"Fields to update for the payment method",required:!0,content:{"application/json":{schema:{type:"object",properties:{name:{type:"string"},description:{type:"string"},instructions:{type:"string"},metadata:{type:"object",description:"Flexible key-value pairs for payment details",additionalProperties:{type:"string"}},processingTime:{type:"string"},available:{type:"boolean"}}}}}},responses:{200:{description:"Payment method updated successfully."},401:{description:"Unauthorized."},404:{description:"Payment method not found or not owned by user."},409:{description:"Cannot edit payment method with active trades."},500:query_1.serverErrorResponse}};exports.default=async e=>{var t,a,r,o;const{params:i,body:s,user:n,ctx:d}=e,p=null==i?void 0:i.id;if(!(null==n?void 0:n.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});null==d||d.step("Finding and validating payment method ownership");try{const e=await db_1.models.p2pPaymentMethod.findByPk(p);if(!e)throw(0,error_1.createError)({statusCode:404,message:"Payment method not found"});if(e.userId!==n.id)throw(0,error_1.createError)({statusCode:401,message:"Unauthorized - you can only edit your own payment methods"});if(await db_1.models.p2pTrade.findOne({where:{paymentMethod:p,status:{[sequelize_1.Op.in]:["PENDING","PAYMENT_SENT","DISPUTED"]}}}))throw(0,error_1.createError)({statusCode:409,message:"Cannot edit payment method while it is being used in an active trade. Please wait for all trades using this method to complete or be cancelled."});let i=e.metadata;if(void 0!==s.metadata)if(s.metadata&&"object"==typeof s.metadata&&!Array.isArray(s.metadata)){i={};const e=20;let t=0;for(const[a,r]of Object.entries(s.metadata)){if(t>=e)break;if("string"==typeof a&&"string"==typeof r){const e=a.trim().substring(0,100),o=r.trim().substring(0,500);if(e&&o){i[e]=o;t++}}}0===Object.keys(i).length&&(i=null)}else i=null;null==d||d.step("Updating payment method");await e.update({name:null!==(t=s.name)&&void 0!==t?t:e.name,description:null!==(a=s.description)&&void 0!==a?a:e.description,instructions:null!==(r=s.instructions)&&void 0!==r?r:e.instructions,metadata:i,processingTime:null!==(o=s.processingTime)&&void 0!==o?o:e.processingTime,available:"boolean"==typeof s.available?s.available:e.available});null==d||d.success(`Updated payment method: ${e.name}`);return{message:"Payment method updated successfully.",paymentMethod:e.toJSON()}}catch(e){if(e.statusCode)throw e;throw(0,error_1.createError)({statusCode:500,message:"Internal Server Error: "+e.message})}};