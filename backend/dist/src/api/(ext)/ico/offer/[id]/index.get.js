"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),sequelize_1=require("sequelize"),console_1=require("@b/utils/console"),error_1=require("@b/utils/error");exports.metadata={summary:"Get ICO Offering by ID",description:"Retrieves detailed ICO token offering data by its unique identifier. The response includes related phases, token details, team members, and roadmap items. Additionally, it calculates the current and next phases based on the offering's start date and the durations of its phases.",operationId:"getIcoOfferingById",tags:["ICO","Offerings"],logModule:"ICO",logTitle:"Get ICO Offer",parameters:[{name:"id",in:"path",description:"Unique identifier of the ICO offering",required:!0,schema:{type:"string"}}],responses:{200:{description:"ICO offering retrieved successfully.",content:{"application/json":{schema:{type:"object",properties:{id:{type:"string",description:"Unique identifier for the offering"},name:{type:"string",description:"Name of the offering"},symbol:{type:"string",description:"Token ticker"},icon:{type:"string",description:"Offering icon URL"},purchaseWalletCurrency:{type:"string",description:"Wallet currency for purchase"},purchaseWalletType:{type:"string",description:"Wallet type for purchase"},status:{type:"string",description:"Current status (ACTIVE, PENDING, etc.). For COMPLETED queries, the status may be SUCCESS or FAILED."},tokenPrice:{type:"number",description:"Current active phase token price (used for purchase calculations)"},baseTokenPrice:{type:"number",description:"Base token price from offering (for reference)"},targetAmount:{type:"number",description:"Total funding target"},participants:{type:"number",description:"Number of participants"},isPaused:{type:"boolean",description:"Flag if the offering is paused"},isFlagged:{type:"boolean",description:"Flag if the offering is flagged"},startDate:{type:"string",format:"date-time",description:"Start date of the offering"},endDate:{type:"string",format:"date-time",description:"End date of the offering"},currentPhase:{type:"object",description:"Information about the current phase"},nextPhase:{type:"object",description:"Information about the next phase"},phases:{type:"array",description:"List of all phases for the offering",items:{type:"object"}},tokenDetail:{type:"object",description:"Detailed token information"},teamMembers:{type:"array",description:"List of team members",items:{type:"object"}},roadmapItems:{type:"array",description:"List of roadmap items",items:{type:"object"}},currentRaised:{type:"number",description:"Sum of all transactions (price * amount) associated with this offering"}}}}}},404:{description:"ICO offering not found."},500:{description:"Internal Server Error."}}};exports.default=async e=>{try{const{ctx:t}=e;null==t||t.step("Fetching get ico offer");const{id:r}=e.params||{};if(!r)throw(0,error_1.createError)({statusCode:400,message:"No offering ID provided"});const i=await db_1.models.icoTokenOffering.findOne({where:{id:r},include:[{model:db_1.models.icoTokenOfferingPhase,as:"phases",order:[["sortOrder","ASC"]]},{model:db_1.models.icoTokenDetail,as:"tokenDetail",include:[{model:db_1.models.icoTokenType,as:"tokenTypeData"}]},{model:db_1.models.icoTeamMember,as:"teamMembers"},{model:db_1.models.icoRoadmapItem,as:"roadmapItems"}]});if(!i){null==t||t.success("Get ICO Offer retrieved successfully");return{error:"Offering not found"}}const s=db_1.models.icoTransaction.findOne({attributes:[[(0,sequelize_1.fn)("SUM",(0,sequelize_1.literal)("price * amount")),"currentRaised"]],where:{offeringId:r,status:{[sequelize_1.Op.not]:["REJECTED"]}},raw:!0}),o=i.phases||[],n=new Date(i.startDate),a=Math.floor((Date.now()-n.getTime())/864e5);let d=0,c=null,p=null;const l=o.find(e=>e.remaining>0);for(let e=0;e<o.length;e++){d+=o[e].duration;if(a<d){c={...o[e].toJSON(),endsIn:d-a};e+1<o.length&&(p={...o[e+1].toJSON(),endsIn:o[e+1].duration});break}}l&&(!c||l.sequence<c.sequence)&&(c={...l.toJSON(),endsIn:(null==c?void 0:c.endsIn)||0});const u=await s,f=u&&u.currentRaised?Number(u.currentRaised):0,m=(null==c?void 0:c.tokenPrice)||i.tokenPrice;return{id:i.id,name:i.name,symbol:i.symbol,icon:i.icon,purchaseWalletCurrency:i.purchaseWalletCurrency,purchaseWalletType:i.purchaseWalletType,status:i.status,tokenPrice:m,baseTokenPrice:i.tokenPrice,targetAmount:i.targetAmount,participants:i.participants,isPaused:i.isPaused,isFlagged:i.isFlagged,startDate:i.startDate,endDate:i.endDate,currentPhase:c,nextPhase:p,phases:o.map(e=>e.toJSON()),tokenDetail:i.tokenDetail?i.tokenDetail.toJSON():null,teamMembers:i.teamMembers?i.teamMembers.map(e=>e.toJSON()):[],roadmapItems:i.roadmapItems?i.roadmapItems.map(e=>e.toJSON()):[],currentRaised:f}}catch(e){console_1.logger.error("ICO_OFFER","Error retrieving ICO offering by ID",e);throw e}};