"use strict";function validateTransactionHash(e,t){const a={ethereum:/^0x[a-fA-F0-9]{64}$/,bsc:/^0x[a-fA-F0-9]{64}$/,polygon:/^0x[a-fA-F0-9]{64}$/,bitcoin:/^[a-fA-F0-9]{64}$/,solana:/^[1-9A-HJ-NP-Za-km-z]{87,88}$/}[t.toLowerCase()];return!a||a.test(e)}var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),notifications_1=require("@b/utils/notifications"),Middleware_1=require("@b/handler/Middleware"),crypto_1=__importDefault(require("crypto"));exports.metadata={summary:"Submit Token Release Transaction Hash",description:"Submits the transaction hash after sending tokens to the investor and updates the token release status to VERIFICATION.",operationId:"submitTokenReleaseHash",tags:["ICO","Token","Release"],requiresAuth:!0,logModule:"ICO_RELEASE",logTitle:"Submit token release",parameters:[{index:0,name:"id",in:"path",required:!0,schema:{type:"string"},description:"ID of the token offering"},{index:1,name:"transactionId",in:"path",required:!0,schema:{type:"string"},description:"ID of the ICO transaction"}],requestBody:{required:!0,content:{"application/json":{schema:{type:"object",properties:{releaseUrl:{type:"string",description:"Transaction hash or explorer URL"},gasUsed:{type:"number",description:"Gas used for the transaction (optional)"},blockNumber:{type:"number",description:"Block number of the transaction (optional)"}},required:["releaseUrl"]}}}},responses:{200:{description:"Token release transaction hash submitted successfully.",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"},verificationId:{type:"string"}}}}}},400:{description:"Bad Request"},401:{description:"Unauthorized"},403:{description:"Forbidden - Not the offering owner"},404:{description:"Transaction not found"},500:{description:"Internal Server Error"}}};exports.default=async e=>{await Middleware_1.rateLimiters.general(e);const{user:t,params:a,body:r}=e;if(!(null==t?void 0:t.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});const{id:s,transactionId:o}=a,{releaseUrl:i,gasUsed:n,blockNumber:d}=r;if(!s||!o||!i)throw(0,error_1.createError)({statusCode:400,message:"Missing required fields"});const c=await db_1.sequelize.transaction();try{const e=await db_1.models.icoTokenOffering.findByPk(s,{include:[{model:db_1.models.icoTokenDetail,as:"tokenDetail",required:!0}],transaction:c});if(!e)throw(0,error_1.createError)({statusCode:404,message:"Offering not found"});if(e.userId!==t.id)throw(0,error_1.createError)({statusCode:403,message:"You are not the owner of this offering"});const a=await db_1.models.icoTransaction.findOne({where:{id:o,offeringId:s},include:[{model:db_1.models.user,as:"user",attributes:["id","email","firstName","lastName"]}],transaction:c,lock:c.LOCK.UPDATE});if(!a)throw(0,error_1.createError)({statusCode:404,message:"Transaction not found"});if("PENDING"!==a.status)throw(0,error_1.createError)({statusCode:400,message:`Cannot release tokens for transaction with status: ${a.status}`});let r=i;if(i.includes("etherscan.io")||i.includes("bscscan.com")||i.includes("polygonscan.com")){const e=i.match(/tx\/(0x[a-fA-F0-9]{64})/);e&&(r=e[1])}const l=e.tokenDetail.blockchain;if(!validateTransactionHash(r,l))throw(0,error_1.createError)({statusCode:400,message:`Invalid ${l} transaction hash format`});await a.update({releaseUrl:i,status:"VERIFICATION",notes:JSON.stringify({...JSON.parse(a.notes||"{}"),releaseData:{transactionHash:r,gasUsed:n,blockNumber:d,releasedAt:(new Date).toISOString(),releasedBy:t.id}})},{transaction:c});const u=crypto_1.default.randomBytes(16).toString("hex");await db_1.models.icoAdminActivity.create({type:"TOKEN_RELEASE_SUBMITTED",offeringId:e.id,offeringName:e.name,adminId:t.id,details:JSON.stringify({transactionId:a.id,investor:a.user.email,tokenAmount:a.amount,walletAddress:a.walletAddress,releaseUrl:i,transactionHash:r,verificationId:u})},{transaction:c});await c.commit();try{await(0,notifications_1.createNotification)({userId:a.userId,relatedId:s,type:"investment",title:"Token Release In Progress",message:"Your tokens are being released to your wallet.",details:`Transaction hash: ${r}\nTokens: ${a.amount} ${e.symbol}\nWallet: ${a.walletAddress}\nStatus: Awaiting blockchain confirmation`,link:"/ico/dashboard?tab=transactions",actions:[{label:"View Transaction",link:i,primary:!0},{label:"View in Dashboard",link:"/ico/dashboard?tab=transactions"}]});await(0,notifications_1.createNotification)({userId:t.id,relatedId:s,type:"system",title:"Token Release Submitted",message:"Token release transaction submitted successfully.",details:`Investor: ${a.user.firstName} ${a.user.lastName}\nTokens: ${a.amount} ${e.symbol}\nTransaction: ${r}`,link:`/ico/creator/token/${s}/release`,actions:[{label:"View Release Dashboard",link:`/ico/creator/token/${s}/release`,primary:!0}]})}catch(e){console.error("Failed to send notifications:",e)}return{message:"Token release transaction submitted successfully.",verificationId:u}}catch(e){await c.rollback();throw e}};