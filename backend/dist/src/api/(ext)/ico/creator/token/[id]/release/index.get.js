"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error");exports.metadata={summary:"Fetch Token Release Transactions",description:"Retrieves token release transactions for a given token (offering) ID, optionally filtered by status and paginated with sorting support.",operationId:"getTokenReleaseTransactions",tags:["ICO","Token","Release"],logModule:"ICO",logTitle:"Get Token Releases",requiresAuth:!0,parameters:[{index:0,name:"id",in:"param",required:!0,schema:{type:"string"},description:"Token (offering) ID"},{index:1,name:"status",in:"query",required:!1,schema:{type:"string"},description:"Filter transactions by status (PENDING, VERIFICATION, RELEASED)"},{index:2,name:"page",in:"query",required:!1,schema:{type:"number"},description:"Page number"},{index:3,name:"limit",in:"query",required:!1,schema:{type:"number"},description:"Number of items per page"},{index:4,name:"sortField",in:"query",required:!1,schema:{type:"string"},description:"Field to sort by (default is createdAt). For associated models use dot notation (e.g., 'user.firstName')"},{index:5,name:"sortDirection",in:"query",required:!1,schema:{type:"string"},description:"Sort direction: asc or desc (default is desc)"}],responses:{200:{description:"Token release transactions retrieved successfully.",content:{"application/json":{schema:{type:"object",properties:{items:{type:"array",items:{type:"object"}},pagination:{type:"object",properties:{currentPage:{type:"number"},totalPages:{type:"number"},totalItems:{type:"number"},itemsPerPage:{type:"number"}}}}}}}},400:{description:"Bad Request"},401:{description:"Unauthorized"},500:{description:"Internal Server Error"}}};exports.default=async e=>{const{user:t,query:r,params:s,ctx:i}=e;if(!(null==t?void 0:t.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});null==i||i.step("Fetching token releases");const{id:a}=s;if(!a)throw(0,error_1.createError)({statusCode:400,message:"id is required"});const o={offeringId:a};r.status&&(o.status=r.status.toUpperCase());const n=parseInt(r.page,10)||1,d=parseInt(r.limit,10)||10,c=(n-1)*d,u=r.sortField||"createdAt",l=r.sortDirection&&"ASC"===r.sortDirection.toUpperCase()?"ASC":"DESC";let p;if(u.includes(".")){const e=u.split(".");p="user"===e[0]?[[{model:db_1.models.user,as:"user"},e[1],l]]:[[u,l]]}else p=[[u,l]];const m=await db_1.models.icoTransaction.count({where:o}),g=await db_1.models.icoTransaction.findAll({where:o,include:[{model:db_1.models.user,as:"user",attributes:["firstName","lastName","avatar"]}],offset:c,limit:d,order:p}),y=Math.ceil(m/d);null==i||i.success("Get Token Releases retrieved successfully");return{items:g,pagination:{currentPage:n,totalPages:y,totalItems:m,itemsPerPage:d}}};