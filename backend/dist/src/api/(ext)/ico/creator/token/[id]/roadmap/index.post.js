"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),notifications_1=require("@b/utils/notifications");exports.metadata={summary:"Add a Roadmap Item",description:"Adds a new roadmap item to the specified ICO offering for the authenticated creator.",operationId:"addRoadmapItem",tags:["ICO","Creator","Roadmap"],requiresAuth:!0,logModule:"ICO_ROADMAP",logTitle:"Add roadmap item",parameters:[{index:0,name:"id",in:"path",description:"ICO offering ID",required:!0,schema:{type:"string"}}],requestBody:{description:"Roadmap item data",required:!0,content:{"application/json":{schema:{type:"object",properties:{title:{type:"string"},description:{type:"string"},date:{type:"string"},completed:{type:"boolean"}},required:["title","description","date"]}}}},responses:{200:{description:"Roadmap item added successfully"},400:{description:"Bad Request"},401:{description:"Unauthorized"},500:{description:"Internal Server Error"}}};exports.default=async e=>{const{user:t,params:a,body:r,ctx:o}=e,i=a.id;if(!(null==t?void 0:t.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});if(!i)throw(0,error_1.createError)({statusCode:400,message:"Offering ID is required"});null==o||o.step("Validating roadmap item request");const d=await db_1.models.icoTokenOffering.findOne({where:{id:i,userId:t.id},include:[{model:db_1.models.icoLaunchPlan,as:"plan"},{model:db_1.models.icoRoadmapItem,as:"roadmapItems"}]});if(!d)throw(0,error_1.createError)({statusCode:404,message:"Offering not found"});null==o||o.step("Checking roadmap item limit");if(d.plan&&d.roadmapItems.length>=d.plan.features.maxRoadmapItems)throw(0,error_1.createError)({statusCode:400,message:"Roadmap item limit reached. Upgrade your plan to add more roadmap items."});null==o||o.step("Creating roadmap item");const{title:s,description:n,date:m,completed:p}=r;await db_1.models.icoRoadmapItem.create({offeringId:i,title:s,description:n,date:m,completed:p});null==o||o.step("Sending notification");try{await(0,notifications_1.createNotification)({userId:t.id,relatedId:i,type:"system",title:"New Roadmap Item Added",message:`New roadmap item "${s}" added successfully.`,details:"A new roadmap item has been added to your offering.",link:`/ico/creator/token/${i}?tab=roadmap`,actions:[{label:"View Offering",link:`/ico/creator/token/${i}?tab=roadmap`,primary:!0}]})}catch(e){console.error("Failed to create notification for adding roadmap item",e)}null==o||o.success(`Added roadmap item "${s}"`);return{message:"Roadmap item added successfully"}};