"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),notifications_1=require("@b/utils/notifications");exports.metadata={summary:"Delete a Token Offering Update",description:"Deletes an update for a token offering by the authenticated creator.",operationId:"deleteTokenOfferingUpdate",tags:["ICO","Creator","Updates"],requiresAuth:!0,logModule:"ICO",logTitle:"Delete ICO Token Offering Update",parameters:[{index:0,name:"updateId",in:"path",description:"Token offering update ID",required:!0,schema:{type:"string"}}],responses:{200:{description:"Token offering update deleted successfully.",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}}},401:{description:"Unauthorized"},404:{description:"Not Found"},500:{description:"Internal Server Error"}}};exports.default=async e=>{var t,r,o,i,a,d,n;const{user:s,params:l,ctx:u}=e;null===(t=null==u?void 0:u.step)||void 0===t||t.call(u,"Validating user authentication");if(!(null==s?void 0:s.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});null===(r=null==u?void 0:u.step)||void 0===r||r.call(u,"Validating update ID parameter");const{updateId:c}=l;if(!c)throw(0,error_1.createError)({statusCode:400,message:"Missing update ID"});null===(o=null==u?void 0:u.step)||void 0===o||o.call(u,"Fetching update record from database");const p=await db_1.models.icoTokenOfferingUpdate.findByPk(c);if(!p)throw(0,error_1.createError)({statusCode:404,message:"Update not found"});null===(i=null==u?void 0:u.step)||void 0===i||i.call(u,"Verifying user ownership");if(p.userId!==s.id)throw(0,error_1.createError)({statusCode:403,message:"Forbidden"});const f=p.title;null===(a=null==u?void 0:u.step)||void 0===a||a.call(u,"Deleting update record");await p.destroy();null===(d=null==u?void 0:u.step)||void 0===d||d.call(u,"Creating deletion notification");try{await(0,notifications_1.createNotification)({userId:s.id,relatedId:p.offeringId,type:"system",title:"Update Deleted",message:`Token offering update "${f}" has been deleted successfully.`,details:"Your update has been removed. You can always add new updates to keep your investors informed.",link:p.offeringId?`/ico/creator/token/${p.offeringId}?tab=updates`:void 0,actions:p.offeringId?[{label:"View Offering",link:`/ico/creator/token/${p.offeringId}?tab=updates`,primary:!0}]:[]})}catch(e){console.error("Failed to create notification for update deletion",e)}null===(n=null==u?void 0:u.success)||void 0===n||n.call(u,"Update deleted successfully");return{message:"Update deleted successfully."}};