"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),notifications_1=require("@b/utils/notifications");exports.metadata={summary:"Edit a Token Offering Update",description:"Edits an existing update for a token offering by the authenticated creator.",operationId:"editTokenOfferingUpdate",tags:["ICO","Creator","Updates"],requiresAuth:!0,logModule:"ICO_UPDATE",logTitle:"Edit offering update",parameters:[{index:0,name:"updateId",in:"path",description:"Token offering update ID",required:!0,schema:{type:"string"}}],requestBody:{description:"Updated token offering update data",required:!0,content:{"application/json":{schema:{type:"object",properties:{title:{type:"string"},content:{type:"string"},attachments:{type:"array",items:{type:"object",properties:{type:{type:"string",enum:["image","document","link"]},url:{type:"string"},name:{type:"string"}}}}},required:["title","content"]}}}},responses:{200:{description:"Token offering update updated successfully.",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"},update:{type:"object"}}}}}},400:{description:"Bad Request"},401:{description:"Unauthorized"},404:{description:"Update not found"},500:{description:"Internal Server Error"}}};exports.default=async e=>{const{user:t,params:r,body:i,ctx:o}=e;if(!(null==t?void 0:t.id))throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"});null==o||o.step("Validating update edit request");const{updateId:a}=r;if(!a)throw(0,error_1.createError)({statusCode:400,message:"Missing update ID"});const{title:n,content:s,attachments:d}=i;if(!n||!s)throw(0,error_1.createError)({statusCode:400,message:"Missing required fields"});const p=await db_1.models.icoTokenOfferingUpdate.findByPk(a);if(!p)throw(0,error_1.createError)({statusCode:404,message:"Update not found"});if(p.userId!==t.id)throw(0,error_1.createError)({statusCode:403,message:"Forbidden"});const u=p.title;null==o||o.step("Updating offering update record");await p.update({title:n,content:s,attachments:d||[]});null==o||o.step("Sending notification");try{await(0,notifications_1.createNotification)({userId:t.id,relatedId:p.offeringId,type:"system",title:"Update Updated",message:`Token offering update "${n}" updated successfully.`,details:"Your update has been modified."+(u!==n?` Title changed from "${u}" to "${n}".`:""),link:p.offeringId?`/ico/creator/token/${p.offeringId}?tab=updates`:void 0,actions:p.offeringId?[{label:"View Update",link:`/ico/creator/token/${p.offeringId}?tab=updates`,primary:!0}]:[]})}catch(e){console.error("Failed to create notification for update edit",e)}null==o||o.success(`Edited update "${n}"`);return{message:"Update updated successfully.",update:p}};