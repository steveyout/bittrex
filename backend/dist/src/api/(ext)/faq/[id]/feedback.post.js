"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),Middleware_1=require("@b/handler/Middleware");exports.metadata={summary:"Submit FAQ Feedback",description:"Creates or updates a feedback record for a specific FAQ. If a feedback record already exists for the user and FAQ, it updates the comment field.",operationId:"submitFAQFeedbackPublic",tags:["FAQ"],logModule:"FAQ",logTitle:"Submit FAQ Feedback",parameters:[{index:0,name:"id",in:"path",required:!0,schema:{type:"string"},description:"FAQ ID"}],requestBody:{required:!0,content:{"application/json":{schema:{type:"object",properties:{isHelpful:{type:"boolean"},comment:{type:"string"}},required:["isHelpful"]}}}},responses:{200:{description:"Feedback submitted successfully"},400:{description:"Bad Request"},500:{description:"Internal Server Error"}},requiresAuth:!0};exports.default=async e=>{const{params:r,body:t,user:a,ctx:s}=e;null==s||s.step("Applying rate limiting");await(0,Middleware_1.faqFeedbackRateLimit)(e);if(!(null==a?void 0:a.id)){null==s||s.fail("Unauthorized");throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"})}const{id:i}=r;if(!i||"boolean"!=typeof t.isHelpful){null==s||s.fail("Invalid input");throw(0,error_1.createError)({statusCode:400,message:"Invalid input"})}try{null==s||s.step(`Checking for existing feedback (FAQ ID: ${i})`);const e=await db_1.models.faqFeedback.findOne({where:{faqId:i,userId:a.id}});if(e){null==s||s.step("Updating existing feedback record");const r=await e.update({isHelpful:t.isHelpful,comment:t.comment||e.comment});null==s||s.success(`Feedback updated successfully (ID: ${r.id})`);return r}{null==s||s.step("Creating new feedback record");const e=await db_1.models.faqFeedback.create({userId:a.id,faqId:i,isHelpful:t.isHelpful,comment:t.comment});null==s||s.success(`Feedback created successfully (ID: ${e.id})`);return e}}catch(e){console.error("Error submitting FAQ feedback:",e);null==s||s.fail(e instanceof Error?e.message:"Failed to submit feedback");throw(0,error_1.createError)({statusCode:500,message:e instanceof Error?e.message:"Failed to submit feedback"})}};