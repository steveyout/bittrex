"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error");exports.metadata={summary:"Get checkout session",description:"Retrieves checkout session details for the customer to complete payment.",operationId:"getCheckoutSession",tags:["Gateway","Checkout"],parameters:[{name:"paymentIntentId",in:"path",required:!0,description:"Payment intent ID",schema:{type:"string"}}],responses:{200:{description:"Checkout session details"},404:{description:"Payment not found or expired"}},requiresAuth:!1,logModule:"GATEWAY",logTitle:"Get Checkout"};exports.default=async e=>{var t,r,s,a,o;const{params:n,ctx:i}=e,{paymentIntentId:u}=n,d=await db_1.models.gatewayPayment.findOne({where:{paymentIntentId:u},include:[{model:db_1.models.gatewayMerchant,as:"merchant",attributes:["id","name","logo","website","status"]}]});if(!d)throw(0,error_1.createError)({statusCode:404,message:"Payment not found"});if("PENDING"!==d.status&&"PROCESSING"!==d.status)throw(0,error_1.createError)({statusCode:400,message:`Payment is ${d.status.toLowerCase()}`});if(new Date(d.expiresAt)<new Date){await d.update({status:"EXPIRED"});throw(0,error_1.createError)({statusCode:400,message:"Payment session has expired"})}if("ACTIVE"!==(null===(t=d.merchant)||void 0===t?void 0:t.status))throw(0,error_1.createError)({statusCode:400,message:"Merchant is not active"});const c=null===(r=d.lineItems)||void 0===r?void 0:r.map(e=>({name:e.name,description:e.description,quantity:e.quantity,unitPrice:e.unitPrice,image:e.imageUrl||e.image}));null==i||i.success("Request completed successfully");return{id:d.paymentIntentId,merchant:{name:null===(s=d.merchant)||void 0===s?void 0:s.name,logo:null===(a=d.merchant)||void 0===a?void 0:a.logo,website:null===(o=d.merchant)||void 0===o?void 0:o.website},amount:d.amount,currency:d.currency,walletType:d.walletType,description:d.description,lineItems:c,expiresAt:d.expiresAt,status:d.status,testMode:d.testMode,cancelUrl:d.cancelUrl,returnUrl:d.returnUrl}};