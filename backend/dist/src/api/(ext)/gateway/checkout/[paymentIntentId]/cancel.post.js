"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),gateway_1=require("@b/utils/gateway"),console_1=require("@b/utils/console");exports.metadata={summary:"Cancel checkout",description:"Cancels the checkout session and redirects to cancel URL.",operationId:"cancelCheckout",tags:["Gateway","Checkout"],parameters:[{name:"paymentIntentId",in:"path",required:!0,description:"Payment intent ID",schema:{type:"string"}}],responses:{200:{description:"Checkout cancelled"},400:{description:"Checkout cannot be cancelled"}},requiresAuth:!1,logModule:"GATEWAY",logTitle:"Cancel Checkout Session"};exports.default=async e=>{const{params:t,ctx:a}=e,{paymentIntentId:n}=t;null==a||a.step("Find payment session");const r=await db_1.models.gatewayPayment.findOne({where:{paymentIntentId:n},include:[{model:db_1.models.gatewayMerchant,as:"merchant"}]});if(!r){null==a||a.fail("Payment not found");throw(0,error_1.createError)({statusCode:404,message:"Payment not found"})}null==a||a.step("Validate payment can be cancelled");if("PENDING"!==r.status&&"PROCESSING"!==r.status){null==a||a.fail(`Payment is already ${r.status.toLowerCase()}`);throw(0,error_1.createError)({statusCode:400,message:`Payment is already ${r.status.toLowerCase()}`})}null==a||a.step("Update payment status to cancelled");await r.update({status:"CANCELLED"});null==a||a.step("Send cancellation webhook");if(r.webhookUrl)try{await(0,gateway_1.sendWebhook)(r.merchant.id,r.id,null,"payment.cancelled",r.webhookUrl,{id:`evt_${r.paymentIntentId}`,type:"payment.cancelled",createdAt:(new Date).toISOString(),data:{id:r.paymentIntentId,merchantOrderId:r.merchantOrderId,amount:r.amount,currency:r.currency,status:"CANCELLED"}},r.merchant.webhookSecret)}catch(e){console_1.logger.error("GATEWAY_CHECKOUT","Failed to send payment.cancelled webhook",e)}null==a||a.step("Build redirect URL");const s=r.cancelUrl||r.returnUrl,c=new URL(s);c.searchParams.set("payment_id",r.paymentIntentId);c.searchParams.set("status","cancelled");null==a||a.success("Checkout cancelled successfully");return{success:!0,paymentId:r.paymentIntentId,status:"CANCELLED",redirectUrl:c.toString()}};