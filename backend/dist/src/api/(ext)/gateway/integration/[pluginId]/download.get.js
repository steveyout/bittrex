"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}});Object.defineProperty(e,o,n)}:function(e,t,r,o){void 0===o&&(o=r);e[o]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var e=function(t){e=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t};return e(t)};return function(t){if(t&&t.__esModule)return t;var r={};if(null!=t)for(var o=e(t),n=0;n<o.length;n++)"default"!==o[n]&&__createBinding(r,t,o[n]);__setModuleDefault(r,t);return r}}(),__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const error_1=require("@b/utils/error"),fs=__importStar(require("fs")),path=__importStar(require("path")),archiver_1=__importDefault(require("archiver")),stream_1=require("stream");exports.metadata={summary:"Download integration plugin",description:"Downloads the integration plugin as a ZIP file",operationId:"downloadIntegrationPlugin",tags:["Gateway","Integrations"],parameters:[{name:"pluginId",in:"path",required:!0,description:"Plugin identifier (e.g., woocommerce)",schema:{type:"string"}}],responses:{200:{description:"Plugin ZIP file",content:{"application/zip":{schema:{type:"string",format:"binary"}}}},404:{description:"Plugin not found"}},requiresAuth:!0,logModule:"GATEWAY",logTitle:"Download Integration",responseType:"binary"};const PLUGINS={woocommerce:{name:"Bicrypto Payment Gateway for WooCommerce",folder:"bicrypto-payment-gateway-woocommerce",zipName:"bicrypto-payment-gateway-woocommerce.zip"}};exports.default=async e=>{const{params:t,ctx:r}=e,{pluginId:o}=t,n=PLUGINS[o];if(!n)throw(0,error_1.createError)({statusCode:404,message:"Plugin not found"});const i=path.join(process.cwd(),"src","api","(ext)","gateway","integration","plugins"),a=path.join(i,n.folder);if(!fs.existsSync(a))throw(0,error_1.createError)({statusCode:404,message:"Plugin files not found"});null==r||r.success("Request completed successfully");return new Promise((e,t)=>{const r=[],o=new stream_1.PassThrough;o.on("data",e=>{r.push(e)});o.on("end",()=>{const t=Buffer.concat(r);e({data:t,headers:{"Content-Type":"application/zip","Content-Disposition":`attachment; filename="${n.zipName}"`}})});o.on("error",()=>{t((0,error_1.createError)({statusCode:500,message:"Failed to create plugin archive"}))});const i=(0,archiver_1.default)("zip",{zlib:{level:9}});i.on("error",()=>{t((0,error_1.createError)({statusCode:500,message:"Failed to create plugin archive"}))});i.pipe(o);i.directory(a,n.folder);i.finalize()})};