"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),gateway_1=require("@b/utils/gateway"),console_1=require("@b/utils/console");exports.metadata={summary:"Cancel a payment",description:"Cancels a pending payment. Only payments with status PENDING can be cancelled.",operationId:"cancelPayment",tags:["Gateway","Payment"],parameters:[{name:"id",in:"path",required:!0,description:"Payment intent ID (e.g., pi_xxx)",schema:{type:"string"}}],responses:{200:{description:"Payment cancelled successfully",content:{"application/json":{schema:{type:"object",properties:{id:{type:"string"},status:{type:"string"},cancelledAt:{type:"string"}}}}}},400:{description:"Payment cannot be cancelled"},401:{description:"Invalid or missing API key"},404:{description:"Payment not found"}},requiresAuth:!1,logModule:"GATEWAY",logTitle:"Cancel Payment"};exports.default=async e=>{var t,a;const{params:n,headers:r,ctx:s}=e,{id:o}=n;null==s||s.step("Authenticate API key");const l=(null==r?void 0:r["x-api-key"])||(null==r?void 0:r["X-API-Key"]),i=(null===(a=null===(t=null==r?void 0:r["x-forwarded-for"])||void 0===t?void 0:t.split(",")[0])||void 0===a?void 0:a.trim())||(null==r?void 0:r["x-real-ip"])||(null==r?void 0:r["cf-connecting-ip"])||null,{merchant:c,apiKey:d,isTestMode:u,isSecretKey:y}=await(0,gateway_1.authenticateGatewayApi)(l,i);if(!y){null==s||s.fail("Secret key required");throw(0,error_1.createError)({statusCode:403,message:"Secret key required to cancel payments"})}(0,gateway_1.checkApiPermission)(d,"payment.cancel");null==s||s.step("Find payment to cancel");const p=await db_1.models.gatewayPayment.findOne({where:{paymentIntentId:o,merchantId:c.id}});if(!p){null==s||s.fail("Payment not found");throw(0,error_1.createError)({statusCode:404,message:"Payment not found"})}if(p.testMode!==u){null==s||s.fail("Test mode mismatch");throw(0,error_1.createError)({statusCode:404,message:"Payment not found"})}null==s||s.step("Validate payment can be cancelled");if("PENDING"!==p.status&&"PROCESSING"!==p.status){null==s||s.fail(`Payment status is ${p.status}`);throw(0,error_1.createError)({statusCode:400,message:`Payment with status ${p.status} cannot be cancelled`})}null==s||s.step("Update payment status");await p.update({status:"CANCELLED"});null==s||s.step("Send cancellation webhook");if(p.webhookUrl)try{await(0,gateway_1.sendWebhook)(c.id,p.id,null,"payment.cancelled",p.webhookUrl,{id:`evt_${p.paymentIntentId}`,type:"payment.cancelled",createdAt:(new Date).toISOString(),data:{id:p.paymentIntentId,merchantOrderId:p.merchantOrderId,amount:p.amount,currency:p.currency,status:"CANCELLED"}},c.webhookSecret)}catch(e){console_1.logger.error("GATEWAY_PAYMENT","Failed to send payment.cancelled webhook",e)}null==s||s.success("Payment cancelled successfully");return{id:p.paymentIntentId,status:"CANCELLED",cancelledAt:(new Date).toISOString()}};