"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error"),gateway_1=require("@b/utils/gateway");exports.metadata={summary:"Rotate API key",description:"Rotates an API key, generating a new key value.",operationId:"rotateApiKey",tags:["Gateway","Merchant","API Keys"],parameters:[{name:"id",in:"path",required:!0,schema:{type:"string"}}],responses:{200:{description:"API key rotated"},404:{description:"API key not found"}},requiresAuth:!0,logModule:"GATEWAY",logTitle:"Rotate API Key"};exports.default=async e=>{const{user:t,params:a,ctx:r}=e,{id:s}=a;null==r||r.step("Validate user authentication");if(!(null==t?void 0:t.id)){null==r||r.fail("Unauthorized - no user ID");throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"})}null==r||r.step("Find merchant account");const o=await db_1.models.gatewayMerchant.findOne({where:{userId:t.id}});if(!o){null==r||r.fail("Merchant account not found");throw(0,error_1.createError)({statusCode:404,message:"Merchant account not found"})}null==r||r.step("Find API key to rotate");const n=await db_1.models.gatewayApiKey.findOne({where:{id:s,merchantId:o.id}});if(!n){null==r||r.fail("API key not found");throw(0,error_1.createError)({statusCode:404,message:"API key not found"})}null==r||r.step("Generate new API key");const i=(0,gateway_1.generateApiKey)(n.keyPrefix);await n.update({keyHash:(0,gateway_1.hashApiKey)(i),lastFourChars:(0,gateway_1.getLastFourChars)(i),lastUsedAt:null,lastUsedIp:null});null==r||r.success("API key rotated successfully");return{id:n.id,name:n.name,key:i,keyPreview:`${n.keyPrefix}...${n.lastFourChars}`,type:n.type,mode:n.mode,note:"Save this new key securely. The old key is now invalid."}};