"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.metadata=void 0;const db_1=require("@b/db"),error_1=require("@b/utils/error");exports.metadata={summary:"Delete API key pair",description:"Deletes an API key and its corresponding pair (public + secret).",operationId:"deleteApiKey",tags:["Gateway","Merchant","API Keys"],parameters:[{name:"id",in:"path",required:!0,schema:{type:"string"}}],responses:{200:{description:"API key pair deleted"},404:{description:"API key not found"}},requiresAuth:!0,logModule:"GATEWAY",logTitle:"Delete API Key Pair"};exports.default=async e=>{const{user:t,params:r,ctx:a}=e,{id:s}=r;null==a||a.step("Validate user authentication");if(!(null==t?void 0:t.id)){null==a||a.fail("Unauthorized - no user ID");throw(0,error_1.createError)({statusCode:401,message:"Unauthorized"})}null==a||a.step("Find merchant account");const n=await db_1.models.gatewayMerchant.findOne({where:{userId:t.id}});if(!n){null==a||a.fail("Merchant account not found");throw(0,error_1.createError)({statusCode:404,message:"Merchant account not found"})}null==a||a.step("Find API key to delete");const d=await db_1.models.gatewayApiKey.findOne({where:{id:s,merchantId:n.id}});if(!d){null==a||a.fail("API key not found");throw(0,error_1.createError)({statusCode:404,message:"API key not found"})}null==a||a.step("Find and delete API key pair");const o=d.name.replace(" (Public)","").replace(" (Secret)",""),i="PUBLIC"===d.type?"SECRET":"PUBLIC",l="PUBLIC"===i?" (Public)":" (Secret)",u=await db_1.models.gatewayApiKey.findOne({where:{merchantId:n.id,mode:d.mode,type:i,name:`${o}${l}`}});await d.destroy();u&&await u.destroy();null==a||a.success("API key pair deleted successfully");return{message:"API key pair deleted successfully",deletedCount:u?2:1}};